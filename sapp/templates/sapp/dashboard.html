{% extends "sapp/base.html" %}
{% load humanize %}

{% block title %}Dashboard - Sementes App{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Cabeçalho -->
    <div class="page-title text-center mb-4">
        <h1 class="mb-2"><i class="fas fa-boxes me-2"></i>Dashboard do Estoque</h1>
        <p class="mb-0 text-muted">Bem-vindo, {{ user.username }}! Visão geral em tempo real</p>
    </div>

    <!-- KPIs Cards - Reorganizados -->
    <div class="row mb-4">
        <!-- Total Estoque -->
        <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100" style="border-left-width: 4px !important;">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="small font-weight-bold text-uppercase text-success mb-1">
                                Total Estoque
                            </div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">
                                {{ total_sc_convertido|intcomma }} sc
                            </div>
                            <div class="small text-muted">
                                {{ total_bag }} bgs + {{ total_sc }} sc físicos
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-pallet fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Peso Total -->
        <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100" style="border-left-width: 4px !important;">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="small font-weight-bold text-uppercase text-primary mb-1">
                                Peso Total
                            </div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">
                                {{ peso_total|floatformat:0|intcomma }} kg
                            </div>
                            <div class="small text-muted">Em estoque atual</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-weight-hanging fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lotes Ativos -->
        <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100" style="border-left-width: 4px !important;">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="small font-weight-bold text-uppercase text-info mb-1">
                                Lotes Ativos
                            </div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">
                                {{ itens_ativos }}
                            </div>
                            <div class="small text-muted">
                                <span class="text-success">{{ itens_ativos }}</span> ativos | 
                                <span class="text-danger">{{ itens_esgotados }}</span> esgotados
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-box-open fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movimentação -->
        <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100" style="border-left-width: 4px !important;">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="small font-weight-bold text-uppercase text-warning mb-1">
                                Movimentação
                            </div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">
                                {{ movimentacao_mes }}
                            </div>
                            <div class="small text-muted">Registros este mês</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-exchange-alt fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Linha 1: Gráficos principais -->
    <div class="row mb-4">
        <!-- Top Cultivares -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3" style="background: linear-gradient(135deg, var(--brand-green), #3aa55c);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-white">
                            <i class="fas fa-seedling me-2"></i>Top Cultivares
                        </h6>
                        <span class="badge bg-light text-dark">{{ top_cultivares|length }} cultivares</span>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div style="height: 220px; position: relative;">
                        <canvas id="cultivarChart"></canvas>
                    </div>
                    <div class="mt-3" id="cultivarLegend" style="max-height: 100px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Distribuição por Peneira -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3" style="background: linear-gradient(135deg, var(--brand-dark), #2a3d38);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-white">
                            <i class="fas fa-filter me-2"></i>Distribuição por Peneira
                        </h6>
                        <span class="badge bg-light text-dark">{{ categorias_distribuicao|length }} peneiras</span>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div style="height: 220px; position: relative;">
                        <canvas id="peneiraChart"></canvas>
                    </div>
                    <div class="mt-3" id="peneiraLegend" style="max-height: 100px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Linha 2: Armazém e Movimentação -->
    <div class="row mb-4">
        <!-- Ocupação por Armazém -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #FF9F40, #FF6B6B);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-white">
                            <i class="fas fa-warehouse me-2"></i>Ocupação por Armazém
                        </h6>
                        <span class="badge bg-light text-dark">{{ capacidade_armazem|length }} armazéns</span>
                    </div>
                </div>
                <div class="card-body p-3">
                    {% if capacidade_armazem %}
                    <div style="height: 240px; position: relative;">
                        <canvas id="armazemChart"></canvas>
                    </div>
                    <div class="mt-3" id="armazemLegend" style="max-height: 120px; overflow-y: auto;"></div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-warehouse fa-3x mb-3 opacity-25"></i>
                        <p class="mb-0">Nenhum dado de armazém disponível</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Movimentação Recente -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #36A2EB, #4BC0C0);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-white">
                            <i class="fas fa-history me-2"></i>Movimentação Recente
                        </h6>
                        <span class="badge bg-light text-dark">{{ movimentacao_recente|length }} registros</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-3" style="min-width: 120px;">Data/Hora</th>
                                    <th class="text-center" style="min-width: 100px;">Tipo</th>
                                    <th style="min-width: 100px;">Lote</th>
                                    <th style="min-width: 100px;">Usuário</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mov in movimentacao_recente %}
                                <tr>
                                    <td class="ps-3">
                                        <div class="small text-muted">{{ mov.data_hora|date:"d/m" }}</div>
                                        <div class="small">{{ mov.data_hora|date:"H:i" }}</div>
                                    </td>
                                    <td class="text-center">
                                        {% if 'Entrada' in mov.tipo %}
                                        <span class="badge bg-success" style="font-size: 0.7rem; padding: 2px 6px;">ENTRADA</span>
                                        {% elif 'Saída' in mov.tipo or 'Expedição' in mov.tipo %}
                                        <span class="badge bg-danger" style="font-size: 0.7rem; padding: 2px 6px;">SAÍDA</span>
                                        {% elif 'Transferência' in mov.tipo %}
                                        <span class="badge bg-warning text-dark" style="font-size: 0.7rem; padding: 2px 6px;">TRANSF.</span>
                                        {% elif 'Edição' in mov.tipo %}
                                        <span class="badge bg-info" style="font-size: 0.7rem; padding: 2px 6px;">EDIÇÃO</span>
                                        {% else %}
                                        <span class="badge bg-secondary" style="font-size: 0.7rem; padding: 2px 6px;">OUTRO</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="small">{{ mov.lote_ref|default:"--"|truncatechars:12 }}</div>
                                    </td>
                                    <td>
                                        <div class="small">{{ mov.usuario.username|default:"Sistema"|truncatechars:12 }}</div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="fas fa-history fa-lg mb-2 opacity-25"></i>
                                        <p class="mb-0">Nenhuma movimentação recente</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações Rápidas -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-header py-3 bg-light">
                    <h6 class="m-0 font-weight-bold" style="color: var(--brand-dark);">
                        <i class="fas fa-bolt me-2"></i>Ações Rápidas
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <a href="{% url 'sapp:lista_estoque' %}" class="btn btn-success btn-sm px-3">
                            <i class="fas fa-boxes me-1"></i>Ver Estoque
                        </a>
                        <a href="{% url 'sapp:nova_entrada' %}" class="btn btn-primary btn-sm px-3">
                            <i class="fas fa-plus me-1"></i>Nova Entrada
                        </a>
                        <a href="{% url 'sapp:configuracoes' %}" class="btn btn-dark btn-sm px-3">
                            <i class="fas fa-cog me-1"></i>Configurações
                        </a>
                        <a href="{% url 'sapp:importar_estoque' %}" class="btn btn-warning btn-sm px-3">
                            <i class="fas fa-file-import me-1"></i>Importar
                        </a>
                        <a href="{% url 'sapp:exportar_excel' %}" class="btn btn-info btn-sm px-3">
                            <i class="fas fa-file-excel me-1"></i>Exportar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Paleta de cores otimizada
    const themeColors = [
        '#2f8f4e', '#36A2EB', '#FFCE56', '#FF6384', '#4BC0C0',
        '#9966FF', '#FF9F40', '#8AC926', '#6A4C93', '#1982C4',
        '#FF595E', '#FFCA3A', '#6A4C93', '#1982C4', '#FF595E'
    ];

    // Função para criar legenda responsiva
    function createCustomLegend(chartId, labels, values, colors, suffix = '') {
        const legendContainer = document.getElementById(chartId + 'Legend');
        if (!legendContainer) return;
        
        let html = '<div class="row g-2">';
        const total = values.reduce((a, b) => a + b, 0);
        
        labels.forEach((label, index) => {
            if (index < 6) { // Mostrar apenas top 6 na legenda
                const percentage = total > 0 ? ((values[index] / total) * 100).toFixed(1) : 0;
                const displayValue = values[index].toLocaleString('pt-BR');
                
                html += `
                    <div class="col-6 col-md-4 col-lg-6">
                        <div class="d-flex align-items-center mb-1">
                            <div class="flex-shrink-0 me-2" style="width: 12px; height: 12px; background-color: ${colors[index]}; border-radius: 2px;"></div>
                            <div class="flex-grow-1 small">
                                <div class="text-truncate" title="${label}" style="max-width: 120px;">${label}</div>
                                <div class="text-muted">${displayValue}${suffix} (${percentage}%)</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        if (labels.length > 6) {
            html += `<div class="col-12 mt-1 text-center">
                        <small class="text-muted">+${labels.length - 6} outros</small>
                    </div>`;
        }
        
        html += '</div>';
        legendContainer.innerHTML = html;
    }

    // Configuração comum dos gráficos
    const commonChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 10,
                cornerRadius: 6,
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('pt-BR')} bgs (${percentage}%)`;
                    }
                }
            }
        }
    };

    // 1. Gráfico de Cultivares
    const cultivarLabels = [{% for item in top_cultivares %}'{{ item.cultivar__nome }}',{% endfor %}];
    const cultivarValues = [{% for item in top_cultivares %}{{ item.total_saldo }},{% endfor %}];
    
    const ctx1 = document.getElementById('cultivarChart');
    if (ctx1 && cultivarLabels.length > 0) {
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: cultivarLabels,
                datasets: [{
                    data: cultivarValues,
                    backgroundColor: themeColors.slice(0, cultivarLabels.length),
                    borderWidth: 1.5,
                    borderColor: '#fff'
                }]
            },
            options: {
                ...commonChartOptions,
                cutout: '65%',
                plugins: {
                    ...commonChartOptions.plugins,
                    tooltip: {
                        ...commonChartOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value.toLocaleString('pt-BR')} bgs (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        createCustomLegend('cultivar', cultivarLabels, cultivarValues, themeColors.slice(0, cultivarLabels.length), ' bgs');
    }

    // 2. Gráfico de Peneira
    const peneiraLabels = [{% for item in categorias_distribuicao %}'{{ item.peneira__nome }}',{% endfor %}];
    const peneiraValues = [{% for item in categorias_distribuicao %}{{ item.total }},{% endfor %}];
    
    const ctx2 = document.getElementById('peneiraChart');
    if (ctx2 && peneiraLabels.length > 0) {
        new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: peneiraLabels,
                datasets: [{
                    data: peneiraValues,
                    backgroundColor: themeColors.slice(0, peneiraLabels.length),
                    borderWidth: 1.5,
                    borderColor: '#fff'
                }]
            },
            options: {
                ...commonChartOptions,
                plugins: {
                    ...commonChartOptions.plugins,
                    tooltip: {
                        ...commonChartOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value.toLocaleString('pt-BR')} bgs (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        createCustomLegend('peneira', peneiraLabels, peneiraValues, themeColors.slice(0, peneiraLabels.length), ' bgs');
    }

    // 3. Gráfico de Armazém
    const armazemLabels = [{% for item in capacidade_armazem %}'AZ {{ item.az }}',{% endfor %}];
    const armazemValues = [{% for item in capacidade_armazem %}{{ item.total_sc }},{% endfor %}];
    const armazemLotes = [{% for item in capacidade_armazem %}{{ item.total_lotes }},{% endfor %}];
    
    const ctx3 = document.getElementById('armazemChart');
    if (ctx3 && armazemLabels.length > 0) {
        new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: armazemLabels,
                datasets: [{
                    label: 'Volume (bgs)',
                    data: armazemValues,
                    backgroundColor: themeColors.slice(0, armazemLabels.length),
                    borderWidth: 1,
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 6,
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                const volume = context.raw.toLocaleString('pt-BR');
                                const lotes = armazemLotes[index] || 0;
                                return [
                                    `Volume: ${volume} bgs`,
                                    `Lotes: ${lotes}`,
                                    `Média: ${lotes > 0 ? Math.round(context.raw / lotes) : 0} bgs/lote`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('pt-BR') + ' bgs';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                }
            }
        });
        
        // Legenda para armazém
        const armazemLegend = document.getElementById('armazemLegend');
        if (armazemLegend) {
            let armazemHtml = '<div class="row g-2">';
            armazemLabels.forEach((label, index) => {
                armazemHtml += `
                    <div class="col-6 col-md-4">
                        <div class="border-start border-3 ps-2 py-1" style="border-color: ${themeColors[index]} !important;">
                            <div class="small fw-bold">${label}</div>
                            <div class="small text-muted">
                                ${armazemValues[index].toLocaleString('pt-BR')} bgs<br>
                                ${armazemLotes[index]} lotes
                            </div>
                        </div>
                    </div>
                `;
            });
            armazemHtml += '</div>';
            armazemLegend.innerHTML = armazemHtml;
        }
    }
});

// Ajustar gráficos quando a tela for redimensionada
window.addEventListener('resize', function() {
    if (typeof Chart !== 'undefined') {
        Chart.getChart('cultivarChart')?.resize();
        Chart.getChart('peneiraChart')?.resize();
        Chart.getChart('armazemChart')?.resize();
    }
});
</script>

<style>
/* Estilos otimizados */
.page-title {
    background: linear-gradient(135deg, #2f8f4e, #1f2d2a);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(47, 143, 78, 0.15);
}

.card {
    border: none;
    border-radius: 10px !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08) !important;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
    padding: 0.75rem 1rem;
}

.card-body {
    padding: 1rem;
}

/* Ajustes para mobile */
@media (max-width: 768px) {
    .page-title {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .page-title h1 {
        font-size: 1.5rem;
    }
    
    .card {
        margin-bottom: 1rem !important;
    }
    
    .card-header h6 {
        font-size: 0.9rem;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
}

/* Scrollbar customizada */
.table-responsive::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Legendas com scroll */
#cultivarLegend, #peneiraLegend, #armazemLegend {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
}

#cultivarLegend::-webkit-scrollbar,
#peneiraLegend::-webkit-scrollbar,
#armazemLegend::-webkit-scrollbar {
    width: 4px;
}

/* Badges compactos */
.badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    font-weight: 500;
}

/* Tabela compacta */
.table-sm th,
.table-sm td {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
}

.table thead th {
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

/* Hover das linhas da tabela */
.table-hover tbody tr:hover {
    background-color: rgba(47, 143, 78, 0.05);
}

/* Ícones dos cards KPI */
.fa-pallet, .fa-weight-hanging, .fa-box-open, .fa-exchange-alt {
    opacity: 0.7;
}

/* Responsividade das colunas KPI */
@media (max-width: 576px) {
    .col-md-6 .card-body .h4 {
        font-size: 1.25rem;
    }
    
    .col-md-6 .small {
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}
