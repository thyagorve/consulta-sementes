{% extends 'sapp/base.html' %}
{% load static %}

{% block content %}
<style>
    /* VARIÁVEIS DE CORES */
    :root {
        --cor-primaria: #4f46e5;
        --cor-hover: #eef2ff;
        --bg-editor: #333333; 
        --bg-canvas: #ffffff; 
    }

    .editor-wrapper {
        padding-top: 20px;
        height: calc(100vh - 60px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* BARRA DE TÍTULO */
    .editor-toolbar {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px 8px 0 0;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .editor-main {
        display: flex;
        flex: 1;
        border: 1px solid #ddd;
        border-top: none;
        overflow: hidden;
        background: white;
    }

    .sidebar-left {
        width: 260px;
        background: #f8f9fa;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        z-index: 5;
    }

    .tools-panel {
        padding: 15px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        border-bottom: 1px solid #e0e0e0;
        background: white;
    }

    .tool-btn {
        height: 50px;
        border: 1px solid #ccc;
        background: white;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #555;
        font-size: 12px;
        transition: all 0.2s;
    }
    
    .tool-btn i { font-size: 16px; margin-bottom: 2px; }
    .tool-btn:hover { background: var(--cor-hover); border-color: var(--cor-primaria); color: var(--cor-primaria); }
    .tool-btn.active { background: var(--cor-primaria); color: white; border-color: var(--cor-primaria); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    .layers-header {
        padding: 10px 15px;
        font-weight: bold;
        font-size: 12px;
        text-transform: uppercase;
        color: #666;
        background: #f1f1f1;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
    }

    .layers-list {
        flex: 1;
        overflow-y: auto;
        padding: 5px;
    }

    .layer-item {
        background: white;
        border: 1px solid #eee;
        padding: 8px 10px;
        margin-bottom: 4px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 13px;
        transition: 0.1s;
    }

    .layer-item:hover { background-color: #f8f9fa; border-color: #ccc; }
    .layer-item.selected { 
        background-color: var(--cor-hover); 
        border-left: 4px solid var(--cor-primaria);
        font-weight: 600;
    }

    .canvas-viewport {
        flex: 1;
        background-color: var(--bg-editor);
        overflow: auto;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 50px;
        background-image: radial-gradient(#555 1px, transparent 1px);
        background-size: 20px 20px;
    }

    #meuCanvas {
        background-color: var(--bg-canvas);
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
        cursor: default;
    }

    .sidebar-right {
        width: 300px;
        background: white;
        border-left: 1px solid #ddd;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .prop-group {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    label { font-size: 11px; font-weight: bold; color: #555; margin-bottom: 2px; display: block; }
</style>

<div class="container-fluid editor-wrapper">
    <!-- BARRA DE TOPO INTEGRADA -->
    <div class="editor-toolbar">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h5 class="mb-0 fw-bold text-dark">
                    <i class="fas fa-drafting-compass text-primary me-2"></i>{{ armazem.nome }}
                    <!-- BOTÃO ENGRENAGEM (EDITAR ATUAL) -->
                    <button class="btn btn-link btn-sm p-0 ms-1" data-bs-toggle="modal" data-bs-target="#modalEditarConfigAZ" title="Configurar tamanho/nome deste armazém">
                        <i class="fas fa-cog text-secondary"></i>
                    </button>
                </h5>
                <small class="text-muted" id="statusMsg">Pronto para editar</small>
            </div>

            <!-- SELETOR DE AZ + BOTÃO NOVO -->
            <div class="input-group input-group-sm" style="width: auto;">
                <label class="input-group-text bg-light">AZ</label>
                <select class="form-select" style="width: 140px;" onchange="location.href='/editor-mapa/'+this.value+'/'">
                    {% for az in armazens_disponiveis %}
                        <option value="{{ az.numero }}" {% if az.numero == armazem.numero %}selected{% endif %}>
                            {{ az.numero }} - {{ az.nome }}
                        </option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoAZ" title="Criar Novo Armazém">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <a href="/mapa-armazem/{{ armazem.numero }}/" class="btn btn-outline-secondary btn-sm" target="_blank">
                <i class="fas fa-eye me-1"></i> Ver Mapa
            </a>
            <button id="btnSalvar" class="btn btn-success btn-sm px-4 fw-bold shadow-sm">
                <i class="fas fa-save me-1"></i> SALVAR TUDO
            </button>
        </div>
    </div>

    <!-- ÁREA DE TRABALHO -->
    <div class="editor-main">
        <div class="sidebar-left">
            <div class="tools-panel">
                <div class="tool-btn active" onclick="setFerramenta('selecionar')" title="Mover e Selecionar (V)">
                    <i class="fas fa-mouse-pointer"></i> <span>Mover</span>
                </div>
                <div class="tool-btn" onclick="setFerramenta('retangulo')" title="Criar Endereço/Lote (R)">
                    <i class="fas fa-vector-square"></i> <span>Endereço</span>
                </div>
                <div class="tool-btn" onclick="setFerramenta('texto')" title="Criar Texto (T)">
                    <i class="fas fa-font"></i> <span>Texto</span>
                </div>
                <div class="tool-btn text-danger" onclick="excluirSelecionado()" title="Excluir Item (Del)">
                    <i class="fas fa-trash"></i> <span>Excluir</span>
                </div>
            </div>

            <div class="layers-header">
                <span>Itens Criados</span>
                <span class="badge bg-secondary" id="countItens">0</span>
            </div>

            <div class="layers-list" id="listaCamadas"></div>
        </div>

        <div class="canvas-viewport" id="viewport">
            <canvas id="meuCanvas" width="{{ armazem.largura_canvas }}" height="{{ armazem.altura_canvas }}"></canvas>
            
            <div style="position: absolute; bottom: 20px; right: 340px; background: white; padding: 5px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center;">
                <button class="btn btn-sm btn-light rounded-circle" onclick="alterarZoom(-0.1)"><i class="fas fa-minus"></i></button>
                <span class="small fw-bold px-2" id="zoomLabel">100%</span>
                <button class="btn btn-sm btn-light rounded-circle" onclick="alterarZoom(0.1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="sidebar-right">
            <h6 class="fw-bold mb-3 border-bottom pb-2">Propriedades</h6>
            <div id="painelNenhum" class="text-center text-muted py-5">
                <i class="fas fa-arrow-left mb-3"></i>
                <p class="small">Selecione um item para editar.</p>
            </div>

            <div id="painelPropriedades" style="display: none;">
                <div class="prop-group border-start border-4 border-primary shadow-sm bg-white">
                    <label class="text-primary fw-bold text-uppercase">VÍNCULO (ENDEREÇO)</label>
                    <input type="text" id="propId" class="form-control fw-bold border-primary" placeholder="Ex: A-01" autocomplete="off">
                </div>

                <div class="prop-group">
                    <label>Dimensões</label>
                    <div class="row g-2">
                        <div class="col-6"><label>Largura</label><input type="number" id="propW" class="form-control form-control-sm"></div>
                        <div class="col-6"><label>Altura</label><input type="number" id="propH" class="form-control form-control-sm"></div>
                        <div class="col-6"><label>X</label><input type="number" id="propX" class="form-control form-control-sm"></div>
                        <div class="col-6"><label>Y</label><input type="number" id="propY" class="form-control form-control-sm"></div>
                    </div>
                    <div class="mt-2">
                        <label>Rotação: <span id="rotVal">0</span>°</label>
                        <input type="range" id="propRot" class="form-range" min="0" max="360" step="90">
                    </div>
                </div>

                <div id="divTextoExtras" class="prop-group" style="display: none;">
                    <label>Conteúdo do Texto</label>
                    <input type="text" id="propTexto" class="form-control mb-2">
                    <label>Tamanho da Fonte</label>
                    <input type="number" id="propFontSize" class="form-control form-control-sm" value="14">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL 1: CRIAR NOVO AZ -->
<div class="modal fade" id="modalNovoAZ" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Novo Mapa (AZ)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'sapp:criar_armazem' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4"><label class="fw-bold">Nº (AZ)</label><input type="number" name="numero" class="form-control" required></div>
                        <div class="col-md-8"><label class="fw-bold">Nome</label><input type="text" name="nome" class="form-control" required></div>
                        <div class="col-md-6"><label>Largura (px)</label><input type="number" name="largura_canvas" class="form-control" value="1200" required></div>
                        <div class="col-md-6"><label>Altura (px)</label><input type="number" name="altura_canvas" class="form-control" value="800" required></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Armazém</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL 2: EDITAR CONFIGURAÇÃO DO ATUAL -->
<div class="modal fade" id="modalEditarConfigAZ" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Configurar Mapa Atual</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'sapp:editar_config_armazem' armazem.id %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4"><label class="fw-bold">Nº (AZ)</label><input type="number" name="numero" class="form-control" value="{{ armazem.numero }}" required></div>
                        <div class="col-md-8"><label class="fw-bold">Nome</label><input type="text" name="nome" class="form-control" value="{{ armazem.nome }}" required></div>
                        <div class="col-md-6"><label>Largura (px)</label><input type="number" name="largura_canvas" class="form-control" value="{{ armazem.largura_canvas }}" required></div>
                        <div class="col-md-6"><label>Altura (px)</label><input type="number" name="altura_canvas" class="form-control" value="{{ armazem.altura_canvas }}" required></div>
                    </div>
                    <p class="small text-muted mt-3 mb-0">Nota: Alterar o tamanho expande o papel para a direita e para baixo.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Configurações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ================= SCRIPT DO EDITOR =================
const CONFIG = {
    csrf: "{{ csrf_token }}",
    urlSalvar: "{% url 'sapp:salvar_todos_elementos' %}",
    armazemId: {{ armazem.id }},
    snap: 10
};

let elementos = [
    {% for el in elementos %}
    {
        id: {{ el.id|default:"null" }},
        tipo: "{{ el.tipo }}",
        x: {{ el.pos_x }},
        y: {{ el.pos_y }},
        w: {{ el.largura }},
        h: {{ el.altura }},
        rot: {{ el.rotacao|default:0 }},
        id_texto: "{{ el.identificador|escapejs }}",
        texto: "{{ el.conteudo_texto|default:''|escapejs }}",
        fontSize: {{ el.fonte_tamanho|default:14 }},
        z: {{ el.ordem_z|default:0 }}
    },
    {% endfor %}
];

const app = {
    canvas: document.getElementById('meuCanvas'),
    ctx: document.getElementById('meuCanvas').getContext('2d'),
    tool: 'selecionar',
    zoom: 1.0,
    selectedIdx: -1,
    isDragging: false,
    startMouse: {x:0, y:0},
    dragOffset: {x:0, y:0}
};

function draw() {
    app.ctx.clearRect(0, 0, app.canvas.width, app.canvas.height);
    app.ctx.strokeStyle = '#f0f0f0';
    app.ctx.lineWidth = 0.5;
    for (let x=0; x<=app.canvas.width; x+=50) { app.ctx.beginPath(); app.ctx.moveTo(x,0); app.ctx.lineTo(x, app.canvas.height); app.ctx.stroke(); }
    for (let y=0; y<=app.canvas.height; y+=50) { app.ctx.beginPath(); app.ctx.moveTo(0,y); app.ctx.lineTo(app.canvas.width, y); app.ctx.stroke(); }

    elementos.forEach((el, idx) => {
        app.ctx.save();
        if (el.rot) {
            const cx = el.x + el.w/2;
            const cy = el.y + el.h/2;
            app.ctx.translate(cx, cy);
            app.ctx.rotate(el.rot * Math.PI / 180);
            app.ctx.translate(-cx, -cy);
        }
        const isSel = (idx === app.selectedIdx);
        if (el.tipo === 'RETANGULO') {
            app.ctx.fillStyle = isSel ? '#e0e7ff' : '#f3f4f6';
            app.ctx.fillRect(el.x, el.y, el.w, el.h);
            app.ctx.strokeStyle = isSel ? '#4f46e5' : '#6b7280';
            app.ctx.lineWidth = isSel ? 2 : 1;
            app.ctx.strokeRect(el.x, el.y, el.w, el.h);
            if (el.id_texto) {
                app.ctx.fillStyle = '#111827';
                app.ctx.font = 'bold 11px Arial';
                app.ctx.textAlign = 'center';
                app.ctx.textBaseline = 'middle';
                app.ctx.fillText(el.id_texto, el.x + el.w/2, el.y + el.h/2);
            }
        } else if (el.tipo === 'TEXTO') {
            app.ctx.font = `${el.fontSize}px Arial`;
            app.ctx.fillStyle = isSel ? '#4f46e5' : '#000';
            app.ctx.fillText(el.texto || 'Texto', el.x, el.y + el.fontSize);
        }
        app.ctx.restore();
    });
}

function updateLayerList() {
    const list = document.getElementById('listaCamadas');
    list.innerHTML = '';
    document.getElementById('countItens').innerText = elementos.length;
    elementos.slice().reverse().forEach((el, revIndex) => {
        const realIndex = elementos.length - 1 - revIndex;
        const item = document.createElement('div');
        item.className = `layer-item ${realIndex === app.selectedIdx ? 'selected' : ''}`;
        item.innerHTML = `<span>${el.id_texto || el.texto || el.tipo}</span>`;
        item.onclick = () => { app.selectedIdx = realIndex; updateUI(); draw(); updateLayerList(); };
        list.appendChild(item);
    });
}

function setFerramenta(nome) {
    app.tool = nome;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.tool-btn[onclick="setFerramenta('${nome}')"]`).classList.add('active');
}

function getMousePos(e) {
    const rect = app.canvas.getBoundingClientRect();
    return { x: (e.clientX - rect.left) / app.zoom, y: (e.clientY - rect.top) / app.zoom };
}

app.canvas.addEventListener('mousedown', (e) => {
    const pos = getMousePos(e);
    if (app.tool === 'selecionar') {
        let clicked = -1;
        for (let i = elementos.length - 1; i >= 0; i--) {
            const el = elementos[i];
            if (pos.x >= el.x && pos.x <= el.x + el.w && pos.y >= el.y && pos.y <= el.y + el.h) { clicked = i; break; }
        }
        app.selectedIdx = clicked;
        if (clicked !== -1) { app.isDragging = true; app.dragOffset = { x: pos.x - elementos[clicked].x, y: pos.y - elementos[clicked].y }; }
    } else if (app.tool === 'retangulo') {
        app.isDragging = true; app.startMouse = pos;
        elementos.push({ tipo: 'RETANGULO', x: Math.round(pos.x/10)*10, y: Math.round(pos.y/10)*10, w: 0, h: 0, rot: 0, id_texto: '', z: elementos.length });
        app.selectedIdx = elementos.length - 1;
    } else if (app.tool === 'texto') {
        elementos.push({ tipo: 'TEXTO', x: pos.x, y: pos.y, w: 50, h: 20, texto: 'Novo Texto', fontSize: 14, rot: 0, z: elementos.length });
        app.selectedIdx = elementos.length - 1;
        setFerramenta('selecionar');
    }
    updateUI(); updateLayerList(); draw();
});

window.addEventListener('mousemove', (e) => {
    if (!app.isDragging || app.selectedIdx === -1) return;
    const pos = getMousePos(e);
    const el = elementos[app.selectedIdx];
    if (app.tool === 'selecionar') { el.x = Math.round((pos.x - app.dragOffset.x)/10)*10; el.y = Math.round((pos.y - app.dragOffset.y)/10)*10; }
    else if (app.tool === 'retangulo') { el.w = Math.round((pos.x - app.startMouse.x)/10)*10; el.h = Math.round((pos.y - app.startMouse.y)/10)*10; }
    draw(); updateUI();
});

window.addEventListener('mouseup', () => {
    if (app.isDragging) {
        app.isDragging = false;
        const el = elementos[app.selectedIdx];
        if (el && el.w < 0) { el.x += el.w; el.w = Math.abs(el.w); }
        if (el && el.h < 0) { el.y += el.h; el.h = Math.abs(el.h); }
        draw(); updateLayerList();
    }
});

function updateUI() {
    const hasSel = app.selectedIdx !== -1;
    document.getElementById('painelPropriedades').style.display = hasSel ? 'block' : 'none';
    document.getElementById('painelNenhum').style.display = hasSel ? 'none' : 'block';
    if (hasSel) {
        const el = elementos[app.selectedIdx];
        document.getElementById('propId').value = el.id_texto || '';
        document.getElementById('propW').value = Math.round(el.w);
        document.getElementById('propH').value = Math.round(el.h);
        document.getElementById('propX').value = Math.round(el.x);
        document.getElementById('propY').value = Math.round(el.y);
        document.getElementById('propRot').value = el.rot;
        document.getElementById('rotVal').innerText = el.rot;
        document.getElementById('divTextoExtras').style.display = el.tipo === 'TEXTO' ? 'block' : 'none';
        if (el.tipo === 'TEXTO') { document.getElementById('propTexto').value = el.texto; document.getElementById('propFontSize').value = el.fontSize; }
    }
}

const inputs = {
    'propId': (v) => { elementos[app.selectedIdx].id_texto = v; updateLayerList(); },
    'propW': (v) => elementos[app.selectedIdx].w = parseInt(v),
    'propH': (v) => elementos[app.selectedIdx].h = parseInt(v),
    'propX': (v) => elementos[app.selectedIdx].x = parseInt(v),
    'propY': (v) => elementos[app.selectedIdx].y = parseInt(v),
    'propRot': (v) => { elementos[app.selectedIdx].rot = parseInt(v); document.getElementById('rotVal').innerText = v; },
    'propTexto': (v) => { elementos[app.selectedIdx].texto = v; updateLayerList(); },
    'propFontSize': (v) => elementos[app.selectedIdx].fontSize = parseInt(v),
};
Object.entries(inputs).forEach(([id, fn]) => { document.getElementById(id).addEventListener('input', (e) => { if(app.selectedIdx!==-1){ fn(e.target.value); draw(); } }); });

function excluirSelecionado() { if (app.selectedIdx !== -1 && confirm('Excluir?')) { elementos.splice(app.selectedIdx, 1); app.selectedIdx = -1; draw(); updateUI(); updateLayerList(); } }

function alterarZoom(delta) {
    app.zoom = Math.max(0.5, Math.min(3, app.zoom + delta));
    document.getElementById('zoomLabel').innerText = Math.round(app.zoom * 100) + "%";
    app.canvas.style.transform = `scale(${app.zoom})`;
    app.canvas.style.transformOrigin = "top left";
}

document.getElementById('btnSalvar').onclick = async function() {
    this.disabled = true;
    try {
        const payload = {
            armazem_id: CONFIG.armazemId,
            elementos: elementos.map((el, i) => ({
                id: el.id, tipo: el.tipo, pos_x: Math.round(el.x), pos_y: Math.round(el.y),
                largura: Math.round(el.w), altura: Math.round(el.h), rotacao: el.rot,
                cor_preenchimento: '#CCCCCC', identificador: el.id_texto,
                conteudo_texto: el.texto, fonte_tamanho: el.fontSize, ordem_z: i
            }))
        };
        const res = await fetch(CONFIG.urlSalvar, { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': CONFIG.csrf}, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data.success) { alert('Salvo!'); location.reload(); }
    } catch (e) { alert('Erro ao salvar'); } finally { this.disabled = false; }
};

updateLayerList(); draw();
</script>
{% endblock %}