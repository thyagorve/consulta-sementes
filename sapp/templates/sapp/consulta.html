{% extends "sapp/base.html" %}

{% block title %}Consulta de Produto{% endblock %}

{% block content %}
<style>
/* --------------------------- */
/* VARI√ÅVEIS DE ESTILO GERAIS */
/* --------------------------- */
:root {
    --primary-color: #0d6efd;
    --primary-hover: #0b5ed7;
    --secondary-color: #6c757d;
    --light-bg: #f8f9fa;
    --border-color: #dee2e6;
    --card-shadow: 0 4px 8px rgba(0,0,0,0.05);
    --border-radius: 8px;
    --danger-bg: #f8d7da;
    --danger-text: #721c24;
    --warning-bg: #fff3cd;
    --warning-text: #856404;
    --success-bg: #d4edda;
    --success-text: #155724;
}

/* --------------------------- */
/* CONTAINER PRINCIPAL */
/* --------------------------- */
.container {
    max-width: 850px;
    margin: auto;
    padding: 20px;
    font-family: Arial, sans-serif;
}

/* --------------------------- */
/* FORMUL√ÅRIO DE BUSCA */
/* --------------------------- */
.search-wrapper {
    background-color: #fff;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
}

.search-box {
    display: flex;
    gap: 10px;
}

.search-box input[type="text"] {
    flex-grow: 1;
    padding: 12px 15px;
    font-size: 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    transition: border-color 0.2s, box-shadow 0.2s;
}

.search-box input[type="text"]:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
}

.search-box button {
    flex-shrink: 0;
    width: 50px;
    font-size: 1.5rem;
    border: none;
    background-color: var(--primary-color);
    color: white;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-box button:hover {
    background-color: var(--primary-hover);
}

.search-options {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 15px;
    justify-content: center;
    color: var(--secondary-color);
    font-size: 0.9rem;
}

.search-options label {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

/* --------------------------- */
/* QR CODE SCANNER */
/* --------------------------- */
#qr-reader {
    width: 100%;
    border: 2px dashed var(--border-color);
    margin-bottom: 1.5rem;
    border-radius: var(--border-radius);
    overflow: hidden;
    background-color: #fff;
    padding: 10px;
}

/* --------------------------- */
/* RESULTADOS */
/* --------------------------- */
.results-section {
    margin-bottom: 20px;
}
.results-section h3 {
    color: var(--secondary-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    font-size: 1.2rem;
    margin-bottom: 15px;
}

.item-card {
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: 10px;
    box-shadow: var(--card-shadow);
    transition: box-shadow 0.2s;
    overflow: hidden;
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    background-color: var(--light-bg);
}

.item-header:hover {
    background-color: #e9ecef;
}

.item-header span {
    font-weight: bold;
    color: #333;
    font-size: 1rem;
}

.item-details {
    padding: 15px;
    border-top: 1px solid var(--border-color);
    display: none;
    background-color: #fff;
}

.item-details p {
    margin: 8px 0;
    display: flex;
    justify-content: space-between;
    border-bottom: 1px dotted #eee;
    padding-bottom: 6px;
    font-size: 0.95rem;
}
.item-details p:last-child {
    border-bottom: none;
}

.item-details strong {
    color: var(--secondary-color);
}

.toggle-btn {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color);
    border: none;
    background: none;
    width: 30px;
    height: 30px;
    line-height: 30px;
    text-align: center;
    transition: transform 0.2s;
}

/* Acorde√£o Aberto */
.item-card.open .toggle-btn {
    transform: rotate(45deg);
}
.item-card.open .item-details {
    display: block;
}

/* --------------------------- */
/* MENSAGENS */
/* --------------------------- */
.messages {
    padding: 15px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    font-weight: bold;
}
.messages.warning { background-color: var(--warning-bg); color: var(--warning-text); }
.messages.error { background-color: var(--danger-bg); color: var(--danger-text); }
.messages.success { background-color: var(--success-bg); color: var(--success-text); }

/* --------------------------- */
/* RESPONSIVIDADE */
/* --------------------------- */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }

    .search-box input[type="text"] {
        font-size: 0.95rem;
    }

    .search-options {
        gap: 10px;
        font-size: 0.85rem;
    }

    .item-header span {
        font-size: 0.9rem;
    }
}

</style>

<div class="container">
    <h2>Consultar Produto/Lotes</h2>
    
    <!-- FORMUL√ÅRIO DE BUSCA -->
    <div class="search-wrapper">
        <form method="POST" id="search-form"> 
            {% csrf_token %}
            <div class="search-box">
                <input type="text" name="termo_busca" value="{{ termo_buscado }}" placeholder="Digite C√≥digo ou Lote..." required autofocus>
                <button type="button" id="start-scan-btn">üì∑</button>
                <button type="submit" style="display:none;"></button>
            </div>

            <div class="search-options">
                <label>
                    <input type="radio" name="search_type" value="all" {% if search_type == 'all' or not search_type %}checked{% endif %}>
                    Buscar em Tudo
                </label>
                <label>
                    <input type="radio" name="search_type" value="cadastro" {% if search_type == 'cadastro' %}checked{% endif %}>
                    Apenas produto
                </label>
                <label>
                    <input type="radio" name="search_type" value="lote" {% if search_type == 'lote' %}checked{% endif %}>
                    Apenas lotes
                </label>
            </div>
        </form>
    </div>
    
    <!-- SCANNER QR CODE -->
    <div id="qr-reader" style="display: none;"></div>



{% if resultados %}
<div class="results-section">
    <h3>Resultados Encontrados ({{ resultados|length }})</h3>
    {% for item in resultados %}
        <div class="item-card">
            <div class="item-header">
                {% if item.produto %}
                    <span>Produto: {{ item.produto.codigo }} - {{ item.produto.descricao|default:"(Sem descri√ß√£o)" }}</span>
                {% else %}
                    <span>Lote: {{ item.lotes.0.obj.lote }} - Endere√ßo: {{ item.lotes.0.obj.endereco|default:"(Sem endere√ßo)" }}</span>
                {% endif %}
                <button type="button" class="toggle-btn">+</button>
            </div>
            <div class="item-details">
                {% if item.produto %}
                    <h4 style="margin-top:0;color:#0d6efd;">Detalhes do Produto</h4>
                    {% for detalhe in item.detalhes_produto %}
                        <p><strong>{{ detalhe.label }}:</strong> <span>{{ detalhe.valor }}</span></p>
                    {% endfor %}
                {% endif %}

                {% if item.lotes %}
                    <h4 style="margin:15px 0 10px;color:#198754;">Lotes Relacionados</h4>
                    {% for lote in item.lotes %}
                        <div style="border:2px solid {% if lote.destaque %}#0d6efd{% else %}#eee{% endif %};padding:10px;border-radius:6px;margin-bottom:10px;background-color:{% if lote.destaque %}#e9f3ff{% else %}#fff{% endif %};">
                            <strong>Lote: {{ lote.obj.lote }} - Endere√ßo: {{ lote.obj.endereco|default:"(N√£o informado)" }}</strong>
                            <div style="margin-top:8px;">
                                {% for d in lote.detalhes %}
                                    <p><strong>{{ d.label }}:</strong> <span>{{ d.valor }}</span></p>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    {% endfor %}
</div>
{% elif termo_buscado %}
<div class="messages warning">Nenhum resultado encontrado para "{{ termo_buscado }}"</div>
{% endif %}


</div>



<!-- dentro do body, antes do script -->
<div id="qr-reader" style="display: none;">
    <button id="qr-close-btn" aria-label="Fechar scanner">&times;</button>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Acorde√£o (+/-)
    document.querySelectorAll('.item-header').forEach(header => {
        header.addEventListener('click', () => {
            const card = header.closest('.item-card');
            card.classList.toggle('open');
            const btn = header.querySelector('.toggle-btn');
            btn.textContent = card.classList.contains('open') ? '‚àí' : '+';
        });
    });

    // Elementos principais
    const startScanBtn = document.getElementById('start-scan-btn');
    const qrReaderDiv = document.getElementById('qr-reader');
    const searchInput = document.querySelector('input[name="termo_busca"]');
    const searchForm = document.getElementById('search-form');
    const qrCloseBtn = document.getElementById('qr-close-btn');
    let html5QrCode = null;
    let ultimoCodigo = null;
    let ultimoTimestamp = 0;

    // Fun√ß√£o para tocar beep (sem precisar de arquivo)
    function playBeep() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioContext();
            const oscillator = ctx.createOscillator();
            const gain = ctx.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1000, ctx.currentTime); // 1kHz
            gain.gain.setValueAtTime(0, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.005);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);

            oscillator.connect(gain).connect(ctx.destination);
            oscillator.start();
            oscillator.stop(ctx.currentTime + 0.16);
        } catch (e) {
            console.warn("Falha ao gerar beep via Web Audio API:", e);
        }
    }

    const startScanning = () => {
        qrReaderDiv.style.display = 'block';
        startScanBtn.textContent = '‚úñÔ∏è';

        html5QrCode = new Html5Qrcode("qr-reader");

        const qrCodeSuccessCallback = (decodedText) => {
            const agora = Date.now();
            // evita leituras duplicadas em menos de 1s
            if (decodedText === ultimoCodigo && (agora - ultimoTimestamp) < 1000) {
                return;
            }
            ultimoCodigo = decodedText;
            ultimoTimestamp = agora;

            playBeep(); // feedback sonoro
            searchInput.value = decodedText;

            // pequena espera pra deixar o beep tocar minimamente antes de submeter
            setTimeout(() => {
                stopScanning();
                searchForm.submit();
            }, 150);
        };

        const config = { fps: 10, qrbox: { width: 300, height: 300 } };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            qrCodeSuccessCallback
        ).catch(err => {
            console.warn("C√¢mera traseira falhou, tentando outra.", err);
            html5QrCode.start({}, config, qrCodeSuccessCallback)
                .catch(() => {
                    alert("N√£o foi poss√≠vel iniciar a c√¢mera. Verifique as permiss√µes do seu navegador.");
                    stopScanning();
                });
        });
    };

    const stopScanning = () => {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error("Falha ao parar o scanner.", err));
        }
        qrReaderDiv.style.display = 'none';
        startScanBtn.textContent = 'üì∑';
    };

    startScanBtn.addEventListener('click', () => {
        if (qrReaderDiv.style.display === 'none') {
            startScanning();
        } else {
            stopScanning();
        }
    });

    // fechar via bot√£o dentro do scanner
    qrCloseBtn.addEventListener('click', () => {
        stopScanning();
    });
});
</script>

{% endblock %}
