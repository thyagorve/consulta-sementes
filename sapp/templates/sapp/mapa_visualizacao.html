{% extends 'sapp/base.html' %}
{% load static %}

{% block content %}
<!-- CONTAINER PRINCIPAL -->
<div class="d-flex flex-column h-100 p-3" style="height: calc(100vh - 60px) !important; overflow: hidden;">
    
    <!-- BARRA DE CONTROLE -->
    <div class="card shadow-sm mb-3 flex-shrink-0">
        <div class="card-body p-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
            
            <!-- TITULO E SELETOR -->
            <div class="d-flex align-items-center gap-3">
                <div>
                    <h5 class="mb-0 fw-bold"><i class="fas fa-warehouse text-primary me-2"></i>{{ armazem.nome }}</h5>
                    <div class="text-muted small">
                        <span id="statsTotal">0</span> posições | 
                        <span id="statsOcupados" class="text-success fw-bold">0</span> ocupadas
                    </div>
                </div>

                <div class="input-group input-group-sm" style="width: 220px;">
                    <label class="input-group-text bg-light" for="selectAZ"><i class="fas fa-exchange-alt"></i></label>
                    <select class="form-select fw-bold border-primary" id="selectAZ" onchange="location.href='/mapa-armazem/'+this.value+'/'">
                        {% for az in armazens_disponiveis %}
                            <option value="{{ az.numero }}" {% if az.numero == armazem.numero %}selected{% endif %}>
                                {{ az.nome }} (AZ {{ az.numero }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="d-flex gap-3 align-items-center flex-wrap">
                <!-- LEGENDA -->
                <div class="d-none d-md-flex align-items-center small border-end pe-3 me-2">
                    <div class="d-flex align-items-center me-3">
                        <span style="width: 12px; height: 12px; background: #10b981; border: 1px solid #047857; border-radius: 2px; margin-right: 5px;"></span>
                        <span>Ocupado</span>
                    </div>
                    <div class="d-flex align-items-center me-3">
                        <span style="width: 12px; height: 12px; background: #f3f4f6; border: 1px solid #9ca3af; border-radius: 2px; margin-right: 5px;"></span>
                        <span>Vazio</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle text-danger me-1"></i>
                        <span>Multi-Lote</span>
                    </div>
                </div>

                <!-- BOTÕES DE VISUALIZAÇÃO -->
                <div class="btn-group btn-group-sm">
                    <button id="btnToggleEndereco" class="btn btn-outline-secondary">
                        <i class="fas fa-map-marker-alt me-1"></i> Ver Endereço
                    </button>
                    <button id="btnToggleLote" class="btn btn-outline-primary">
                        <i class="fas fa-tag me-1"></i> Ver Lote
                    </button>
                </div>
                
                <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm" title="Atualizar">
                    <i class="fas fa-sync-alt"></i>
                </button>
                
                <!-- EDITOR -->
                {% if is_admin %}
                <a href="/editor-mapa/{{ armazem.numero }}/" class="btn btn-warning btn-sm fw-bold shadow-sm">
                    <i class="fas fa-pen-ruler me-1"></i> Editor
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ÁREA DO MAPA -->
    <div class="card shadow-sm border-0 bg-light flex-fill overflow-hidden position-relative">
        <div class="card-body p-2 d-flex justify-content-center align-items-center h-100 w-100 bg-secondary bg-opacity-10">
            <canvas id="mapaCanvas"></canvas>
            <!-- Tooltip -->
            <div id="tooltipMapa" class="tooltip-mapa"></div>
        </div>
    </div>
</div>

<!-- MODAL PARA SELEÇÃO DE MÚLTIPLOS LOTES -->
<div class="modal fade" id="modalMultiplosLotes" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-layer-group me-2"></i>Selecionar Lote</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="p-3 bg-light border-bottom">
                    <small class="text-muted fw-bold">ENDEREÇO:</small>
                    <h4 class="mb-0 fw-bold text-dark" id="modalEnderecoTitulo">A-00-00</h4>
                </div>
                <div class="list-group list-group-flush" id="listaLotesModal">
                    <!-- Preenchido via JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #mapaCanvas {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        display: block;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        background-color: white;
        cursor: pointer;
    }

    .tooltip-mapa {
        position: fixed;
        display: none;
        background: white;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        padding: 0;
        width: 260px;
        z-index: 9999;
        pointer-events: none;
        font-family: system-ui, -apple-system, sans-serif;
        text-align: left;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const LAYOUT_ELEMENTS = {{ elementos_json|safe }};
    const STOCK_DATA = {{ dados_ocupacao_json|safe }};
    
    const canvas = document.getElementById('mapaCanvas');
    const ctx = canvas.getContext('2d');
    const tooltip = document.getElementById('tooltipMapa');
    const modalEl = document.getElementById('modalMultiplosLotes');
    const bsModal = new bootstrap.Modal(modalEl);
    
    canvas.width = {{ armazem.largura_canvas|default:1000 }};
    canvas.height = {{ armazem.altura_canvas|default:600 }};

    let estado = { mostrarEndereco: false, mostrarLote: false };

    // --- DESENHO DO MAPA ---
    function desenharMapa() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        let totalPosicoes = 0;
        let totalOcupados = 0;

        LAYOUT_ELEMENTS.forEach(el => {
            ctx.save();
            if (el.rot) {
                const cx = el.x + el.w/2;
                const cy = el.y + el.h/2;
                ctx.translate(cx, cy);
                ctx.rotate(el.rot * Math.PI / 180);
                ctx.translate(-cx, -cy);
            }

            if (el.tipo === 'RETANGULO') {
                totalPosicoes++;
                const chave = el.id ? el.id.trim().toUpperCase() : '';
                const dadosItem = STOCK_DATA[chave];
                const estaOcupado = dadosItem && dadosItem.length > 0;
                const temMultiplos = dadosItem && dadosItem.length > 1;

                if (estaOcupado) totalOcupados++;

                // Cor
                let fillStyle = el.cor || '#e5e7eb';
                if (estaOcupado && el.cor_ocupado) fillStyle = el.cor_ocupado;
                else if (estaOcupado) fillStyle = '#10b981'; 

                ctx.fillStyle = fillStyle;
                ctx.fillRect(el.x, el.y, el.w, el.h);

                // Borda
                if (temMultiplos) {
                    ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3;
                } else {
                    ctx.strokeStyle = el.stroke || '#999'; ctx.lineWidth = 1;
                }
                ctx.strokeRect(el.x, el.y, el.w, el.h);

                // Texto
                let textoParaExibir = "";
                if (estado.mostrarLote && estaOcupado) {
                    if (temMultiplos) textoParaExibir = "VÁRIOS";
                    else textoParaExibir = dadosItem[0].lote.substring(0, 10);
                } else if (estado.mostrarEndereco && el.id) {
                    textoParaExibir = el.id;
                }

                if (textoParaExibir) {
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    let corTexto = (fillStyle === '#10b981' || estaOcupado) ? '#ffffff' : '#374151';
                    ctx.fillStyle = corTexto;
                    let fontSize = Math.min(el.h / 2.5, 14);
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.fillText(textoParaExibir, el.x + el.w/2, el.y + el.h/2);
                }

                // Alerta Multiplos
                if (temMultiplos) {
                    const padding = 6;
                    ctx.beginPath();
                    ctx.arc(el.x + el.w - padding, el.y + padding, 4, 0, 2*Math.PI);
                    ctx.fillStyle = '#dc2626'; ctx.fill();
                    ctx.fillStyle = 'white'; ctx.font = 'bold 7px Arial';
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText('!', el.x + el.w - padding, el.y + padding);
                }

            } else if (el.tipo === 'TEXTO') {
                ctx.font = '14px Arial';
                ctx.fillStyle = '#000000';
                ctx.textAlign = 'left';
                ctx.fillText(el.texto || '', el.x, el.y + 14);
            }
            ctx.restore();
        });

        document.getElementById('statsTotal').innerText = totalPosicoes;
        document.getElementById('statsOcupados').innerText = totalOcupados;
    }

    // --- CONTROLES BOTÕES ---
    const btnEnd = document.getElementById('btnToggleEndereco');
    const btnLote = document.getElementById('btnToggleLote');

    btnEnd.addEventListener('click', () => {
        estado.mostrarEndereco = !estado.mostrarEndereco;
        estado.mostrarLote = false; 
        atualizarBotoes(); desenharMapa();
    });

    btnLote.addEventListener('click', () => {
        estado.mostrarLote = !estado.mostrarLote;
        estado.mostrarEndereco = false; 
        atualizarBotoes(); desenharMapa();
    });

    function atualizarBotoes() {
        if(estado.mostrarEndereco) btnEnd.classList.replace('btn-outline-secondary', 'btn-secondary');
        else btnEnd.classList.replace('btn-secondary', 'btn-outline-secondary');

        if(estado.mostrarLote) btnLote.classList.replace('btn-outline-primary', 'btn-primary');
        else btnLote.classList.replace('btn-primary', 'btn-outline-primary');
    }

    // --- INTERAÇÃO (DUPLO CLIQUE + TOOLTIP) ---
    
    // 1. Tooltip Hover
    canvas.addEventListener('mousemove', function(e) {
        // Se o modal estiver aberto, não mostra tooltip
        if(modalEl.classList.contains('show')) return;

        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        
        let achou = false;

        for (let i = LAYOUT_ELEMENTS.length - 1; i >= 0; i--) {
            const el = LAYOUT_ELEMENTS[i];
            if (el.tipo === 'RETANGULO' && x >= el.x && x <= el.x + el.w && y >= el.y && y <= el.y + el.h) {
                const chave = el.id ? el.id.trim().toUpperCase() : '';
                const itens = STOCK_DATA[chave];

                let html = `<div style="background:#f8fafc; padding:8px 10px; border-bottom:1px solid #e2e8f0;">
                                <strong style="color:#1e293b; font-size:13px;">${el.id || 'N/A'}</strong>
                                <span style="float:right; font-size:10px; color:#64748b; margin-top:2px;">Clique 2x</span>
                            </div>
                            <div style="padding:10px;">`;
                
                if (itens && itens.length > 0) {
                    if (itens.length > 1) {
                        html += `<div class="alert alert-danger p-1 mb-2 text-center" style="font-size:10px; font-weight:bold;">
                                    <i class="fas fa-exclamation-triangle"></i> MÚLTIPLOS LOTES
                                 </div>`;
                    }
                    itens.forEach(item => {
                        html += `
                            <div style="margin-bottom:6px; border-bottom:1px dashed #e2e8f0; padding-bottom:4px;">
                                <span class="badge bg-primary" style="font-size:11px;">${item.lote}</span>
                                <div style="font-size:11px; color:#475569; margin-top:2px;">
                                    <strong>${item.qtd}</strong> ${item.embalagem}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += `<div style="color:#94a3b8; font-style:italic; text-align:center; font-size:12px;">Posição Vazia</div>`;
                }
                html += `</div>`;

                tooltip.innerHTML = html;
                tooltip.style.display = 'block';
                
                // Posicionamento Tooltip
                const ttWidth = 260; 
                const ttHeight = tooltip.offsetHeight || 150; 
                let leftPos = e.clientX + 15;
                let topPos = e.clientY + 15;
                if (leftPos + ttWidth > window.innerWidth) leftPos = e.clientX - ttWidth - 15;
                if (topPos + ttHeight > window.innerHeight) topPos = e.clientY - ttHeight - 15;
                tooltip.style.left = leftPos + 'px';
                tooltip.style.top = topPos + 'px';
                
                achou = true;
                canvas.style.cursor = 'pointer';
                break;
            }
        }
        if (!achou) {
            tooltip.style.display = 'none';
            canvas.style.cursor = 'default';
        }
    });

    // 2. Duplo Clique
    canvas.addEventListener('dblclick', function(e) {
        // Esconde tooltip imediatamente ao dar duplo clique
        tooltip.style.display = 'none';

        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;

        for (let i = LAYOUT_ELEMENTS.length - 1; i >= 0; i--) {
            const el = LAYOUT_ELEMENTS[i];
            
            if (el.tipo === 'RETANGULO' && x >= el.x && x <= el.x + el.w && y >= el.y && y <= el.y + el.h) {
                const chave = el.id ? el.id.trim().toUpperCase() : '';
                const itens = STOCK_DATA[chave];
                
                // === CORREÇÃO DA URL AQUI (lista_estoque) ===
                const baseUrl = "{% url 'sapp:lista_estoque' %}"; 

                if (!itens || itens.length === 0) {
                    window.location.href = `${baseUrl}?busca=${encodeURIComponent(chave)}`;
                } else if (itens.length === 1) {
                    window.location.href = `${baseUrl}?busca=${encodeURIComponent(itens[0].lote)}`;
                } else {
                    abrirModalMultiplos(chave, itens, baseUrl);
                }
                break;
            }
        }
    });

    function abrirModalMultiplos(endereco, itens, baseUrl) {
        // Garante que o tooltip sumiu
        tooltip.style.display = 'none';

        document.getElementById('modalEnderecoTitulo').innerText = endereco;
        const lista = document.getElementById('listaLotesModal');
        lista.innerHTML = '';

        itens.forEach(item => {
            const link = document.createElement('a');
            link.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3';
            link.href = `${baseUrl}?busca=${encodeURIComponent(item.lote)}`;
            link.innerHTML = `
                <div>
                    <div class="fw-bold text-primary">${item.lote}</div>
                    <small class="text-muted">${item.cliente || 'Sem cliente'}</small>
                </div>
                <span class="badge bg-secondary rounded-pill">${item.qtd} ${item.embalagem}</span>
            `;
            lista.appendChild(link);
        });

        bsModal.show();
    }

    window.addEventListener('resize', desenharMapa);
    desenharMapa();
});
</script>
{% endblock %}