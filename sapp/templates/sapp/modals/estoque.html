<!-- ESTRUTURA DO MODAL -->
<div class="modal fade" id="modalNovaEntrada" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen-sm-down modal-xl modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-4">
            <!-- Header -->
            <div class="modal-header bg-primary text-white border-0 py-3 rounded-top-4">
                <h5 class="modal-title fw-bold d-flex align-items-center">
                    <i class="bi bi-box-seam me-2"></i> Nova Entrada de Estoque
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="formNovaEntrada" method="POST" action="{% url 'sapp:nova_entrada' %}" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- SCANNER FULLSCREEN (OCULTA TUDO) -->
                <div id="scannerFullscreen" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark" style="z-index: 9999;">
                    <div class="d-flex flex-column align-items-center justify-content-center h-100 p-4">
                        <div class="text-center mb-4">
                            <h4 class="text-white mb-2">üì∑ Escanear QR Code</h4>
                            <p class="text-white-50">Posicione o c√≥digo na √°rea de leitura</p>
                        </div>
                        
                        <!-- Container do Scanner -->
                        <div id="scannerContainer" style="width: 90%; max-width: 500px; height: auto; aspect-ratio: 1/1; position: relative; margin: 0 auto;">
                            <div id="scannerReader" style="width: 100%; height: 100%;" class="overflow-hidden rounded-3 shadow-lg border border-primary border-4"></div>
                            
                            <!-- Moldura do scanner -->
                            <div class="scanner-frame">
                                <div class="scanner-line"></div>
                            </div>
                        </div>
                        
                        <div id="scannerStatus" class="text-white mt-4 fw-bold text-center" style="min-height: 30px;"></div>
                        
                        <div class="d-flex gap-3 mt-5">
                            <button type="button" class="btn btn-outline-light btn-lg px-4" onclick="ScannerApp.toggleFlash()" id="btnFlash" disabled>
                                <i class="bi bi-lightning"></i> Flash
                            </button>
                            <button type="button" class="btn btn-danger btn-lg px-5 fw-bold" onclick="ScannerApp.stop()">
                                <i class="bi bi-x-circle"></i> Fechar Scanner
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CONTE√öDO NORMAL DO FORMUL√ÅRIO (FICA OCULTO DURANTE SCAN) -->
                <div id="formContent">
                    <div class="modal-body p-4 bg-light">
                        <div class="row g-3">
                            <!-- SE√á√ÉO 1: IDENTIFICA√á√ÉO -->
                            <div class="col-12"><h6 class="text-primary fw-bold mb-0 mt-2">Identifica√ß√£o Principal</h6><hr class="mt-1"></div>
                            
                            <div class="col-md-8 position-relative">
                                <label class="form-label small fw-bold">N√∫mero do Lote *</label>
                                <div class="input-group">
                                    <input type="text" name="lote" id="inputLote" class="form-control form-control-lg fw-bold" required autocomplete="off" placeholder="Digite o lote ou escaneie">
                                    <button type="button" class="btn btn-primary px-3" onclick="ScannerApp.start()" title="Escanear QR Code" id="btnScan">
                                        <i class="bi bi-qr-code-scan fs-5"></i>
                                    </button>
                                </div>
                                <!-- Dropdown Autocomplete -->
                                <div id="autoCompleteList" class="dropdown-menu shadow-lg w-100"></div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Quantidade *</label>
                                <input type="number" name="entrada" id="inputQtd" class="form-control form-control-lg text-center fw-bold" required min="1" placeholder="0">
                            </div>

                            <!-- SE√á√ÉO 2: LOCALIZA√á√ÉO -->
                            <div class="col-12"><h6 class="text-primary fw-bold mb-0 mt-3">Localiza√ß√£o e Origem</h6><hr class="mt-1"></div>
                            
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label small fw-bold">Origem / Destino *</label>
                                <input type="text" name="origem_destino" id="inputOrigem" class="form-control" required placeholder="Ex: Produ√ß√£o Interna">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label small fw-bold">Endere√ßo *</label>
                                <input type="text" name="endereco" id="inputEndereco" class="form-control text-uppercase" required placeholder="P01-A01">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label small fw-bold">Armaz√©m (AZ) *</label>
                                <input type="text" name="az" id="inputAz" class="form-control text-uppercase" required placeholder="AZ-01">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label small fw-bold">Cliente</label>
                                <input type="text" name="cliente" id="inputCliente" class="form-control">
                            </div>

                            <!-- SE√á√ÉO 3: PRODUTO E DADOS T√âCNICOS -->
                            <div class="col-12"><h6 class="text-primary fw-bold mb-0 mt-3">Dados do Produto e SKU</h6><hr class="mt-1"></div>
                            
                            <div class="col-md-12 col-lg-4">
                                <label class="form-label small fw-bold">C√≥digo do Produto (SKU)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" name="produto" id="inputSKU" class="form-control fw-bold" placeholder="Digite SKU para buscar dados">
                                </div>
                                <small id="skuLoading" class="text-primary d-none">Buscando dados...</small>
                            </div>

                            <div class="col-md-6 col-lg-4">
                                <label class="form-label small fw-bold">Esp√©cie *</label>
                                <select name="especie" id="selEspecie" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    {% for e in all_especies %}<option value="{{ e.id }}">{{ e.nome }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <label class="form-label small fw-bold">Cultivar *</label>
                                <select name="cultivar" id="selCultivar" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    {% for c in all_cultivares %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Peneira *</label>
                                <select name="peneira" id="selPeneira" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    {% for p in all_peneiras %}<option value="{{ p.id }}">{{ p.nome }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Categoria *</label>
                                <select name="categoria" id="selCategoria" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    {% for c in all_categorias %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Tratamento</label>
                                <select name="tratamento" id="selTratamento" class="form-select">
                                    <option value="">Nenhum tratamento</option>
                                    {% for t in all_tratamentos %}<option value="{{ t.id }}">{{ t.nome }}</option>{% endfor %}
                                </select>
                            </div>

                            <!-- SE√á√ÉO 4: COMPLEMENTO -->
                            <div class="col-12"><h6 class="text-primary fw-bold mb-0 mt-3">Complementares</h6><hr class="mt-1"></div>

                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Empresa</label>
                                <input type="text" name="empresa" id="inputEmpresa" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Embalagem</label>
                                <select name="embalagem" id="selEmbalagem" class="form-select">
                                    <option value="BAG">BAG</option>
                                    <option value="SC">SACO (SC)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Peso Unit. (Kg)</label>
                                <input type="number" step="0.01" name="peso_unitario" id="inputPeso" class="form-control" placeholder="0.00">
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">Fotos / Arquivos</label>
                                <input type="file" name="fotos" class="form-control" multiple accept="image/*">
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">Observa√ß√µes Adicionais</label>
                                <textarea name="observacao" id="inputObs" class="form-control" rows="2" placeholder="Notas, hist√≥rico ou avisos..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer border-0 p-3 bg-white rounded-bottom-4">
                        <button type="button" class="btn btn-light btn-lg px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary btn-lg px-5 shadow fw-bold" id="btnSubmit">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="submitSpinner"></span>
                            <span id="submitText">Confirmar Registro</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ESTILO -->
<style>
    #autoCompleteList { 
        max-height: 300px; 
        overflow-y: auto; 
        display: none; 
        margin-top: 2px; 
        border-radius: 8px; 
        position: absolute;
        z-index: 1000;
        background: white;
    }
    
    .autocomplete-item { 
        padding: 10px 15px; 
        cursor: pointer; 
        border-bottom: 1px solid #f1f1f1; 
    }
    
    .autocomplete-item:last-child { 
        border-bottom: none; 
    }
    
    .autocomplete-item:hover { 
        background-color: #f8f9fa; 
    }
    
    .autocomplete-item strong { 
        display: block; 
        color: #0d6efd; 
        font-family: monospace; 
    }
    
    .autocomplete-item small { 
        display: block; 
        color: #6c757d; 
        font-size: 0.8rem; 
        margin-top: 2px; 
    }

    @media (max-width: 575.98px) {
        .modal-fullscreen-sm-down { 
            width: 100vw; 
            height: 100%; 
            margin: 0; 
        }
        .modal-fullscreen-sm-down .modal-content { 
            height: 100%; 
            border-radius: 0 !important; 
        }
        .modal-fullscreen-sm-down .modal-body { 
            overflow-y: auto; 
            padding: 20px !important; 
        }
        .modal-footer { 
            padding: 15px !important; 
            flex-direction: column-reverse; 
        }
        .modal-footer .btn { 
            width: 100%; 
            margin: 5px 0; 
        }
    }
    
    .is-invalid { 
        border-color: #dc3545 !important; 
        background-image: none !important; 
    }
    
    /* Scanner Fullscreen */
    #scannerFullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 99999 !important;
    }
    
    #scannerReader video { 
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
    }
    
    /* Moldura do scanner */
    .scanner-frame {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 3px solid rgba(13, 110, 253, 0.5);
        border-radius: 16px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        pointer-events: none;
    }
    
    .scanner-line {
        position: absolute;
        top: 0;
        left: 10%;
        width: 80%;
        height: 3px;
        background: linear-gradient(90deg, transparent, #0d6efd, transparent);
        animation: scanLine 2s linear infinite;
        border-radius: 3px;
    }
    
    @keyframes scanLine {
        0% { top: 10%; }
        50% { top: 90%; }
        100% { top: 10%; }
    }
    
    .btn:disabled {
        cursor: not-allowed;
        opacity: 0.65;
    }
</style>

<!-- SCRIPTS -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const StockApp = {
        debounce: null,
        isSubmitting: false,
        
        init() {
            this.setupAutocomplete();
            this.setupSKUSearch();
            this.setupValidation();
            this.setupClean();
            this.preventDoubleSubmit();
        },

        preventDoubleSubmit() {
            const form = document.getElementById('formNovaEntrada');
            const submitBtn = document.getElementById('btnSubmit');
            const spinner = document.getElementById('submitSpinner');
            const submitText = document.getElementById('submitText');

            // NOVO C√ìDIGO PARA O EVENTO SUBMIT (Substitua no seu script)
            form.addEventListener('submit', function(e) {
                if (isSubmitting) {
                    e.preventDefault();
                    return false;
                }

                // Validar quantidade
                const quantidade = document.getElementById('transf_quantidade');
                const saldoAtual = parseInt(document.getElementById('transf_saldo_atual').textContent) || 0;
                const qtdValue = parseInt(quantidade.value) || 0;
                
                if (qtdValue <= 0) {
                    e.preventDefault();
                    alert('A quantidade deve ser maior que zero');
                    quantidade.focus();
                    return false;
                }
                
                if (qtdValue > saldoAtual) {
                    e.preventDefault();
                    alert(`Quantidade n√£o pode ser maior que o saldo atual (${saldoAtual})`);
                    quantidade.focus();
                    return false;
                }
                
                // Validar endere√ßo no modo normal
                if (tipoNormal.checked && !enderecoInput.value.trim()) {
                    e.preventDefault();
                    alert('Endere√ßo de destino √© obrigat√≥rio');
                    enderecoInput.focus();
                    return false;
                }

                // SE PASSOU NAS VALIDA√á√ïES:
                isSubmitting = true;
                btnConfirmar.disabled = true;
                btnSpinner.classList.remove('d-none');
                
                // CORRE√á√ÉO CR√çTICA AQUI:
                // Desabilita apenas inputs que N√ÉO sejam o CSRF token para que ele possa ser enviado
                const inputsParaDesabilitar = form.querySelectorAll('input:not([name="csrfmiddlewaretoken"]), select, textarea');
                inputsParaDesabilitar.forEach(input => {
                    // Usamos readonly ou um pequeno timeout para desabilitar 
                    // mas o ideal para o CSRF √© apenas ignor√°-lo na lista de desabilitados
                    input.readOnly = true; 
                });

                return true; // Envia o form com o CSRF habilitado
            });
        },

        setupAutocomplete() {
            const input = document.getElementById('inputLote');
            const list = document.getElementById('autoCompleteList');

            input.addEventListener('input', (e) => {
                clearTimeout(this.debounce);
                const term = e.target.value;
                if (term.length < 3) { 
                    list.style.display = 'none'; 
                    return; 
                }

                this.debounce = setTimeout(() => {
                    fetch(`/api/autocomplete-lotes/?term=${encodeURIComponent(term)}`)
                        .then(r => r.json())
                        .then(data => {
                            list.innerHTML = '';
                            if (data.length > 0) {
                                list.style.display = 'block';
                                data.forEach(item => {
                                    const d = item.dados;
                                    const div = document.createElement('div');
                                    div.className = 'autocomplete-item';
                                    div.innerHTML = `<strong>${d.lote}</strong><small>Prod: ${d.produto || 'N/A'} | End: ${d.endereco || '?'}</small>`;
                                    div.addEventListener('mousedown', (evt) => {
                                        evt.preventDefault();
                                        this.fillFromData(d);
                                    });
                                    list.appendChild(div);
                                });
                            } else { 
                                list.style.display = 'none'; 
                            }
                        })
                        .catch(() => {
                            list.style.display = 'none';
                        });
                }, 400);
            });

            input.addEventListener('blur', () => {
                setTimeout(() => list.style.display = 'none', 200);
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.style.display = 'none';
                }
            });
        },

        setupSKUSearch() {
            const input = document.getElementById('inputSKU');
            const loading = document.getElementById('skuLoading');
            let searchTimeout;

            input.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const cod = input.value.trim();
                
                if (cod.length < 3) return;
                
                searchTimeout = setTimeout(() => {
                    loading.classList.remove('d-none');
                    fetch(`/api/buscar-produto/?codigo=${encodeURIComponent(cod)}`)
                        .then(r => r.json())
                        .then(data => {
                            loading.classList.add('d-none');
                            if (data.encontrado) {
                                this.fillFields(data.dados);
                            }
                        })
                        .catch(() => {
                            loading.classList.add('d-none');
                        });
                }, 500);
            });
        },

        fillFromData(d) {
            document.getElementById('inputLote').value = d.lote || '';
            document.getElementById('inputSKU').value = d.produto || '';
            document.getElementById('inputOrigem').value = d.origem_destino || '';
            document.getElementById('inputEndereco').value = d.endereco || '';
            document.getElementById('inputAz').value = d.az || '';
            this.fillFields(d);
            document.getElementById('autoCompleteList').style.display = 'none';
            document.getElementById('inputQtd').focus();
        },

        fillFields(d) {
            const setValue = (id, val) => {
                const el = document.getElementById(id);
                if (el && val) el.value = val;
            };

            setValue('selEspecie', d.especie_id || d.especie__id);
            setValue('selCultivar', d.cultivar_id || d.cultivar__id);
            setValue('selPeneira', d.peneira_id || d.peneira__id);
            setValue('selCategoria', d.categoria_id || d.categoria__id);
            setValue('selTratamento', d.tratamento_id || d.tratamento__id);
            
            setValue('inputEmpresa', d.empresa);
            setValue('inputCliente', d.cliente);
            setValue('inputPeso', d.peso_unitario);
            setValue('selEmbalagem', d.embalagem);
        },

        setupValidation() {
            const form = document.getElementById('formNovaEntrada');
            const inputs = form.querySelectorAll('[required]');
            
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (input.value.trim()) {
                        input.classList.remove('is-invalid');
                    }
                });
                
                input.addEventListener('blur', () => {
                    if (!input.value.trim()) {
                        input.classList.add('is-invalid');
                    }
                });
            });
        },

        setupClean() {
            const modal = document.getElementById('modalNovaEntrada');
            modal.addEventListener('hidden.bs.modal', () => {
                document.getElementById('formNovaEntrada').reset();
                document.querySelectorAll('.is-invalid').forEach(el => {
                    el.classList.remove('is-invalid');
                });
                StockApp.isSubmitting = false;
                const submitBtn = document.getElementById('btnSubmit');
                submitBtn.disabled = false;
                document.getElementById('submitSpinner').classList.add('d-none');
                document.getElementById('submitText').textContent = 'Confirmar Registro';
                ScannerApp.stop();
            });
        }
    };

    const ScannerApp = {
        html5QrCode: null,
        isScanning: false,
        hasFlash: false,
        
        playBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 1000;
                gainNode.gain.value = 0.2;
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } catch (e) {
                console.log('Beep error:', e);
            }
        },

        async start() {
            if (this.isScanning) return;
            
            const scannerDiv = document.getElementById('scannerFullscreen');
            const formContent = document.getElementById('formContent');
            
            // Esconder formul√°rio e mostrar scanner fullscreen
            formContent.style.display = 'none';
            scannerDiv.classList.remove('d-none');
            
            try {
                if (!this.html5QrCode) {
                    this.html5QrCode = new Html5Qrcode("scannerReader");
                }
                
                const config = { 
                    fps: 30,
                    qrbox: { width: 300, height: 300 },
                    aspectRatio: 1.0
                };
                
                await this.html5QrCode.start(
                    { facingMode: "environment" }, 
                    config, 
                    (decodedText) => {
                        if (this.isScanning) {
                            this.isScanning = false;
                            this.playBeep();
                            
                            document.getElementById('scannerStatus').innerHTML = '<span class="text-success">‚úì QR Code lido com sucesso!</span>';
                            
                            const partes = decodedText.split('/');
                            if (partes.length >= 2) {
                                document.getElementById('inputSKU').value = partes[0];
                                document.getElementById('inputLote').value = partes[1];
                                
                                // Disparar busca do SKU
                                document.getElementById('inputSKU').dispatchEvent(new Event('input'));
                                
                                setTimeout(() => {
                                    this.stop();
                                    document.getElementById('inputQtd').focus();
                                }, 800);
                            } else {
                                document.getElementById('scannerStatus').innerHTML = '<span class="text-danger">‚úó Formato inv√°lido (use SKU/LOTE)</span>';
                                setTimeout(() => {
                                    this.isScanning = true;
                                    document.getElementById('scannerStatus').innerHTML = '';
                                }, 2000);
                            }
                        }
                    },
                    (error) => {}
                );
                
                this.isScanning = true;
                
                // Verificar flash
                this.checkFlashSupport();
                
            } catch (err) {
                console.error('Erro:', err);
                document.getElementById('scannerStatus').textContent = 'Erro ao iniciar c√¢mera';
                setTimeout(() => this.stop(), 2000);
            }
        },

        async checkFlashSupport() {
            try {
                const devices = await Html5Qrcode.getCameras();
                if (devices && devices.length) {
                    const backCamera = devices.find(d => 
                        d.label.toLowerCase().includes('back') || 
                        d.label.toLowerCase().includes('traseira')
                    );
                    
                    if (backCamera) {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { deviceId: backCamera.id }
                        });
                        
                        const track = stream.getVideoTracks()[0];
                        this.hasFlash = track.getCapabilities().torch || false;
                        
                        document.getElementById('btnFlash').disabled = !this.hasFlash;
                        
                        stream.getTracks().forEach(t => t.stop());
                    }
                }
            } catch (e) {
                console.log('Flash check error:', e);
            }
        },

        async stop() {
            if (this.html5QrCode && this.isScanning) {
                try {
                    await this.html5QrCode.stop();
                } catch (err) {
                    console.log('Stop error:', err);
                }
            }
            
            this.isScanning = false;
            this.hasFlash = false;
            
            const scannerDiv = document.getElementById('scannerFullscreen');
            const formContent = document.getElementById('formContent');
            
            // Mostrar formul√°rio e esconder scanner
            formContent.style.display = 'block';
            scannerDiv.classList.add('d-none');
            
            document.getElementById('btnFlash').disabled = true;
            document.getElementById('btnFlash').innerHTML = '<i class="bi bi-lightning"></i> Flash';
            document.getElementById('scannerStatus').innerHTML = '';
        },

        async toggleFlash() {
            if (!this.html5QrCode || !this.hasFlash) return;
            
            try {
                const track = await this.html5QrCode.getRunningTrackCameraConfig();
                if (track) {
                    const torch = !track.torch;
                    await this.html5QrCode.applyVideoConstraints({ 
                        advanced: [{ torch: torch }] 
                    });
                    
                    const btnFlash = document.getElementById('btnFlash');
                    if (torch) {
                        btnFlash.innerHTML = '<i class="bi bi-lightning-fill"></i> Flash';
                        btnFlash.classList.replace('btn-outline-light', 'btn-warning');
                    } else {
                        btnFlash.innerHTML = '<i class="bi bi-lightning"></i> Flash';
                        btnFlash.classList.replace('btn-warning', 'btn-outline-light');
                    }
                }
            } catch (err) {
                console.log('Flash error:', err);
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => StockApp.init());
</script>



























<!-- === MODAL TRANSFER√äNCIA === -->
<div class="modal fade" id="modalTransferencia" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Transferir e Ajustar</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formTransferencia" method="POST" action="{% url 'sapp:transferir' 0 %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="item_id" id="transf_item_id">
                <div class="modal-body">
                    <!-- TIPO DE TRANSFER√äNCIA - NOVO CAMPO NO TOPO -->
                    <div class="row mb-4 p-3 bg-light rounded border border-warning">
                        <div class="col-12 mb-2">
                            <h6 class="text-warning fw-bold border-bottom border-warning pb-2">
                                <i class="fas fa-arrows-alt me-2"></i>Tipo de Transfer√™ncia
                            </h6>
                        </div>
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-4 align-items-center">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="tipo_transferencia" id="tipo_normal" value="normal" checked>
                                    <label class="form-check-label fw-bold" for="tipo_normal">
                                        <i class="fas fa-exchange-alt text-primary me-1"></i>Transfer√™ncia Normal
                                    </label>
                                    <small class="d-block text-muted mt-1 ms-3">Origem ‚Üí Destino com cria√ß√£o de novo registro</small>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="tipo_transferencia" id="tipo_beneficiamento" value="beneficiamento">
                                    <label class="form-check-label fw-bold" for="tipo_beneficiamento">
                                        <i class="fas fa-industry text-success me-1"></i>Enviar para Beneficiamento
                                    </label>
                                    <small class="d-block text-muted mt-1 ms-3">Sa√≠da definitiva do estoque (baixa direta)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SALDO DESTAQUE -->
                    <div class="text-center py-2 bg-light rounded border mb-3">
                        <small class="text-muted text-uppercase fw-bold">Saldo Atual</small>
                        <div class="fs-2 fw-bold text-dark" id="transf_saldo_atual">0</div>
                        <small class="text-muted" id="transf_endereco_atual">Endere√ßo: </small>
                    </div>

                    <!-- DESTINO - SE√á√ÉO QUE MUDA CONFORME O TIPO -->
                    <div class="row mb-3 p-3 bg-opacity-10 rounded border" id="destino_section">
                        <div class="col-12 mb-2">
                            <h6 class="fw-bold border-bottom pb-2" id="destino_title">
                                <i class="fas fa-arrow-right me-2"></i>Destino da Transfer√™ncia
                            </h6>
                        </div>
                        <div class="col-6 mb-2">
                            <label class="fw-bold" id="endereco_label">Novo Endere√ßo *</label>
                            <input type="text" name="novo_endereco" id="transf_novo_endereco" class="form-control" required>
                        </div>
                        <div class="col-3 mb-2">
                            <label class="fw-bold">Quantidade *</label>
                            <input type="number" name="quantidade" id="transf_quantidade" class="form-control fw-bold" required min="1">
                        </div>
                        <div class="col-3 mb-2">
                            <label>AZ</label>
                            <input type="text" name="az" id="transf_az" class="form-control">
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-12">
                            <h6 class="text-muted border-bottom pb-1">
                                <i class="fas fa-info-circle me-1"></i>Dados do Item (Editar se necess√°rio)
                                <small class="text-muted ms-2">Tudo abaixo j√° est√° preenchido com os dados atuais do lote</small>
                            </h6>
                        </div>
                        
                        <!-- Linha 1 -->
                        <div class="col-3"><label>Lote</label><input type="text" class="form-control bg-light" id="transf_lote_display" readonly></div>
                        <div class="col-9"><label>Produto</label><input type="text" name="produto" id="transf_produto" class="form-control"></div>
                        
                        <!-- Linha 2 -->
                        <div class="col-4">
                            <label>Esp√©cie</label>
                            <select name="especie" id="transf_especie" class="form-select">
                                <option value="">Selecione...</option>
                                {% for e in all_especies %}<option value="{{ e.id }}">{{ e.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-4"><label>Cliente</label><input type="text" name="cliente" id="transf_cliente" class="form-control"></div>
                        <div class="col-4"><label>Empresa</label><input type="text" name="empresa" id="transf_empresa" class="form-control"></div>
                        
                        <!-- Linha 3 -->
                        <div class="col-3"><label>Peso Unit√°rio</label><input type="text" name="peso_unitario" id="transf_peso" class="form-control"></div>
                        <div class="col-3"><label>Embalagem</label>
                            <select name="embalagem" id="transf_embalagem" class="form-select">
                                <option value="BAG">BAG</option>
                                <option value="SC">Saco</option>
                            </select>
                        </div>
                        <div class="col-3"><label>Saldo</label><input type="text" id="transf_saldo" class="form-control bg-light" readonly></div>
                        <div class="col-3"><label>Entrada</label><input type="text" id="transf_entrada" class="form-control bg-light" readonly></div>
                        
                        <div class="col-12 mt-2">
                            <a class="text-primary text-decoration-none small fw-bold" data-bs-toggle="collapse" href="#advancedFields">
                                <i class="fas fa-cog me-1"></i> Dados T√©cnicos (Cultivar, Peneira...)
                            </a>
                            <div class="collapse show mt-2" id="advancedFields">
                                <div class="row g-2 bg-light p-3 rounded border">
                                    <div class="col-6">
                                        <label>Cultivar</label>
                                        <select name="cultivar" id="transf_cultivar" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for c in all_cultivares %}
                                            <option value="{{ c.id }}">{{ c.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Peneira</label>
                                        <select name="peneira" id="transf_peneira" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for p in all_peneiras %}
                                            <option value="{{ p.id }}">{{ p.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Categoria</label>
                                        <select name="categoria" id="transf_categoria" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for c in all_categorias %}
                                            <option value="{{ c.id }}">{{ c.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Tratamento</label>
                                        <select name="tratamento" id="transf_tratamento" class="form-select">
                                            <option value="">Nenhum</option>
                                            {% for t in all_tratamentos %}
                                            <option value="{{ t.id }}">{{ t.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label>Observa√ß√£o</label>
                        <textarea name="observacao" id="transf_obs" class="form-control" rows="2" placeholder="Adicione observa√ß√µes sobre a transfer√™ncia..."></textarea>
                    </div>
                    
                    <div class="mt-2">
                        <label><i class="fas fa-camera me-1"></i> Fotos da Transfer√™ncia</label>
                        <input type="file" name="fotos" class="form-control" multiple accept="image/*">
                        <small class="text-muted">Opcional: Adicione fotos do lote sendo transferido</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning fw-bold text-white" id="btn_confirmar_transferencia">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="transf_spinner"></span>
                        <span id="transf_btn_text"><i class="fas fa-exchange-alt me-1"></i>Confirmar Transfer√™ncia</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript para controle din√¢mico do modal + preven√ß√£o de duplo envio -->
<script>
(function() {
    // Aguarda o DOM carregar completamente
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTransferModal);
    } else {
        initTransferModal();
    }

    function initTransferModal() {
        // Elementos principais
        const tipoNormal = document.getElementById('tipo_normal');
        const tipoBeneficiamento = document.getElementById('tipo_beneficiamento');
        const destinoSection = document.getElementById('destino_section');
        const enderecoInput = document.getElementById('transf_novo_endereco');
        const enderecoLabel = document.getElementById('endereco_label');
        const destinoTitle = document.getElementById('destino_title');
        const btnConfirmar = document.getElementById('btn_confirmar_transferencia');
        const btnSpinner = document.getElementById('transf_spinner');
        const btnText = document.getElementById('transf_btn_text');
        const form = document.getElementById('formTransferencia');
        const modal = document.getElementById('modalTransferencia');
        
        // Apenas prossegue se todos os elementos existirem
        if (!tipoNormal || !tipoBeneficiamento || !destinoSection || !enderecoInput || !destinoTitle || !btnConfirmar || !form) {
            console.warn('Elementos do modal de transfer√™ncia n√£o encontrados');
            return;
        }

        // Vari√°vel de controle para prevenir duplo envio
        let isSubmitting = false;

        // Fun√ß√£o para atualizar interface por tipo
        function atualizarInterfacePorTipo() {
            if (tipoBeneficiamento.checked) {
                // MODO BENEFICIAMENTO
                destinoSection.classList.remove('border-warning');
                destinoSection.classList.add('border-success', 'bg-success', 'bg-opacity-10');
                destinoTitle.innerHTML = '<i class="fas fa-industry me-2"></i>Envio para Beneficiamento';
                enderecoLabel.innerHTML = 'Destino na UBS (apenas refer√™ncia)';
                enderecoInput.required = false;
                enderecoInput.placeholder = 'Ex: UBS - Linha 1 (opcional)';
                btnText.innerHTML = '<i class="fas fa-industry me-1"></i>Confirmar Envio para Beneficiamento';
                btnConfirmar.classList.add('btn-success');
                btnConfirmar.classList.remove('btn-warning');
            } else {
                // MODO NORMAL
                destinoSection.classList.remove('border-success', 'bg-success', 'bg-opacity-10');
                destinoSection.classList.add('border-warning');
                destinoTitle.innerHTML = '<i class="fas fa-arrow-right me-2"></i>Destino da Transfer√™ncia';
                enderecoLabel.innerHTML = 'Novo Endere√ßo *';
                enderecoInput.required = true;
                enderecoInput.placeholder = '';
                btnText.innerHTML = '<i class="fas fa-exchange-alt me-1"></i>Confirmar Transfer√™ncia';
                btnConfirmar.classList.add('btn-warning');
                btnConfirmar.classList.remove('btn-success');
            }
        }

        // PREVEN√á√ÉO DE DUPLO ENVIO
        form.addEventListener('submit', function(e) {
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }

            // Validar quantidade
            const quantidade = document.getElementById('transf_quantidade');
            const saldoAtual = parseInt(document.getElementById('transf_saldo_atual').textContent) || 0;
            const qtdValue = parseInt(quantidade.value) || 0;
            
            if (qtdValue <= 0) {
                e.preventDefault();
                alert('A quantidade deve ser maior que zero');
                quantidade.focus();
                return false;
            }
            
            if (qtdValue > saldoAtual) {
                e.preventDefault();
                alert(`Quantidade n√£o pode ser maior que o saldo atual (${saldoAtual})`);
                quantidade.focus();
                return false;
            }
            
            // Validar endere√ßo no modo normal
            if (tipoNormal.checked && !enderecoInput.value.trim()) {
                e.preventDefault();
                alert('Endere√ßo de destino √© obrigat√≥rio');
                enderecoInput.focus();
                return false;
            }

            // Se passou pelas valida√ß√µes, bloquear duplo envio
            isSubmitting = true;
            btnConfirmar.disabled = true;
            btnSpinner.classList.remove('d-none');
            
            // O formul√°rio ser√° enviado normalmente
            return true;
        });

        // Resetar estado quando o modal for fechado
        modal.addEventListener('hidden.bs.modal', function() {
            isSubmitting = false;
            btnConfirmar.disabled = false;
            btnSpinner.classList.add('d-none');
            
            // Reset visual da quantidade se necess√°rio
            document.getElementById('transf_quantidade').classList.remove('is-invalid');
            
            // Voltar para modo normal
            tipoNormal.checked = true;
            atualizarInterfacePorTipo();
        });

        // Validar quantidade em tempo real
        const quantidadeInput = document.getElementById('transf_quantidade');
        quantidadeInput.addEventListener('input', function() {
            const saldoAtual = parseInt(document.getElementById('transf_saldo_atual').textContent) || 0;
            const valor = parseInt(this.value) || 0;
            
            if (valor > saldoAtual) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Adiciona listeners para os radios
        tipoNormal.addEventListener('change', atualizarInterfacePorTipo);
        tipoBeneficiamento.addEventListener('change', atualizarInterfacePorTipo);
        
        // Estado inicial
        atualizarInterfacePorTipo();
    }
})();
</script>

<!-- Estilo adicional para feedback visual -->
<style>
    #transf_quantidade.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    #transf_quantidade.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }
</style>






<!-- MODAIS DENTRO DO LOOP -->
{% for item in estoque %}
    <!-- 3. MODAL DE SA√çDA (EXPEDI√á√ÉO) -->
    <div class="modal fade" id="modalSaida{{ item.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-truck me-2"></i>Expedi√ß√£o - {{ item.lote }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'sapp:registrar_saida' item.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="text-center py-3 bg-danger bg-opacity-10 rounded border border-danger mb-3">
                            <small class="text-danger text-uppercase fw-bold">Saldo Dispon√≠vel</small>
                            <div class="fs-1 fw-bold text-danger">{{ item.saldo }}</div>
                            <small class="text-muted">{{ item.embalagem }}</small>
                        </div>
                        <div class="row g-2">
                            <div class="col-6"><label class="fw-bold">Qtd Sa√≠da *</label><input type="number" name="quantidade_saida" class="form-control border-danger fw-bold" max="{{ item.saldo }}" min="1" required></div>
                            <div class="col-6"><label>N¬∫ Carga *</label><input type="text" name="numero_carga" class="form-control" required></div>
                            <div class="col-6"><label>Motorista *</label><input type="text" name="motorista" class="form-control" required></div>
                            <div class="col-6"><label>Placa *</label><input type="text" name="placa" class="form-control" required></div>
                            <div class="col-12"><label>Cliente</label><input type="text" name="cliente" class="form-control" value="{{ item.cliente|default:'' }}"></div>
                            <div class="col-12"><label>Fotos (Obrigat√≥rio)</label><input type="file" name="fotos" class="form-control" multiple required></div>
                            <div class="col-12"><label>Observa√ß√£o</label><textarea name="observacao" class="form-control" rows="2"></textarea></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Confirmar Sa√≠da</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 4. MODAL DE EDITAR (COMPLETO E TURBINADO) -->
<!-- 4. MODAL DE EDITAR (COMPLETO E TURBINADO) -->
<div class="modal fade" id="modalEditar{{ item.id }}" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Lote {{ item.lote }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'sapp:editar' item.id %}">
                {% csrf_token %}
                <div class="modal-body text-start">
                    
                    <!-- Se√ß√£o 1: Dados Principais -->
                    <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="fas fa-box me-1"></i> Dados do Lote</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">N√∫mero do Lote</label>
                            <input type="text" name="lote" class="form-control bg-light" value="{{ item.lote }}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Armaz√©m (AZ)</label>
                            <input type="text" name="az" class="form-control" value="{{ item.az|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Endere√ßo</label>
                            <input type="text" name="endereco" class="form-control border-primary" value="{{ item.endereco }}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Esp√©cie</label>
                            <select name="especie" class="form-select select2-modal">
                                <option value="">Selecione...</option>
                                {% for e in all_especies %}
                                <option value="{{ e.id }}" {% if item.especie_id == e.id %}selected{% endif %}>{{ e.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Embalagem</label>
                            <select name="embalagem" class="form-select">
                                <option value="BAG" {% if item.embalagem == 'BAG' %}selected{% endif %}>Big Bag</option>
                                <option value="SC" {% if item.embalagem == 'SC' %}selected{% endif %}>Saco</option>
                            </select>
                        </div>
                        <!-- NOVO CAMPO QUANTIDADE -->
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-danger">
                                <i class="fas fa-cubes me-1"></i>Quantidade (Entrada)
                            </label>
                            <input type="number" name="entrada" class="form-control border-danger fw-bold" 
                                   value="{{ item.entrada }}" min="0" step="1" required
                                   oninput="atualizarPesoTotal(this)">
                            <small class="text-muted">Saldo atual: <span class="fw-bold">{{ item.saldo }}</span></small>
                        </div>
                    </div>

                    <!-- Se√ß√£o 2: Classifica√ß√£o -->
                    <h6 class="fw-bold text-success border-bottom pb-2 mb-3"><i class="fas fa-leaf me-1"></i> Classifica√ß√£o T√©cnica</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label">Cultivar</label>
                            <select name="cultivar" class="form-select select2-modal">
                                {% for c in all_cultivares %}
                                <option value="{{ c.id }}" {% if c.id == item.cultivar.id %}selected{% endif %}>{{ c.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Peneira</label>
                            <select name="peneira" class="form-select select2-modal">
                                {% for p in all_peneiras %}
                                <option value="{{ p.id }}" {% if p.id == item.peneira.id %}selected{% endif %}>{{ p.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Categoria</label>
                            <select name="categoria" class="form-select select2-modal">
                                {% for c in all_categorias %}
                                <option value="{{ c.id }}" {% if c.id == item.categoria.id %}selected{% endif %}>{{ c.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tratamento</label>
                            <select name="tratamento" class="form-select select2-modal">
                                <option value="">Sem Tratamento</option>
                                {% for t in all_tratamentos %}
                                <option value="{{ t.id }}" {% if t.id == item.tratamento.id %}selected{% endif %}>{{ t.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Se√ß√£o 3: Log√≠stica e Info -->
                    <h6 class="fw-bold text-info border-bottom pb-2 mb-3"><i class="fas fa-truck me-1"></i> Log√≠stica e Informa√ß√µes</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Produto / Descri√ß√£o</label>
                            <input type="text" name="produto" class="form-control" value="{{ item.produto|default:'' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cliente / Propriet√°rio</label>
                            <input type="text" name="cliente" class="form-control" value="{{ item.cliente|default:'' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Empresa</label>
                            <input type="text" name="empresa" class="form-control" value="{{ item.empresa|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Peso Unit√°rio (kg)</label>
                            <input type="text" name="peso_unitario" class="form-control" value="{{ item.peso_unitario }}" id="pesoUnitario{{ item.id }}">
                        </div>
                        <!-- Peso Total (autom√°tico) -->
                        <div class="col-md-3">
                            <label class="form-label">Peso Total (kg)</label>
                            <input type="text" class="form-control bg-light" id="pesoTotal{{ item.id }}" 
                                   value="{{ item.peso_total }}" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Origem/Destino</label>
                            <input type="text" name="origem_destino" class="form-control" value="{{ item.origem_destino|default:'' }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observa√ß√µes</label>
                            <textarea name="observacao" class="form-control" rows="2">{{ item.observacao|default:'' }}</textarea>
                        </div>
                    </div>

                    <!-- AVISO SOBRE SA√çDAS -->
                    <div class="alert alert-warning mt-3 mb-0 py-2 small">
                        <i class="fas fa-info-circle me-1"></i> 
                        <strong>Aten√ß√£o:</strong> Alterar a quantidade afeta o saldo do lote. 
                        As sa√≠das registradas (<span class="fw-bold">{{ item.saida }}</span> unidades) n√£o ser√£o alteradas.
                    </div>

                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SCRIPT PARA CALCULAR PESO TOTAL DINAMICAMENTE -->
<script>
function atualizarPesoTotal(input) {
    // Encontra o modal correspondente
    var modal = input.closest('.modal');
    var itemId = modal.id.replace('modalEditar', '');
    
    // Pega os valores
    var quantidade = parseInt(input.value) || 0;
    var pesoUnitario = parseFloat(document.getElementById('pesoUnitario' + itemId).value.replace(',', '.')) || 0;
    
    // Calcula peso total
    var pesoTotal = quantidade * pesoUnitario;
    
    // Atualiza o campo de peso total
    document.getElementById('pesoTotal' + itemId).value = pesoTotal.toFixed(2).replace('.', ',');
}
</script>
{% endfor %}