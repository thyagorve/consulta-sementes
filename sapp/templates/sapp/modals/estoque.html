<!-- === MODAL NOVA ENTRADA ATUALIZADO === -->
<div class="modal fade" id="modalNovaEntrada" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <!-- Header Estilizado -->
            <div class="modal-header border-0 bg-primary text-white p-4">
                <div class="d-flex align-items-center">
                    <div class="bg-white bg-opacity-20 p-3 rounded-3 me-3">
                        <i class="fas fa-truck-loading fs-3"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold mb-0">Nova Entrada de Estoque</h5>
                        <small class="opacity-75">Registre a chegada de novos materiais ou produtos</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <form method="POST" action="{% url 'sapp:nova_entrada' %}" enctype="multipart/form-data" id="formNovaEntrada">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <!-- ÁREA DE MENSAGENS -->
                    <div id="alertsArea" class="mb-3"></div>
                    
                    <div class="row g-4">
                        <!-- SEÇÃO 1: IDENTIFICAÇÃO (DESTAQUE) -->
                        <div class="col-12">
                            <div class="p-3 rounded-3 bg-light border-start border-primary border-4">
                                <div class="row g-3">
                                    <!-- Lote com Scanner -->
                                    <div class="col-md-7">
                                        <label class="form-label fw-bold text-dark">
                                            <i class="fas fa-barcode me-1 text-primary"></i> Número do Lote *
                                        </label>
                                        <div class="input-group">
                                            <input type="text" name="lote" id="inputLoteEntrada" 
                                                   class="form-control form-control-lg border-primary border-opacity-25" 
                                                   required placeholder="Escaneie ou digite o lote"
                                                   style="font-family: monospace; font-weight: bold; letter-spacing: 1px;">
                                            <button type="button" class="btn btn-primary px-3" onclick="InventoryScanner.start()" title="Escanear QR Code">
                                                <i class="fas fa-camera fa-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Quantidade -->
                                    <div class="col-md-5">
                                        <label class="form-label fw-bold text-dark">
                                            <i class="fas fa-layer-group me-1 text-primary"></i> Quantidade *
                                        </label>
                                        <input type="number" name="entrada" class="form-control form-control-lg text-center fw-bold" 
                                               required min="1" placeholder="000">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SEÇÃO 2: ORIGEM E LOCALIZAÇÃO -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase text-muted">Origem / Destino</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fas fa-route text-muted"></i></span>
                                <input type="text" name="origem_destino" class="form-control" required placeholder="Ex: Produção Interna">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">Endereço</label>
                            <input type="text" name="endereco" class="form-control" required placeholder="P01-A02">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">Armazém (AZ)</label>
                            <input type="text" name="az" class="form-control" required placeholder="AZ-01">
                        </div>

                        <!-- SEÇÃO 3: PRODUTO (INTELIGENTE) -->
                        <div class="col-12 mt-4">
                            <div class="d-flex align-items-center mb-3">
                                <hr class="flex-grow-1 my-0">
                                <span class="mx-3 fw-bold text-primary small text-uppercase">Dados Técnicos do Produto</span>
                                <hr class="flex-grow-1 my-0">
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Código do Produto (SKU)</label>
                                    <div class="position-relative">
                                        <input type="text" name="produto" id="inputProdutoEntrada" 
                                               class="form-control bg-light fw-bold" 
                                               placeholder="Busca automática via Lote/QR" autocomplete="off">
                                        <div id="productLoader" class="spinner-border spinner-border-sm position-absolute end-0 top-50 translate-middle-y me-3 d-none text-primary"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Cultivar</label>
                                    <select name="cultivar" class="form-select bg-light" required>
                                        <option value="">Aguardando código...</option>
                                        {% for c in all_cultivares %}
                                        <option value="{{ c.id }}">{{ c.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Peneira</label>
                                    <select name="peneira" class="form-select bg-light" required>
                                        <option value="">Selecione...</option>
                                        {% for p in all_peneiras %}
                                        <option value="{{ p.id }}">{{ p.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Categoria</label>
                                    <select name="categoria" class="form-select bg-light" required>
                                        <option value="">Selecione...</option>
                                        {% for c in all_categorias %}
                                        <option value="{{ c.id }}">{{ c.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Tratamento</label>
                                    <select name="tratamento" class="form-select bg-light">
                                        <option value="">Nenhum</option>
                                        {% for t in all_tratamentos %}
                                        <option value="{{ t.id }}">{{ t.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- SEÇÃO 4: OUTROS DETALHES -->
                        <div class="col-md-4">
                            <label class="form-label small">Embalagem</label>
                            <select name="embalagem" class="form-select">
                                <option value="BAG">BIG BAG</option>
                                <option value="SC">SACO (SC)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Peso Unit. (kg)</label>
                            <input type="number" step="0.01" name="peso_unitario" class="form-control" placeholder="0.00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Fotos</label>
                            <input type="file" name="fotos" class="form-control" multiple accept="image/*">
                        </div>

                        <div class="col-12">
                            <label class="form-label small">Observações</label>
                            <textarea name="observacao" class="form-control" rows="2" placeholder="Notas adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 p-4 bg-light rounded-bottom-4">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-5 fw-bold shadow">
                        <i class="fas fa-check-circle me-2"></i> Confirmar Entrada
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ESTILOS ADICIONAIS -->
<style>
    .field-success-animate {
        animation: pulseSuccess 1s ease-in-out;
        border-color: #10b981 !important;
        box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.25) !important;
    }
    @keyframes pulseSuccess {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    .modal-content { border-radius: 1rem; overflow: hidden; }
    .form-control, .form-select { border-radius: 8px; border: 1px solid #d1d5db; padding: 0.6rem 0.75rem; }
    .form-control:focus, .form-select:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
</style>

<!-- SCRIPTS DE LOGICA APRIMORADA -->
<script>
/**
 * INVENTORY SCANNER MANAGER
 * Objeto responsável por gerenciar o ciclo de vida do scanner QR Code
 */
const InventoryScanner = {
    html5QrCode: null,
    isActive: false,

    async start() {
        if (this.isActive) return;
        
        const container = document.getElementById('scannerContainer');
        container.style.display = 'flex';
        
        try {
            if (!this.html5QrCode) {
                this.html5QrCode = new Html5Qrcode("scanner-viewfinder");
            }

            const config = {
                fps: 15,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            await this.html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                this.onSuccess.bind(this)
            );
            this.isActive = true;
        } catch (err) {
            console.error("Erro ao iniciar câmera:", err);
            alert("Não foi possível acessar a câmera. Verifique as permissões de HTTPS.");
            this.stop();
        }
    },

    async stop() {
        if (this.html5QrCode && this.isActive) {
            await this.html5QrCode.stop();
        }
        document.getElementById('scannerContainer').style.display = 'none';
        this.isActive = false;
    },

    onSuccess(decodedText) {
        // Formato esperado: PRODUTO/LOTE/OUTRO
        const parts = decodedText.split('/');
        const codProduto = parts[0] || "";
        const lote = parts[1] || "";

        // Preencher Lote
        const inputLote = document.getElementById('inputLoteEntrada');
        inputLote.value = lote;
        inputLote.classList.add('field-success-animate');

        // Preencher Produto e disparar busca
        const inputProd = document.getElementById('inputProdutoEntrada');
        inputProd.value = codProduto;
        
        this.stop();
        
        // Disparar busca automática do produto após 300ms
        setTimeout(() => buscarDadosProdutoReal(codProduto), 300);
        
        // Som de confirmação (opcional)
        if (typeof Audio !== 'undefined') {
            new Audio('https://assets.mixkit.co/active_storage/sfx/766/766-preview.mp3').play().catch(()=>{});
        }
    }
};

/**
 * BUSCA DE PRODUTO NA API DJANGO
 */
async function buscarDadosProdutoReal(codigo) {
    if (!codigo || codigo.length < 3) return;

    const loader = document.getElementById('productLoader');
    const alerts = document.getElementById('alertsArea');
    const form = document.getElementById('formNovaEntrada');
    
    loader.classList.remove('d-none');
    
    try {
        const response = await fetch(`{% url 'sapp:api_buscar_produto' %}?codigo=${encodeURIComponent(codigo)}`);
        const data = await response.json();

        if (data.encontrado) {
            const d = data.dados;
            
            // Função utilitária para preencher selects e disparar efeito
            const preencher = (name, val) => {
                const el = form.querySelector(`[name="${name}"]`);
                if (el && val) {
                    el.value = val;
                    el.classList.add('field-success-animate');
                    setTimeout(() => el.classList.remove('field-success-animate'), 2000);
                }
            };

            preencher('cultivar', d.cultivar_id);
            preencher('peneira', d.peneira_id);
            preencher('categoria', d.categoria_id);
            preencher('tratamento', d.tratamento_id);
            preencher('especie', d.especie_id);
            preencher('empresa', d.empresa);

            alerts.innerHTML = `
                <div class="alert alert-success d-flex align-items-center mb-0 py-2">
                    <i class="fas fa-check-double me-2"></i>
                    <small>Dados de <strong>${d.cultivar_nome}</strong> carregados do banco.</small>
                </div>
            `;
        } else {
            alerts.innerHTML = `
                <div class="alert alert-warning py-2 small">
                    <i class="fas fa-exclamation-circle me-1"></i> Produto não encontrado no cadastro base.
                </div>
            `;
        }
    } catch (err) {
        console.error("Erro API:", err);
    } finally {
        loader.classList.add('d-none');
    }
}

// Escuta input manual do produto
document.getElementById('inputProdutoEntrada').addEventListener('blur', function() {
    buscarDadosProdutoReal(this.value);
});

// Autocomplete do Lote (Existente e aprimorado)
document.getElementById('inputLoteEntrada').addEventListener('blur', function() {
    // Se o usuário digitou um lote manualmente, tenta inferir se existe no estoque
    // ou apenas segue o fluxo. O scanner já faz o trabalho principal.
});

// Fechar scanner no ESC
document.addEventListener('keydown', (e) => {
    if (e.key === "Escape" && InventoryScanner.isActive) InventoryScanner.stop();
});
</script>



<!-- === MODAL TRANSFERÊNCIA === -->
<div class="modal fade" id="modalTransferencia" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Transferir e Ajustar</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formTransferencia" method="POST" action="{% url 'sapp:transferir' 0 %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="item_id" id="transf_item_id">
                <div class="modal-body">
                    <!-- SALDO DESTAQUE -->
                    <div class="text-center py-2 bg-light rounded border mb-3">
                        <small class="text-muted text-uppercase fw-bold">Saldo Atual</small>
                        <div class="fs-2 fw-bold text-dark" id="transf_saldo_atual">0</div>
                        <small class="text-muted" id="transf_endereco_atual">Endereço: </small>
                    </div>

                    <div class="row mb-3 p-3 bg-warning bg-opacity-10 rounded border border-warning">
                        <div class="col-12 mb-2"><h6 class="text-warning fw-bold border-bottom border-warning pb-2">Destino da Transferência</h6></div>
                        <div class="col-6 mb-2"><label class="fw-bold">Novo Endereço *</label><input type="text" name="novo_endereco" class="form-control border-warning" required></div>
                        <div class="col-3 mb-2"><label class="fw-bold">Qtd *</label><input type="number" name="quantidade" id="transf_quantidade" class="form-control border-warning fw-bold" required min="1"></div>
                        <div class="col-3 mb-2"><label>AZ</label><input type="text" name="az" id="transf_az" class="form-control"></div>
                    </div>

                    <div class="row g-2">
                        <div class="col-12">
                            <h6 class="text-muted border-bottom pb-1">
                                <i class="fas fa-info-circle me-1"></i>Dados do Item (Editar se necessário)
                                <small class="text-muted ms-2">Tudo abaixo já está preenchido com os dados atuais do lote</small>
                            </h6>
                        </div>
                        
                        <!-- Linha 1 -->
                        <div class="col-3"><label>Lote</label><input type="text" class="form-control bg-light" id="transf_lote_display" readonly></div>
                        <div class="col-9"><label>Produto</label><input type="text" name="produto" id="transf_produto" class="form-control"></div>
                        
                        <!-- Linha 2 -->
                        <div class="col-4">
                            <label>Espécie</label>
                            <select name="especie" id="transf_especie" class="form-select">
                                <option value="">Selecione...</option>
                                {% for e in all_especies %}<option value="{{ e.id }}">{{ e.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-4"><label>Cliente</label><input type="text" name="cliente" id="transf_cliente" class="form-control"></div>
                        <div class="col-4"><label>Empresa</label><input type="text" name="empresa" id="transf_empresa" class="form-control"></div>
                        
                        <!-- Linha 3 -->
                        <div class="col-3"><label>Peso Unitário</label><input type="text" name="peso_unitario" id="transf_peso" class="form-control"></div>
                        <div class="col-3"><label>Embalagem</label>
                            <select name="embalagem" id="transf_embalagem" class="form-select">
                                <option value="BAG">BAG</option>
                                <option value="SC">Saco</option>
                                <option value="CX">Caixa</option>
                                <option value="FD">Fardo</option>
                                <option value="PL">Pallets</option>
                            </select>
                        </div>
                        <div class="col-3"><label>Saldo</label><input type="text" id="transf_saldo" class="form-control bg-light" readonly></div>
                        <div class="col-3"><label>Entrada</label><input type="text" id="transf_entrada" class="form-control bg-light" readonly></div>
                        
                        <div class="col-12 mt-2">
                            <a class="text-primary text-decoration-none small fw-bold" data-bs-toggle="collapse" href="#advancedFields">
                                <i class="fas fa-cog me-1"></i> Dados Técnicos (Cultivar, Peneira...)
                            </a>
                            <div class="collapse show mt-2" id="advancedFields">
                                <div class="row g-2 bg-light p-3 rounded border">
                                    <div class="col-6">
                                        <label>Cultivar</label>
                                        <select name="cultivar" id="transf_cultivar" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for c in all_cultivares %}
                                            <option value="{{ c.id }}">{{ c.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Peneira</label>
                                        <select name="peneira" id="transf_peneira" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for p in all_peneiras %}
                                            <option value="{{ p.id }}">{{ p.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Categoria</label>
                                        <select name="categoria" id="transf_categoria" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for c in all_categorias %}
                                            <option value="{{ c.id }}">{{ c.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Tratamento</label>
                                        <select name="tratamento" id="transf_tratamento" class="form-select">
                                            <option value="">Nenhum</option>
                                            {% for t in all_tratamentos %}
                                            <option value="{{ t.id }}">{{ t.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label>Observação</label>
                        <textarea name="observacao" id="transf_obs" class="form-control" rows="2" placeholder="Adicione observações sobre a transferência..."></textarea>
                    </div>
                    
                    <div class="mt-2">
                        <label><i class="fas fa-camera me-1"></i> Fotos da Transferência</label>
                        <input type="file" name="fotos" class="form-control" multiple accept="image/*">
                        <small class="text-muted">Opcional: Adicione fotos do lote sendo transferido</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning fw-bold text-white">
                        <i class="fas fa-exchange-alt me-1"></i>Confirmar Transferência
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAIS DENTRO DO LOOP -->
{% for item in estoque %}
    <!-- 3. MODAL DE SAÍDA (EXPEDIÇÃO) -->
    <div class="modal fade" id="modalSaida{{ item.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-truck me-2"></i>Expedição - {{ item.lote }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'sapp:registrar_saida' item.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="text-center py-3 bg-danger bg-opacity-10 rounded border border-danger mb-3">
                            <small class="text-danger text-uppercase fw-bold">Saldo Disponível</small>
                            <div class="fs-1 fw-bold text-danger">{{ item.saldo }}</div>
                            <small class="text-muted">{{ item.embalagem }}</small>
                        </div>
                        <div class="row g-2">
                            <div class="col-6"><label class="fw-bold">Qtd Saída *</label><input type="number" name="quantidade_saida" class="form-control border-danger fw-bold" max="{{ item.saldo }}" min="1" required></div>
                            <div class="col-6"><label>Nº Carga *</label><input type="text" name="numero_carga" class="form-control" required></div>
                            <div class="col-6"><label>Motorista *</label><input type="text" name="motorista" class="form-control" required></div>
                            <div class="col-6"><label>Placa *</label><input type="text" name="placa" class="form-control" required></div>
                            <div class="col-12"><label>Cliente</label><input type="text" name="cliente" class="form-control" value="{{ item.cliente|default:'' }}"></div>
                            <div class="col-12"><label>Fotos (Obrigatório)</label><input type="file" name="fotos" class="form-control" multiple required></div>
                            <div class="col-12"><label>Observação</label><textarea name="observacao" class="form-control" rows="2"></textarea></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Confirmar Saída</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 4. MODAL DE EDITAR (COMPLETO E TURBINADO) -->
    <div class="modal fade" id="modalEditar{{ item.id }}" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Lote {{ item.lote }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'sapp:editar' item.id %}">
                    {% csrf_token %}
                    <div class="modal-body text-start">
                        
                        <!-- Seção 1: Dados Principais -->
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="fas fa-box me-1"></i> Dados do Lote</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Número do Lote</label>
                                <input type="text" name="lote" class="form-control bg-light" value="{{ item.lote }}" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Armazém (AZ)</label>
                                <input type="text" name="az" class="form-control" value="{{ item.az|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Endereço</label>
                                <input type="text" name="endereco" class="form-control border-primary" value="{{ item.endereco }}" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Espécie</label>
                                <select name="especie" class="form-select select2-modal">
                                    <option value="">Selecione...</option>
                                    {% for e in all_especies %}
                                    <option value="{{ e.id }}" {% if item.especie_id == e.id %}selected{% endif %}>{{ e.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Embalagem</label>
                                <select name="embalagem" class="form-select">
                                    <option value="BAG" {% if item.embalagem == 'BAG' %}selected{% endif %}>Big Bag</option>
                                    <option value="SC" {% if item.embalagem == 'SC' %}selected{% endif %}>Saco</option>
                                </select>
                            </div>
                        </div>

                        <!-- Seção 2: Classificação -->
                        <h6 class="fw-bold text-success border-bottom pb-2 mb-3"><i class="fas fa-leaf me-1"></i> Classificação Técnica</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Cultivar</label>
                                <select name="cultivar" class="form-select select2-modal">
                                    {% for c in all_cultivares %}
                                    <option value="{{ c.id }}" {% if c.id == item.cultivar.id %}selected{% endif %}>{{ c.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Peneira</label>
                                <select name="peneira" class="form-select select2-modal">
                                    {% for p in all_peneiras %}
                                    <option value="{{ p.id }}" {% if p.id == item.peneira.id %}selected{% endif %}>{{ p.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Categoria</label>
                                <select name="categoria" class="form-select select2-modal">
                                    {% for c in all_categorias %}
                                    <option value="{{ c.id }}" {% if c.id == item.categoria.id %}selected{% endif %}>{{ c.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tratamento</label>
                                <select name="tratamento" class="form-select select2-modal">
                                    <option value="">Sem Tratamento</option>
                                    {% for t in all_tratamentos %}
                                    <option value="{{ t.id }}" {% if t.id == item.tratamento.id %}selected{% endif %}>{{ t.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Seção 3: Logística e Info -->
                        <h6 class="fw-bold text-info border-bottom pb-2 mb-3"><i class="fas fa-truck me-1"></i> Logística e Informações</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Produto / Descrição</label>
                                <input type="text" name="produto" class="form-control" value="{{ item.produto|default:'' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Cliente / Proprietário</label>
                                <input type="text" name="cliente" class="form-control" value="{{ item.cliente|default:'' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Empresa</label>
                                <input type="text" name="empresa" class="form-control" value="{{ item.empresa|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Peso Unitário (kg)</label>
                                <input type="text" name="peso_unitario" class="form-control" value="{{ item.peso_unitario }}">
                            </div>
                         
                            <div class="col-md-3">
                                <label class="form-label">Origem/Destino</label>
                                <input type="text" name="origem_destino" class="form-control" value="{{ item.origem_destino|default:'' }}">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Observações</label>
                                <textarea name="observacao" class="form-control" rows="2">{{ item.observacao|default:'' }}</textarea>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary px-4 fw-bold">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endfor %}