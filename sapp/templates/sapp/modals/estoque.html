<!-- ESTRUTURA DO MODAL -->
<div class="modal fade" id="modalNovaEntrada" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen-sm-down modal-xl modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-4">
            <!-- Header -->
            <div class="modal-header bg-primary text-white border-0 py-3 rounded-top-4">
                <h5 class="modal-title fw-bold d-flex align-items-center">
                    <i class="bi bi-box-seam me-2"></i> Nova Entrada de Estoque
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="formNovaEntrada" method="POST" action="{% url 'sapp:nova_entrada' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body p-4 bg-light position-relative">
                    
                    <!-- Scanner Overlay -->
                    <div id="scannerOverlay" class="d-none position-absolute top-0 start-0 w-100 h-100 bg-dark z-3 rounded-4 flex-column align-items-center justify-content-center">
                        <div id="scannerReader" style="width: 100%; max-width: 500px;" class="overflow-hidden rounded-3 shadow"></div>
                        <button type="button" class="btn btn-danger btn-lg mt-4 px-5 fw-bold" onclick="ScannerApp.stop()">
                             Parar Câmera
                        </button>
                    </div>

                    <div class="row g-3">
                        <!-- SEÇÃO 1: IDENTIFICAÇÃO -->
                        <div class="col-12"><h6 class="text-primary fw-bold mb-0 mt-2">Identificação Principal</h6><hr class="mt-1"></div>
                        
                        <div class="col-md-8 position-relative">
                            <label class="form-label small fw-bold">Número do Lote *</label>
                            <div class="input-group">
                                <input type="text" name="lote" id="inputLote" class="form-control form-control-lg fw-bold" required autocomplete="off" placeholder="Digite o lote ou escaneie">
                                <button type="button" class="btn btn-primary px-3" onclick="ScannerApp.start()" title="Escanear QR Code">
                                    <i class="bi bi-qr-code-scan fs-5"></i>
                                </button>
                            </div>
                            <!-- Dropdown Autocomplete Corrigido -->
                            <div id="autoCompleteList" class="dropdown-menu shadow-lg w-100"></div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Quantidade *</label>
                            <input type="number" name="entrada" id="inputQtd" class="form-control form-control-lg text-center fw-bold" required min="1" placeholder="0">
                        </div>

                        <!-- SEÇÃO 2: LOCALIZAÇÃO -->
                        <div class="col-12"><h6 class="text-primary fw-bold mb-0 mt-3">Localização e Origem</h6><hr class="mt-1"></div>
                        
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold">Origem / Destino *</label>
                            <input type="text" name="origem_destino" id="inputOrigem" class="form-control" required placeholder="Ex: Produção Interna">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold">Endereço *</label>
                            <input type="text" name="endereco" id="inputEndereco" class="form-control text-uppercase" required placeholder="P01-A01">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold">Armazém (AZ) *</label>
                            <input type="text" name="az" id="inputAz" class="form-control text-uppercase" required placeholder="AZ-01">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold">Cliente</label>
                            <input type="text" name="cliente" id="inputCliente" class="form-control">
                        </div>

                        <!-- SEÇÃO 3: PRODUTO E DADOS TÉCNICOS -->
                        <div class="col-12"><h6 class="text-primary fw-bold mb-0 mt-3">Dados do Produto e SKU</h6><hr class="mt-1"></div>
                        
                        <div class="col-md-12 col-lg-4">
                            <label class="form-label small fw-bold">Código do Produto (SKU)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" name="produto" id="inputSKU" class="form-control fw-bold" placeholder="Digite SKU para buscar dados">
                            </div>
                            <small id="skuLoading" class="text-primary d-none">Buscando dados...</small>
                        </div>

                        <div class="col-md-6 col-lg-4">
                            <label class="form-label small fw-bold">Espécie *</label>
                            <select name="especie" id="selEspecie" class="form-select" required>
                                <option value="">Selecione...</option>
                                {% for e in all_especies %}<option value="{{ e.id }}">{{ e.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label class="form-label small fw-bold">Cultivar *</label>
                            <select name="cultivar" id="selCultivar" class="form-select" required>
                                <option value="">Selecione...</option>
                                {% for c in all_cultivares %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Peneira *</label>
                            <select name="peneira" id="selPeneira" class="form-select" required>
                                <option value="">Selecione...</option>
                                {% for p in all_peneiras %}<option value="{{ p.id }}">{{ p.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Categoria *</label>
                            <select name="categoria" id="selCategoria" class="form-select" required>
                                <option value="">Selecione...</option>
                                {% for c in all_categorias %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Tratamento</label>
                            <select name="tratamento" id="selTratamento" class="form-select">
                                <option value="">Nenhum tratamento</option>
                                {% for t in all_tratamentos %}<option value="{{ t.id }}">{{ t.nome }}</option>{% endfor %}
                            </select>
                        </div>

                        <!-- SEÇÃO 4: COMPLEMENTO -->
                        <div class="col-12"><h6 class="text-primary fw-bold mb-0 mt-3">Complementares</h6><hr class="mt-1"></div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Empresa</label>
                            <input type="text" name="empresa" id="inputEmpresa" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Embalagem</label>
                            <select name="embalagem" id="selEmbalagem" class="form-select">
                                <option value="BAG">BIG BAG</option>
                                <option value="SC">SACO (SC)</option>
                                <option value="CX">CAIXA</option>
                                <option value="PL">PALLET</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Peso Unit. (Kg)</label>
                            <input type="number" step="0.01" name="peso_unitario" id="inputPeso" class="form-control" placeholder="0.00">
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold">Fotos / Arquivos</label>
                            <input type="file" name="fotos" class="form-control" multiple accept="image/*">
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold">Observações Adicionais</label>
                            <textarea name="observacao" id="inputObs" class="form-control" rows="2" placeholder="Notas, histórico ou avisos..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-0 p-3 bg-white rounded-bottom-4">
                    <button type="button" class="btn btn-light btn-lg px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary btn-lg px-5 shadow fw-bold">Confirmar Registro</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ESTILO -->
<style>
    #autoCompleteList { max-height: 300px; overflow-y: auto; display: none; margin-top: 2px; border-radius: 8px; }
    .autocomplete-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f1f1; }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover { background-color: #f8f9fa; }
    .autocomplete-item strong { display: block; color: #0d6efd; font-family: monospace; }
    .autocomplete-item small { display: block; color: #6c757d; font-size: 0.8rem; margin-top: 2px; }

    @media (max-width: 575.98px) {
        .modal-fullscreen-sm-down { width: 100vw; height: 100%; margin: 0; }
        .modal-fullscreen-sm-down .modal-content { height: 100%; border-radius: 0 !important; }
        .modal-fullscreen-sm-down .modal-body { overflow-y: auto; padding: 20px !important; }
        .modal-footer { padding: 15px !important; flex-direction: column-reverse; }
        .modal-footer .btn { width: 100%; margin: 5px 0; }
    }
    .is-invalid { border-color: #dc3545 !important; background-image: none !important; }
    #scannerReader video { object-fit: cover !important; }
</style>

<!-- SCRIPTS DE LÓGICA -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const StockApp = {
        debounce: null,
        
        init() {
            this.setupAutocomplete();
            this.setupSKUSearch();
            this.setupValidation();
            this.setupClean();
        },

        // AUTOCOMPLETE LOTE (CORRIGIDO: item.dados)
        setupAutocomplete() {
            const input = document.getElementById('inputLote');
            const list = document.getElementById('autoCompleteList');

            input.addEventListener('input', (e) => {
                clearTimeout(this.debounce);
                const term = e.target.value;
                if (term.length < 3) { list.style.display = 'none'; return; }

                this.debounce = setTimeout(() => {
                    fetch(`/api/autocomplete-lotes/?term=${encodeURIComponent(term)}`)
                        .then(r => r.json())
                        .then(data => {
                            list.innerHTML = '';
                            if (data.length > 0) {
                                list.style.display = 'block';
                                data.forEach(item => {
                                    const d = item.dados;
                                    const div = document.createElement('div');
                                    div.className = 'autocomplete-item';
                                    div.innerHTML = `<strong>${d.lote}</strong><small>Prod: ${d.produto || 'N/A'} | End: ${d.endereco || '?'}</small>`;
                                    div.addEventListener('mousedown', (evt) => {
                                        evt.preventDefault();
                                        this.fillFromData(d);
                                    });
                                    list.appendChild(div);
                                });
                            } else { list.style.display = 'none'; }
                        });
                }, 400);
            });

            // Corregido: Fechar ao perder foco mas permitir clique
            input.addEventListener('blur', () => {
                setTimeout(() => list.style.display = 'none', 200);
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.style.display = 'none';
                }
            });
        },

        // BUSCA SKU (CORRIGIDO: encontrado / dados)
        setupSKUSearch() {
            const input = document.getElementById('inputSKU');
            const loading = document.getElementById('skuLoading');

            input.addEventListener('blur', () => {
                const cod = input.value.trim();
                if (!cod) return;

                loading.classList.remove('d-none');
                fetch(`/api/buscar-produto/?codigo=${encodeURIComponent(cod)}`)
                    .then(r => r.json())
                    .then(data => {
                        loading.classList.add('d-none');
                        // Lógica corrigida conforme a API:
                        if (data.encontrado) {
                            this.fillFields(data.dados);
                        }
                    })
                    .catch(() => loading.classList.add('d-none'));
            });
        },

        // POPULAR FORMULÁRIO (CORRIGIDO)
        fillFromData(d) {
            document.getElementById('inputLote').value = d.lote || '';
            document.getElementById('inputSKU').value = d.produto || '';
            document.getElementById('inputOrigem').value = d.origem_destino || '';
            document.getElementById('inputEndereco').value = d.endereco || '';
            document.getElementById('inputAz').value = d.az || '';
            this.fillFields(d);
            document.getElementById('autoCompleteList').style.display = 'none';
            document.getElementById('inputQtd').focus();
        },

        fillFields(d) {
            // Mapeamento corrigido para lidar com ids normais ou Django __id
            const setValue = (id, val) => {
                const el = document.getElementById(id);
                if (el && val) el.value = val;
            };

            setValue('selEspecie', d.especie_id || d.especie__id);
            setValue('selCultivar', d.cultivar_id || d.cultivar__id);
            setValue('selPeneira', d.peneira_id || d.peneira__id);
            setValue('selCategoria', d.categoria_id || d.categoria__id);
            setValue('selTratamento', d.tratamento_id || d.tratamento__id);
            
            setValue('inputEmpresa', d.empresa);
            setValue('inputCliente', d.cliente);
            setValue('inputPeso', d.peso_unitario);
            setValue('selEmbalagem', d.embalagem);
        },

        setupValidation() {
            const form = document.getElementById('formNovaEntrada');
            form.addEventListener('submit', (e) => {
                const reqs = form.querySelectorAll('[required]');
                let valid = true;
                reqs.forEach(el => {
                    if (!el.value.trim()) {
                        el.classList.add('is-invalid');
                        valid = false;
                    } else { el.classList.remove('is-invalid'); }
                });
                if (!valid) { e.preventDefault(); alert("Campos obrigatórios pendentes."); }
            });
        },

        setupClean() {
            const modal = document.getElementById('modalNovaEntrada');
            modal.addEventListener('hidden.bs.modal', () => {
                document.getElementById('formNovaEntrada').reset();
                ScannerApp.stop();
            });
        }
    };

    const ScannerApp = {
        html5QrCode: null,
        
        async start() {
            const overlay = document.getElementById('scannerOverlay');
            overlay.classList.remove('d-none');
            overlay.classList.add('d-flex');

            try {
                if (!this.html5QrCode) {
                    this.html5QrCode = new Html5Qrcode("scannerReader");
                }
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                await this.html5QrCode.start({ facingMode: "environment" }, config, (txt) => {
                    const partes = txt.split('/');
                    if (partes.length >= 2) {
                        document.getElementById('inputSKU').value = partes[0];
                        document.getElementById('inputLote').value = partes[1];
                        // Trigger busca SKU automática
                        document.getElementById('inputSKU').dispatchEvent(new Event('blur'));
                        this.stop();
                        setTimeout(() => document.getElementById('inputQtd').focus(), 300);
                    }
                });
            } catch (err) { this.stop(); }
        },

        async stop() {
            const overlay = document.getElementById('scannerOverlay');
            if (this.html5QrCode && this.html5QrCode.isScanning) {
                await this.html5QrCode.stop();
            }
            overlay.classList.replace('d-flex', 'd-none');
        }
    };

    document.addEventListener('DOMContentLoaded', () => StockApp.init());
</script>































<!-- === MODAL TRANSFERÊNCIA === -->
<div class="modal fade" id="modalTransferencia" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Transferir e Ajustar</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formTransferencia" method="POST" action="{% url 'sapp:transferir' 0 %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="item_id" id="transf_item_id">
                <div class="modal-body">
                    <!-- SALDO DESTAQUE -->
                    <div class="text-center py-2 bg-light rounded border mb-3">
                        <small class="text-muted text-uppercase fw-bold">Saldo Atual</small>
                        <div class="fs-2 fw-bold text-dark" id="transf_saldo_atual">0</div>
                        <small class="text-muted" id="transf_endereco_atual">Endereço: </small>
                    </div>

                    <div class="row mb-3 p-3 bg-warning bg-opacity-10 rounded border border-warning">
                        <div class="col-12 mb-2"><h6 class="text-warning fw-bold border-bottom border-warning pb-2">Destino da Transferência</h6></div>
                        <div class="col-6 mb-2"><label class="fw-bold">Novo Endereço *</label><input type="text" name="novo_endereco" class="form-control border-warning" required></div>
                        <div class="col-3 mb-2"><label class="fw-bold">Qtd *</label><input type="number" name="quantidade" id="transf_quantidade" class="form-control border-warning fw-bold" required min="1"></div>
                        <div class="col-3 mb-2"><label>AZ</label><input type="text" name="az" id="transf_az" class="form-control"></div>
                    </div>

                    <div class="row g-2">
                        <div class="col-12">
                            <h6 class="text-muted border-bottom pb-1">
                                <i class="fas fa-info-circle me-1"></i>Dados do Item (Editar se necessário)
                                <small class="text-muted ms-2">Tudo abaixo já está preenchido com os dados atuais do lote</small>
                            </h6>
                        </div>
                        
                        <!-- Linha 1 -->
                        <div class="col-3"><label>Lote</label><input type="text" class="form-control bg-light" id="transf_lote_display" readonly></div>
                        <div class="col-9"><label>Produto</label><input type="text" name="produto" id="transf_produto" class="form-control"></div>
                        
                        <!-- Linha 2 -->
                        <div class="col-4">
                            <label>Espécie</label>
                            <select name="especie" id="transf_especie" class="form-select">
                                <option value="">Selecione...</option>
                                {% for e in all_especies %}<option value="{{ e.id }}">{{ e.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-4"><label>Cliente</label><input type="text" name="cliente" id="transf_cliente" class="form-control"></div>
                        <div class="col-4"><label>Empresa</label><input type="text" name="empresa" id="transf_empresa" class="form-control"></div>
                        
                        <!-- Linha 3 -->
                        <div class="col-3"><label>Peso Unitário</label><input type="text" name="peso_unitario" id="transf_peso" class="form-control"></div>
                        <div class="col-3"><label>Embalagem</label>
                            <select name="embalagem" id="transf_embalagem" class="form-select">
                                <option value="BAG">BAG</option>
                                <option value="SC">Saco</option>
                                <option value="CX">Caixa</option>
                                <option value="FD">Fardo</option>
                                <option value="PL">Pallets</option>
                            </select>
                        </div>
                        <div class="col-3"><label>Saldo</label><input type="text" id="transf_saldo" class="form-control bg-light" readonly></div>
                        <div class="col-3"><label>Entrada</label><input type="text" id="transf_entrada" class="form-control bg-light" readonly></div>
                        
                        <div class="col-12 mt-2">
                            <a class="text-primary text-decoration-none small fw-bold" data-bs-toggle="collapse" href="#advancedFields">
                                <i class="fas fa-cog me-1"></i> Dados Técnicos (Cultivar, Peneira...)
                            </a>
                            <div class="collapse show mt-2" id="advancedFields">
                                <div class="row g-2 bg-light p-3 rounded border">
                                    <div class="col-6">
                                        <label>Cultivar</label>
                                        <select name="cultivar" id="transf_cultivar" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for c in all_cultivares %}
                                            <option value="{{ c.id }}">{{ c.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Peneira</label>
                                        <select name="peneira" id="transf_peneira" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for p in all_peneiras %}
                                            <option value="{{ p.id }}">{{ p.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Categoria</label>
                                        <select name="categoria" id="transf_categoria" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for c in all_categorias %}
                                            <option value="{{ c.id }}">{{ c.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label>Tratamento</label>
                                        <select name="tratamento" id="transf_tratamento" class="form-select">
                                            <option value="">Nenhum</option>
                                            {% for t in all_tratamentos %}
                                            <option value="{{ t.id }}">{{ t.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label>Observação</label>
                        <textarea name="observacao" id="transf_obs" class="form-control" rows="2" placeholder="Adicione observações sobre a transferência..."></textarea>
                    </div>
                    
                    <div class="mt-2">
                        <label><i class="fas fa-camera me-1"></i> Fotos da Transferência</label>
                        <input type="file" name="fotos" class="form-control" multiple accept="image/*">
                        <small class="text-muted">Opcional: Adicione fotos do lote sendo transferido</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning fw-bold text-white">
                        <i class="fas fa-exchange-alt me-1"></i>Confirmar Transferência
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAIS DENTRO DO LOOP -->
{% for item in estoque %}
    <!-- 3. MODAL DE SAÍDA (EXPEDIÇÃO) -->
    <div class="modal fade" id="modalSaida{{ item.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-truck me-2"></i>Expedição - {{ item.lote }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'sapp:registrar_saida' item.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="text-center py-3 bg-danger bg-opacity-10 rounded border border-danger mb-3">
                            <small class="text-danger text-uppercase fw-bold">Saldo Disponível</small>
                            <div class="fs-1 fw-bold text-danger">{{ item.saldo }}</div>
                            <small class="text-muted">{{ item.embalagem }}</small>
                        </div>
                        <div class="row g-2">
                            <div class="col-6"><label class="fw-bold">Qtd Saída *</label><input type="number" name="quantidade_saida" class="form-control border-danger fw-bold" max="{{ item.saldo }}" min="1" required></div>
                            <div class="col-6"><label>Nº Carga *</label><input type="text" name="numero_carga" class="form-control" required></div>
                            <div class="col-6"><label>Motorista *</label><input type="text" name="motorista" class="form-control" required></div>
                            <div class="col-6"><label>Placa *</label><input type="text" name="placa" class="form-control" required></div>
                            <div class="col-12"><label>Cliente</label><input type="text" name="cliente" class="form-control" value="{{ item.cliente|default:'' }}"></div>
                            <div class="col-12"><label>Fotos (Obrigatório)</label><input type="file" name="fotos" class="form-control" multiple required></div>
                            <div class="col-12"><label>Observação</label><textarea name="observacao" class="form-control" rows="2"></textarea></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Confirmar Saída</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 4. MODAL DE EDITAR (COMPLETO E TURBINADO) -->
    <div class="modal fade" id="modalEditar{{ item.id }}" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Lote {{ item.lote }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'sapp:editar' item.id %}">
                    {% csrf_token %}
                    <div class="modal-body text-start">
                        
                        <!-- Seção 1: Dados Principais -->
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="fas fa-box me-1"></i> Dados do Lote</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Número do Lote</label>
                                <input type="text" name="lote" class="form-control bg-light" value="{{ item.lote }}" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Armazém (AZ)</label>
                                <input type="text" name="az" class="form-control" value="{{ item.az|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Endereço</label>
                                <input type="text" name="endereco" class="form-control border-primary" value="{{ item.endereco }}" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Espécie</label>
                                <select name="especie" class="form-select select2-modal">
                                    <option value="">Selecione...</option>
                                    {% for e in all_especies %}
                                    <option value="{{ e.id }}" {% if item.especie_id == e.id %}selected{% endif %}>{{ e.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Embalagem</label>
                                <select name="embalagem" class="form-select">
                                    <option value="BAG" {% if item.embalagem == 'BAG' %}selected{% endif %}>Big Bag</option>
                                    <option value="SC" {% if item.embalagem == 'SC' %}selected{% endif %}>Saco</option>
                                </select>
                            </div>
                        </div>

                        <!-- Seção 2: Classificação -->
                        <h6 class="fw-bold text-success border-bottom pb-2 mb-3"><i class="fas fa-leaf me-1"></i> Classificação Técnica</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Cultivar</label>
                                <select name="cultivar" class="form-select select2-modal">
                                    {% for c in all_cultivares %}
                                    <option value="{{ c.id }}" {% if c.id == item.cultivar.id %}selected{% endif %}>{{ c.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Peneira</label>
                                <select name="peneira" class="form-select select2-modal">
                                    {% for p in all_peneiras %}
                                    <option value="{{ p.id }}" {% if p.id == item.peneira.id %}selected{% endif %}>{{ p.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Categoria</label>
                                <select name="categoria" class="form-select select2-modal">
                                    {% for c in all_categorias %}
                                    <option value="{{ c.id }}" {% if c.id == item.categoria.id %}selected{% endif %}>{{ c.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tratamento</label>
                                <select name="tratamento" class="form-select select2-modal">
                                    <option value="">Sem Tratamento</option>
                                    {% for t in all_tratamentos %}
                                    <option value="{{ t.id }}" {% if t.id == item.tratamento.id %}selected{% endif %}>{{ t.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Seção 3: Logística e Info -->
                        <h6 class="fw-bold text-info border-bottom pb-2 mb-3"><i class="fas fa-truck me-1"></i> Logística e Informações</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Produto / Descrição</label>
                                <input type="text" name="produto" class="form-control" value="{{ item.produto|default:'' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Cliente / Proprietário</label>
                                <input type="text" name="cliente" class="form-control" value="{{ item.cliente|default:'' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Empresa</label>
                                <input type="text" name="empresa" class="form-control" value="{{ item.empresa|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Peso Unitário (kg)</label>
                                <input type="text" name="peso_unitario" class="form-control" value="{{ item.peso_unitario }}">
                            </div>
                         
                            <div class="col-md-3">
                                <label class="form-label">Origem/Destino</label>
                                <input type="text" name="origem_destino" class="form-control" value="{{ item.origem_destino|default:'' }}">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Observações</label>
                                <textarea name="observacao" class="form-control" rows="2">{{ item.observacao|default:'' }}</textarea>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary px-4 fw-bold">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endfor %}