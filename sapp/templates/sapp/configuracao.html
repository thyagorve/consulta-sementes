{% extends "sapp/base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Importar Dados do Excel</h2>
    <p>Copie os dados completos da sua planilha Excel (incluindo a linha do cabeçalho) e clique no botão correspondente abaixo para importar. Os dados existentes serão apagados.</p>

    <!-- Área de Status e Progresso -->
    <div id="status-area" class="d-none alert fade show" role="alert">
        <div id="status-message"></div>
        <div class="progress mt-2" style="height: 25px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <button type="button" class="btn-close" aria-label="Close" onclick="document.getElementById('status-area').classList.add('d-none');"></button>
    </div>

    <div class="row mt-3">
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Importar planila de Produtos</h5>
                    <p class="card-text">
                        Vai gerar uma tabela identica a planila de produtos que vai esta na pagina (Produtos) <br>
                        <code>
                        1 - Na planilha de produtos, clique na linha (onde começa o titulos).<br>
                        2 - Pressione CTRL + ↓ para ir até a última linha preenchida.<br>
                        3 - Com tudo selecionado, pressione CTRL + C para copiar<br>
                        4 - Volte aqui e clique no botão abaixo para colar os dados.
                        </code>
                    </p>
                    <button class="btn-import btn btn-primary" data-tipo="cadastro">
                        <i class="fas fa-paste"></i> Colar e Importar Produtos
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Importar Mapa de oculpação</h5>
                    <p class="card-text">
                        Vai gerar uma tabela identica ao mapa de ocupação que vai esta na pagina (Endereço) <br>
                        <code>
                        1 - No mapa de oculpação, clique na linha 10 (onde começa o titulos).<br>
                        2 - Pressione CTRL + ↓ para ir até a última linha preenchida.<br>
                        3 - Com tudo selecionado, pressione CTRL + C para copiar, aguarde e clique em ok se aparcer alguma msg<br>
                        4 - Volte aqui e clique no botão abaixo para colar os dados.
                        </code>
                        </p>

                    <button class="btn-import btn btn-success" data-tipo="lotes">
                        <i class="fas fa-paste"></i> Colar e Importar Mapa de oculpação
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <hr class="my-5">

    <h2 class="mb-4">Configurar Exibição da Consulta</h2>
    <p>Marque os campos que você deseja que apareçam nos resultados da página de consulta de Produtos e Lotes.<code> Não se esqueça de salvar!</code></p>
    
    <form method="POST">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6">
                <h5>Campos do Produto</h5>
                <div class="card p-3" style="max-height: 400px; overflow-y: auto;">
                    {% for checkbox in form_config.campos_visiveis_produto %}
                        <div class="form-check">
                            {{ checkbox.tag }}
                            <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                {{ checkbox.choice_label }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6 mt-3 mt-md-0">
                <h5>Campos do Lote</h5>
                <div class="card p-3" style="max-height: 400px; overflow-y: auto;">
                    {% for checkbox in form_config.campos_visiveis_lote %}
                        <div class="form-check">
                            {{ checkbox.tag }}
                            <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                {{ checkbox.choice_label }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-4">Salvar Configurações de Exibição</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const CHUNK_SIZE = 500; // Processar 500 linhas por vez. Ajuste se necessário.
    const importButtons = document.querySelectorAll('.btn-import');
    const statusArea = document.getElementById('status-area');
    const statusMessage = document.getElementById('status-message');
    const progressBar = document.getElementById('progress-bar');

    const handleImportClick = async (event) => {
        const btn = event.target.closest('.btn-import'); // Garante que o clique no ícone ou texto funciona
        if (!btn) return; // Se clicou fora do botão, sai
        
        const tipoModelo = btn.dataset.tipo;

        try {
            const clipboardText = await navigator.clipboard.readText();
            if (!clipboardText.trim()) {
                showStatus('Área de transferência vazia. Copie os dados do Excel primeiro.', 'warning', true);
                return;
            }

            const lines = clipboardText.trim().split('\n');
            if (lines.length < 2) { // Pelo menos cabeçalho e uma linha de dados
                showStatus('Dados insuficientes. Copie pelo menos o cabeçalho e uma linha de dados.', 'warning', true);
                return;
            }
            
            const header = lines.shift(); // Pega a primeira linha como cabeçalho
            const dataRows = lines;
            const totalChunks = Math.ceil(dataRows.length / CHUNK_SIZE);
            
            disableButtons(true);
            showStatus(`Iniciando importação de ${dataRows.length} registros...`, 'info');
            updateProgress(0);

            let totalRegistrosProcessados = 0;

            for (let i = 0; i < totalChunks; i++) {
                const start = i * CHUNK_SIZE;
                const end = start + CHUNK_SIZE;
                const chunk = dataRows.slice(start, end).join('\n');
                
                showStatus(`Enviando lote ${i + 1} de ${totalChunks}...`, 'info');

                const formData = new FormData();
                formData.append('tipo_modelo', tipoModelo);
                formData.append('dados_lote', chunk);
                formData.append('cabecalho', header); // Envia o cabeçalho em cada chunk
                formData.append('is_first_chunk', i === 0);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch("{% url 'sapp:api_importar_lotes_clipboard' %}", {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.status !== 200 || data.status !== 'sucesso') {
                    // Trata erros de validação ou outros erros do backend
                    const errorMessage = data.mensagem || 'Ocorreu um erro desconhecido no servidor.';
                    throw new Error(errorMessage);
                }
                
                totalRegistrosProcessados += data.registros_processados;
                const progressPercentage = Math.round(((i + 1) / totalChunks) * 100);
                updateProgress(progressPercentage);
            }
            
            showStatus(`Importação concluída com sucesso! ${totalRegistrosProcessados} registros importados.`, 'success', true);
            disableButtons(false);
            // Opcional: Limpar o clipboard após a importação bem-sucedida
            navigator.clipboard.writeText('').catch(err => console.error('Falha ao limpar clipboard:', err));

        } catch (error) {
            showStatus(`ERRO: ${error.message}`, 'danger', true);
            disableButtons(false);
        }
    };
    
    const showStatus = (message, type, hideProgress = false) => {
        statusMessage.className = ''; // Limpa classes anteriores
        statusMessage.textContent = message;
        statusArea.className = `alert alert-${type} fade show`; // Reinicia classes
        statusArea.classList.remove('d-none');
        if (hideProgress) {
             progressBar.parentElement.classList.add('d-none');
        } else {
             progressBar.parentElement.classList.remove('d-none');
        }
    };
    
    const updateProgress = (percentage) => {
        progressBar.style.width = `${percentage}%`;
        progressBar.textContent = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
    };
    
    const disableButtons = (disabled) => {
        importButtons.forEach(btn => btn.disabled = disabled);
    };

    importButtons.forEach(btn => btn.addEventListener('click', handleImportClick));
});
</script>
{% endblock %}