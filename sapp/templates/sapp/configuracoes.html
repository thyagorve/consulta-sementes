{% extends 'sapp/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    :root {
        --primary: #059669;
        --primary-dark: #064e3b;
        --slate-900: #0f172a;
        --slate-500: #64748b;
        --border-color: #e2e8f0;
        --radius-lg: 16px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    body {
        background-color: #f8fafc;
        font-family: 'Plus Jakarta Sans', sans-serif;
        color: var(--slate-900);
    }

    .config-container { padding: 1.5rem; max-width: 1650px; margin: 0 auto; }

    /* Header Hero */
    .hero-panel {
        background: linear-gradient(135deg, var(--primary-dark) 0%, #065f46 100%);
        border-radius: var(--radius-lg);
        padding: 1.5rem 2rem;
        color: white;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 15px 25px -5px rgba(0,0,0,0.1);
    }

    /* Menu de Navegação Superior */
    .nav-modern {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 10px;
        background: white;
        border-radius: 14px;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        scrollbar-width: none;
    }
    .nav-modern::-webkit-scrollbar { display: none; }

    .nav-btn {
        padding: 12px 22px;
        border-radius: 10px;
        color: var(--slate-500);
        font-weight: 700;
        font-size: 0.85rem;
        border: none;
        background: transparent;
        white-space: nowrap;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .nav-btn.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
    }

    .glass-card {
        background: white;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        box-shadow: var(--shadow);
    }

    /* Formulário Estilizado */
    .pro-form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.25rem;
        background: #fbfcfe;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }
    .col-full { grid-column: span 2; }
    .form-group label { display: block; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; color: var(--slate-500); margin-bottom: 5px; }
    .form-control-pro {
        width: 100%; padding: 0.8rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9rem;
    }
    .form-control-pro:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(5,150,105,0.1); }

    /* Estilo de Tabela (Desktop/Tablet) */
    .table-responsive-custom {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        background: #fff;
    }
    .table-pro {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    .table-pro thead {
        background: #f1f5f9;
        text-align: left;
    }
    .table-pro th {
        padding: 15px;
        font-weight: 800;
        color: var(--slate-700);
        text-transform: uppercase;
        font-size: 0.65rem;
        letter-spacing: 0.5px;
    }
    .table-pro td {
        padding: 14px 15px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
        white-space: normal;
        word-break: break-word;
    }
    .table-pro tr:hover { background: #fdfdfd; }

    /* Status e Ações */
    .status-badge {
        background: #dcfce7;
        color: #166534;
        padding: 5px 12px;
        border-radius: 50px;
        font-weight: 800;
        font-size: 0.7rem;
    }
    .codigo-pill {
        background: #1e293b;
        color: white;
        padding: 4px 8px;
        border-radius: 5px;
        font-family: monospace;
        font-weight: bold;
    }

    /* Outros Itens (Cultivar, etc) */
    .others-item {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.2s;
    }
    .others-item:hover { border-color: var(--primary); transform: translateX(5px); }

    .btn-main { background: var(--primary); color: white; padding: 1rem; border: none; border-radius: 10px; font-weight: 800; width: 100%; cursor: pointer; }
    .btn-del { color: #ef4444; background: #fee2e2; width: 34px; height: 34px; border-radius: 6px; display: grid; place-items: center; border: none; transition: 0.2s; }
    .btn-del:hover { background: #ef4444; color: white; }

    @media (max-width: 991px) { .pro-form-grid { grid-template-columns: 1fr; } .col-full { grid-column: span 1; } }
</style>

<div class="config-container">
    
    <header class="hero-panel">
        <div>
            <h1><i class="fas fa-cog me-2"></i> Configurações do Sistema</h1>
            <p class="mb-0 opacity-75">Controle mestre de estoque e registros auxiliares.</p>
        </div>
        <div class="d-none d-md-block"><span class="badge bg-white text-dark p-2">Sementes App v2.0</span></div>
    </header>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if 'error' in message.tags %}danger{% else %}success{% endif %} border-0 shadow-sm mb-4 rounded-4 d-flex align-items-center">
                <i class="fas fa-check-circle me-3"></i> {{ message }}
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <nav class="nav-modern" id="navTabs">
        <button class="nav-btn active" data-tab="produto"><i class="fas fa-cube"></i><span>Produtos</span></button>
        <button class="nav-btn" data-tab="cultivar"><i class="fas fa-seedling"></i><span>Cultivares</span></button>
        <button class="nav-btn" data-tab="peneira"><i class="fas fa-filter"></i><span>Peneiras</span></button>
        <button class="nav-btn" data-tab="especie"><i class="fas fa-leaf"></i><span>Espécies</span></button>
        <button class="nav-btn" data-tab="categoria"><i class="fas fa-tags"></i><span>Categorias</span></button>
        <button class="nav-btn" data-tab="tratamento"><i class="fas fa-vial"></i><span>Tratamentos</span></button>
        <button class="nav-btn" data-tab="conferente"><i class="fas fa-user-shield"></i><span>Contas</span></button>
    </nav>

    <main class="glass-card">
        <!-- PRODUTOS -->
        <div id="tab-produto" class="tab-content">
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="pro-form-grid">
                        <div class="col-full mb-1"><h5 class="m-0 fw-800"><i class="fas fa-plus-circle text-primary me-2"></i>Novo Cadastro</h5></div>
                        <form method="POST" class="col-full">
                            {% csrf_token %}
                            <input type="hidden" name="acao" value="add_produto">
                            <input type="hidden" name="active_tab" value="produto">
                            <!-- Envia Ativo=On por padrão -->
                            <input type="hidden" name="ativo" value="on">

                            <div class="pro-form-grid" style="border:none; padding:0;">
                                <div class="form-group col-full">
                                    <label>Cultivar *</label>
                                    <select name="cultivar" class="form-control-pro" required>
                                        <option value="">Selecione...</option>
                                        {% for c in cultivares %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="form-group col-full">
                                    <label>Código do Item *</label>
                                    <input type="text" name="codigo" class="form-control-pro" required placeholder="Ex: 50.400">
                                </div>
                                <div class="form-group">
                                    <label>Tipo</label>
                                    <input type="text" name="tipo" class="form-control-pro" placeholder="Soja">
                                </div>
                                <div class="form-group">
                                    <label>Empresa</label>
                                    <input type="text" name="empresa" class="form-control-pro" placeholder="Bio Seeds">
                                </div>
                                <div class="form-group">
                                    <label>Espécie</label>
                                    <select name="especie" class="form-control-pro">
                                        <option value="">Nenhuma</option>
                                        {% for e in especies %}<option value="{{ e.id }}">{{ e.nome }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Peneira</label>
                                    <select name="peneira" class="form-control-pro">
                                        <option value="">Nenhuma</option>
                                        {% for p in peneiras %}<option value="{{ p.id }}">{{ p.nome }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Categoria</label>
                                    <select name="categoria" class="form-control-pro">
                                        <option value="">Nenhuma</option>
                                        {% for cat in categorias %}<option value="{{ cat.id }}">{{ cat.nome }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Tratamento</label>
                                    <select name="tratamento" class="form-control-pro">
                                        <option value="">Nenhum</option>
                                        {% for t in tratamentos %}<option value="{{ t.id }}">{{ t.nome }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="form-group col-full">
                                    <label>Descrição</label>
                                    <textarea name="descricao" class="form-control-pro" rows="2"></textarea>
                                </div>
                                <div class="form-group col-full">
                                    <button type="submit" class="btn-main"><i class="fas fa-save me-2"></i> SALVAR PRODUTO</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="d-flex justify-content-between mb-3 px-1">
                        <h6 class="fw-800">Itens Cadastrados</h6>
                        <span class="badge bg-dark px-3 rounded-pill">{{ produtos|length }}</span>
                    </div>
                    <div class="table-responsive-custom shadow-sm" style="max-height: 700px; overflow-y:auto;">
                        <table class="table-pro">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Status</th>
                                    <th>Cultivar / Descrição</th>
                                    <th>Espec / Pen</th>
                                    <th>Empresa / Cat</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in produtos %}
                                <tr>
                                    <td><span class="codigo-pill">{{ p.codigo }}</span></td>
                                    <td><span class="status-badge">Operacional</span></td>
                                    <td>
                                        <strong class="d-block">{{ p.cultivar.nome }}</strong>
                                        <small class="text-muted">{{ p.descricao|default:"---" }}</small>
                                    </td>
                                    <td>
                                        <div class="small fw-bold">{{ p.especie.nome|default:"---" }}</div>
                                        <div class="small text-muted">{{ p.peneira.nome|default:"---" }}</div>
                                    </td>
                                    <td>
                                        <div class="small fw-bold text-success">{{ p.empresa|default:"Interno" }}</div>
                                        <div class="small text-muted">{{ p.categoria.nome|default:"---" }}</div>
                                    </td>
                                    <td class="text-center">
                                        <form method="POST" onsubmit="return confirm('Deseja excluir?')">
                                            {% csrf_token %}
                                            <input type="hidden" name="acao" value="delete_produto">
                                            <input type="hidden" name="id_item" value="{{ p.id }}">
                                            <input type="hidden" name="active_tab" value="produto">
                                            <button type="submit" class="btn-del mx-auto"><i class="fas fa-trash-alt"></i></button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA OUTROS (OUTRAS TABELAS) -->
        <div id="tab-others" class="tab-content" style="display: none;">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="pro-form-grid">
                        <h6 class="col-full fw-800 text-primary mb-1" id="other-title">Cadastrar Item</h6>
                        <form method="POST" class="col-full">
                            {% csrf_token %}
                            <input type="hidden" name="acao" id="o-acao">
                            <input type="hidden" name="tipo_item" id="o-tipo">
                            <input type="hidden" name="active_tab" id="o-active-tab">
                            <div class="mb-3">
                                <label id="o-label">Nome Oficial</label>
                                <input type="text" name="nome" class="form-control-pro" required placeholder="...">
                            </div>
                            <button type="submit" class="btn-main"><i class="fas fa-plus me-1"></i> ADICIONAR</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-7">
                    <div id="list-target"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    const auxData = {
        'cultivar': { title: 'Tabela de Cultivares', acao: 'add_cultivar', list: [{% for i in cultivares %}{id: {{i.id}}, n: "{{i.nome}}"},{% endfor %}] },
        'peneira': { title: 'Tabela de Peneiras', acao: 'add_peneira', list: [{% for i in peneiras %}{id: {{i.id}}, n: "{{i.nome}}"},{% endfor %}] },
        'especie': { title: 'Lista de Espécies', acao: 'add_especie', list: [{% for i in especies %}{id: {{i.id}}, n: "{{i.nome}}"},{% endfor %}] },
        'categoria': { title: 'Lista de Categorias', acao: 'add_categoria', list: [{% for i in categorias %}{id: {{i.id}}, n: "{{i.nome}}"},{% endfor %}] },
        'tratamento': { title: 'Tipos de Tratamentos', acao: 'add_tratamento', list: [{% for i in tratamentos %}{id: {{i.id}}, n: "{{i.nome}}"},{% endfor %}] },
        'conferente': { title: 'Usuários Registrados', acao: 'add_conferente_user', list: [{% for i in usuarios_conferentes %}{id: {{i.id}}, n: "{{i.username}}"},{% endfor %}] },
    };

    function goTab(k) {
        document.querySelectorAll('.nav-btn').forEach(b => {
            b.classList.toggle('active', b.getAttribute('data-tab') === k);
            if(b.classList.contains('active')) b.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        });

        const pProd = document.getElementById('tab-produto');
        const pOth = document.getElementById('tab-others');

        if(k === 'produto') {
            pProd.style.display = 'block'; pOth.style.display = 'none';
        } else {
            pProd.style.display = 'none'; pOth.style.display = 'block';
            const data = auxData[k];
            document.getElementById('other-title').innerText = data.title;
            document.getElementById('o-label').innerText = 'Nome do Registro';
            document.getElementById('o-acao').value = data.acao;
            document.getElementById('o-tipo').value = k;
            document.getElementById('o-active-tab').value = k;

            let h = `<div class="d-flex justify-content-between mb-3"><strong>Cadastros (${data.list.length})</strong></div>`;
            data.list.forEach(i => {
                h += `<div class="others-item animate__animated animate__fadeInUp">
                        <span class="fw-bold">${i.n}</span>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="acao" value="delete_item"><input type="hidden" name="tipo_item" value="${k}"><input type="hidden" name="id_item" value="${i.id}"><input type="hidden" name="active_tab" value="${k}">
                            <button type="submit" class="btn-del" onclick="return confirm('Deseja excluir?')"><i class="fas fa-trash"></i></button>
                        </form>
                      </div>`;
            });
            document.getElementById('list-target').innerHTML = h;
        }
        localStorage.setItem('last_tab_v2', k);
        window.history.replaceState(null, null, `#${k}`);
    }

    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => goTab(btn.getAttribute('data-tab')));
    });

    window.onload = () => {
        const hash = window.location.hash.replace('#', '');
        goTab(hash || localStorage.getItem('last_tab_v2') || 'produto');
    }
</script>
{% endblock %}