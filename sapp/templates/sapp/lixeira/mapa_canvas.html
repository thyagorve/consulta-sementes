<!-- templates/sapp/mapa_canvas.html -->
{% extends 'sapp/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 fw-bold text-dark mb-1">
                üó∫Ô∏è Mapa do Armaz√©m {{ armazem.numero }} - {{ armazem.nome }}
                {% if is_admin %}<span class="badge bg-danger ms-2">MODO ADMIN</span>{% endif %}
            </h2>
            <p class="text-muted mb-0">
                <i class="fas fa-eye text-secondary me-1"></i> Modo visualiza√ß√£o - Apenas leitura
            </p>
        </div>
        
        <div class="d-flex gap-2">
            <!-- Seletor de Armaz√©m -->
            <select id="selectArmazemNav" class="form-select" style="width: 200px;">
                {% for a in armazens_disponiveis %}
                <option value="{% url 'sapp:mapa_canvas' a.numero %}" 
                        {% if a.numero == armazem.numero %}selected{% endif %}>
                    Armaz√©m {{ a.numero }} - {{ a.nome }}
                </option>
                {% endfor %}
            </select>
            
            {% if is_admin %}
            <!-- Link para o Editor Gr√°fico -->
            <a href="{% url 'sapp:editor_mapa_admin' armazem.numero %}" class="btn btn-success">
                <i class="fas fa-paint-brush me-1"></i> Editar Mapa
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Container do Canvas -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0 position-relative">
            <div id="canvasContainer" style="position: relative; padding: 20px;">
                <canvas id="meuCanvas" 
                        width="{{ armazem.largura_canvas }}" 
                        height="{{ armazem.altura_canvas }}"
                        style="border: 1px solid #ddd; background: #f8f9fa; display: block; max-width: 100%;">
                </canvas>
            </div>
        </div>
    </div>
    
    <!-- Legenda -->
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-info-circle me-2"></i>Informa√ß√µes do Mapa
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="small mb-0">
                                <li><strong>Ret√¢ngulos verdes</strong> indicam endere√ßos com saldo dispon√≠vel</li>
                                <li><strong>Ret√¢ngulos cinzas</strong> indicam endere√ßos vazios</li>
                                <li><strong>Linhas azuis</strong> representam corredores e divis√≥rias</li>
                                <li><strong>Textos pretos</strong> s√£o informa√ß√µes do mapa</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">Status dos Endere√ßos:</h6>
                            <div class="d-flex flex-column gap-2">
                                <div class="d-flex align-items-center">
                                    <div style="width:20px;height:20px;background-color:#10b981;border-radius:3px;margin-right:8px;"></div>
                                    <small>Endere√ßo com estoque</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div style="width:20px;height:20px;background-color:#CCCCCC;border-radius:3px;margin-right:8px;"></div>
                                    <small>Endere√ßo vazio</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div style="width:20px;height:20px;border:2px solid #2563eb;border-radius:3px;margin-right:8px;"></div>
                                    <small>Corredor/Divis√≥ria</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-warehouse me-2"></i>Detalhes do Armaz√©m
                    </h6>
                    <div class="small">
                        <p><strong>Nome:</strong> {{ armazem.nome }}</p>
                        <p><strong>Dimens√µes:</strong> {{ armazem.largura_canvas }} x {{ armazem.altura_canvas }}px</p>
                        <p><strong>Elementos:</strong> {{ elementos.count }}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-{% if armazem.ativo %}success{% else %}danger{% endif %}">
                                {{ armazem.ativo|yesno:"Ativo,Inativo" }}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dados iniciais do armaz√©m
const ARMAZEM_DATA = {
    id: {{ armazem.id }},
    numero: {{ armazem.numero }},
    largura: {{ armazem.largura_canvas }},
    altura: {{ armazem.altura_canvas }},
    isAdmin: {% if is_admin %}true{% else %}false{% endif %}
};

// Elementos carregados do banco
const ELEMENTOS_INICIAIS = [
    {% for elemento in elementos %}
    {
        id: {{ elemento.id|default:0 }},
        tipo: "{{ elemento.tipo }}",
        pos_x: {{ elemento.pos_x }},
        pos_y: {{ elemento.pos_y }},
        largura: {{ elemento.largura }},
        altura: {{ elemento.altura }},
        cor_preenchimento: "{{ elemento.cor_atual|default:elemento.cor_preenchimento }}",
        cor_borda: "{{ elemento.cor_borda }}",
        espessura_borda: {{ elemento.espessura_borda }},
        conteudo_texto: `{{ elemento.conteudo_texto|default:""|escapejs }}`,
        fonte_nome: "{{ elemento.fonte_nome }}",
        fonte_tamanho: {{ elemento.fonte_tamanho }},
        texto_negrito: {% if elemento.texto_negrito %}true{% else %}false{% endif %},
        texto_italico: {% if elemento.texto_italico %}true{% else %}false{% endif %},
        texto_direcao: "{{ elemento.texto_direcao }}",
        linha_tipo: "{{ elemento.linha_tipo }}",
        identificador: "{{ elemento.identificador|default:""|escapejs }}"
    },
    {% endfor %}
];
</script>

<!-- Script para visualiza√ß√£o -->
<script src="{% static 'sapp/js/visualizador_mapa.js' %}"></script>

<script>
// Configura√ß√£o do seletor de armaz√©m
document.addEventListener('DOMContentLoaded', function() {
    const seletor = document.getElementById('selectArmazemNav');
    if (seletor) {
        seletor.addEventListener('change', function() {
            window.location.href = this.value;
        });
    }
});
</script>

{% endblock %}