{% extends 'sapp/base.html' %}
{% load static humanize %}
{% block content %}

<style>
/* ===== CONTAINER ===== */
.main-container{max-width:98%;margin:12px auto;background:#fff;border-radius:14px;box-shadow:0 15px 40px rgba(0,0,0,.12)}
.page-header{background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff;padding:18px 28px;border-bottom:4px solid #3b82f6}

/* ===== CARDS ===== */
#sectionCards{background:#f8fafc;padding:20px;border-bottom:2px solid #e2e8f0}
.draft-card{background:#fff;border-radius:14px;border:1px solid #e2e8f0;border-left:6px solid #3b82f6;padding:16px;transition:.25s}
.draft-card:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(0,0,0,.12)}
.draft-card.active{border-left-color:#16a34a;background:#ecfdf5}

/* ===== TABELA ===== */
.table-responsive{max-height:72vh;overflow-y:auto;overflow-x:hidden}
.table-excel{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;font-size:.8rem}
.table-excel th,.table-excel td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.table-excel thead th{position:sticky;top:0;background:#f1f5f9;padding:10px;border-bottom:2px solid #cbd5e1;font-weight:800;z-index:10}
.filter-row{position:sticky;top:42px;background:#f8fafc;z-index:9}
.filter-row input{width:100%;border-radius:6px;border:1px solid #cbd5e1;padding:4px 6px;font-size:.75rem}

/* ===== MOBILE ===== */
@media(max-width:768px){
.table-responsive{overflow-x:auto}
.table-excel{min-width:1200px;table-layout:auto}
}

/* ===== TAG ===== */
.tag-rascunho{display:inline-flex;align-items:center;background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;padding:3px 8px;border-radius:6px;font-size:.7rem;margin:2px;font-weight:700}

.hidden{display:none!important}
</style>

<div class="main-container">

<!-- HEADER -->
<div class="page-header d-flex justify-content-between align-items-center">
<div>
<h4 class="mb-0"><i class="fas fa-layer-group me-2"></i>Centro de Movimenta√ß√µes</h4>
<small class="opacity-75">Rascunhos / Empenhos</small>
</div>
<div class="d-flex gap-2">
<button class="btn btn-sm btn-outline-light" onclick="limparFiltros()">
<i class="fas fa-broom me-1"></i> Limpar filtros
</button>
<button class="btn btn-sm btn-outline-light" onclick="toggleCards()">
<span id="toggleText">Ocultar Cards</span>
</button>
</div>
</div>

<!-- CARDS -->
<div id="sectionCards">
<div class="row row-cols-1 row-cols-md-4 row-cols-xl-6 g-3">
{% for c in cards %}
<div class="col">
<div class="draft-card h-100 d-flex flex-column justify-content-between" data-card="{{ c.observacao }}">

<div>
<div class="d-flex justify-content-between">
<span class="badge bg-primary">{{ c.observacao }}</span>

<form method="POST" onsubmit="return confirm('Excluir card inteiro?')">
{% csrf_token %}
<input type="hidden" name="excluir_card" value="1">
<input type="hidden" name="empenho_id" value="{{ c.id }}">
<button class="btn btn-sm text-danger p-0 bg-transparent border-0">
<i class="fas fa-times-circle"></i>
</button>
</form>
</div>

<p class="small text-muted mt-2">
<b>{{ c.itens.count }}</b> lotes | <b>{{ c.saldo_afetado }}</b> un
</p>
</div>

<div class="d-flex gap-1">
<button class="btn btn-sm btn-outline-primary flex-grow-1"
onclick="filtrarPorCard('{{ c.observacao }}', this)">VER</button>

<button class="btn btn-sm btn-warning"
onclick="abrirModalMassa('transferir','{{ c.id }}','{{ c.observacao }}')">
<i class="fas fa-exchange-alt"></i>
</button>

<button class="btn btn-sm btn-success"
onclick="abrirModalMassa('expedir','{{ c.id }}','{{ c.observacao }}')">
<i class="fas fa-truck"></i>
</button>
</div>

</div>
</div>
{% endfor %}
</div>
</div>

<!-- TABELA -->
<div class="table-responsive">
<table class="table-excel">
<thead>
<tr>
<th>AZ</th><th>LOTE</th><th>CULTIVAR</th><th>ENDERE√áO</th>
<th>SALDO</th><th>EMPENHADO</th><th class="bg-primary text-white">DISP.</th>
<th>RASCUNHOS</th><th>A√á√ÉO</th>
</tr>
<tr class="filter-row">
{% for i in "01234567" %}
<th><input class="filter-input" onkeyup="filterTable({{ forloop.counter0 }},this.value)" placeholder="üîç"></th>
{% endfor %}
<th></th>
</tr>
</thead>

<tbody id="tableBody">
{% for item in lotes %}
<tr data-rascunhos="{% for r in item.itens_empenho %}{{ r.empenho.observacao }},{% endfor %}">
<td>{{ item.lote.az }}</td>
<td class="fw-bold text-primary">{{ item.lote.lote }}</td>
<td>{{ item.lote.cultivar.nome }}</td>
<td><span class="badge bg-light text-dark border">{{ item.lote.endereco }}</span></td>
<td class="fw-bold">{{ item.lote.saldo }}</td>
<td class="text-warning fw-bold">{{ item.empenhado }}</td>
<td class="fw-bold text-primary">{{ item.disponivel }}</td>

<td>
{% for r in item.itens_empenho %}
<span class="tag-rascunho">
{{ r.empenho.observacao }}: {{ r.quantidade }}
<form method="POST" class="d-inline">
{% csrf_token %}
<input type="hidden" name="excluir_item" value="1">
<input type="hidden" name="item_id" value="{{ r.id }}">
<button class="border-0 bg-transparent text-danger ps-1">
<i class="fas fa-trash-alt"></i>
</button>
</form>
</span>
{% endfor %}
</td>

<td>
<button class="btn btn-sm btn-outline-primary"
onclick="abrirModalIndividual('{{ item.lote.id }}','{{ item.lote.lote }}','{{ item.disponivel }}')">
<i class="fas fa-plus"></i>
</button>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

<!-- MODAL INDIVIDUAL -->
<div class="modal fade" id="modalIndividual" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header bg-primary text-white">
<h5 class="modal-title">Adicionar ao Rascunho</h5>
<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>

<form method="POST">
{% csrf_token %}
<input type="hidden" name="empenhar_lote" value="1">
<input type="hidden" name="lote_id" id="modal_lote_id">

<div class="modal-body">
<p class="small">Lote: <b id="modal_lote_nome"></b></p>
<label>Quantidade (m√°x: <span id="modal_max"></span>)</label>
<input type="number" class="form-control mb-2" name="quantidade" id="modal_qtd" required>

<label>Nome do Card</label>
<input type="text" class="form-control text-uppercase" name="nome_empenho" required>
</div>

<div class="modal-footer">
<button class="btn btn-primary w-100">ADICIONAR</button>
</div>
</form>
</div>
</div>
</div>

<!-- MODAL MASSA -->
<div class="modal fade" id="modalMassa" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header" id="headerMassa">
<h5 class="modal-title fw-bold">Executar Card</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<form method="POST" id="formMassa" enctype="multipart/form-data">
{% csrf_token %}
<input type="hidden" name="origem_acao" value="cards">
<input type="hidden" name="acao_tipo" id="inputAcao">
<input type="hidden" name="empenho_id" id="inputEmpId">

<div class="modal-body">
<div class="alert alert-info text-center small">
Card: <strong id="txtNomeEmp"></strong>
</div>

<div id="divTransfer" style="display:none">
<input class="form-control mb-2" name="novo_endereco" placeholder="Novo endere√ßo">
<input class="form-control" name="az" placeholder="AZ">
</div>

<div id="divExped" style="display:none">
<input class="form-control mb-2" name="numero_carga" placeholder="Carga">
<input class="form-control mb-2" name="cliente" placeholder="Cliente">
<input class="form-control mb-2" name="placa" placeholder="Placa">
<input type="file" class="form-control" name="fotos" multiple>
</div>

<textarea class="form-control mt-2" name="obs_global" placeholder="Observa√ß√µes"></textarea>
</div>

<div class="modal-footer">
<button class="btn btn-primary w-100 fw-bold">PROCESSAR</button>
</div>
</form>
</div>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
let cardAtivo=null;

function toggleCards(){
$('sectionCards').classList.toggle('hidden');
$('toggleText').innerText=$('sectionCards').classList.contains('hidden')?'Exibir Cards':'Ocultar Cards';
}

function abrirModalIndividual(id,lote,max){
$('modal_lote_id').value=id;
$('modal_lote_nome').innerText=lote;
$('modal_max').innerText=max;
$('modal_qtd').max=max;
$('modal_qtd').value=max;
bootstrap.Modal.getOrCreateInstance($('modalIndividual')).show();
}

function abrirModalMassa(acao,id,nome){
$('formMassa').reset();
$('inputAcao').value=acao;
$('inputEmpId').value=id;
$('txtNomeEmp').innerText=nome;
$('divTransfer').style.display=acao==='transferir'?'block':'none';
$('divExped').style.display=acao==='expedir'?'block':'none';
$('headerMassa').className=acao==='transferir'
?'modal-header bg-warning text-dark'
:'modal-header bg-success text-white';
bootstrap.Modal.getOrCreateInstance($('modalMassa')).show();
}

function filtrarPorCard(nome,btn){
if(cardAtivo===nome){limparFiltros();return;}
cardAtivo=nome;
document.querySelectorAll('.draft-card').forEach(c=>c.classList.remove('active'));
btn.closest('.draft-card').classList.add('active');
document.querySelectorAll('#tableBody tr').forEach(tr=>{
tr.style.display=tr.dataset.rascunhos.includes(nome)?'':'none';
});
}

function limparFiltros(){
cardAtivo=null;
document.querySelectorAll('#tableBody tr').forEach(tr=>tr.style.display='');
document.querySelectorAll('.draft-card').forEach(c=>c.classList.remove('active'));
document.querySelectorAll('.filter-input').forEach(i=>i.value='');
}

function filterTable(idx,val){
val=val.toLowerCase();
document.querySelectorAll('#tableBody tr').forEach(tr=>{
const td=tr.children[idx];
tr.style.display=td&&td.innerText.toLowerCase().includes(val)?'':'none';
});
}
</script>

{% endblock %}
