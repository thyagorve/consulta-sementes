{% extends 'sapp/base.html' %}
{% load static humanize %}

{% block content %}
<style>
    /* =========================================
       1. ESTILOS GERAIS E LAYOUT
       ========================================= */
    :root {
        --primary-gradient: linear-gradient(135deg, #2f8f4e 0%, #267a41 100%);
        --hover-gradient: linear-gradient(135deg, #267a41 0%, #1f5a34 100%);
        --active-gradient: linear-gradient(135deg, #1f6a36 0%, #16572b 100%);
        --border-color: #e2e8f0;
        --bg-light: #f8fafc;
    }

    .container-fluid {
        padding: 20px;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    /* HEADER */
    .page-header {
        background: var(--primary-gradient);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* =========================================
       2. CARDS SUPERIORES (RASCUNHOS)
       ========================================= */
    #sectionCards {
        background: var(--bg-light);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    #sectionCards.hidden {
        display: none;
    }

    .draft-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .draft-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .draft-card.active {
        border: 2px solid #2f8f4e;
        background-color: #f0fdf4;
    }

    .card-badge {
        background: var(--primary-gradient);
        color: white;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .lote-list-preview {
        max-height: 80px;
        overflow-y: auto;
        font-size: 0.75rem;
        margin-top: 8px;
        border-top: 1px solid #eee;
        padding-top: 4px;
    }

    /* =========================================
       3. CARDS DE RESUMO (STATS)
       ========================================= */
    .summary-card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: white;
        transition: transform 0.2s;
        height: 100%;
        border-top-width: 4px;
    }

    .summary-card:hover {
        transform: translateY(-2px);
    }

    .summary-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
    }

    /* =========================================
       4. TABELA AVANÇADA E CONTAINER
       ========================================= */
    .table-container {
        position: relative; /* Base para o popup absolute */
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
        margin-bottom: 30px;
        overflow: visible; /* Importante para não cortar sombras, mas scroll é na table-responsive */
    }

    .table-responsive {
        max-height: 70vh;
        overflow: auto; /* Scroll bar nativa */
        border-radius: 8px;
    }

    .table-advanced {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 1800px; /* Garante scroll horizontal se necessário */
        font-size: 0.85rem;
    }

    /* HEADER DA TABELA */
    .table-advanced th {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        padding: 12px 8px;
        position: sticky;
        top: 0;
        z-index: 20; /* Maior que o conteúdo */
        white-space: nowrap;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
    }

    .table-advanced th:hover {
        background: var(--hover-gradient);
    }

    .table-advanced th.filter-active {
        background: var(--active-gradient);
    }

    .table-advanced th i.fa-filter {
        margin-left: 5px;
        opacity: 0.7;
        font-size: 0.75rem;
    }

    .table-advanced th.filter-active i.fa-filter,
    .table-advanced th:hover i.fa-filter {
        opacity: 1;
    }

    /* CONTEÚDO DA TABELA */
    .table-advanced td {
        padding: 8px;
        vertical-align: middle;
        border-bottom: 1px solid var(--border-color);
        border-right: 1px solid #f1f5f9;
        white-space: nowrap;
        color: #334155;
    }

    .table-advanced tr:hover td {
        background-color: #f8fafc;
    }

    /* Celulas Específicas */
    .col-actions {
        position: sticky;
        right: 0;
        background: white;
        z-index: 10;
        border-left: 2px solid #e2e8f0;
        text-align: center;
        width: 100px;
    }
    .table-advanced th:last-child {
        position: sticky;
        right: 0;
        z-index: 30;
    }

    .tag-rascunho {
        display: inline-flex;
        align-items: center;
        background: #ecfdf5;
        color: #047857;
        border: 1px solid #a7f3d0;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        margin: 1px;
    }

    .btn-delete-item {
        color: #ef4444;
        margin-left: 4px;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        font-size: 0.7rem;
    }

    /* =========================================
       5. POPUP DE FILTRO (ESTILO EXCEL)
       ========================================= */
    .excel-popup {
        position: absolute;
        background: white;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        width: 280px;
        z-index: 1000;
        font-family: 'Segoe UI', sans-serif;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.15s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .excel-popup-header {
        padding: 10px;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        border-radius: 6px 6px 0 0;
    }

    .excel-search {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .excel-search:focus {
        outline: none;
        border-color: #2f8f4e;
        box-shadow: 0 0 0 2px rgba(47, 143, 78, 0.1);
    }

    .excel-list {
        max-height: 250px;
        overflow-y: auto;
        padding: 6px;
    }

    .excel-option {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        color: #334155;
    }

    .excel-option:hover {
        background-color: #f1f5f9;
    }

    .excel-option input[type="checkbox"] {
        margin-right: 8px;
        accent-color: #2f8f4e;
        width: 16px;
        height: 16px;
    }

    .excel-option-label {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .excel-footer {
        padding: 10px;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        gap: 8px;
        border-radius: 0 0 6px 6px;
    }

    .excel-btn {
        flex: 1;
        padding: 6px;
        font-size: 0.75rem;
        border-radius: 4px;
        border: 1px solid transparent;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-apply { background: #2f8f4e; color: white; }
    .btn-apply:hover { background: #267a41; }
    
    .btn-clear { background: #fff; border-color: #cbd5e1; color: #64748b; }
    .btn-clear:hover { background: #f1f5f9; color: #334155; }

    .popup-actions {
        display: flex;
        gap: 5px;
        padding: 4px 10px;
        border-bottom: 1px solid #e2e8f0;
    }
    .link-action {
        font-size: 0.75rem;
        color: #2563eb;
        text-decoration: none;
        cursor: pointer;
    }
    .link-action:hover { text-decoration: underline; }

    /* UTILS */
    .hidden { display: none !important; }
    .badge-filter-count {
        position: absolute;
        top: 2px;
        right: 2px;
        background: #ef4444;
        color: white;
        font-size: 10px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<div class="container-fluid">
    
    <!-- HEADER -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0"><i class="fas fa-layer-group me-2"></i>Centro de Movimentações</h4>
            <small class="opacity-75">Rascunho & Empenho em Lote</small>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-light" onclick="resetAllFilters()">
                <i class="fas fa-broom me-1"></i> Limpar Filtros
            </button>
            <button class="btn btn-sm btn-outline-light" onclick="toggleCards()">
                <i class="fas fa-eye-slash me-1"></i> <span id="btnToggleText">Ocultar Cards</span>
            </button>
        </div>
    </div>

    <!-- SESSÃO DE CARDS (RASCUNHOS) -->
    <div id="sectionCards">
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-5 row-cols-xl-6 g-3">
            {% for c in cards %}
            <div class="col">
                <div class="draft-card" data-card-name="{{ c.observacao }}">
                    <div>
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="card-badge" title="{{ c.observacao }}">{{ c.observacao|truncatechars:15 }}</span>
                            <form method="POST" onsubmit="return confirm('Tem certeza que deseja EXCLUIR este card inteiro?');">
                                {% csrf_token %}
                                <input type="hidden" name="excluir_card" value="1">
                                <input type="hidden" name="empenho_id" value="{{ c.id }}">
                                <button type="submit" class="btn btn-link text-danger p-0 border-0">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </form>
                        </div>
                        <div class="small text-muted mb-1">
                            <i class="fas fa-box me-1"></i> {{ c.itens.count }} Lotes
                        </div>
                        <div class="small text-muted">
                            <i class="fas fa-weight-hanging me-1"></i> {{ c.saldo_afetado }} Und
                        </div>
                        
                        <!-- Mini Preview -->
                        <div class="lote-list-preview">
                            {% for item in c.itens.all|slice:":5" %}
                            <div class="d-flex justify-content-between">
                                <span class="text-truncate">{{ item.estoque.lote }}</span>
                                <b>{{ item.quantidade }}</b>
                            </div>
                            {% endfor %}
                            {% if c.itens.count > 5 %}
                            <div class="text-center text-muted fst-italic">+{{ c.itens.count|add:"-5" }}...</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mt-3 d-flex flex-column gap-2">
                        <button class="btn btn-sm btn-outline-success w-100" onclick="filterByCard('{{ c.observacao }}', this)">
                            <i class="fas fa-filter me-1"></i> Filtrar Tabela
                        </button>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning w-50" 
                                    onclick="openModalMass('transferir', '{{ c.id }}', '{{ c.observacao }}')" title="Transferir">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger w-50" 
                                    onclick="openModalMass('expedir', '{{ c.id }}', '{{ c.observacao }}')" title="Expedir">
                                <i class="fas fa-truck"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- CARDS DE RESUMO -->
    <div class="row mb-4" id="statsRow">
        <div class="col-md-3 mb-2">
            <div class="summary-card border-primary p-3 d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted small fw-bold text-uppercase">Lotes Visíveis</div>
                    <div class="h3 mb-0 fw-bold text-primary" id="statLotes">0</div>
                </div>
                <div class="summary-icon bg-primary">
                    <i class="fas fa-cubes"></i>
                </div>
            </div>
        </div>




        <div class="col-md-3 mb-2">
            <div class="summary-card border-primary p-3 d-flex justify-content-between align-items-center">
               <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-circle p-3 me-3"><i class="fa-solid fa-users text-white"></i></div>
                    <div><h4 class="mb-0 text-primary" id="statClientes">0</h4><small class="text-muted">Clientes Únicos</small></div>
                </div>
                <div class="summary-icon bg-primary">
                    <i class="fas fa-cubes"></i>
                </div>
            </div>
        </div>




        <div class="col-md-3 mb-2">
            <div class="summary-card border-success p-3 d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted small fw-bold text-uppercase">Saldo Disponível (Total)</div>
                    <div class="h3 mb-0 fw-bold text-success" id="statSaldo">0</div>
                </div>
                <div class="summary-icon bg-success">
                    <i class="fas fa-coins"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="summary-card border-warning p-3 d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted small fw-bold text-uppercase">Total Empenhado</div>
                    <div class="h3 mb-0 fw-bold text-warning" id="statEmpenhado">0</div>
                </div>
                <div class="summary-icon bg-warning">
                    <i class="fas fa-clipboard-check"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- TABELA PRINCIPAL -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table-advanced" id="mainTable">
                <thead>
                    <tr>
                        <!-- Definição de Colunas: Index 0 a 17 -->
                        <th onclick="toggleFilter(0, this)">AZ <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(1, this)">Lote <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(2, this)">Cultivar <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(3, this)">Peneira <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(4, this)">Categoria <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(5, this)">Espécie <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(6, this)">Tratamento <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(7, this)">Embalagem <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(8, this)">Cliente <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(9, this)">Empresa <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(10, this)">Endereço <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(11, this)">Peso Unit. <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(12, this)">Peso Total <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(13, this)">Saldo <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(14, this)">Empenhado <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(15, this)" class="bg-success text-white">Disponível <i class="fas fa-filter"></i></th>
                        <th onclick="toggleFilter(16, this)">Rascunhos <i class="fas fa-filter"></i></th>
                        <th class="col-actions">Ações</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for item in lotes %}
                    <tr class="align-middle">
                        <td>{{ item.lote.az|default:"-" }}</td>
                        <td class="fw-bold text-primary">{{ item.lote.lote }}</td>
                        <td>{{ item.lote.cultivar.nome }}</td>
                        <td>{{ item.lote.peneira|default:"-" }}</td>
                        <td>{{ item.lote.categoria|default:"-" }}</td>
                        <td>{{ item.lote.especie|default:"-" }}</td>
                        <td>{{ item.lote.tratamento|default:"-" }}</td>
                        <td>{{ item.lote.embalagem|default:"-" }}</td>
                        <td>{{ item.lote.cliente|default:"-" }}</td>
                        <td>{{ item.lote.empresa|default:"-" }}</td>
                        <td><span class="badge bg-light text-dark border">{{ item.lote.endereco }}</span></td>
                        <td>{{ item.lote.peso_unitario|default:"0" }}</td>
                        <td>{{ item.lote.peso_total|default:"0" }}</td>
                        
                        <td class="fw-bold">{{ item.lote.saldo|intcomma }}</td>
                        <td class="text-warning fw-bold">{{ item.empenhado|intcomma }}</td>
                        <td class="text-success fw-bold">{{ item.disponivel|intcomma }}</td>
                        
                        <!-- Rascunhos (Lista de tags) -->
                        <td data-raw-rascunhos="{% for r in item.itens_empenho %}{{ r.empenho.observacao }}|{% endfor %}">
                            <div class="d-flex flex-wrap" style="max-width: 250px;">
                                {% for r in item.itens_empenho %}
                                <span class="tag-rascunho">
                                    {{ r.empenho.observacao }}: {{ r.quantidade }}
                                    <form method="POST" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="excluir_item" value="1">
                                        <input type="hidden" name="item_id" value="{{ r.id }}">
                                        <button class="btn-delete-item" type="submit"><i class="fas fa-times"></i></button>
                                    </form>
                                </span>
                                {% endfor %}
                            </div>
                        </td>

                        <td class="col-actions">
                            <button class="btn btn-sm btn-outline-success border-0" 
                                    onclick="openModalIndividual('{{ item.lote.id }}', '{{ item.lote.lote }}', {{ item.disponivel|stringformat:'d' }})">
                                <i class="fas fa-plus-circle fa-lg"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL INDIVIDUAL -->
<div class="modal fade" id="modalIndividual" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Adicionar ao Rascunho</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="empenhar_lote" value="1">
                <input type="hidden" name="lote_id" id="ind_lote_id">
                <div class="modal-body">
                    <div class="alert alert-light border">
                        Lote: <strong id="ind_lote_nome" class="text-primary"></strong><br>
                        Disponível: <strong id="ind_lote_disp" class="text-success"></strong>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        <input type="number" name="quantidade" id="ind_qtd" class="form-control" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nome do Card (Rascunho)</label>
                        <input type="text" name="nome_empenho" class="form-control text-uppercase" placeholder="Ex: EXPEDICAO_ABC" required list="cards_existentes">
                        <datalist id="cards_existentes">
                            {% for c in cards %}
                            <option value="{{ c.observacao }}">
                            {% endfor %}
                        </datalist>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Adicionar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL EM MASSA (TRANSFERIR / EXPEDIR) -->
<div class="modal fade" id="modalMassa" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-white" id="headerMassa">
                <h5 class="modal-title" id="titleMassa">Ação em Massa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="POST" enctype="multipart/form-data" id="formMassa">
                {% csrf_token %}
                <input type="hidden" name="origem_acao" value="cards">
                <input type="hidden" name="acao_tipo" id="acao_tipo"> <!-- transferir ou expedir -->
                <input type="hidden" name="empenho_id" id="mass_empenho_id">

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-1"></i> Card: <strong id="mass_card_name"></strong>
                    </div>

                    <!-- CAMPOS TRANSFERÊNCIA -->
                    <div id="blockTransfer">
                        <h6 class="border-bottom pb-2 mb-3 text-warning">Dados da Transferência</h6>
                        <div class="row g-2">
                            <div class="col-md-8">
                                <label class="form-label">Novo Endereço <span class="text-danger">*</span></label>
                                <input type="text" name="novo_endereco" id="field_novo_end" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Novo AZ</label>
                                <input type="text" name="az" id="field_az" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- CAMPOS EXPEDIÇÃO -->
                    <div id="blockExped">
                        <h6 class="border-bottom pb-2 mb-3 text-danger">Dados da Expedição</h6>
                        <div class="mb-2">
                            <label class="form-label">Número da Carga/Pedido <span class="text-danger">*</span></label>
                            <input type="text" name="numero_carga" id="field_carga" class="form-control" required>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Cliente</label>
                                <input type="text" name="cliente" id="field_cliente" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Placa Veículo</label>
                                <input type="text" name="placa" id="field_placa" class="form-control">
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Fotos (Opcional)</label>
                            <input type="file" name="fotos" id="field_fotos" class="form-control" multiple accept="image/*">
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Observação Global</label>
                        <textarea name="obs_global" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-primary fw-bold">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
/**
 * ESTADO GLOBAL
 * Mantemos o estado fora do DOMContentLoaded para acessibilidade global
 */
var AppState = {
    activeCardFilter: null,
    columnFilters: {} // Formato: { colIndex: ["valor1", "valor2"] }
};

/**
 * INICIALIZAÇÃO
 */
document.addEventListener('DOMContentLoaded', function() {
    // Calcular estatísticas iniciais
    calculateStats();

    // Evento Global para fechar Popups
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.excel-popup') && !e.target.closest('th')) {
            closeAllPopups();
        }
    });

    // Fechar popups ao rolar a tabela
    const tableResp = document.querySelector('.table-responsive');
    if (tableResp) {
        tableResp.addEventListener('scroll', closeAllPopups);
    }
});

/**
 * FUNÇÕES DE INTERFACE (UI)
 */
function toggleCards() {
    const sec = document.getElementById('sectionCards');
    const txt = document.getElementById('btnToggleText');
    if(sec && txt) {
        sec.classList.toggle('hidden');
        txt.textContent = sec.classList.contains('hidden') ? 'Exibir Cards' : 'Ocultar Cards';
    }
}

/**
 * FUNÇÕES DE MODAL - Usando getOrCreateInstance para robustez
 */
function openModalIndividual(id, nome, disp) {
    const el = document.getElementById('modalIndividual');
    if(!el) return;

    // Elementos do form
    const inputId = document.getElementById('ind_lote_id');
    const nomeEl = document.getElementById('ind_lote_nome');
    const dispEl = document.getElementById('ind_lote_disp');
    const qtdEl = document.getElementById('ind_qtd');

    // Setar valores
    if(inputId) inputId.value = id;
    if(nomeEl) nomeEl.textContent = nome;
    if(dispEl) dispEl.textContent = disp;
    if(qtdEl) {
        qtdEl.max = disp;
        qtdEl.value = '';
    }

    // Abrir Modal de forma segura
    const modal = bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
}

function openModalMass(tipo, id, nome) {
    const el = document.getElementById('modalMassa');
    if(!el) return;

    // Elementos
    const form = document.getElementById('formMassa');
    const title = document.getElementById('titleMassa');
    const header = document.getElementById('headerMassa');
    const cardName = document.getElementById('mass_card_name');
    const inputAcao = document.getElementById('acao_tipo');
    const inputId = document.getElementById('mass_empenho_id');
    
    const blkTrans = document.getElementById('blockTransfer');
    const blkExped = document.getElementById('blockExped');

    // Resetar e Configurar
    form.reset();
    if(inputId) inputId.value = id;
    if(cardName) cardName.textContent = nome;
    if(inputAcao) inputAcao.value = tipo;

    // Lógica de Exibição
    if (tipo === 'transferir') {
        title.innerHTML = '<i class="fas fa-exchange-alt me-2"></i>Transferir Lotes';
        header.className = 'modal-header bg-warning text-dark border-0';
        
        blkTrans.style.display = 'block';
        blkExped.style.display = 'none';
        
        toggleRequired(blkTrans, true);
        toggleRequired(blkExped, false);
    } else {
        title.innerHTML = '<i class="fas fa-truck me-2"></i>Expedir Carga';
        header.className = 'modal-header bg-danger text-white border-0';
        
        blkTrans.style.display = 'none';
        blkExped.style.display = 'block';
        
        toggleRequired(blkTrans, false);
        toggleRequired(blkExped, true);
    }

    const modal = bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
}

function toggleRequired(container, isRequired) {
    if(!container) return;
    const inputs = container.querySelectorAll('input, select, textarea');
    inputs.forEach(inp => {
        inp.disabled = !isRequired;
        // Apenas inputs que originalmente eram required devem ser manipulados, 
        // mas aqui vamos simplificar garantindo que disabled inputs não validam
    });
}

/**
 * LÓGICA DE FILTRO (CORE)
 */
function filterByCard(cardName, btn) {
    if (AppState.activeCardFilter === cardName) {
        AppState.activeCardFilter = null;
        document.querySelectorAll('.draft-card').forEach(c => c.classList.remove('active'));
    } else {
        AppState.activeCardFilter = cardName;
        document.querySelectorAll('.draft-card').forEach(c => c.classList.remove('active'));
        if(btn) btn.closest('.draft-card').classList.add('active');
    }
    applyAllFilters();
}

function resetAllFilters() {
    AppState.activeCardFilter = null;
    AppState.columnFilters = {};
    
    document.querySelectorAll('.draft-card').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.badge-filter-count').forEach(b => b.remove());
    document.querySelectorAll('th').forEach(th => th.classList.remove('filter-active'));
    
    applyAllFilters();
}

function applyAllFilters() {
    const rows = document.querySelectorAll('#tableBody tr');
    
    rows.forEach(row => {
        let isVisible = true;

        // 1. Filtro de Card
        if (AppState.activeCardFilter) {
            const raw = row.children[16].getAttribute('data-raw-rascunhos') || '';
            // Verifica token exato "NOME|"
            if (!raw.includes(AppState.activeCardFilter + '|')) {
                isVisible = false;
            }
        }

        // 2. Filtros de Coluna
        if (isVisible) {
            for (const [colIndex, values] of Object.entries(AppState.columnFilters)) {
                if (!checkRowAgainstFilter(row, parseInt(colIndex), values)) {
                    isVisible = false;
                    break;
                }
            }
        }

        row.style.display = isVisible ? '' : 'none';
    });

    calculateStats();
    updateHeaderIcons();
}

// Verifica uma linha contra um filtro específico
function checkRowAgainstFilter(row, colIndex, allowedValues) {
    // Se filtro vazio (por segurança), passa
    if (!allowedValues || allowedValues.length === 0) return true;
    if (allowedValues.includes('__NONE__')) return false; 

    // Coluna 16 (Rascunhos) é especial (contém lista)
    if (colIndex === 16) {
        const raw = row.children[16].getAttribute('data-raw-rascunhos') || '';
        // Se a linha tem ALGUM dos valores permitidos
        return allowedValues.some(val => raw.includes(val + '|'));
    } 
    
    // Colunas normais (texto exato)
    const cellValue = row.children[colIndex].textContent.trim();
    return allowedValues.includes(cellValue);
}

/**
 * POPUP EXCEL
 */
function toggleFilter(colIndex, th) {
    // Se já existe, fecha e sai
    const existing = document.querySelector(`.excel-popup[data-col="${colIndex}"]`);
    if (existing) {
        existing.remove();
        return;
    }

    closeAllPopups();

    // 1. Obter valores únicos INTELIGENTES (Adaptive)
    // Devemos pegar valores das linhas que passariam por TODOS os filtros, EXCETO o desta coluna
    const uniqueValues = getAdaptiveUniqueValues(colIndex);
    
    // 2. Estado atual da seleção
    const currentSelection = AppState.columnFilters[colIndex] || [];
    
    // 3. Construir HTML
    let listHTML = '';
    uniqueValues.forEach(val => {
        // Se seleção vazia, tudo marcado. Senão, checar se está na lista.
        const isChecked = (currentSelection.length === 0 || currentSelection.includes(val)) ? 'checked' : '';
        const displayVal = val === '' ? '(Vazio)' : val;
        
        listHTML += `
            <label class="excel-option">
                <input type="checkbox" class="filter-chk" value="${val}" ${isChecked}>
                <span>${displayVal}</span>
            </label>
        `;
    });

    if(uniqueValues.length === 0) {
        listHTML = '<div class="p-2 text-muted small text-center">Sem dados disponíveis</div>';
    }

    const popup = document.createElement('div');
    popup.className = 'excel-popup';
    popup.setAttribute('data-col', colIndex);
    popup.innerHTML = `
        <div class="excel-popup-header">
            <input type="text" class="excel-search" placeholder="Buscar..." onkeyup="filterPopupList(this)">
            <div class="popup-actions">
                <span class="link-action" onclick="setPopupChecks(this, true)">Todos</span>
                <span class="text-muted mx-1">|</span>
                <span class="link-action" onclick="setPopupChecks(this, false)">Nenhum</span>
            </div>
        </div>
        <div class="excel-list">
            ${listHTML}
        </div>
        <div class="excel-footer">
            <button class="excel-btn btn-clear" onclick="clearColumnFilter(${colIndex})">Limpar</button>
            <button class="excel-btn btn-apply" onclick="confirmPopupFilter(${colIndex})">Aplicar</button>
        </div>
    `;

    document.querySelector('.table-container').appendChild(popup);

    // 4. Posicionamento
    const rect = th.getBoundingClientRect();
    const containerRect = document.querySelector('.table-container').getBoundingClientRect();
    
    popup.style.top = (rect.bottom - containerRect.top) + 'px';
    
    // Evitar que saia pela direita
    let leftPos = rect.left - containerRect.left;
    if(leftPos + 280 > containerRect.width) {
        leftPos = (rect.right - containerRect.left) - 280;
    }
    popup.style.left = leftPos + 'px';
}

function getAdaptiveUniqueValues(targetColIndex) {
    const values = new Set();
    const rows = document.querySelectorAll('#tableBody tr');

    rows.forEach(row => {
        // Verifica se a linha passa pelo filtro de Card
        let passesCard = true;
        if (AppState.activeCardFilter) {
            const raw = row.children[16].getAttribute('data-raw-rascunhos') || '';
            if (!raw.includes(AppState.activeCardFilter + '|')) passesCard = false;
        }

        if (!passesCard) return; // Pula linha

        // Verifica filtros das OUTRAS colunas
        let passesOtherCols = true;
        for (const [colIndex, filterVals] of Object.entries(AppState.columnFilters)) {
            if (parseInt(colIndex) === targetColIndex) continue; // Ignora a própria coluna
            
            if (!checkRowAgainstFilter(row, parseInt(colIndex), filterVals)) {
                passesOtherCols = false;
                break;
            }
        }

        if (passesOtherCols) {
            // Se a linha é válida para exibição neste contexto, captura o valor
            if (targetColIndex === 16) {
                // Rascunhos: Splitar valores
                const raw = row.children[16].getAttribute('data-raw-rascunhos') || '';
                raw.split('|').forEach(v => {
                    if(v) values.add(v);
                });
            } else {
                values.add(row.children[targetColIndex].textContent.trim());
            }
        }
    });

    // Ordenação
    return Array.from(values).sort((a, b) => {
        // Tenta ordenar numérico
        const na = parseFloat(a.replace(/\./g, '').replace(',', '.'));
        const nb = parseFloat(b.replace(/\./g, '').replace(',', '.'));
        if(!isNaN(na) && !isNaN(nb)) return na - nb;
        return a.localeCompare(b);
    });
}

function filterPopupList(input) {
    const term = input.value.toLowerCase();
    const items = input.closest('.excel-popup').querySelectorAll('.excel-option');
    items.forEach(item => {
        const txt = item.querySelector('span').textContent.toLowerCase();
        item.style.display = txt.includes(term) ? 'flex' : 'none';
    });
}

function setPopupChecks(btn, checked) {
    const popup = btn.closest('.excel-popup');
    const items = popup.querySelectorAll('.excel-option');
    items.forEach(item => {
        if(item.style.display !== 'none') {
            item.querySelector('input').checked = checked;
        }
    });
}

function confirmPopupFilter(colIndex) {
    const popup = document.querySelector(`.excel-popup[data-col="${colIndex}"]`);
    if(!popup) return;

    const checkboxes = popup.querySelectorAll('.filter-chk');
    const checked = [];
    let totalVisible = 0;

    checkboxes.forEach(chk => {
        // Considera apenas o que está marcado E visível (caso haja busca)
        // Mas a lógica Excel padrão pega tudo marcado. Vamos pegar tudo marcado.
        if(chk.checked) checked.push(chk.value);
        totalVisible++;
    });

    if (checked.length === 0) {
        // Nada selecionado = Filtro que esconde tudo
        AppState.columnFilters[colIndex] = ['__NONE__']; 
    } else if (checked.length === totalVisible) {
        // Tudo selecionado = Remove filtro
        delete AppState.columnFilters[colIndex];
    } else {
        AppState.columnFilters[colIndex] = checked;
    }

    closeAllPopups();
    applyAllFilters();
}

function clearColumnFilter(colIndex) {
    delete AppState.columnFilters[colIndex];
    closeAllPopups();
    applyAllFilters();
}

function closeAllPopups() {
    document.querySelectorAll('.excel-popup').forEach(p => p.remove());
}

function updateHeaderIcons() {
    // Limpa icons antigos
    document.querySelectorAll('.badge-filter-count').forEach(e => e.remove());
    document.querySelectorAll('th').forEach(th => th.classList.remove('filter-active'));

    // Adiciona novos
    Object.entries(AppState.columnFilters).forEach(([colIndex, vals]) => {
        if (vals.includes('__NONE__') || vals.length > 0) {
            const th = document.querySelectorAll('#mainTable thead th')[colIndex];
            if(th) {
                th.classList.add('filter-active');
                const badge = document.createElement('span');
                badge.className = 'badge-filter-count';
                badge.textContent = vals.includes('__NONE__') ? 0 : vals.length;
                th.appendChild(badge);
            }
        }
    });
}

/**
 * ESTATÍSTICAS
 */
function calculateStats() {
    let count = 0;
    let sumSaldo = 0;
    let sumEmp = 0;
    let clientes = new Set();

    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            count++;

            sumSaldo += parsePtBrFloat(row.children[15].textContent);
            sumEmp += parsePtBrFloat(row.children[14].textContent);

            // Coluna Cliente = índice 8
            const cliente = row.children[8].textContent.trim();
            if (cliente && cliente !== '-') {
                clientes.add(cliente);
            }
        }
    });

    document.getElementById('statLotes').textContent = count.toLocaleString('pt-BR');
    document.getElementById('statSaldo').textContent = sumSaldo.toLocaleString('pt-BR');
    document.getElementById('statEmpenhado').textContent = sumEmp.toLocaleString('pt-BR');
    document.getElementById('statClientes').textContent = clientes.size.toLocaleString('pt-BR');
}


function parsePtBrFloat(str) {
    if(!str) return 0;
    // Remove pontos de milhar, troca vírgula por ponto
    const clean = str.replace(/\./g, '').replace(',', '.');
    const val = parseFloat(clean);
    return isNaN(val) ? 0 : val;
}
</script>
{% endblock %}