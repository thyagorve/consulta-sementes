{% extends 'sapp/base.html' %}
{% load humanize %}
{% load static %}

{% block content %}
<style>
    /* --- DESIGN SYSTEM (CORES E FONTES) --- */
    :root {
        --primary: #0f172a;       /* Azul Escuro Profundo */
        --accent: #3b82f6;        /* Azul Vibrante */
        --success: #10b981;       /* Verde Esmeralda */
        --danger: #ef4444;        /* Vermelho Vibrante */
        --warning: #f59e0b;       /* Laranja Ouro */
        --bg-body: #f1f5f9;       /* Cinza Muito Claro */
        --surface: #ffffff;       /* Branco Puro */
        --border-color: #e2e8f0;  /* Cinza Borda */
        --radius-lg: 16px;
        --radius-sm: 8px;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body { background-color: var(--bg-body); font-family: 'Inter', system-ui, -apple-system, sans-serif; color: #334155; }

    /* --- CARDS INTELIGENTES --- */
    .metric-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; margin-bottom: 2rem;
    }
    .metric-card {
        background: var(--surface); border-radius: var(--radius-lg); padding: 1.5rem;
        box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
        position: relative; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s;
    }
    .metric-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    
    .metric-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .metric-value { font-size: 2rem; font-weight: 800; color: #0f172a; line-height: 1; }
    .metric-unit { font-size: 0.875rem; font-weight: 600; color: #94a3b8; margin-left: 4px; }
    
    /* Decoração lateral colorida */
    .border-l-success { border-left: 5px solid var(--success); }
    .border-l-danger { border-left: 5px solid var(--danger); }
    .border-l-primary { border-left: 5px solid var(--accent); }

    /* Footer do card com totalizador */
    .metric-footer {
        margin-top: 1rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .metric-total-lbl { font-size: 0.7rem; font-weight: 700; color: #94a3b8; }
    .metric-total-val { font-size: 1rem; font-weight: 700; }

    /* --- TABELA MODERNA --- */
    .table-container {
        background: var(--surface); border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); overflow: hidden;
    }
    .modern-table { width: 100%; border-collapse: collapse; }
    .modern-table th {
        background: #f8fafc; padding: 1rem 1.5rem; text-align: left;
        font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b;
        border-bottom: 1px solid var(--border-color);
    }
    .modern-table td {
        padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color);
        vertical-align: middle; font-size: 0.95rem;
    }
    .modern-table tr:hover { background-color: #f8fafc; cursor: pointer; }
    .modern-table tr:last-child td { border-bottom: none; }

    /* --- ÁREA DE DETALHES (ONDE A MÁGICA ACONTECE) --- */
    .detail-panel { background: #f8fafc; box-shadow: inset 0 4px 10px -4px rgba(0,0,0,0.05); }
    
    .spec-card {
        background: white; border-radius: var(--radius-lg); padding: 1.5rem;
        box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); height: 100%;
    }
    
    /* Lista de Especificações */
    .spec-list { list-style: none; padding: 0; margin: 0; }
    .spec-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.75rem 0; border-bottom: 1px solid #f1f5f9;
    }
    .spec-item:last-child { border-bottom: none; }
    .spec-label { color: #64748b; font-size: 0.9rem; }
    .spec-val { font-weight: 600; color: #334155; }

    /* Botões de Ação Premium */
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem; }
    .btn-action {
        border: none; border-radius: var(--radius-sm); padding: 0.75rem;
        font-weight: 600; font-size: 0.9rem; transition: all 0.2s;
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        box-shadow: var(--shadow-sm);
    }
    .btn-action:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .btn-action:active { transform: translateY(0); }

    .btn-expedition { background: var(--danger); color: white; grid-column: 1 / -1; font-size: 1rem; padding: 1rem; } /* Ocupa largura total */
    .btn-transfer { background: var(--warning); color: white; }
    .btn-edit { background: white; border: 1px solid var(--border-color); color: #475569; }
    .btn-edit:hover { background: #f1f5f9; }

    /* --- TIMELINE --- */
    .timeline { position: relative; padding-left: 2rem; border-left: 2px solid #e2e8f0; margin-left: 1rem; }
    .timeline-node { position: relative; margin-bottom: 2rem; }
    .timeline-dot {
        position: absolute; left: -39px; top: 0; width: 14px; height: 14px; border-radius: 50%;
        border: 2px solid white; box-shadow: 0 0 0 2px #e2e8f0;
    }
    .timeline-dot.in { background: var(--success); }
    .timeline-dot.out { background: var(--danger); }
    .timeline-dot.move { background: var(--warning); }
    
    .timeline-card {
        background: white; border-radius: var(--radius-sm); padding: 1rem;
        border: 1px solid var(--border-color);
    }

    /* Galeria */
    .thumb-grid { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .thumb { 
        width: 50px; height: 50px; border-radius: 6px; object-fit: cover; 
        border: 1px solid #e2e8f0; cursor: zoom-in; 
    }
    
    /* Responsividade Tabela */
    @media (max-width: 768px) {
        .hide-mobile { display: none; }
        .modern-table th, .modern-table td { padding: 1rem; }
    }
</style>

<div class="container-fluid py-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0 text-dark">Controle de Estoque</h3>
            <span class="text-muted small">Visão Geral & Operações</span>
        </div>
        <button class="btn btn-primary shadow-sm rounded-pill px-4 py-2 fw-bold" data-bs-toggle="modal" data-bs-target="#modalNovaEntrada">
            <i class="fas fa-plus me-2"></i>NOVA ENTRADA
        </button>
    </div>

    <!-- CARDS DE MÉTRICAS -->
    <div class="metric-grid">
        <!-- Entrada -->
        <div class="metric-card border-l-success">
            <div class="metric-label">Entrada Total</div>
            <div class="d-flex align-items-baseline">
                <span class="metric-value">{{ dados_entrada.bags|intcomma }}</span> <span class="metric-unit">BAGs</span>
            </div>
            {% if dados_entrada.sc_fisico > 0 %}
            <small class="text-muted d-block mt-1">+ {{ dados_entrada.sc_fisico|intcomma }} Sacos avulsos</small>
            {% endif %}
            <div class="metric-footer">
                <span class="metric-total-lbl">CONVERTIDO (SC)</span>
                <span class="metric-total-val text-success">{{ dados_entrada.total_sc|intcomma }}</span>
            </div>
        </div>

        <!-- Saída -->
        <div class="metric-card border-l-danger">
            <div class="metric-label">Saída Total</div>
            <div class="d-flex align-items-baseline">
                <span class="metric-value">{{ dados_saida.bags|intcomma }}</span> <span class="metric-unit">BAGs</span>
            </div>
            {% if dados_saida.sc_fisico > 0 %}
            <small class="text-muted d-block mt-1">+ {{ dados_saida.sc_fisico|intcomma }} Sacos avulsos</small>
            {% endif %}
            <div class="metric-footer">
                <span class="metric-total-lbl">CONVERTIDO (SC)</span>
                <span class="metric-total-val text-danger">{{ dados_saida.total_sc|intcomma }}</span>
            </div>
        </div>

        <!-- Saldo -->
        <div class="metric-card border-l-primary">
            <div class="metric-label">Saldo Físico</div>
            <div class="d-flex align-items-baseline">
                <span class="metric-value">{{ dados_saldo.bags|intcomma }}</span> <span class="metric-unit">BAGs</span>
            </div>
            {% if dados_saldo.sc_fisico > 0 %}
            <small class="text-muted d-block mt-1">+ {{ dados_saldo.sc_fisico|intcomma }} Sacos avulsos</small>
            {% endif %}
            <div class="metric-footer">
                <span class="metric-total-lbl">CONVERTIDO (SC)</span>
                <span class="metric-total-val" style="color: var(--accent);">{{ dados_saldo.total_sc|intcomma }}</span>
            </div>
        </div>
    </div>

    <!-- BARRA DE FERRAMENTAS -->
    <div class="metric-card p-3 mb-4 d-flex flex-wrap gap-3 align-items-center">
        <div class="flex-grow-1">
            <form method="GET" class="position-relative">
                <i class="fas fa-search text-muted position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                <input type="text" name="busca" class="form-control border-0 bg-light ps-5 py-2 rounded-pill" 
                       placeholder="Pesquisar por lote, local, produto..." value="{{ busca }}">
            </form>
        </div>
        <div class="d-flex gap-2">
            <form method="GET" class="d-flex gap-2">
                <!-- Truque para manter a busca ao trocar o select -->
                <input type="hidden" name="busca" value="{{ busca }}">
                <select name="status" class="form-select border-0 bg-light rounded-pill" onchange="this.form.submit()">
                    <option value="">Status: Todos</option>
                    <option value="disponivel" {% if status == 'disponivel' %}selected{% endif %}>Disponíveis</option>
                    <option value="esgotado" {% if status == 'esgotado' %}selected{% endif %}>Esgotados</option>
                </select>
                {% if busca or status %}
                <a href="{% url 'sapp:lista_estoque' %}" class="btn btn-light rounded-circle" title="Limpar">
                    <i class="fas fa-times text-danger"></i>
                </a>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- TABELA PRINCIPAL -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th width="40"></th>
                        <th>Lote</th>
                        <th>Produto</th>
                        <th class="hide-mobile">Local</th>
                        <th class="text-center">Fluxo / Saldo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in itens %}
                    <tr onclick="toggleDetails('details-{{ item.id }}')">
                        <td class="text-center"><i class="fas fa-chevron-down" style="color: var(--accent);"></i></td>
                        <td>
                            <div class="fw-bold" style="color: #1e293b;">{{ item.lote }}</div>
                            <small class="text-muted">{{ item.data_entrada|date:"d/m/y" }}</small>
                        </td>
                        <td>
                            <div class="fw-bold" style="color: #3b82f6;">{{ item.cultivar.nome }}</div>
                            <small class="text-muted">{{ item.produto|default:"-" }}</small>
                        </td>
                        <td class="hide-mobile">
                            <span class="badge bg-light text-dark border">{{ item.endereco }}</span>
                            {% if item.az %}<small class="text-muted ms-1">AZ: {{ item.az }}</small>{% endif %}
                        </td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-3 mb-1 small">
                                <span class="text-success fw-bold"><i class="fas fa-arrow-down"></i> {{ item.entrada }}</span>
                                <span class="text-danger fw-bold"><i class="fas fa-arrow-up"></i> {{ item.saida }}</span>
                            </div>
                            <div class="fw-bold fs-5 text-dark">{{ item.saldo }} <small class="fw-normal fs-6 text-muted">{{ item.embalagem }}</small></div>
                        </td>
                    </tr>

                    <!-- LINHA DE DETALHES (EXPANSÍVEL) -->
                    <tr id="details-{{ item.id }}" class="d-none detail-panel">
                        <td colspan="5" class="p-0">
                            <div class="p-4">
                                <div class="row g-4">
                                    
                                    <!-- COLUNA ESQUERDA: ESPECIFICAÇÕES E AÇÕES -->
                                    <div class="col-lg-5">
                                        <div class="spec-card">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-4">Especificações Técnicas</h6>
                                            
                                            <ul class="spec-list">
                                                <li class="spec-item">
                                                    <span class="spec-label">Embalagem</span>
                                                    <span class="spec-val">{{ item.embalagem }}</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Peso Unitário</span>
                                                    <span class="spec-val">{{ item.peso_unitario }} kg</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Peso Total</span>
                                                    <span class="spec-val">{{ item.peso_total|intcomma }} kg</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Peneira</span>
                                                    <span class="spec-val">{{ item.peneira.nome }}</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Categoria</span>
                                                    <span class="spec-val">{{ item.categoria.nome }}</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Localização</span>
                                                    <span class="spec-val">{{ item.endereco }}</span>
                                                </li>
                                            </ul>
                                            
                                            <div class="mt-3 p-2 bg-light rounded small text-muted fst-italic border">
                                                Obs: {{ item.observacao|default:"Nenhuma observação." }}
                                            </div>

                                            <hr class="my-4">

                                            <!-- BOTÕES DE AÇÃO ORGANIZADOS -->
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Gerenciar Lote</h6>
                                            <div class="action-grid">
                                                {% if item.saldo > 0 %}
                                                <!-- Botão Principal: EXPEDIÇÃO -->
                                                <button class="btn-action btn-expedition" data-bs-toggle="modal" data-bs-target="#modalSaida{{ item.id }}">
                                                    <i class="fas fa-truck-fast fa-lg"></i> REGISTRAR EXPEDIÇÃO
                                                </button>

                                                <!-- Botão Secundário: TRANSFERIR -->
                                                <button class="btn-action btn-transfer" onclick="abrirTransferirModal({{ item.id }}, '{{ item.lote }}', '{{ item.endereco }}', {{ item.saldo }})">
                                                    <i class="fas fa-dolly"></i> Transferir
                                                </button>
                                                {% endif %}

                                                <!-- Botão Terciário: EDITAR -->
                                                <button class="btn-action btn-edit" onclick="abrirEditarModal({{ item.id }})">
                                                    <i class="fas fa-pen"></i> Editar
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- COLUNA DIREITA: HISTÓRICO RICO -->
                                    <div class="col-lg-7">
                                        <div class="h-100 bg-white rounded-lg border p-4 shadow-sm" style="border-radius: var(--radius-lg);">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-4">Linha do Tempo</h6>
                                            
                                            <div class="timeline" style="max-height: 500px; overflow-y: auto;">
                                                {% for h in item.historico.all %}
                                                <div class="timeline-node">
                                                    <div class="timeline-dot {% if 'Entrada' in h.tipo %}in{% elif 'Saída' in h.tipo or 'Expedição' in h.tipo %}out{% else %}move{% endif %}"></div>
                                                    
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <span class="fw-bold text-dark">{{ h.tipo }}</span>
                                                        <span class="small text-muted">{{ h.data_hora|date:"d/m/y H:i" }}</span>
                                                    </div>

                                                    <div class="timeline-card">
                                                        <div class="text-secondary small">{{ h.descricao|safe }}</div>
                                                        
                                                        <!-- Galeria -->
                                                        {% if h.fotos.all %}
                                                        <div class="thumb-grid">
                                                            {% for foto in h.fotos.all %}
                                                            <img src="{{ foto.arquivo.url }}" class="thumb" onclick="verFoto('{{ foto.arquivo.url }}', '{{ h.tipo }}')">
                                                            {% endfor %}
                                                        </div>
                                                        {% endif %}

                                                        <div class="mt-2 text-end text-muted" style="font-size: 0.7rem;">
                                                            <i class="fas fa-user-circle me-1"></i> {{ h.usuario.first_name|default:h.usuario.username }}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <div class="text-center py-5 text-muted">
                                                    <i class="fas fa-history fa-2x mb-2 opacity-50"></i>
                                                    <p>Sem histórico registrado.</p>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>

                    <!-- MODAL SAÍDA (Para cada item) -->
                    <div class="modal fade" id="modalSaida{{ item.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <form method="POST" action="{% url 'sapp:registrar_saida' item.id %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title"><i class="fas fa-truck me-2"></i>Expedição: {{ item.lote }}</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="alert alert-light border border-danger text-danger fw-bold d-flex justify-content-between">
                                            <span>SALDO DISPONÍVEL:</span>
                                            <span>{{ item.saldo }} {{ item.embalagem }}</span>
                                        </div>
                                        
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="fw-bold text-uppercase small">Quantidade</label>
                                                <input type="number" name="quantidade_saida" class="form-control form-control-lg border-danger" max="{{ item.saldo }}" required placeholder="0">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="fw-bold text-uppercase small">Nº Carga</label>
                                                <input type="text" name="numero_carga" class="form-control form-control-lg" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="fw-bold text-uppercase small">Motorista</label>
                                                <input type="text" name="motorista" class="form-control" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="fw-bold text-uppercase small">Placa</label>
                                                <input type="text" name="placa" class="form-control" required>
                                            </div>
                                            <div class="col-12">
                                                <label class="fw-bold text-uppercase small">Cliente / Destino</label>
                                                <input type="text" name="cliente" class="form-control">
                                            </div>
                                            <div class="col-12">
                                                <label class="fw-bold text-danger text-uppercase small">Fotos (Obrigatório)</label>
                                                <input type="file" name="fotos" class="form-control" multiple required>
                                            </div>
                                            <div class="col-12">
                                                <label class="fw-bold text-uppercase small">Observações</label>
                                                <textarea name="observacao" class="form-control" rows="2"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer bg-light">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-danger px-4 fw-bold">CONFIRMAR SAÍDA</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAIS GERAIS (Nova Entrada, Transferir, Foto) -->
<div class="modal fade" id="modalNovaEntrada" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form method="POST" action="{% url 'sapp:nova_entrada' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Nova Entrada</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="fw-bold">Lote *</label>
                            <input type="text" name="lote" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="fw-bold">Quantidade *</label>
                            <input type="number" name="entrada" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label>Cultivar *</label>
                            <select name="cultivar" class="form-select" required>
                                {% for c in all_cultivares %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>Peneira *</label>
                            <select name="peneira" class="form-select" required>
                                {% for p in all_peneiras %}<option value="{{ p.id }}">{{ p.nome }}</option>{% endfor %}
                            </select>
                        </div>
                         <div class="col-md-6">
                            <label>Categoria *</label>
                            <select name="categoria" class="form-select" required>
                                {% for c in all_categorias %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>Tratamento</label>
                            <select name="tratamento" class="form-select">
                                <option value="">Nenhum</option>
                                {% for t in all_tratamentos %}<option value="{{ t.id }}">{{ t.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="fw-bold">Endereço *</label>
                            <input type="text" name="endereco" class="form-control" required>
                        </div>
                         <div class="col-md-6">
                            <label>Embalagem</label>
                            <select name="embalagem" class="form-select">
                                <option value="BAG">Big Bag</option>
                                <option value="SC">Saco</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="fw-bold">Fotos (Opcional)</label>
                            <input type="file" name="fotos" class="form-control" multiple>
                        </div>
                        <div class="col-12">
                            <label>Observação</label>
                            <textarea name="observacao" class="form-control"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">SALVAR</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalTransferir" tabindex="-1">
    <div class="modal-dialog">
        <form method="POST" id="formTransferir" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Transferir</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-1"><strong>Lote:</strong> <span id="transf_lote"></span></p>
                    <p class="mb-3"><strong>Origem:</strong> <span id="transf_origem"></span> (Max: <span id="transf_max"></span>)</p>
                    <div class="mb-3">
                        <label class="fw-bold">Quantidade</label>
                        <input type="number" name="quantidade" id="transf_qtd" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Novo Endereço</label>
                        <input type="text" name="novo_endereco" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Fotos</label>
                        <input type="file" name="fotos" class="form-control" multiple>
                    </div>
                    <div class="mb-3">
                        <label>Obs</label>
                        <input type="text" name="observacao" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning w-100 fw-bold">CONFIRMAR</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalFoto" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
             <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2 z-index-3" data-bs-dismiss="modal"></button>
            <div class="modal-body text-center p-0">
                <img src="" id="fotoGrande" class="img-fluid rounded shadow" style="max-height: 90vh;">
                <h6 class="text-white mt-2" id="fotoTitulo"></h6>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleDetails(rowId) {
        const row = document.getElementById(rowId);
        // Fecha outros
        document.querySelectorAll('tr[id^="details-"]').forEach(r => {
            if(r.id !== rowId) r.classList.add('d-none');
        });
        // Alterna atual
        row.classList.toggle('d-none');
    }

    function abrirTransferirModal(id, lote, endereco, maxSaldo) {
        document.getElementById('transf_lote').innerText = lote;
        document.getElementById('transf_origem').innerText = endereco;
        document.getElementById('transf_max').innerText = maxSaldo;
        document.getElementById('transf_qtd').max = maxSaldo;
        document.getElementById('formTransferir').action = `/estoque/transferir/${id}/`;
        new bootstrap.Modal(document.getElementById('modalTransferir')).show();
    }

    function abrirEditarModal(id) {
        window.location.href = `/estoque/editar/${id}/`;
    }

    function verFoto(url, titulo) {
        document.getElementById('fotoGrande').src = url;
        document.getElementById('fotoTitulo').innerText = titulo;
        new bootstrap.Modal(document.getElementById('modalFoto')).show();
    }
</script>

{% endblock %}