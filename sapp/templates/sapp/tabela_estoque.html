{% extends 'sapp/base.html' %}

{% block content %}
<style>
    .bg-header-custom { background-color: #8B4513; color: white; } 
    .bg-sub-header { background-color: #D2691E; color: white; font-weight: bold; }
    .table-hover tbody tr:hover { background-color: #f5f5f5; }
    .badge-bag { background-color: #2E8B57; } 
    .badge-sc { background-color: #A0522D; }
    
    .history-box {
        background-color: #fff8dc; 
        border-left: 5px solid #8B4513;
        padding: 15px;
        margin: 10px;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    }
</style>

<div class="container-fluid mt-4">
    
    <div class="row mb-3 text-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-header-custom">TOTAL EM BAGS</div>
                <div class="card-body"><h3>{{ total_bag }} <small>bags</small></h3></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-header-custom">
                    TOTAL EM SACOS (CONVERTIDO) <br>
                    <small style="font-weight: normal; font-size: 0.7em;"></small>
                </div>
                <div class="card-body">
                    <h3>{{ total_sc }} <small>sc</small></h3>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mb-3 align-items-end">
        <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#modalNovaEntrada">
            <i class="fas fa-plus-circle"></i> NOVA ENTRADA
        </button>
        
        <form class="d-flex" method="GET">
            <input class="form-control me-2" type="search" name="busca" placeholder="Lote, Cultivar..." value="{{ request.GET.busca }}">
            <button class="btn btn-outline-dark" type="submit">Pesquisar</button>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-sm text-center align-middle">
            <thead class="bg-sub-header">
                <tr>
                    <th style="width: 50px;">+</th>
                    <th>LOTE</th>
                    <th>CULTIVAR</th>
                    <th>PN</th>
                    <th>CAT</th>
                    <th>ENDEREÇO</th>
                    <th>SALDO</th>
                    <th>EMB.</th>
                    <th>PESO TOTAL</th>
                    <th>STATUS</th>
                </tr>
            </thead>
            <tbody>
                {% for item in itens %}
                <tr>
                    <td>
                        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.id }}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                    <td class="fw-bold">{{ item.lote }}</td>
                    <td>{{ item.cultivar.nome }}</td>
                    <td>{{ item.peneira.nome }}</td>
                    <td>{{ item.categoria.nome }}</td>
                    <td>{{ item.endereco }}</td>
                    <td class="fs-5">{{ item.saldo }}</td>
                    <td>
                        {% if item.embalagem == 'BAG' %}
                            <span class="badge badge-bag">BAG</span>
                        {% else %}
                            <span class="badge badge-sc">SC</span>
                        {% endif %}
                    </td>
                    <td>{{ item.peso_total }} kg</td>
                    <td>
                        {% if item.saldo > 0 %}
                            <span class="text-success fw-bold">Disponível</span>
                        {% else %}
                            <span class="text-danger fw-bold">Esgotado</span>
                        {% endif %}
                    </td>
                </tr>

                <tr class="collapse" id="collapse{{ item.id }}">
                    <td colspan="10" class="p-0">
                        <div class="history-box text-start">
                            <div class="row">
                                <div class="col-md-4 border-end">
                                    <h5 class="text-primary">Ações e Detalhes</h5>
                                    
                                    <div class="d-grid gap-2 mb-3">
                                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalTransferir{{ item.id }}">
                                            <i class="fas fa-exchange-alt"></i> Transferir Endereço
                                        </button>
                                        <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditar{{ item.id }}">
                                            <i class="fas fa-edit"></i> Editar Dados
                                        </button>
                                    </div>
                                    
                                    <button class="btn btn-danger btn-sm" onclick="if(confirm('ATENÇÃO: Tem certeza que deseja excluir este lote PERMANENTEMENTE? O histórico será mantido.')) { document.getElementById('form-excluir-{{ item.id }}').submit(); }">
                                        <i class="fas fa-trash"></i> Excluir Lote
                                    </button>

                                    <form id="form-excluir-{{ item.id }}" action="{% url 'sapp:excluir_lote' item.id %}" method="POST" style="display:none;">
                                        {% csrf_token %}
                                    </form>
                                    
                                    <hr>
                                    <ul class="list-unstyled small">
                                        <li><strong>Empresa:</strong> {{ item.empresa }}</li>
                                        <li><strong>Tratamento:</strong> {{ item.tratamento.nome|default:"Sem Tratamento" }}</li>
                                        <!-- Aqui mostramos o nome do usuário conferente (pode ser first_name ou username) -->
                                        <li><strong>Conferente (Último):</strong> {{ item.conferente.first_name|default:item.conferente.username }}</li>
                                        <li><strong>Observação:</strong> {{ item.observacao|default:"--" }}</li>
                                        <li><strong>Origem/Destino:</strong> {{ item.origem_destino }}</li>
                                    </ul>
                                </div>
                                
                                <div class="col-md-8">
                                    <h5 class="text-secondary"><i class="fas fa-history"></i> Histórico</h5>
                                    <table class="table table-striped table-sm bg-white border rounded">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Usuário</th>
                                                <th>Tipo</th>
                                                <th>Descrição</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for h in item.historico.all %}
                                            <tr>
                                                <td>{{ h.data_hora|date:"d/m/Y H:i" }}</td>
                                                <td>{{ h.usuario.username|default:"Sistema" }}</td>
                                                <td><span class="badge bg-info text-dark">{{ h.tipo }}</span></td>
                                                <td>{{ h.descricao|safe }}</td> 
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="4" class="text-center text-muted">Nenhum histórico registrado.</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>

                <!-- Modal Transferir -->
                <div class="modal fade" id="modalTransferir{{ item.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <form method="POST" action="{% url 'sapp:transferir' item.id %}">
                            {% csrf_token %}
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Transferir: {{ item.lote }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Endereço Atual: <strong>{{ item.endereco }}</strong></p>
                                    <p>Saldo: <strong>{{ item.saldo }}</strong></p>
                                    <label class="form-label">Quantidade:</label>
                                    <input type="number" name="quantidade" class="form-control mb-2" max="{{ item.saldo }}" required>
                                    <label class="form-label">Novo Endereço:</label>
                                    <input type="text" name="novo_endereco" class="form-control" required>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Confirmar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal Editar COMPLETO -->
                <div class="modal fade" id="modalEditar{{ item.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <form method="POST" action="{% url 'sapp:editar' item.id %}">
                            {% csrf_token %}
                            <div class="modal-content">
                                <div class="modal-header bg-secondary text-white">
                                    <h5 class="modal-title">Edição Completa: {{ item.lote }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">Lote</label>
                                            <input type="text" name="lote" class="form-control" value="{{ item.lote }}">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">Endereço</label>
                                            <input type="text" name="endereco" class="form-control" value="{{ item.endereco }}">
                                        </div>
                                        
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">Cultivar</label>
                                            <select name="cultivar" class="form-select">
                                                {% for c in all_cultivares %}
                                                    <option value="{{ c.id }}" {% if item.cultivar.id == c.id %}selected{% endif %}>{{ c.nome }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">Peneira</label>
                                            <select name="peneira" class="form-select">
                                                {% for p in all_peneiras %}
                                                    <option value="{{ p.id }}" {% if item.peneira.id == p.id %}selected{% endif %}>{{ p.nome }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">Categoria</label>
                                            <select name="categoria" class="form-select">
                                                {% for cat in all_categorias %}
                                                    <option value="{{ cat.id }}" {% if item.categoria.id == cat.id %}selected{% endif %}>{{ cat.nome }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">Empresa</label>
                                            <input type="text" name="empresa" class="form-control" value="{{ item.empresa }}">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">Origem/Destino</label>
                                            <input type="text" name="origem_destino" class="form-control" value="{{ item.origem_destino }}">
                                        </div>

                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Peso Unit.</label>
                                            <input type="number" step="0.01" name="peso_unitario" class="form-control" value="{{ item.peso_unitario|stringformat:'.2f' }}">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Embalagem</label>
                                            <select name="embalagem" class="form-select">
                                                <option value="BAG" {% if item.embalagem == 'BAG' %}selected{% endif %}>BAG</option>
                                                <option value="SC" {% if item.embalagem == 'SC' %}selected{% endif %}>SC</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <label class="form-label">AZ</label>
                                            <input type="text" name="az" class="form-control" value="{{ item.az|default:'' }}">
                                        </div>
                                        
                                        <!-- REMOVIDO O CAMPO CONFERENTE (POIS É AUTOMÁTICO AGORA) -->

                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">Tratamento</label>
                                            <select name="tratamento" class="form-select">
                                                <option value="">Sem Tratamento</option>
                                                {% for t in all_tratamentos %}
                                                    <option value="{{ t.id }}" {% if item.tratamento and item.tratamento.id == t.id %}selected{% endif %}>{{ t.nome }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-12 mb-2">
                                            <label class="form-label">Observação</label>
                                            <textarea name="observacao" class="form-control" rows="1">{{ item.observacao|default:'' }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-success">Salvar Alterações</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nova Entrada -->
<div class="modal fade" id="modalNovaEntrada" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form method="POST" action="{% url 'sapp:nova_entrada' %}">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header bg-header-custom">
                    <h5 class="modal-title">Nova Entrada de Estoque</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        {% for field in form_entrada %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold small">{{ field.label }}</label>
                            {{ field }} 
                            {% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success w-100">REGISTRAR ENTRADA</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Estilização automática dos campos
    document.querySelectorAll('#modalNovaEntrada input').forEach(el => el.classList.add('form-control'));
    document.querySelectorAll('#modalNovaEntrada select').forEach(el => el.classList.add('form-select'));
    document.querySelectorAll('#modalNovaEntrada textarea').forEach(el => el.classList.add('form-control'));

    // Script de Preenchimento Automático
    document.addEventListener("DOMContentLoaded", function() {
        const campoLote = document.getElementById('id_lote');
        
        if (campoLote) {
            campoLote.addEventListener('blur', function() {
                const loteDigitado = campoLote.value;
                
                if (loteDigitado) {
                    // USA A URL DINÂMICA DO DJANGO PARA EVITAR ERRO 404
                    const urlApi = "{% url 'sapp:api_buscar_dados_lote' %}?lote=" + encodeURIComponent(loteDigitado);

                    fetch(urlApi)
                        .then(response => {
                            if (!response.ok) { throw new Error("Erro na rede"); }
                            return response.json();
                        })
                        .then(data => {
                            if (data.encontrado) {
                                // Preenche os selects (IDs)
                                document.getElementById('id_cultivar').value = data.cultivar;
                                document.getElementById('id_peneira').value = data.peneira;
                                document.getElementById('id_categoria').value = data.categoria;
                                
                                const campoTrat = document.getElementById('id_tratamento');
                                if(campoTrat) campoTrat.value = data.tratamento;

                                // Preenche os textos
                                document.getElementById('id_endereco').value = data.endereco;
                                document.getElementById('id_empresa').value = data.empresa;
                                document.getElementById('id_origem_destino').value = data.origem_destino;
                                document.getElementById('id_peso_unitario').value = data.peso_unitario;
                                document.getElementById('id_embalagem').value = data.embalagem;
                                document.getElementById('id_az').value = data.az;
                                document.getElementById('id_observacao').value = data.observacao;
                                
                                // Feedback visual (Borda verde)
                                campoLote.classList.add('is-valid');
                                setTimeout(() => campoLote.classList.remove('is-valid'), 2000);
                            }
                        })
                        .catch(error => console.error('Erro ao buscar:', error));
                }
            });
        }
    });
</script>
{% endblock %}