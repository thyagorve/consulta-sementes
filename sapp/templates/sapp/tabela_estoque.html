{% extends 'sapp/base.html' %}
{% load humanize %}
{% load static %}

{% block content %}
<style>
    /* --- DESIGN SYSTEM SIMPLIFICADO --- */
    :root {
        --primary: #2563eb;
        --primary-light: #3b82f6;
        --primary-dark: #1e40af;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --surface: #ffffff;
        --surface-light: #f8fafc;
        --surface-dark: #1e293b;
        --border: #e2e8f0;
        --text: #334155;
        --text-light: #64748b;
    }

    body {
        background-color: #f8fafc;
        font-family: 'Inter', -apple-system, sans-serif;
        color: var(--text);
    }

    /* --- HEADER SIMPLES --- */
    .page-header {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--surface-dark);
        margin-bottom: 0.25rem;
    }

    .page-subtitle {
        color: var(--text-light);
        font-size: 0.875rem;
    }

    /* --- BOTÃO PRINCIPAL --- */
    .btn-primary-main {
        background: var(--primary);
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        color: white;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary-main:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    /* --- CARDS DE MÉTRICAS --- */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        overflow: hidden;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }

    .metric-card.entrada::before { background: var(--success); }
    .metric-card.saida::before { background: var(--danger); }
    .metric-card.saldo::before { background: var(--primary); }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .metric-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: white;
    }

    .metric-icon.entrada { background: var(--success); }
    .metric-icon.saida { background: var(--danger); }
    .metric-icon.saldo { background: var(--primary); }

    .metric-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-light);
        letter-spacing: 0.05em;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--surface-dark);
        line-height: 1;
        margin: 0.5rem 0;
    }

    .metric-detail {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }

    .metric-total {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .total-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-light);
    }

    .total-value {
        font-size: 1.125rem;
        font-weight: 700;
    }

    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }
    .text-primary { color: var(--primary); }

    /* --- BARRA DE PESQUISA --- */
    .search-container {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
    }

    .search-wrapper {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-light);
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .filter-select {
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.875rem;
        background: white;
        min-width: 160px;
    }

    /* --- TABELA --- */
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
        margin-bottom: 2rem;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table thead {
        background: #f8fafc;
    }

    .table th {
        padding: 1rem 1.25rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-light);
        border-bottom: 1px solid var(--border);
    }

    .table tbody tr {
        border-bottom: 1px solid var(--border);
        transition: background-color 0.2s;
    }

    .table tbody tr:hover {
        background: #f8fafc;
        cursor: pointer;
    }

    .table tbody tr:last-child {
        border-bottom: none;
    }

    .table td {
        padding: 1rem 1.25rem;
        vertical-align: middle;
        font-size: 0.875rem;
    }

    /* --- BADGES --- */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-primary {
        background: #dbeafe;
        color: #1e40af;
    }

    /* --- DETALHES EXPANDÍVEIS --- */
    .detail-row {
        background: #f8fafc;
    }

    .detail-content {
        padding: 1.5rem;
    }

    .spec-card {
        background: white;
        border-radius: 8px;
        padding: 1.25rem;
        border: 1px solid var(--border);
        height: 100%;
    }

    .spec-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .spec-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .spec-item:last-child {
        border-bottom: none;
    }

    .spec-label {
        color: var(--text-light);
        font-size: 0.875rem;
    }

    .spec-value {
        font-weight: 600;
        color: var(--text);
    }

    /* --- BOTÕES DE AÇÃO --- */
    .action-buttons {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
    }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
        transform: translateY(-1px);
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }

    .btn-warning:hover {
        background: #d97706;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #f1f5f9;
        color: var(--text);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: #e2e8f0;
    }

    /* --- TIMELINE --- */
    .timeline-card {
        background: white;
        border-radius: 8px;
        padding: 1.25rem;
        border: 1px solid var(--border);
        height: 100%;
    }

    .timeline {
        position: relative;
        padding-left: 2rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 1.25rem;
        padding-left: 1rem;
    }

    .timeline-dot {
        position: absolute;
        left: -1.5rem;
        top: 0.25rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 2px var(--border);
    }

    .timeline-dot.entrada { background: var(--success); }
    .timeline-dot.saida { background: var(--danger); }
    .timeline-dot.transferencia { background: var(--warning); }

    .timeline-content {
        background: white;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid var(--border);
    }

    /* --- MODAIS --- */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        background: var(--primary);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1.25rem 1.5rem;
        border: none;
    }

    .modal-title {
        font-weight: 600;
        font-size: 1.125rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--text);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 0.875rem;
        transition: border-color 0.2s;
        width: 100%;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .modal-footer {
        padding: 1.25rem 1.5rem;
        border-top: 1px solid var(--border);
        background: #f8fafc;
        border-radius: 0 0 12px 12px;
    }

    /* --- RESPONSIVIDADE --- */
    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .table td, .table th {
            padding: 0.75rem;
        }
        
        .mobile-hidden {
            display: none;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn-action {
            width: 100%;
            justify-content: center;
        }
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .text-muted {
        color: var(--text-light) !important;
    }

    .fw-bold {
        font-weight: 600;
    }

    .fs-5 {
        font-size: 1.25rem;
    }

    .fs-6 {
        font-size: 1rem;
    }

    .small {
        font-size: 0.875rem;
    }

    .text-center {
        text-align: center;
    }

    .d-flex {
        display: flex;
    }

    .justify-content-between {
        justify-content: space-between;
    }

    .align-items-center {
        align-items: center;
    }

    .gap-1 { gap: 0.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 1rem; }
    .gap-4 { gap: 1.5rem; }

    .mb-0 { margin-bottom: 0; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 1rem; }
    .mb-4 { margin-bottom: 1.5rem; }

    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 1rem; }
    .mt-4 { margin-top: 1.5rem; }

    .ms-1 { margin-left: 0.25rem; }
    .ms-2 { margin-left: 0.5rem; }

    .me-1 { margin-right: 0.25rem; }
    .me-2 { margin-right: 0.5rem; }

    .p-0 { padding: 0; }
    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 1rem; }

    .border-0 { border: 0; }
    .border { border: 1px solid var(--border); }

    .rounded { border-radius: 6px; }
    .rounded-pill { border-radius: 50rem; }

    .bg-light { background-color: #f8fafc; }
    .bg-primary { background-color: var(--primary); }

    .text-white { color: white; }
    .text-dark { color: var(--surface-dark); }

    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    .position-relative { position: relative; }
    .position-absolute { position: absolute; }

    .top-0 { top: 0; }
    .end-0 { right: 0; }
    .start-0 { left: 0; }

    .translate-middle-y {
        transform: translateY(-50%);
    }

    .z-index-3 { z-index: 3; }

    .d-none { display: none; }
    .d-block { display: block; }
    .d-inline-flex { display: inline-flex; }

    .w-100 { width: 100%; }
    .flex-grow-1 { flex-grow: 1; }

    .flex-wrap { flex-wrap: wrap; }

    .align-items-baseline { align-items: baseline; }

    .fst-italic { font-style: italic; }

    .border-top-0 { border-top: 0; }

    .table-active {
        background-color: rgba(37, 99, 235, 0.05) !important;
    }

    .table-responsive {
        overflow-x: auto;
    }

    /* --- GALERIA DE FOTOS --- */
    .thumb-grid {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }

    .thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid var(--border);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .thumb:hover {
        transform: scale(1.1);
        border-color: var(--primary);
    }

    /* --- ALERTAS --- */
    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid transparent;
    }

    .alert-danger {
        background-color: #fee2e2;
        border-color: #fecaca;
        color: #991b1b;
    }

    .alert-warning {
        background-color: #fef3c7;
        border-color: #fde68a;
        color: #92400e;
    }

    .alert-light {
        background-color: #f8fafc;
        border-color: #e2e8f0;
        color: #334155;
    }

    /* --- OBSERVAÇÃO --- */
    .obs-container {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border: 1px solid var(--border);
    }

    .obs-text {
        font-size: 0.875rem;
        color: var(--text);
        font-style: italic;
        margin: 0;
    }
</style>

<div class="container-fluid py-3">
    <!-- HEADER -->
    <div class="page-header">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
            <div>
                <h1 class="page-title">Controle de Estoque</h1>
                <p class="page-subtitle">Visão geral e gerenciamento de lotes</p>
            </div>
            <button class="btn-primary-main" data-bs-toggle="modal" data-bs-target="#modalNovaEntrada">
                <i class="fas fa-plus"></i>
                Nova Entrada
            </button>
        </div>
    </div>

    <!-- MÉTRICAS -->
    <div class="metrics-grid">
        <!-- Entrada -->
        <div class="metric-card entrada">
            <div class="metric-header">
                <div>
                    <div class="metric-label">Entrada Total</div>
                    <div class="metric-value">{{ dados_entrada.bags|intcomma }}</div>
                    <div class="metric-detail">BIG BAGS</div>
                </div>
                <div class="metric-icon entrada">
                    <i class="fas fa-arrow-down"></i>
                </div>
            </div>
            {% if dados_entrada.sc_fisico > 0 %}
            <div class="metric-detail">
                <i class="fas fa-plus text-success me-1"></i>
                {{ dados_entrada.sc_fisico|intcomma }} sacos avulsos
            </div>
            {% endif %}
            <div class="metric-total">
                <span class="total-label">Convertido (SC)</span>
                <span class="total-value text-success">{{ dados_entrada.total_sc|intcomma }}</span>
            </div>
        </div>

        <!-- Saída -->
        <div class="metric-card saida">
            <div class="metric-header">
                <div>
                    <div class="metric-label">Saída Total</div>
                    <div class="metric-value">{{ dados_saida.bags|intcomma }}</div>
                    <div class="metric-detail">BIG BAGS</div>
                </div>
                <div class="metric-icon saida">
                    <i class="fas fa-arrow-up"></i>
                </div>
            </div>
            {% if dados_saida.sc_fisico > 0 %}
            <div class="metric-detail">
                <i class="fas fa-plus text-danger me-1"></i>
                {{ dados_saida.sc_fisico|intcomma }} sacos avulsos
            </div>
            {% endif %}
            <div class="metric-total">
                <span class="total-label">Convertido (SC)</span>
                <span class="total-value text-danger">{{ dados_saida.total_sc|intcomma }}</span>
            </div>
        </div>

        <!-- Saldo -->
        <div class="metric-card saldo">
            <div class="metric-header">
                <div>
                    <div class="metric-label">Saldo Físico</div>
                    <div class="metric-value">{{ dados_saldo.bags|intcomma }}</div>
                    <div class="metric-detail">BIG BAGS</div>
                </div>
                <div class="metric-icon saldo">
                    <i class="fas fa-balance-scale"></i>
                </div>
            </div>
            {% if dados_saldo.sc_fisico > 0 %}
            <div class="metric-detail">
                <i class="fas fa-plus text-primary me-1"></i>
                {{ dados_saldo.sc_fisico|intcomma }} sacos avulsos
            </div>
            {% endif %}
            <div class="metric-total">
                <span class="total-label">Disponível (SC)</span>
                <span class="total-value text-primary">{{ dados_saldo.total_sc|intcomma }}</span>
            </div>
        </div>
    </div>

    <!-- BARRA DE PESQUISA -->
    <div class="search-container">
        <div class="row g-2">
            <div class="col-md-8">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <form method="GET" class="mb-0">
                        <input type="text" 
                               name="busca" 
                               class="search-input" 
                               placeholder="Pesquisar por lote, cultivar, local, cliente..."
                               value="{{ busca }}">
                    </form>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <form method="GET" class="d-flex gap-2 w-100">
                        <input type="hidden" name="busca" value="{{ busca }}">
                        <select name="status" class="filter-select w-100" onchange="this.form.submit()">
                            <option value="">Todos os status</option>
                            <option value="disponivel" {% if status == 'disponivel' %}selected{% endif %}>Disponíveis</option>
                            <option value="esgotado" {% if status == 'esgotado' %}selected{% endif %}>Esgotados</option>
                        </select>
                        {% if busca or status %}
                        <a href="{% url 'sapp:lista_estoque' %}" class="btn btn-outline-secondary" title="Limpar filtros">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- TABELA -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th width="50"></th>
                        <th>Lote</th>
                        <th>Produto / Cliente / Variedade</th>
                        <th class="mobile-hidden">Endereço</th>
                        <th class="text-center">Tratamento</th>
                        <th class="text-center">Fluxo  Entrada / Saldo</th>
                        <th width="100" class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in itens %}
                    <tr onclick="toggleDetails('details-{{ item.id }}')" class="cursor-pointer">
                        <td class="text-center">
                            <i class="fas fa-chevron-right text-primary" id="chevron-{{ item.id }}"></i>
                        </td>
                        <td>
                            <div class="fw-bold text-dark">{{ item.lote }}</div>
                            <small class="text-muted">{{ item.data_entrada|date:"d/m/y" }}</small>
                        </td>
                        <td>
                            <div class="fw-bold">{{ item.cultivar.nome }}</div>
                            {% if item.cliente %}
                            <small class="text-primary d-block">
                                <i class="fas fa-user-tag me-1"></i>{{ item.cliente }}
                            </small>
                            {% endif %}
                            <small class="text-muted">{{ item.produto|default:"-" }}</small>
                        </td>
                        <td class="mobile-hidden">
                            <span class="badge badge-primary">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ item.endereco }}
                            </span>
                        </td>

<td>
                        <div class="fw-bold">{{ item.tratamento.nome }}</div>
                            {% if item.cliente %}
                            <small class="text-primary d-block">
                                <i class="fas fa-user-tag me-1"></i>{{ item.categoria }}
                            </small>
                            {% endif %}
                            <small class="text-muted">{{ item.peneira|default:"-" }}</small>
                        </td>


                        <td>
                            <div class="d-flex justify-content-center gap-3 mb-1">
                                <span class="text-success fw-bold">
                                    <i class="fas fa-arrow-down me-1"></i>{{ item.entrada }}
                                </span>
                                <span class="text-danger fw-bold">
                                    <i class="fas fa-arrow-up me-1"></i>{{ item.saida }}
                                </span>
                            </div>
                            <div class="text-center">
                                <span class="fw-bold fs-5">{{ item.saldo }}</span>
                                <small class="text-muted ms-1">{{ item.embalagem }}</small>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if item.saldo > 0 %}
                            <span class="badge badge-success">Disponível</span>
                            {% else %}
                            <span class="badge badge-danger">Esgotado</span>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- DETALHES -->
                    <tr id="details-{{ item.id }}" class="d-none detail-row">
                        <td colspan="6" class="p-0">
                            <div class="detail-content">
                                <div class="row g-3">
                                    <!-- Especificações -->
                                    <div class="col-lg-5">
                                        <div class="spec-card">
                                            <h6 class="fw-bold mb-3 text-uppercase small text-muted">Caracteristica</h6>
                                            <ul class="spec-list">
                                                <li class="spec-item">
                                                    <span class="spec-label">Embalagem</span>
                                                    <span class="spec-value">{{ item.embalagem }}</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Peso Unitário</span>
                                                    <span class="spec-value">{{ item.peso_unitario }} kg</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Peso Total</span>
                                                    <span class="spec-value">{{ item.peso_total|intcomma }} kg</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Peneira</span>
                                                    <span class="spec-value">{{ item.peneira.nome }}</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Categoria</span>
                                                    <span class="spec-value">{{ item.categoria.nome }}</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Cliente/Dono</span>
                                                    <span class="spec-value">{{ item.cliente|default:"Não informado" }}</span>
                                                </li>
                                                <li class="spec-item">
                                                    <span class="spec-label">Endereço</span>
                                                    <span class="spec-value">{{ item.endereco }}</span>
                                                </li>
                                                {% if item.az %}
                                                <li class="spec-item">
                                                    <span class="spec-label">Armazém (AZ)</span>
                                                    <span class="spec-value">{{ item.az }}</span>
                                                </li>
                                                {% endif %}
                                            </ul>
                                            
                                            <div class="obs-container mt-3">
                                                <p class="obs-text">
                                                    <strong>Observação:</strong> {{ item.observacao|default:"Nenhuma observação." }}
                                                </p>
                                            </div>

                                            <!-- Botões de Ação -->
                                            <div class="action-buttons">
                                                {% if item.saldo > 0 %}
                                                <button class="btn-action btn-danger" data-bs-toggle="modal" data-bs-target="#modalSaida{{ item.id }}">
                                                    <i class="fas fa-truck"></i>
                                                    Expedição
                                                </button>
                                                <button class="btn-action btn-warning" onclick="abrirTransferirModal({{ item.id }}, '{{ item.lote }}', '{{ item.endereco }}', {{ item.saldo }})">
                                                    <i class="fas fa-exchange-alt"></i>
                                                    Transferir
                                                </button>
                                                {% endif %}
                                                <button class="btn-action btn-secondary" onclick="abrirEditarModal({{ item.id }})" data-bs-toggle="modal" data-bs-target="#modalEditar{{ item.id }}">
                                                    <i class="fas fa-edit"></i>
                                                    Editar
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Histórico -->
                                    <div class="col-lg-7">
                                        <div class="timeline-card h-100">
                                            <h6 class="fw-bold mb-3 text-uppercase small text-muted">Histórico</h6>
                                            <div class="timeline">
                                                {% for h in item.historico.all %}
                                                <div class="timeline-item">
                                                    <div class="timeline-dot 
                                                        {% if 'Entrada' in h.tipo %}entrada
                                                        {% elif 'Saída' in h.tipo or 'Expedição' in h.tipo %}saida
                                                        {% else %}transferencia{% endif %}">
                                                    </div>
                                                    <div class="timeline-content">
                                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                                            <strong>{{ h.tipo }}</strong>
                                                            <small class="text-muted">{{ h.data_hora|date:"d/m H:i" }}</small>
                                                        </div>
                                                        <div class="small text-muted mb-2">{{ h.descricao|safe }}</div>
                                                        {% if h.fotos.all %}
                                                        <div class="thumb-grid">
                                                            {% for foto in h.fotos.all %}
                                                            <img src="{{ foto.arquivo.url }}" 
                                                                 class="thumb"
                                                                 onclick="verFoto('{{ foto.arquivo.url }}', '{{ h.tipo }}')">
                                                            {% endfor %}
                                                        </div>
                                                        {% endif %}
                                                        <div class="small text-muted mt-2">
                                                            <i class="fas fa-user me-1"></i>
                                                            {{ h.usuario.first_name|default:h.usuario.username }}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <div class="text-center py-4 text-muted">
                                                    <i class="fas fa-history fa-2x mb-2 opacity-50"></i>
                                                    <p>Sem histórico registrado</p>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>

                    <!-- MODAL SAÍDA (Expedição) -->
                    <div class="modal fade" id="modalSaida{{ item.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-truck me-2"></i>
                                        Expedição - {{ item.lote }}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <form method="POST" action="{% url 'sapp:registrar_saida' item.id %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="alert alert-warning mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>Saldo disponível:</strong>
                                                <span class="fw-bold fs-5">{{ item.saldo }} {{ item.embalagem }}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Quantidade *</label>
                                                <input type="number" 
                                                       name="quantidade_saida" 
                                                       class="form-control" 
                                                       max="{{ item.saldo }}" 
                                                       min="1"
                                                       required
                                                       placeholder="0">
                                                <small class="text-muted">Máximo: {{ item.saldo }}</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Número da Carga *</label>
                                                <input type="text" 
                                                       name="numero_carga" 
                                                       class="form-control" 
                                                       required
                                                       placeholder="Ex: CARGA-001">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Motorista *</label>
                                                <input type="text" 
                                                       name="motorista" 
                                                       class="form-control" 
                                                       required
                                                       placeholder="Nome completo">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Placa do Veículo *</label>
                                                <input type="text" 
                                                       name="placa" 
                                                       class="form-control" 
                                                       required
                                                       placeholder="AAA-0000">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Cliente / Destino</label>
                                                <input type="text" 
                                                       name="cliente" 
                                                       class="form-control" 
                                                       value="{{ item.cliente|default:'' }}"
                                                       placeholder="Empresa ou pessoa">
                                                {% if item.cliente %}
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle"></i> 
                                                    Cliente já cadastrado para este lote. Edite se necessário.
                                                </small>
                                                {% endif %}
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Fotos da Expedição *</label>
                                                <input type="file" 
                                                       name="fotos" 
                                                       class="form-control" 
                                                       multiple 
                                                       required
                                                       accept="image/*">
                                                <small class="text-muted">Pelo menos uma foto é obrigatória</small>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Observações</label>
                                                <textarea name="observacao" 
                                                          class="form-control" 
                                                          rows="2"
                                                          placeholder="Detalhes adicionais da expedição..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Confirmar Saída
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- MODAL EDITAR (FALTANTE) -->
                    <div class="modal fade" id="modalEditar{{ item.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-edit me-2"></i>
                                        Editar Lote - {{ item.lote }}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <form method="POST" action="{% url 'sapp:editar' item.id %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="row g-3">
                                            <!-- Coluna 1 -->
                                            <div class="col-md-6">
                                                <label class="form-label">Número do Lote *</label>
                                                <input type="text" 
                                                       name="lote" 
                                                       class="form-control" 
                                                       value="{{ item.lote }}"
                                                       required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Endereço *</label>
                                                <input type="text" 
                                                       name="endereco" 
                                                       class="form-control" 
                                                       value="{{ item.endereco }}"
                                                       required
                                                       placeholder="Ex: P-01-02-03">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Cultivar *</label>
                                                <select name="cultivar" class="form-control" required>
                                                    {% for c in all_cultivares %}
                                                    <option value="{{ c.id }}" {% if c.id == item.cultivar.id %}selected{% endif %}>{{ c.nome }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Peneira *</label>
                                                <select name="peneira" class="form-control" required>
                                                    {% for p in all_peneiras %}
                                                    <option value="{{ p.id }}" {% if p.id == item.peneira.id %}selected{% endif %}>{{ p.nome }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Categoria *</label>
                                                <select name="categoria" class="form-control" required>
                                                    {% for cat in all_categorias %}
                                                    <option value="{{ cat.id }}" {% if cat.id == item.categoria.id %}selected{% endif %}>{{ cat.nome }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Tratamento</label>
                                                <select name="tratamento" class="form-control">
                                                    <option value="">Nenhum</option>
                                                    {% for t in all_tratamentos %}
                                                    <option value="{{ t.id }}" {% if item.tratamento and t.id == item.tratamento.id %}selected{% endif %}>{{ t.nome }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <!-- Coluna 2 -->
                                            <div class="col-md-6">
                                                <label class="form-label">Produto</label>
                                                <input type="text" 
                                                       name="produto" 
                                                       class="form-control" 
                                                       value="{{ item.produto|default:'' }}"
                                                       placeholder="Descrição do produto">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Cliente/Dono do Bag</label>
                                                <input type="text" 
                                                       name="cliente" 
                                                       class="form-control" 
                                                       value="{{ item.cliente|default:'' }}"
                                                       placeholder="Nome do cliente">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Peso Unitário (kg)</label>
                                                <input type="text" 
                                                       name="peso_unitario" 
                                                       class="form-control" 
                                                       value="{{ item.peso_unitario }}"
                                                       placeholder="0.00">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Embalagem</label>
                                                <select name="embalagem" class="form-control">
                                                    <option value="BAG" {% if item.embalagem == 'BAG' %}selected{% endif %}>Big Bag</option>
                                                    <option value="SC" {% if item.embalagem == 'SC' %}selected{% endif %}>Saco</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Armazém (AZ)</label>
                                                <input type="text" 
                                                       name="az" 
                                                       class="form-control" 
                                                       value="{{ item.az|default:'' }}"
                                                       placeholder="Número do armazém">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Empresa</label>
                                                <input type="text" 
                                                       name="empresa" 
                                                       class="form-control" 
                                                       value="{{ item.empresa|default:'' }}"
                                                       placeholder="Nome da empresa">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Origem/Destino</label>
                                                <input type="text" 
                                                       name="origem_destino" 
                                                       class="form-control" 
                                                       value="{{ item.origem_destino|default:'' }}"
                                                       placeholder="Informações de origem/destino">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Observações</label>
                                                <textarea name="observacao" 
                                                          class="form-control" 
                                                          rows="3"
                                                          placeholder="Observações importantes...">{{ item.observacao|default:'' }}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>
                                            Salvar Alterações
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginação -->
    {% if itens.has_other_pages %}
    <nav aria-label="Paginação" class="d-flex justify-content-center">
        <ul class="pagination">
            {% if itens.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ itens.previous_page_number }}{% if busca %}&busca={{ busca }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}
            
            {% for num in itens.paginator.page_range %}
                {% if itens.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > itens.number|add:'-3' and num < itens.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if busca %}&busca={{ busca }}{% endif %}{% if status %}&status={{ status }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if itens.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ itens.next_page_number }}{% if busca %}&busca={{ busca }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- MODAL NOVA ENTRADA -->
<div class="modal fade" id="modalNovaEntrada" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Entrada</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'sapp:nova_entrada' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Coluna 1 -->
                        <div class="col-md-6">
                            <label class="form-label">Número do Lote *</label>
                            <input type="text" name="lote" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quantidade *</label>
                            <input type="number" name="entrada" class="form-control" required min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cultivar *</label>
                            <select name="cultivar" class="form-control" required>
                                <option value="">Selecione...</option>
                                {% for c in all_cultivares %}
                                <option value="{{ c.id }}">{{ c.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Peneira *</label>
                            <select name="peneira" class="form-control" required>
                                <option value="">Selecione...</option>
                                {% for p in all_peneiras %}
                                <option value="{{ p.id }}">{{ p.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Categoria *</label>
                            <select name="categoria" class="form-control" required>
                                <option value="">Selecione...</option>
                                {% for cat in all_categorias %}
                                <option value="{{ cat.id }}">{{ cat.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tratamento</label>
                            <select name="tratamento" class="form-control">
                                <option value="">Nenhum</option>
                                {% for t in all_tratamentos %}
                                <option value="{{ t.id }}">{{ t.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Coluna 2 -->
                        <div class="col-md-6">
                            <label class="form-label">Endereço *</label>
                            <input type="text" name="endereco" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Embalagem</label>
                            <select name="embalagem" class="form-control">
                                <option value="BAG">Big Bag</option>
                                <option value="SC">Saco</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Produto</label>
                            <input type="text" name="produto" class="form-control" placeholder="Descrição do produto">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cliente/Dono do Bag</label>
                            <input type="text" name="cliente" class="form-control" placeholder="Nome do cliente">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Peso Unitário (kg)</label>
                            <input type="text" name="peso_unitario" class="form-control" placeholder="0.00">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Armazém (AZ)</label>
                            <input type="text" name="az" class="form-control" placeholder="Número do armazém">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Empresa</label>
                            <input type="text" name="empresa" class="form-control" placeholder="Nome da empresa">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Origem/Destino</label>
                            <input type="text" name="origem_destino" class="form-control" placeholder="Informações de origem/destino">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Fotos (opcional)</label>
                            <input type="file" name="fotos" class="form-control" multiple accept="image/*">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea name="observacao" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL TRANSFERIR -->
<div class="modal fade" id="modalTransferir" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transferir Lote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="formTransferir" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="mb-1"><strong>Lote:</strong> <span id="transf_lote"></span></p>
                        <p class="mb-3"><strong>Origem:</strong> <span id="transf_origem"></span></p>
                        <p class="mb-3"><strong>Saldo disponível:</strong> <span id="transf_max"></span> unidades</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Quantidade a Transferir *</label>
                        <input type="number" 
                               name="quantidade" 
                               id="transf_qtd" 
                               class="form-control" 
                               required
                               min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Novo Endereço *</label>
                        <input type="text" 
                               name="novo_endereco" 
                               class="form-control" 
                               required
                               placeholder="Ex: P-02-03-04">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fotos (opcional)</label>
                        <input type="file" 
                               name="fotos" 
                               class="form-control" 
                               multiple 
                               accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <input type="text" 
                               name="observacao" 
                               class="form-control"
                               placeholder="Motivo da transferência...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-exchange-alt me-1"></i>
                        Confirmar Transferência
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL FOTO -->
<div class="modal fade" id="modalFoto" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body text-center p-0">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-index-3" data-bs-dismiss="modal"></button>
                <img src="" id="fotoGrande" class="img-fluid rounded shadow">
                <h6 class="text-white mt-2" id="fotoTitulo"></h6>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleDetails(rowId) {
        const row = document.getElementById(rowId);
        const chevron = document.getElementById(`chevron-${rowId.split('-')[1]}`);
        
        // Fecha outros painéis
        document.querySelectorAll('tr[id^="details-"]').forEach(r => {
            if(r.id !== rowId) {
                r.classList.add('d-none');
                const otherId = r.id.split('-')[1];
                const otherChevron = document.getElementById(`chevron-${otherId}`);
                if(otherChevron) otherChevron.className = 'fas fa-chevron-right text-primary';
            }
        });
        
        // Alterna atual
        if(row.classList.contains('d-none')) {
            row.classList.remove('d-none');
            chevron.className = 'fas fa-chevron-down text-primary';
        } else {
            row.classList.add('d-none');
            chevron.className = 'fas fa-chevron-right text-primary';
        }
        
        // Adiciona classe de destaque na linha
        document.querySelectorAll('.table tbody tr').forEach(r => {
            r.classList.remove('table-active');
        });
        event.currentTarget.classList.add('table-active');
    }
    
    function abrirTransferirModal(id, lote, endereco, maxSaldo) {
        document.getElementById('transf_lote').textContent = lote;
        document.getElementById('transf_origem').textContent = endereco;
        document.getElementById('transf_max').textContent = maxSaldo;
        document.getElementById('transf_qtd').max = maxSaldo;
        document.getElementById('transf_qtd').value = maxSaldo;
        document.getElementById('formTransferir').action = `/estoque/transferir/${id}/`;
        
        const modal = new bootstrap.Modal(document.getElementById('modalTransferir'));
        modal.show();
    }
    
    function abrirEditarModal(id) {
        // Esta função agora apenas abre o modal via data-bs-target
        // O modal já está vinculado ao botão via data-bs-target
        console.log(`Abrindo edição do item ${id}`);
    }
    
    function verFoto(url, titulo) {
        document.getElementById('fotoGrande').src = url;
        document.getElementById('fotoTitulo').textContent = titulo || 'Foto';
        
        const modal = new bootstrap.Modal(document.getElementById('modalFoto'));
        modal.show();
    }
    
    // Busca em tempo real (opcional)
    document.querySelector('.search-input')?.addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        
        document.querySelectorAll('.table tbody tr:not(.detail-row)').forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(term)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
                // Esconde também o painel de detalhes se estiver aberto
                const rowId = row.getAttribute('onclick')?.match(/details-\d+/)?.[0];
                if (rowId) {
                    const detailRow = document.getElementById(rowId);
                    if (detailRow) {
                        detailRow.classList.add('d-none');
                        const chevron = document.getElementById(`chevron-${rowId.split('-')[1]}`);
                        if (chevron) chevron.className = 'fas fa-chevron-right text-primary';
                    }
                }
            }
        });
    });
    
    // Prevenir envio de formulário ao pressionar Enter na busca
    document.querySelector('.search-input')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            this.closest('form').submit();
        }
    });
    
    // Inicializar tooltips do Bootstrap
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    
    // Auto-focar no primeiro campo dos modais
    document.addEventListener('shown.bs.modal', function(event) {
        const modal = event.target;
        const firstInput = modal.querySelector('input, select, textarea');
        if (firstInput) {
            firstInput.focus();
        }
    });
    
    // Formatação de números para os campos de quantidade
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value && !isNaN(this.value)) {
                this.value = Math.max(1, parseInt(this.value));
                const max = this.getAttribute('max');
                if (max && parseInt(this.value) > parseInt(max)) {
                    this.value = max;
                }
            }
        });
    });
    
    // Formatação de peso unitário
    document.querySelectorAll('input[name="peso_unitario"]').forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value) {
                let value = this.value.replace(',', '.');
                if (!isNaN(value) && value !== '') {
                    this.value = parseFloat(value).toFixed(2);
                }
            }
        });
    });
</script>
{% endblock %}