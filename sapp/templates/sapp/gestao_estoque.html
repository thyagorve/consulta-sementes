{% extends 'sapp/base.html' %}
{% load humanize %}

{% block content %}
<style>
    .table-advanced {
        font-size: 0.875rem;
    }
    
    .table-advanced th {
        background: linear-gradient(135deg, #2f8f4e 0%, #267a41 100%);
        color: white;
        font-weight: 600;
        border: none;
        padding: 12px 8px;
        position: relative;
        cursor: pointer;
    }
    
    .table-advanced th .filter-indicator {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    .table-advanced th.filter-active .filter-indicator {
        color: #ffc107;
    }
    
    .table-advanced th:hover {
        background: linear-gradient(135deg, #267a41 0%, #1f6a36 100%);
    }
    
    .table-advanced td {
        padding: 10px 8px;
        vertical-align: middle;
        border-color: #e9ecef;
    }
    
    .badge-saldo {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
        align-items: center;
    }
    
    .btn-export {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        font-weight: 600;
    }
    
    .btn-import {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        color: white;
        font-weight: 600;
    }
    
    .btn-print {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        border: none;
        color: white;
        font-weight: 600;
    }
    
    .btn-clear-filters {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        color: white;
        font-weight: 600;
    }
    
    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        transition: transform 0.2s;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
    }
    
    .table-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    /* FILTROS ESTILO EXCEL */
    .excel-filter-container {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        min-width: 250px;
        max-width: 300px;
        max-height: 400px;
        overflow-y: auto;
        display: none;
    }
    
    .excel-filter-container.show {
        display: block;
    }
    
    .filter-header {
        padding: 10px 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }
    
    .filter-search {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .filter-search input {
        width: 100%;
        padding: 6px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.875rem;
    }
    
    .filter-options {
        padding: 10px 0;
        max-height: 250px;
        overflow-y: auto;
    }
    
    .filter-option {
        padding: 6px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-option:hover {
        background: #f8f9fa;
    }
    
    .filter-option input[type="checkbox"] {
        margin: 0;
    }
    
    .filter-option label {
        cursor: pointer;
        margin: 0;
        flex: 1;
        font-size: 0.875rem;
    }
    
    .filter-count {
        font-size: 0.75rem;
        color: #6c757d;
        background: #e9ecef;
        padding: 1px 6px;
        border-radius: 10px;
        min-width: 20px;
        text-align: center;
    }
    
    .filter-actions {
        padding: 10px 15px;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }
    
    /* Botão de filtro ativo */
    .filter-active {
        background: #fff3cd !important;
        color: #856404 !important;
    }
    
    /* PAGINAÇÃO MELHORADA */
    .pagination-container {
        background: white;
        border-radius: 10px;
        padding: 1rem 1.5rem;
        margin-top: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }
    
    .pagination-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .pagination-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .pagination-btn {
        min-width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
        color: #2f8f4e;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .pagination-btn:hover {
        background: #f8f9fa;
        border-color: #2f8f4e;
        color: #2f8f4e;
        transform: translateY(-1px);
    }
    
    .pagination-btn.active {
        background: #2f8f4e;
        border-color: #2f8f4e;
        color: white;
    }
    
    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f8f9fa;
    }
    
    .pagination-btn.disabled:hover {
        transform: none;
        border-color: #dee2e6;
    }
    
    .pagination-dots {
        color: #6c757d;
        padding: 0 0.5rem;
    }
    
    .pagination-items-per-page {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }
    
    .pagination-items-select {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.25rem 0.5rem;
        background: white;
        color: #495057;
    }

    /* Campo de busca melhorado */
    .search-container {
        position: relative;
        max-width: 300px;
    }
    
    .search-input {
        padding-left: 2.5rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        border-color: #2f8f4e;
        box-shadow: 0 0 0 0.2rem rgba(47, 143, 78, 0.25);
    }
    
    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        z-index: 5;
    }
    
    /* Cliente badge */
    .badge-cliente {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        margin-top: 2px;
        display: inline-block;
    }
    
    /* Status badges */
    .badge-status-ativo { background: #198754; }
    .badge-status-esgotado { background: #dc3545; }
    .badge-status-bloqueado { background: #6c757d; }
    
    /* Loader para importação */
    .import-loader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .loader-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    /* Empresa badge */
    .badge-empresa {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
    }

    .bg-brown {
        background-color: #8b4513 !important;
        color: white !important;
    }
    
    /* Filtros ativos display */
    .active-filters-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }
    
    .active-filter-badge {
        background: #2f8f4e;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin: 2px;
    }
    
    .active-filter-badge .remove-filter {
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    /* Contador de resultados filtrados */
    .filtered-results {
        background: #e7f1ff;
        border: 1px solid #b3d4fc;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.875rem;
        color: #0d6efd;
        margin-bottom: 15px;
        display: none;
    }
    
    /* Coluna específica para filtro numérico */
    .filter-numeric {
        min-width: 220px;
    }
    
    .filter-numeric .range-inputs {
        display: flex;
        gap: 10px;
        padding: 10px 15px;
    }
    
    .filter-numeric input {
        width: 100%;
        padding: 6px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.875rem;
    }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-success fw-bold mb-1">
                <i class="fa-solid fa-warehouse me-2"></i>Gestão de Estoque
            </h2>
            <p class="text-muted mb-0">Controle completo do estoque atual</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary" id="totalItens">{{ total_itens|intcomma }} itens</span>
            <span class="badge bg-success">{{ total_sc|intcomma }} SC total</span>
        </div>
    </div>

    <!-- Cards de Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex align-items-center">
                    <div class="bg-success rounded-circle p-3 me-3">
                        <i class="fa-solid fa-layer-group text-white"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 text-success">{{ total_itens|intcomma }}</h4>
                        <small class="text-muted">Lotes Ativos</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex align-items-center">
                    <div class="bg-info rounded-circle p-3 me-3">
                        <i class="fa-solid fa-weight-hanging text-white"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 text-info">{{ total_sc|intcomma }}</h4>
                        <small class="text-muted">Equivalente SC</small>
                        <br>
                        <small class="text-muted">
                            ({{ total_bags|intcomma }} BAG × 25 + {{ total_sc_fisico|intcomma }} SC)
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex align-items-center">
                    <div class="bg-warning rounded-circle p-3 me-3">
                        <i class="fa-solid fa-box text-white"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 text-warning">{{ total_bags|intcomma }}</h4>
                        <small class="text-muted">Unidades BAG</small>
                        <br>
                        <small class="text-muted">
                            ({{ total_sc_fisico|intcomma }} unidades SC)
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-circle p-3 me-3">
                        <i class="fa-solid fa-users text-white"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 text-primary">{{ clientes_unicos|default:"0" }}</h4>
                        <small class="text-muted">Clientes Únicos</small>
                        <br>
                        <small class="text-muted">Com lotes ativos</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Ativos -->
    <div class="active-filters-container" id="activeFiltersContainer" style="display: none;">
        <small class="text-muted d-block mb-2">Filtros Ativos:</small>
        <div id="activeFilters"></div>
    </div>

    <!-- Resultados Filtrados -->
    <div class="filtered-results" id="filteredResults">
        Mostrando <span id="filteredCount">0</span> de <span id="totalCount">{{ total_itens|intcomma }}</span> itens
        <span id="clearAllFilters" class="ms-2 text-danger" style="cursor: pointer; text-decoration: underline;">
            Limpar todos os filtros
        </span>
    </div>

    <!-- Botões de Ação -->
    <div class="action-buttons">
        <button class="btn btn-export" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="fa-solid fa-download me-2"></i>Exportar
        </button>
        
        <button class="btn btn-import" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="fa-solid fa-upload me-2"></i>Importar
        </button>
        
        <button class="btn btn-print" onclick="window.print()">
            <i class="fa-solid fa-print me-2"></i>Imprimir
        </button>
        
        <button class="btn btn-clear-filters" onclick="clearAllFilters()" id="clearFiltersBtn" style="display: none;">
            <i class="fa-solid fa-filter-circle-xmark me-2"></i>Limpar Filtros
        </button>
        
        <div class="ms-auto search-container">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="text" id="searchInput" class="form-control search-input" 
                   placeholder="Buscar em todas as colunas..." 
                   value="{{ busca }}">
        </div>
    </div>

    <!-- Tabela de Estoque -->
    <div class="table-container">
        <div class="table-responsive" id="tableContainer">
            <table class="table table-advanced table-hover mb-0" id="estoqueTable">
                <thead>
                    <tr>
                        <th data-column="az" data-type="text">AZ <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="lote" data-type="text">Lote <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="cultivar" data-type="select">Cultivar <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="peneira" data-type="select">Peneira <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="categoria" data-type="select">Categoria <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="endereco" data-type="text">Endereço <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="saldo" data-type="number">Saldo <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="peso_unitario" data-type="number">Peso Unit. (kg) <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="peso_total" data-type="number">Peso Total (kg) <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="especie" data-type="select">Espécie <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="tratamento" data-type="select">Tratamento <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="embalagem" data-type="select">Embalagem <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="cliente" data-type="select">Cliente <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="empresa" data-type="select">Empresa <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="status" data-type="select">Status <i class="fa-solid fa-filter filter-indicator"></i></th>
                        <th data-column="conferente" data-type="select">Conferente <i class="fa-solid fa-filter filter-indicator"></i></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for item in estoque %}
                    <tr onclick="window.location.href='{% url 'sapp:lista_estoque' %}?busca={{ item.lote }}'" 
                        style="cursor: pointer;"
                        data-az="{{ item.az }}"
                        data-lote="{{ item.lote }}"
                        data-cultivar="{{ item.cultivar.nome }}"
                        data-peneira="{{ item.peneira.nome }}"
                        data-categoria="{{ item.categoria.nome }}"
                        data-endereco="{{ item.endereco }}"
                        data-saldo="{{ item.saldo }}"
                        data-peso_unitario="{{ item.peso_unitario }}"
                        data-peso_total="{{ item.peso_total }}"
                        data-especie="{{ item.especie }}"
                        data-tratamento="{{ item.tratamento.nome|default:'' }}"
                        data-embalagem="{{ item.embalagem }}"
                        data-cliente="{{ item.cliente }}"
                        data-empresa="{{ item.empresa }}"
                        data-status="{{ item.status }}"
                        data-conferente="{{ item.conferente.first_name|default:item.conferente.username }}">
                        <td>
                            {% if item.az %}
                            <br><small class="text-muted">{{ item.az }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="fw-bold text-primary">{{ item.lote }}</span>
                        </td>
                     
                        <td>{{ item.cultivar.nome }}</td>
                        <td>{{ item.peneira.nome }}</td>
                        <td>{{ item.categoria.nome }}</td>
                        <td>
                            <span class="badge bg-light text-dark border">{{ item.endereco }}</span>
                        </td>
                        <td>
                            <span class="badge badge-saldo {% if item.saldo > 100 %}bg-success{% elif item.saldo > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ item.saldo|intcomma }}
                            </span>
                        </td>
                        <td>{{ item.peso_unitario|floatformat:3 }} kg</td>
                        <td>
                            <strong>{{ item.peso_total|floatformat:2 }} kg</strong>
                        </td>

                        <td>
                            {% if item.especie %}
                                <span class="badge bg-info text-white">
                                    {{ item.especie }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        
                        <td>
                            {% if item.tratamento %}
                                <span class="badge bg-info">{{ item.tratamento.nome|truncatechars:10 }}</span>
                            {% else %}
                                <span class="badge bg-secondary">Sem Trat.</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if item.embalagem == 'BAG' %}bg-primary{% else %}bg-secondary{% endif %}">
                                {{ item.get_embalagem_display }}
                            </span>
                        </td>
                        <td>
                            {% if item.cliente %}
                                <span class="badge badge-cliente" title="{{ item.cliente }}">
                                    <i class="fas fa-user-tag me-1"></i>{{ item.cliente|truncatechars:15 }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.empresa %}
                                <span class="badge badge-empresa">{{ item.empresa|truncatechars:15 }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.status == 'ATIVO' %}
                                <span class="badge badge-status-ativo">{{ item.status }}</span>
                            {% elif item.status == 'ESGOTADO' %}
                                <span class="badge badge-status-esgotado">{{ item.status }}</span>
                            {% elif item.status == 'BLOQUEADO' %}
                                <span class="badge badge-status-bloqueado">{{ item.status }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ item.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ item.conferente.first_name|default:item.conferente.username }}</small>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="16" class="text-center py-4 text-muted">
                            <i class="fa-solid fa-inbox fa-2x mb-2 d-block"></i>
                            Nenhum item encontrado em estoque
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAGINAÇÃO MELHORADA -->
    {% if estoque.paginator.num_pages > 1 %}
    <div class="pagination-container">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="pagination-info">
                    Mostrando {{ estoque.start_index }} - {{ estoque.end_index }} de {{ estoque.paginator.count }} itens
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="pagination-controls">
                    <!-- Botão Anterior -->
                    {% if estoque.has_previous %}
                    <a href="?page={{ estoque.previous_page_number }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if busca %}&busca={{ busca }}{% endif %}" 
                       class="pagination-btn" title="Página anterior">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                    {% else %}
                    <span class="pagination-btn disabled">
                        <i class="fa-solid fa-chevron-left"></i>
                    </span>
                    {% endif %}
                    
                    <!-- Primeira página -->
                    {% if estoque.number > 3 %}
                    <a href="?page=1{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if busca %}&busca={{ busca }}{% endif %}" 
                       class="pagination-btn" title="Primeira página">
                        1
                    </a>
                    <span class="pagination-dots">...</span>
                    {% endif %}
                    
                    <!-- Páginas ao redor da atual -->
                    {% for num in estoque.paginator.page_range %}
                        {% if num > estoque.number|add:'-3' and num < estoque.number|add:'3' %}
                            {% if num == estoque.number %}
                            <span class="pagination-btn active" title="Página atual">{{ num }}</span>
                            {% else %}
                            <a href="?page={{ num }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if busca %}&busca={{ busca }}{% endif %}" 
                               class="pagination-btn" title="Página {{ num }}">
                                {{ num }}
                            </a>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Última página -->
                    {% if estoque.number < estoque.paginator.num_pages|add:'-2' %}
                    <span class="pagination-dots">...</span>
                    <a href="?page={{ estoque.paginator.num_pages }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if busca %}&busca={{ busca }}{% endif %}" 
                       class="pagination-btn" title="Última página">
                        {{ estoque.paginator.num_pages }}
                    </a>
                    {% endif %}
                    
                    <!-- Botão Próximo -->
                    {% if estoque.has_next %}
                    <a href="?page={{ estoque.next_page_number }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if busca %}&busca={{ busca }}{% endif %}" 
                       class="pagination-btn" title="Próxima página">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                    {% else %}
                    <span class="pagination-btn disabled">
                        <i class="fa-solid fa-chevron-right"></i>
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-4 text-end">
                <div class="pagination-items-per-page">
                    <span class="text-muted">Itens por página:</span>
                    <select class="pagination-items-select" onchange="updatePageSize(this.value)">
                        {% for size in page_sizes %}
                        <option value="{{ size }}" {% if size == page_size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Incluir Modais Separados -->
{% include 'sapp/modais_export_import.html' %}

<!-- Loader para importação -->
<div class="import-loader" id="importLoader">
    <div class="loader-content">
        <div class="spinner-border text-success mb-3" role="status">
            <span class="visually-hidden">Processando...</span>
        </div>
        <h5>Processando Importação</h5>
        <p class="text-muted">Aguarde enquanto processamos o arquivo...</p>
    </div>
</div>

<script>
// gestao_estoque.js
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar sistema de filtros
    initExcelFilters();
    
    // Configurar busca global
    setupSearch();
    
    // Configurar eventos de importação/exportação
    setupImportExport();
});

// ==============================================
// SISTEMA DE FILTROS ESTILO EXCEL
// ==============================================

let filters = {};
let columnValues = {};
let columnTypes = {};
let searchTimeout = null;
let currentImportData = null;
let selectedModifications = new Set();

// Inicializar sistema de filtros
function initExcelFilters() {
    // Extrair valores das colunas
    extractColumnValues();
    
    // Detectar tipos de coluna
    detectColumnTypes();
    
    // Configurar eventos dos cabeçalhos
    setupHeaderEvents();
    
    // Aplicar filtros salvos (se houver)
    loadSavedFilters();
    
    // Configurar botão limpar todos os filtros
    document.getElementById('clearAllFilters')?.addEventListener('click', clearAllFilters);
    
    // Configurar botão de impressão
    document.querySelector('.btn-print')?.addEventListener('click', printTable);
}

// Extrair valores únicos das colunas
function extractColumnValues() {
    const rows = document.querySelectorAll('#tableBody tr');
    columnValues = {};
    
    // Inicializar sets para cada coluna
    document.querySelectorAll('thead th[data-column]').forEach(th => {
        const colName = th.dataset.column;
        columnValues[colName] = new Set();
    });
    
    // Coletar valores de todas as linhas
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        document.querySelectorAll('thead th[data-column]').forEach((th, index) => {
            const colName = th.dataset.column;
            
            if (cells[index]) {
                let value = getCellValue(row, cells[index], colName);
                if (value !== null && value !== undefined && value !== '') {
                    columnValues[colName].add(value);
                }
            }
        });
    });
    
    // Converter Sets para Arrays e ordenar
    Object.keys(columnValues).forEach(key => {
        const valuesArray = Array.from(columnValues[key]);
        
        // Ordenar baseado no tipo de dado
        if (key.includes('saldo') || key.includes('peso') || key.includes('total')) {
            // Ordenar números
            valuesArray.sort((a, b) => a - b);
        } else {
            // Ordenar texto
            valuesArray.sort((a, b) => a.toString().localeCompare(b.toString()));
        }
        
        columnValues[key] = valuesArray;
    });
}

// Detectar tipos de coluna baseado nos dados
function detectColumnTypes() {
    columnTypes = {};
    
    document.querySelectorAll('thead th[data-column]').forEach(th => {
        const colName = th.dataset.column;
        const dataType = th.dataset.type;
        const values = columnValues[colName];
        
        if (dataType) {
            columnTypes[colName] = dataType;
        } else if (values.length > 0) {
            // Auto-detectar tipo
            const sample = values[0];
            if (typeof sample === 'number' || !isNaN(parseFloat(sample))) {
                columnTypes[colName] = 'number';
            } else if (values.length < 20) {
                columnTypes[colName] = 'select';
            } else {
                columnTypes[colName] = 'text';
            }
        } else {
            columnTypes[colName] = 'text';
        }
    });
}

// Obter valor de célula baseado no tipo
function getCellValue(row, cell, columnName) {
    // Primeiro tentar dataset
    const dataValue = row.dataset[columnName];
    if (dataValue !== undefined) {
        // Converter números
        if (columnName.includes('saldo') || columnName.includes('peso') || columnName.includes('total')) {
            const num = parseFloat(dataValue);
            return isNaN(num) ? 0 : num;
        }
        return dataValue;
    }
    
    // Extrair do conteúdo da célula
    let textValue = cell.textContent.trim();
    
    // Limpar badges e ícones
    textValue = textValue.replace(/[★☆♥♠♦♣]/g, '').trim();
    
    // Extrair números
    if (columnName.includes('saldo') || columnName.includes('peso') || columnName.includes('total')) {
        const match = textValue.match(/[\d.,]+/);
        if (match) {
            const num = parseFloat(match[0].replace(',', '.'));
            return isNaN(num) ? 0 : num;
        }
        return 0;
    }
    
    // Extrair texto de badges
    const badge = cell.querySelector('.badge');
    if (badge) {
        return badge.textContent.trim();
    }
    
    return textValue || '';
}

// Configurar eventos nos cabeçalhos
function setupHeaderEvents() {
    document.querySelectorAll('thead th[data-column]').forEach(th => {
        th.addEventListener('click', function(e) {
            // Não abrir filtro se clicar em link ou botão
            if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
            
            const columnName = this.dataset.column;
            const columnType = columnTypes[columnName];
            
            // Fechar outros filtros
            closeAllFilters();
            
            // Remover classe ativa de outros cabeçalhos
            document.querySelectorAll('th').forEach(h => h.classList.remove('filter-active'));
            
            // Adicionar classe ativa
            this.classList.add('filter-active');
            
            // Mostrar filtro
            showExcelFilter(columnName, columnType, e);
        });
    });
}

// Mostrar filtro estilo Excel
function showExcelFilter(columnName, columnType, event) {
    // Criar container
    const filterContainer = document.createElement('div');
    filterContainer.className = 'excel-filter-container';
    filterContainer.id = `filter-${columnName}`;
    
    // Posicionar
    const rect = event.currentTarget.getBoundingClientRect();
    const containerWidth = columnType === 'number' ? 300 : 280;
    
    filterContainer.style.position = 'fixed';
    filterContainer.style.top = `${rect.bottom + window.scrollY + 5}px`;
    filterContainer.style.left = `${Math.min(rect.left + window.scrollX, window.innerWidth - containerWidth - 10)}px`;
    filterContainer.style.width = `${containerWidth}px`;
    filterContainer.style.zIndex = '1050';
    
    // Adicionar conteúdo
    if (columnType === 'number') {
        filterContainer.innerHTML = createNumericFilter(columnName);
    } else if (columnType === 'select') {
        filterContainer.innerHTML = createSelectFilter(columnName);
    } else {
        filterContainer.innerHTML = createTextFilter(columnName);
    }
    
    document.body.appendChild(filterContainer);
    
    // Configurar eventos do filtro
    setupFilterEvents(filterContainer, columnName, columnType);
    
    // Focar no campo de busca se existir
    const searchInput = filterContainer.querySelector('input[type="text"]');
    if (searchInput) searchInput.focus();
    
    // Evento para fechar ao clicar fora
    setTimeout(() => {
        document.addEventListener('click', closeFilterOnClickOutside);
    }, 10);
}

// Criar filtro numérico
function createNumericFilter(columnName) {
    const currentFilter = filters[columnName] || {};
    const min = currentFilter.min !== undefined ? currentFilter.min : '';
    const max = currentFilter.max !== undefined ? currentFilter.max : '';
    
    // Estatísticas dos dados
    const values = columnValues[columnName].filter(v => typeof v === 'number');
    const dataMin = values.length > 0 ? Math.min(...values) : 0;
    const dataMax = values.length > 0 ? Math.max(...values) : 100;
    
    const step = columnName.includes('peso') ? 0.001 : 1;
    
    return `
        <div class="filter-header">
            <strong>${formatColumnName(columnName)}</strong>
            <small class="text-muted ms-2">${columnValues[columnName].length} valores</small>
        </div>
        <div class="filter-numeric">
            <div class="range-inputs p-3">
                <div class="mb-2">
                    <label class="form-label small text-muted mb-1">De:</label>
                    <div class="input-group input-group-sm">
                        <input type="number" 
                               id="${columnName}-min" 
                               class="form-control" 
                               placeholder="Mínimo" 
                               value="${min}" 
                               step="${step}"
                               min="${dataMin}"
                               max="${dataMax}">
                        <button class="btn btn-outline-secondary" type="button" onclick="setMinValue('${columnName}', ${dataMin})">
                            Min
                        </button>
                    </div>
                </div>
                <div>
                    <label class="form-label small text-muted mb-1">Até:</label>
                    <div class="input-group input-group-sm">
                        <input type="number" 
                               id="${columnName}-max" 
                               class="form-control" 
                               placeholder="Máximo" 
                               value="${max}" 
                               step="${step}"
                               min="${dataMin}"
                               max="${dataMax}">
                        <button class="btn btn-outline-secondary" type="button" onclick="setMaxValue('${columnName}', ${dataMax})">
                            Max
                        </button>
                    </div>
                </div>
            </div>
            <div class="filter-actions p-2 border-top">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearColumnFilter('${columnName}')">
                    <i class="fa-solid fa-times me-1"></i>Limpar
                </button>
                <button type="button" class="btn btn-sm btn-primary ms-auto" onclick="applyNumericFilter('${columnName}')">
                    <i class="fa-solid fa-check me-1"></i>Aplicar
                </button>
            </div>
        </div>
    `;
}

// Criar filtro de seleção
function createSelectFilter(columnName) {
    const currentFilter = filters[columnName] || {};
    const selectedValues = currentFilter.values || [];
    const values = columnValues[columnName] || [];
    
    let optionsHtml = '';
    values.forEach(value => {
        const displayValue = value === '' ? '(Vazio)' : value;
        const checked = selectedValues.includes(value) ? 'checked' : '';
        const count = countOccurrences(columnName, value);
        
        optionsHtml += `
            <div class="filter-option">
                <div class="form-check">
                    <input class="form-check-input" 
                           type="checkbox" 
                           id="opt-${columnName}-${value.replace(/[^a-zA-Z0-9]/g, '-')}" 
                           value="${value}" 
                           ${checked}>
                    <label class="form-check-label flex-grow-1" 
                           for="opt-${columnName}-${value.replace(/[^a-zA-Z0-9]/g, '-')}">
                        ${displayValue}
                    </label>
                    <span class="filter-count">${count}</span>
                </div>
            </div>
        `;
    });
    
    return `
        <div class="filter-header">
            <strong>${formatColumnName(columnName)}</strong>
            <small class="text-muted ms-2">${values.length} opções</small>
        </div>
        <div class="filter-search p-2 border-bottom">
            <div class="input-group input-group-sm">
                <span class="input-group-text">
                    <i class="fa-solid fa-search"></i>
                </span>
                <input type="text" 
                       id="${columnName}-search" 
                       class="form-control" 
                       placeholder="Buscar nesta coluna..."
                       onkeyup="filterOptions('${columnName}')">
            </div>
        </div>
        <div class="filter-options p-2" id="${columnName}-options" style="max-height: 250px; overflow-y: auto;">
            ${optionsHtml || '<div class="text-muted p-2 text-center">Nenhum valor encontrado</div>'}
        </div>
        <div class="filter-actions p-2 border-top">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllOptions('${columnName}', false)">
                <i class="fa-solid fa-square me-1"></i>Nenhum
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllOptions('${columnName}', true)">
                <i class="fa-solid fa-check-square me-1"></i>Todos
            </button>
            <button type="button" class="btn btn-sm btn-danger" onclick="clearColumnFilter('${columnName}')">
                <i class="fa-solid fa-times me-1"></i>Limpar
            </button>
            <button type="button" class="btn btn-sm btn-primary" onclick="applySelectFilter('${columnName}')">
                <i class="fa-solid fa-filter me-1"></i>Filtrar
            </button>
        </div>
    `;
}

// Criar filtro de texto
function createTextFilter(columnName) {
    const currentFilter = filters[columnName] || {};
    const searchText = currentFilter.text || '';
    
    return `
        <div class="filter-header">
            <strong>${formatColumnName(columnName)}</strong>
            <small class="text-muted ms-2">Filtro de texto</small>
        </div>
        <div class="filter-search p-3">
            <div class="mb-3">
                <label class="form-label small">Buscar texto:</label>
                <input type="text" 
                       id="${columnName}-text" 
                       class="form-control" 
                       placeholder="Digite para filtrar..."
                       value="${searchText}"
                       onkeyup="debouncedTextFilter('${columnName}')">
            </div>
            <div class="form-check mb-2">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="${columnName}-exact" 
                       ${currentFilter.exact ? 'checked' : ''}>
                <label class="form-check-label small" for="${columnName}-exact">
                    Correspondência exata
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="${columnName}-case" 
                       ${currentFilter.caseSensitive ? 'checked' : ''}>
                <label class="form-check-label small" for="${columnName}-case">
                    Diferenciar maiúsc/minúsc
                </label>
            </div>
        </div>
        <div class="filter-actions p-2 border-top">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearColumnFilter('${columnName}')">
                <i class="fa-solid fa-times me-1"></i>Limpar
            </button>
            <button type="button" class="btn btn-sm btn-primary ms-auto" onclick="applyTextFilter('${columnName}')">
                <i class="fa-solid fa-check me-1"></i>Aplicar
            </button>
        </div>
    `;
}

// Configurar eventos do filtro
function setupFilterEvents(container, columnName, columnType) {
    // Eventos para filtros numéricos
    const minInput = container.querySelector(`#${columnName}-min`);
    const maxInput = container.querySelector(`#${columnName}-max`);
    
    if (minInput) {
        minInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyNumericFilter(columnName);
        });
    }
    
    if (maxInput) {
        maxInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyNumericFilter(columnName);
        });
    }
    
    // Evento para filtros de texto
    const textInput = container.querySelector(`#${columnName}-text`);
    if (textInput) {
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyTextFilter(columnName);
        });
    }
}

// ==============================================
// FUNÇÕES DE APLICAÇÃO DE FILTROS
// ==============================================

// Aplicar filtro numérico
function applyNumericFilter(columnName) {
    const minInput = document.getElementById(`${columnName}-min`);
    const maxInput = document.getElementById(`${columnName}-max`);
    
    const min = minInput?.value ? parseFloat(minInput.value) : null;
    const max = maxInput?.value ? parseFloat(maxInput.value) : null;
    
    if (min !== null || max !== null) {
        filters[columnName] = {
            type: 'number',
            min: min,
            max: max
        };
    } else {
        delete filters[columnName];
    }
    
    closeAllFilters();
    applyAllFilters();
    updateFilterDisplay();
}

// Aplicar filtro de seleção
function applySelectFilter(columnName) {
    const checkboxes = document.querySelectorAll(`#${columnName}-options input[type="checkbox"]:checked`);
    const selectedValues = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedValues.length > 0) {
        filters[columnName] = {
            type: 'select',
            values: selectedValues
        };
    } else {
        delete filters[columnName];
    }
    
    closeAllFilters();
    applyAllFilters();
    updateFilterDisplay();
}

// Aplicar filtro de texto
function applyTextFilter(columnName) {
    const textInput = document.getElementById(`${columnName}-text`);
    const exactCheck = document.getElementById(`${columnName}-exact`);
    const caseCheck = document.getElementById(`${columnName}-case`);
    
    const text = textInput?.value?.trim() || '';
    
    if (text) {
        filters[columnName] = {
            type: 'text',
            text: text,
            exact: exactCheck?.checked || false,
            caseSensitive: caseCheck?.checked || false
        };
    } else {
        delete filters[columnName];
    }
    
    closeAllFilters();
    applyAllFilters();
    updateFilterDisplay();
}

// Aplicar todos os filtros
function applyAllFilters() {
    const rows = document.querySelectorAll('#tableBody tr');
    const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
    let visibleCount = 0;
    
    rows.forEach(row => {
        let showRow = true;
        
        // Aplicar busca global
        if (searchTerm && showRow) {
            const rowText = row.textContent.toLowerCase();
            if (!rowText.includes(searchTerm)) {
                showRow = false;
            }
        }
        
        // Aplicar filtros de coluna
        Object.keys(filters).forEach(columnName => {
            if (!showRow) return;
            
            const filter = filters[columnName];
            const cellValue = getCellValueForFilter(row, columnName);
            
            if (filter.type === 'number') {
                const numValue = parseFloat(cellValue) || 0;
                
                if (filter.min !== null && numValue < filter.min) {
                    showRow = false;
                }
                if (filter.max !== null && numValue > filter.max) {
                    showRow = false;
                }
            } 
            else if (filter.type === 'select') {
                const strValue = String(cellValue);
                if (!filter.values.includes(strValue)) {
                    showRow = false;
                }
            }
            else if (filter.type === 'text') {
                const searchText = filter.text.toLowerCase();
                const cellText = String(cellValue).toLowerCase();
                
                if (filter.exact) {
                    if (filter.caseSensitive) {
                        if (String(cellValue) !== filter.text) showRow = false;
                    } else {
                        if (cellText !== searchText) showRow = false;
                    }
                } else {
                    if (!cellText.includes(searchText)) showRow = false;
                }
            }
        });
        
        // Mostrar/ocultar linha
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
        
        // Adicionar classe para linhas visíveis
        if (showRow) {
            row.classList.add('filtered-visible');
            row.classList.remove('filtered-hidden');
        } else {
            row.classList.add('filtered-hidden');
            row.classList.remove('filtered-visible');
        }
    });
    
    // Atualizar contadores
    updateCounters(visibleCount);
    
    // Salvar filtros
    saveFilters();
}

// Obter valor da célula para filtragem
function getCellValueForFilter(row, columnName) {
    // Tentar dataset primeiro
    const dataValue = row.dataset[columnName];
    if (dataValue !== undefined) {
        return dataValue;
    }
    
    // Procurar célula pela posição da coluna
    const thIndex = Array.from(document.querySelectorAll('thead th[data-column]'))
        .findIndex(th => th.dataset.column === columnName);
    
    if (thIndex !== -1) {
        const cell = row.querySelector(`td:nth-child(${thIndex + 1})`);
        if (cell) {
            return getCellValue(row, cell, columnName);
        }
    }
    
    return '';
}

// ==============================================
// FUNÇÕES AUXILIARES DE FILTROS
// ==============================================

// Contar ocorrências de um valor
function countOccurrences(columnName, value) {
    const rows = document.querySelectorAll('#tableBody tr');
    let count = 0;
    
    rows.forEach(row => {
        const cellValue = getCellValueForFilter(row, columnName);
        if (String(cellValue) === String(value)) {
            count++;
        }
    });
    
    return count;
}

// Filtrar opções no menu
function filterOptions(columnName) {
    const searchTerm = document.getElementById(`${columnName}-search`)?.value.toLowerCase() || '';
    const options = document.querySelectorAll(`#${columnName}-options .filter-option`);
    
    options.forEach(option => {
        const label = option.querySelector('label').textContent.toLowerCase();
        option.style.display = label.includes(searchTerm) ? '' : 'none';
    });
}

// Selecionar todas as opções
function selectAllOptions(columnName, selectAll) {
    const checkboxes = document.querySelectorAll(`#${columnName}-options input[type="checkbox"]`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
    });
}

// Limpar filtro de uma coluna
function clearColumnFilter(columnName) {
    delete filters[columnName];
    closeAllFilters();
    applyAllFilters();
    updateFilterDisplay();
}

// Limpar todos os filtros
function clearAllFilters() {
    filters = {};
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.value = '';
    
    closeAllFilters();
    applyAllFilters();
    updateFilterDisplay();
    
    // Remover classe ativa de todos os cabeçalhos
    document.querySelectorAll('th').forEach(th => th.classList.remove('filter-active'));
}

// Fechar todos os filtros
function closeAllFilters() {
    document.querySelectorAll('.excel-filter-container').forEach(filter => {
        filter.remove();
    });
    document.removeEventListener('click', closeFilterOnClickOutside);
}

// Fechar filtro ao clicar fora
function closeFilterOnClickOutside(event) {
    const filterContainers = document.querySelectorAll('.excel-filter-container');
    let isClickInsideFilter = false;
    
    filterContainers.forEach(container => {
        if (container.contains(event.target)) {
            isClickInsideFilter = true;
        }
    });
    
    const isClickOnHeader = event.target.closest('th') && 
                           event.target.closest('th').querySelector('.filter-indicator');
    
    if (!isClickInsideFilter && !isClickOnHeader) {
        closeAllFilters();
        document.querySelectorAll('th').forEach(th => th.classList.remove('filter-active'));
    }
}

// Atualizar display dos filtros ativos
function updateFilterDisplay() {
    const container = document.getElementById('activeFilters');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.keys(filters).forEach(columnName => {
        const filter = filters[columnName];
        let filterText = '';
        
        if (filter.type === 'number') {
            const parts = [];
            if (filter.min !== null) parts.push(`≥ ${filter.min}`);
            if (filter.max !== null) parts.push(`≤ ${filter.max}`);
            filterText = `${formatColumnName(columnName)}: ${parts.join(' e ')}`;
        } 
        else if (filter.type === 'select') {
            filterText = `${formatColumnName(columnName)}: ${filter.values.length} opção(ões)`;
        }
        else if (filter.type === 'text') {
            filterText = `${formatColumnName(columnName)}: "${filter.text}"`;
            if (filter.exact) filterText += ' (exato)';
            if (filter.caseSensitive) filterText += ' (case)';
        }
        
        const badge = document.createElement('span');
        badge.className = 'active-filter-badge';
        badge.innerHTML = `
            ${filterText}
            <span class="remove-filter ms-2" onclick="clearColumnFilter('${columnName}')">
                <i class="fa-solid fa-times"></i>
            </span>
        `;
        container.appendChild(badge);
    });
    
    // Mostrar/ocultar container
    const filtersContainer = document.getElementById('activeFiltersContainer');
    if (filtersContainer) {
        filtersContainer.style.display = Object.keys(filters).length > 0 ? 'block' : 'none';
    }
    
    // Mostrar/ocultar botão limpar filtros
    const clearBtn = document.getElementById('clearFiltersBtn');
    if (clearBtn) {
        clearBtn.style.display = Object.keys(filters).length > 0 ? 'inline-block' : 'none';
    }
}

// Atualizar contadores
function updateCounters(visibleCount) {
    const totalCount = document.querySelectorAll('#tableBody tr').length;
    
    // Atualizar contador na tela
    const filteredResults = document.getElementById('filteredResults');
    if (filteredResults) {
        document.getElementById('filteredCount').textContent = visibleCount.toLocaleString();
        document.getElementById('totalCount').textContent = totalCount.toLocaleString();
        filteredResults.style.display = Object.keys(filters).length > 0 || 
                                       document.getElementById('searchInput')?.value ? 'block' : 'none';
    }
    
    // Atualizar badge de total
    const totalBadge = document.getElementById('totalItens');
    if (totalBadge) {
        if (visibleCount < totalCount) {
            totalBadge.textContent = `${visibleCount.toLocaleString()} de ${totalCount.toLocaleString()} itens`;
            totalBadge.className = 'badge bg-warning';
        } else {
            totalBadge.textContent = `${totalCount.toLocaleString()} itens`;
            totalBadge.className = 'badge bg-primary';
        }
    }
}

// ==============================================
// FUNÇÕES DE UTILIDADE
// ==============================================

// Formatar nome da coluna
function formatColumnName(columnName) {
    const names = {
        'az': 'AZ',
        'lote': 'Lote',
        'cultivar': 'Cultivar',
        'peneira': 'Peneira',
        'categoria': 'Categoria',
        'endereco': 'Endereço',
        'saldo': 'Saldo',
        'peso_unitario': 'Peso Unitário',
        'peso_total': 'Peso Total',
        'especie': 'Espécie',
        'tratamento': 'Tratamento',
        'embalagem': 'Embalagem',
        'cliente': 'Cliente',
        'empresa': 'Empresa',
        'status': 'Status',
        'conferente': 'Conferente'
    };
    
    return names[columnName] || columnName.replace(/_/g, ' ').toUpperCase();
}

// Definir valor mínimo
function setMinValue(columnName, value) {
    const input = document.getElementById(`${columnName}-min`);
    if (input) {
        input.value = value;
        input.dispatchEvent(new Event('change'));
    }
}

// Definir valor máximo
function setMaxValue(columnName, value) {
    const input = document.getElementById(`${columnName}-max`);
    if (input) {
        input.value = value;
        input.dispatchEvent(new Event('change'));
    }
}

// Debounce para filtro de texto
let textFilterTimeout;
function debouncedTextFilter(columnName) {
    clearTimeout(textFilterTimeout);
    textFilterTimeout = setTimeout(() => {
        applyTextFilter(columnName);
    }, 500);
}

// Salvar filtros no localStorage
function saveFilters() {
    try {
        localStorage.setItem('estoque_filters', JSON.stringify(filters));
        localStorage.setItem('estoque_search', document.getElementById('searchInput')?.value || '');
    } catch (e) {
        console.log('Não foi possível salvar filtros:', e);
    }
}

// Carregar filtros salvos
function loadSavedFilters() {
    try {
        const savedFilters = localStorage.getItem('estoque_filters');
        const savedSearch = localStorage.getItem('estoque_search');
        
        if (savedFilters) {
            filters = JSON.parse(savedFilters);
        }
        
        if (savedSearch && document.getElementById('searchInput')) {
            document.getElementById('searchInput').value = savedSearch;
        }
        
        if (Object.keys(filters).length > 0 || savedSearch) {
            applyAllFilters();
            updateFilterDisplay();
        }
    } catch (e) {
        console.log('Não foi possível carregar filtros:', e);
    }
}

// ==============================================
// SISTEMA DE BUSCA
// ==============================================

function setupSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyAllFilters();
        }, 500);
    });
    
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyAllFilters();
        }
    });
    
    // Botão de limpar busca
    const clearSearchBtn = document.createElement('button');
    clearSearchBtn.type = 'button';
    clearSearchBtn.className = 'btn btn-sm btn-outline-secondary';
    clearSearchBtn.innerHTML = '<i class="fa-solid fa-times"></i>';
    clearSearchBtn.style.position = 'absolute';
    clearSearchBtn.style.right = '5px';
    clearSearchBtn.style.top = '50%';
    clearSearchBtn.style.transform = 'translateY(-50%)';
    clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';
    
    searchInput.parentNode.style.position = 'relative';
    searchInput.parentNode.appendChild(clearSearchBtn);
    
    searchInput.addEventListener('input', function() {
        clearSearchBtn.style.display = this.value ? 'block' : 'none';
    });
    
    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        applyAllFilters();
    });
}

// ==============================================
// IMPORTAÇÃO/EXPORTAÇÃO
// ==============================================

function setupImportExport() {
    // Limpar formulário quando modal abrir
    document.getElementById('importModal')?.addEventListener('show.bs.modal', function() {
        const form = document.getElementById('importForm');
        if (form) form.reset();
        selectedModifications = new Set();
    });
    
    // Event listener para checkboxes de modificação
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('modification-check')) {
            const key = `${e.target.dataset.type}_${e.target.dataset.index}`;
            e.target.checked ? selectedModifications.add(key) : selectedModifications.delete(key);
        }
    });
    
    // Configurar botão de impressão da tabela filtrada
    const printBtn = document.querySelector('.btn-print');
    if (printBtn) {
        printBtn.addEventListener('click', printFilteredTable);
    }
}

// Imprimir tabela filtrada
function printFilteredTable() {
    const originalDisplay = [];
    const rows = document.querySelectorAll('#tableBody tr');
    
    // Ocultar linhas não visíveis
    rows.forEach((row, index) => {
        originalDisplay[index] = row.style.display;
        if (row.style.display === 'none') {
            row.style.display = 'none';
        }
    });
    
    // Criar estilos para impressão
    const printStyles = `
        <style>
            @media print {
                body * {
                    visibility: hidden;
                }
                .table-container, .table-container * {
                    visibility: visible;
                }
                .table-container {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100%;
                    box-shadow: none !important;
                }
                .action-buttons, .pagination-container, .active-filters-container, .filtered-results {
                    display: none !important;
                }
                .table-advanced {
                    font-size: 10pt !important;
                }
                .badge {
                    font-size: 8pt !important;
                    padding: 2px 4px !important;
                }
                h2 {
                    font-size: 14pt !important;
                    margin-bottom: 10px !important;
                }
                .stats-card {
                    display: none !important;
                }
            }
        </style>
    `;
    
    // Adicionar cabeçalho de impressão
    const printHeader = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h2>Relatório de Estoque - ${new Date().toLocaleDateString()}</h2>
            <p>Total de itens: ${document.querySelectorAll('#tableBody tr:not([style*="none"])').length}</p>
        </div>
    `;
    
    const tableContainer = document.querySelector('.table-container');
    const originalHTML = tableContainer.innerHTML;
    
    tableContainer.insertAdjacentHTML('afterbegin', printHeader);
    document.head.insertAdjacentHTML('beforeend', printStyles);
    
    window.print();
    
    // Restaurar estado original
    tableContainer.innerHTML = originalHTML;
    document.querySelectorAll('#tableBody tr').forEach((row, index) => {
        if (originalDisplay[index] !== undefined) {
            row.style.display = originalDisplay[index];
        }
    });
}

// ==============================================
// FUNÇÕES DE IMPORT/EXPORT (mantidas da versão anterior)
// ==============================================

async function previewImport() {
    const form = document.getElementById('importForm');
    const formData = new FormData(form);
    const fileInput = form.querySelector('input[type="file"]');
    
    if (!fileInput.files.length) {
        showAlert('Selecione um arquivo para importar.', 'warning');
        return;
    }
    
    selectedModifications = new Set();
    showLoader(true);
    
    try {
        const response = await fetch('{% url "sapp:importar_estoque" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentImportData = data;
            showPreviewModal(data);
            hideBootstrapModal('importModal');
        } else {
            showAlert('Erro: ' + data.error, 'danger');
        }
    } catch (error) {
        showAlert('Erro ao processar arquivo: ' + error.message, 'danger');
    } finally {
        showLoader(false);
    }
}

function showPreviewModal(data) {
    // ... (implementação da função showPreviewModal)
}

function proceedToApproval() {
    // ... (implementação da função proceedToApproval)
}

async function submitApproval() {
    // ... (implementação da função submitApproval)
}

function toggleAll(checked, type) {
    document.querySelectorAll(`.modification-check[data-type="${type}"]`).forEach(checkbox => {
        checkbox.checked = checked;
        const key = `${checkbox.dataset.type}_${checkbox.dataset.index}`;
        checked ? selectedModifications.add(key) : selectedModifications.delete(key);
    });
}

// ==============================================
// FUNÇÕES UTILITÁRIAS GLOBAIS
// ==============================================

function showAlert(message, type) {
    const existingAlerts = document.querySelectorAll('.alert-dismissible');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 z-3`;
    alertDiv.style.minWidth = '400px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentElement) alertDiv.remove();
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showLoader(show = true) {
    const loader = document.getElementById('importLoader');
    if (loader) {
        loader.style.display = show ? 'flex' : 'none';
    }
}

function hideBootstrapModal(modalId) {
    const modalElement = document.getElementById(modalId);
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }
}

// ==============================================
// EXPORTAR FUNÇÕES PARA ESCOPO GLOBAL
// ==============================================

window.updatePageSize = updatePageSize;
window.performSearch = performSearch;
window.previewImport = previewImport;
window.proceedToApproval = proceedToApproval;
window.submitApproval = submitApproval;
window.toggleAll = toggleAll;
window.showAlert = showAlert;
window.clearAllFilters = clearAllFilters;
window.clearColumnFilter = clearColumnFilter;
window.applyNumericFilter = applyNumericFilter;
window.applySelectFilter = applySelectFilter;
window.applyTextFilter = applyTextFilter;
window.selectAllOptions = selectAllOptions;
window.filterOptions = filterOptions;
window.setMinValue = setMinValue;
window.setMaxValue = setMaxValue;
window.debouncedTextFilter = debouncedTextFilter;
window.printFilteredTable = printFilteredTable;
</script>

<style>
    .bg-purple {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%) !important;
    }
    
    /* Scroll personalizado para filtros */
    .filter-options::-webkit-scrollbar {
        width: 6px;
    }
    
    .filter-options::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .filter-options::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .filter-options::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>

{% endblock %}
