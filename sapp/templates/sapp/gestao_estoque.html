{% extends 'sapp/base.html' %}
{% load humanize %}

{% block content %}
<style>
    /* ESTILOS EXISTENTES MANTIDOS */
    .table-advanced {
        font-size: 0.875rem;
    }
    
    .table-advanced th {
        background: linear-gradient(135deg, #2f8f4e 0%, #267a41 100%);
        color: white;
        font-weight: 600;
        border: none;
        padding: 12px 8px;
    }
    
    /* NOVOS ESTILOS PARA DATATABLES */
    .dataTables_wrapper {
        padding: 0 !important;
    }
    
    .dataTables_filter {
        margin-bottom: 15px;
    }
    
    .dataTables_filter input {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 8px 12px;
        width: 300px !important;
    }
    
    .dataTables_length select {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 4px 8px;
    }
    
    .dataTables_paginate .paginate_button {
        border: 1px solid #dee2e6 !important;
        border-radius: 6px !important;
        margin: 0 2px !important;
    }
    
    .dataTables_paginate .paginate_button.current {
        background: #2f8f4e !important;
        border-color: #2f8f4e !important;
        color: white !important;
    }
    
    /* Estilo para os filtros individuais */
    .col-filter {
        width: 100%;
        padding: 4px 8px;
        font-size: 0.8rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: white;
    }
    
    .col-filter:focus {
        border-color: #2f8f4e;
        outline: none;
        box-shadow: 0 0 0 2px rgba(47, 143, 78, 0.1);
    }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-success fw-bold mb-1">
                <i class="fa-solid fa-warehouse me-2"></i>Gestão de Estoque
            </h2>
            <p class="text-muted mb-0">Controle completo do estoque atual</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary" id="totalItens">{{ estoque.paginator.count|intcomma }} itens</span>
            <span class="badge bg-success" id="totalSC">{{ total_sc|intcomma }} SC total</span>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="action-buttons mb-3">
        <button class="btn btn-export" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="fa-solid fa-download me-2"></i>Exportar
        </button>
        
        <button class="btn btn-import" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="fa-solid fa-upload me-2"></i>Importar
        </button>
        
        <button class="btn btn-print" onclick="window.print()">
            <i class="fa-solid fa-print me-2"></i>Imprimir
        </button>
        
        <div class="ms-auto">
            <button class="btn btn-info" onclick="habilitarFiltrosColunas()">
                <i class="fa-solid fa-filter me-2"></i>Filtros nas Colunas
            </button>
            <button class="btn btn-secondary" onclick="limparFiltros()">
                <i class="fa-solid fa-times me-2"></i>Limpar Filtros
            </button>
        </div>
    </div>

    <!-- Tabela de Estoque com DataTables -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-advanced table-hover mb-0" id="estoqueTable">
                <thead>
                    <tr>
                        <th>AZ</th>
                        <th>Lote</th>
                        <th>Cultivar</th>
                        <th>Peneira</th>
                        <th>Categoria</th>
                        <th>Endereço</th>
                        <th>Saldo</th>
                        <th>Peso Unit. (kg)</th>
                        <th>Peso Total (kg)</th>
                        <th>Espécie</th>
                        <th>Tratamento</th>
                        <th>Embalagem</th>
                        <th>Cliente</th>
                        <th>Empresa</th>
                        <th>Status</th>
                        <th>Conferente</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in estoque %}
                    <tr>
                        <td>{{ item.az|default:"-" }}</td>
                        <td>
                            <span class="fw-bold text-primary">{{ item.lote }}</span>
                            {% if item.produto %}
                            <br><small class="text-muted">{{ item.produto }}</small>
                            {% endif %}
                        </td>
                        <td>{{ item.cultivar.nome }}</td>
                        <td>{{ item.peneira.nome }}</td>
                        <td>{{ item.categoria.nome }}</td>
                        <td>
                            <span class="badge bg-light text-dark border">{{ item.endereco }}</span>
                        </td>
                        <td>
                            <span class="badge badge-saldo {% if item.saldo > 100 %}bg-success{% elif item.saldo > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ item.saldo|intcomma }}
                            </span>
                        </td>
                        <td>{{ item.peso_unitario|floatformat:3 }} kg</td>
                        <td>
                            <strong>{{ item.peso_total|floatformat:2 }} kg</strong>
                        </td>
                        <td>
                            {% if item.especie %}
                                <span class="badge bg-info text-white">{{ item.especie }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.tratamento %}
                                <span class="badge bg-info">{{ item.tratamento.nome|truncatechars:10 }}</span>
                            {% else %}
                                <span class="badge bg-secondary">Sem Trat.</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if item.embalagem == 'BAG' %}bg-primary{% else %}bg-secondary{% endif %}">
                                {{ item.get_embalagem_display }}
                            </span>
                        </td>
                        <td>
                            {% if item.cliente %}
                                <span class="badge badge-cliente" title="{{ item.cliente }}">
                                    <i class="fas fa-user-tag me-1"></i>{{ item.cliente|truncatechars:15 }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.empresa %}
                                <span class="badge badge-empresa">{{ item.empresa|truncatechars:15 }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.status == 'ATIVO' %}
                                <span class="badge badge-status-ativo">{{ item.status }}</span>
                            {% elif item.status == 'ESGOTADO' %}
                                <span class="badge badge-status-esgotado">{{ item.status }}</span>
                            {% elif item.status == 'BLOQUEADO' %}
                                <span class="badge badge-status-bloqueado">{{ item.status }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ item.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ item.conferente.first_name|default:item.conferente.username }}</small>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="16" class="text-center py-4 text-muted">
                            <i class="fa-solid fa-inbox fa-2x mb-2 d-block"></i>
                            Nenhum item encontrado em estoque
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Scripts DataTables -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTable
    var table = $('#estoqueTable').DataTable({
        "pageLength": 25,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
        },
        "order": [[1, 'asc']], // Ordenar por lote por padrão
        "initComplete": function() {
            // Atualizar contadores
            $('#totalItens').text(table.rows().count() + ' itens');
            updateTotalSC(table);
        }
    });
    
    // Adicionar campos de filtro em cada coluna
    function adicionarFiltrosColunas() {
        $('#estoqueTable thead tr').clone(true).appendTo('#estoqueTable thead');
        $('#estoqueTable thead tr:eq(1) th').each(function(i) {
            var title = $(this).text();
            $(this).html('<input type="text" class="col-filter" placeholder="Filtrar ' + title + '" />');
            
            $('input', this).on('keyup change', function() {
                if (table.column(i).search() !== this.value) {
                    table
                        .column(i)
                        .search(this.value)
                        .draw();
                    
                    // Atualizar contadores
                    $('#totalItens').text(table.rows({search:'applied'}).count() + ' itens');
                    updateTotalSC(table);
                }
            });
        });
    }
    
    // Função para habilitar/desabilitar filtros
    function habilitarFiltrosColunas() {
        if ($('#estoqueTable thead tr').length === 1) {
            adicionarFiltrosColunas();
            $('.btn-info').html('<i class="fa-solid fa-filter-circle-xmark me-2"></i>Remover Filtros Colunas');
        } else {
            $('#estoqueTable thead tr:eq(1)').remove();
            $('.btn-info').html('<i class="fa-solid fa-filter me-2"></i>Filtros nas Colunas');
        }
    }
    
    // Função para limpar todos os filtros
    function limparFiltros() {
        table.search('').columns().search('').draw();
        $('.col-filter').val('');
        $('#totalItens').text(table.rows().count() + ' itens');
        updateTotalSC(table);
    }
    
    // Função para atualizar total SC
    function updateTotalSC(dt) {
        // Esta função precisa ser adaptada para seu cálculo específico
        // Por enquanto, mostra apenas a contagem
        $('#totalSC').text(dt.rows({search:'applied'}).count() + ' itens filtrados');
    }
    
    // Exportar para Excel com filtros aplicados
    window.exportarExcelFiltrado = function() {
        var data = table.rows({search:'applied'}).data();
        // Implementar lógica de exportação aqui
        alert('Exportando ' + data.length + ' registros...');
    };
    
    // Tornar funções globais
    window.habilitarFiltrosColunas = habilitarFiltrosColunas;
    window.limparFiltros = limparFiltros;
    
    // Clique na linha para ver detalhes
    $('#estoqueTable tbody').on('click', 'tr', function() {
        var data = table.row(this).data();
        if (data) {
            // Implementar ação ao clicar na linha
            console.log('Linha clicada:', data);
        }
    });
});
</script>

<!-- Modais (mantenha os existentes) -->
{% include 'sapp/modais_export_import.html' %}
{% endblock %}
