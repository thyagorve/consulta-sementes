{% extends 'sapp/base.html' %}
{% load humanize %}

{% block content %}
<style>
    /* ===== VARI√ÅVEIS E RESET ===== */
    :root {
        --verde-status: #28a745;
        --amarelo-status: #ffc107;
        --vermelho-status: #dc3545;
        --primary-dark: #2f8f4e;
        --primary-light: #4aae68;
    }
    
    * {
        box-sizing: border-box;
    }
    
    /* ===== LAYOUT RESPONSIVO ===== */
    .container-fluid {
        padding: 15px;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    /* ===== CARDS DE ESTAT√çSTICAS ===== */
    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .stats-card .rounded-circle {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .stats-card h4 {
        font-size: 1.5rem;
        margin-bottom: 2px;
        line-height: 1.2;
    }
    
    .stats-card small {
        font-size: 0.8rem;
        display: block;
    }
    
    @media (max-width: 768px) {
        .stats-card {
            padding: 12px;
        }
        .stats-card .rounded-circle {
            width: 40px;
            height: 40px;
        }
        .stats-card h4 {
            font-size: 1.2rem;
        }
    }
    
    /* ===== BOT√ïES DE A√á√ÉO ===== */
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        align-items: center;
    }
    
    .action-buttons .btn {
        padding: 8px 16px;
        font-weight: 500;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        transition: all 0.2s;
    }
    
    .btn-export {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
    }
    
    .btn-export:hover {
        background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
    
    .btn-print {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        border: none;
        color: white;
    }
    
    .btn-print:hover {
        background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
        transform: translateY(-2px);
    }
    
    .btn-clear-filters {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        color: white;
    }
    
    .btn-clear-filters:hover {
        background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
        transform: translateY(-2px);
    }
    
    /* ===== BUSCA ===== */
    .search-container {
        position: relative;
        flex: 1;
        min-width: 250px;
        max-width: 400px;
    }
    
    .search-input {
        padding-left: 40px;
        padding-right: 40px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        height: 42px;
        width: 100%;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    
    .search-input:focus {
        border-color: var(--primary-dark);
        box-shadow: 0 0 0 3px rgba(47, 143, 78, 0.1);
        outline: none;
    }
    
    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        z-index: 5;
    }
    
    .clear-search {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        display: none;
        z-index: 5;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        align-items: center;
        justify-content: center;
    }
    
    .clear-search:hover {
        background: #e9ecef;
        color: #dc3545;
    }
    
    /* ===== TABELA RESPONSIVA ===== */
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
        width: 100%;
        position: relative;
    }
    
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-dark) #f1f1f1;
        max-width: 100%;
    }
    
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--primary-dark);
        border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--primary-light);
    }
    
    .table-advanced {
        width: 100%;
        margin-bottom: 0;
        font-size: 0.85rem;
        min-width: 1600px;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table-advanced th {
        background: linear-gradient(135deg, var(--primary-dark) 0%, #267a41 100%);
        color: white;
        font-weight: 600;
        padding: 14px 8px;
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background 0.2s;
    }
    
    .table-advanced th:hover {
        background: linear-gradient(135deg, #267a41 0%, var(--primary-dark) 100%);
    }
    
    .table-advanced th.filter-active {
        background: linear-gradient(135deg, #1f6a36 0%, #16572b 100%);
        position: relative;
    }
    
    .table-advanced th.filter-active::after {
        content: '‚úì';
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        color: #ffc107;
        font-weight: bold;
        font-size: 14px;
    }
    
    .table-advanced th i {
        margin-left: 5px;
        font-size: 0.75rem;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    .table-advanced th:hover i {
        opacity: 1;
    }
    
    .table-advanced td {
        padding: 12px 8px;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
        white-space: nowrap;
    }
    
    .table-advanced tbody tr:hover {
        background-color: rgba(47, 143, 78, 0.05);
    }
    
    /* ===== COLUNA DE STATUS ===== */
    .status-column {
        text-align: center;
        vertical-align: middle;
        min-width: 80px;
    }
    
    .status-sistemico-container {
        display: inline-block;
        cursor: pointer;
        position: relative;
    }
    
    .status-sistemico-indicator {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
        margin: 0 auto;
    }
    
    .status-sistemico-indicator:hover {
        transform: scale(1.15);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    /* Tooltip */
    .status-tooltip-custom {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(33, 37, 41, 0.95);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 12px;
        white-space: nowrap;
        margin-bottom: 10px;
        z-index: 10000;
        pointer-events: none;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .status-tooltip-custom::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: rgba(33, 37, 41, 0.95) transparent transparent transparent;
    }
    
    .status-tooltip-custom strong {
        display: block;
        margin-bottom: 5px;
        text-align: center;
    }
    
    .status-tooltip-custom small {
        color: #adb5bd;
        font-size: 11px;
        display: block;
    }
    
    /* ===== ENDERE√áO ===== */
    .endereco-badge {
        background: #f8f9fa;
        color: #495057;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid #dee2e6;
        display: inline-block;
        transition: all 0.2s;
    }
    
    .endereco-badge:hover {
        background: #e9ecef;
        border-color: var(--primary-dark);
    }
    
    .endereco-badge i {
        color: var(--primary-dark);
    }
    
    /* ===== BADGES ===== */
    .badge-saldo {
        font-size: 0.75rem;
        padding: 5px 10px;
        border-radius: 20px;
        font-weight: 600;
        display: inline-block;
    }
    
    .badge-cliente {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
    }
    
    .badge-empresa {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        display: inline-block;
    }
    
    /* ===== FILTROS ATIVOS ===== */
    .active-filters-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 15px;
        border: 1px solid #e9ecef;
        display: none;
    }
    
    .active-filter-badge {
        background: var(--primary-dark);
        color: white;
        padding: 5px 12px;
        border-radius: 30px;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin: 3px;
        transition: all 0.2s;
    }
    
    .active-filter-badge:hover {
        background: #dc3545;
        transform: translateY(-2px);
    }
    
    .active-filter-badge i {
        cursor: pointer;
        font-size: 0.7rem;
    }
    
    /* ===== FILTROS EXCEL ===== */
    .excel-filter-container {
        position: absolute;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        z-index: 1060;
        min-width: 280px;
        max-width: 350px;
        animation: slideDown 0.2s ease;
        overflow: hidden;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .filter-header {
        padding: 12px 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }
    
    .filter-search {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .filter-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .filter-search input:focus {
        border-color: var(--primary-dark);
        box-shadow: 0 0 0 2px rgba(47, 143, 78, 0.1);
        outline: none;
    }
    
    .filter-options {
        max-height: 250px;
        overflow-y: auto;
        padding: 5px 0;
    }
    
    .filter-option {
        padding: 8px 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .filter-option:hover {
        background: #f8f9fa;
    }
    
    .filter-option input[type="checkbox"] {
        margin: 0;
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: var(--primary-dark);
    }
    
    .filter-option label {
        flex: 1;
        cursor: pointer;
        margin: 0;
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .filter-actions {
        padding: 10px 15px;
        border-top: 1px solid #dee2e6;
        background: #f8f9fa;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }
    
    .filter-actions .btn-sm {
        padding: 4px 10px;
        font-size: 0.8rem;
    }
    
    .filter-actions .btn-link {
        color: var(--primary-dark);
        text-decoration: none;
    }
    
    .filter-actions .btn-link:hover {
        text-decoration: underline;
    }
    
    /* ===== PAGINA√á√ÉO ===== */
    .pagination-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        border: 1px solid #e9ecef;
    }
    
    .pagination-info {
        font-size: 0.95rem;
        color: #495057;
    }
    
    .pagination-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .pagination-btn {
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
        color: var(--primary-dark);
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
        font-size: 0.95rem;
    }
    
    .pagination-btn:hover:not(.disabled) {
        background: #f8f9fa;
        border-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .pagination-btn.active {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
        color: white;
    }
    
    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f8f9fa;
        pointer-events: none;
    }
    
    .pagination-dots {
        padding: 0 8px;
        color: #6c757d;
        font-size: 1rem;
    }
    
    .pagination-items-select {
        padding: 8px 35px 8px 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
        background: white;
        transition: all 0.2s;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%232f8f4e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
    }
    
    .pagination-items-select:hover {
        border-color: var(--primary-dark);
        background-color: #f8f9fa;
    }
    
    .pagination-items-select:focus {
        outline: none;
        border-color: var(--primary-dark);
        box-shadow: 0 0 0 3px rgba(47, 143, 78, 0.1);
    }
    
    /* ===== MODAL ===== */
    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, #267a41 100%);
        color: white;
        border-radius: 16px 16px 0 0;
        padding: 15px 20px;
    }
    
    .modal-header .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    .modal-header .btn-close:hover {
        opacity: 1;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #e9ecef;
    }
    
    /* ===== UTILIT√ÅRIOS ===== */
    .text-truncate-custom {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
    }
    
    @media (max-width: 768px) {
        .pagination-info {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .pagination-controls {
            margin-bottom: 15px;
        }
        
        .pagination-items-per-page {
            text-align: center;
        }
        
        .action-buttons .btn span {
            display: none;
        }
        .action-buttons .btn i {
            margin: 0;
        }
    }
</style>

<div class="container-fluid py-3">
    <!-- CARDS DE ESTAT√çSTICAS -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="d-flex align-items-center">
                    <div class="bg-success rounded-circle p-3 me-3">
                        <i class="fa-solid fa-layer-group text-white"></i>
                    </div>
                    <div class="overflow-hidden">
                        <h4 class="mb-0 text-success text-truncate" id="totalItens">{{ total_itens|intcomma }}</h4>
                        <small class="text-muted text-truncate d-block">Lotes Ativos</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="d-flex align-items-center">
                    <div class="bg-info rounded-circle p-3 me-3">
                        <i class="fa-solid fa-weight-hanging text-white"></i>
                    </div>
                    <div class="overflow-hidden">
                        <h4 class="mb-0 text-info text-truncate" id="totalSc">{{ total_sc|intcomma }}</h4>
                        <small class="text-muted text-truncate d-block">Equivalente SC</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="d-flex align-items-center">
                    <div class="bg-warning rounded-circle p-3 me-3">
                        <i class="fa-solid fa-box text-white"></i>
                    </div>
                    <div class="overflow-hidden">
                        <h4 class="mb-0 text-warning text-truncate" id="totalBags">{{ total_bags|intcomma }}</h4>
                        <small class="text-muted text-truncate d-block">Unidades BAG</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-circle p-3 me-3">
                        <i class="fa-solid fa-users text-white"></i>
                    </div>
                    <div class="overflow-hidden">
                        <h4 class="mb-0 text-primary text-truncate" id="clientesUnicos">{{ clientes_unicos|intcomma }}</h4>
                        <small class="text-muted text-truncate d-block">Clientes √önicos</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTROS ATIVOS -->
    <div class="active-filters-container" id="activeFiltersContainer">
        <small class="text-muted d-block mb-2">Filtros Ativos:</small>
        <div id="activeFilters" class="d-flex flex-wrap"></div>
    </div>

    <!-- BOT√ïES DE A√á√ÉO -->
    <div class="action-buttons">
        <button class="btn btn-export" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="fa-solid fa-download"></i><span>Exportar</span>
        </button>
        <button class="btn btn-print" onclick="window.print()">
            <i class="fa-solid fa-print"></i><span>Imprimir</span>
        </button>
        <button class="btn btn-clear-filters" id="clearFiltersBtn" style="display: none;">
            <i class="fa-solid fa-filter-circle-xmark"></i><span>Limpar Filtros</span>
        </button>
        <div class="search-container">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="text" id="searchInput" class="form-control search-input" placeholder="Buscar em todas as colunas..." value="{{ busca }}">
            <button class="clear-search" id="clearSearchBtn"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <!-- TABELA DE ESTOQUE -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-advanced table-hover" id="estoqueTable">
                <thead>
                    <tr>
                        <th data-column="status_sistemico" data-type="select" onclick="showFilter(this, 'status_sistemico', 'select')" style="text-align: center; min-width: 80px;">
                            <i class="fa-regular fa-circle me-1"></i>
                            <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="az" data-type="text" onclick="showFilter(this, 'az', 'text')">
                            AZ <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="lote" data-type="text" onclick="showFilter(this, 'lote', 'text')">
                            Lote <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="produto" data-type="text" onclick="showFilter(this, 'produto', 'text')">
                            Produto <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="cultivar" data-type="select" onclick="showFilter(this, 'cultivar', 'select')">
                            Cultivar <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="peneira" data-type="select" onclick="showFilter(this, 'peneira', 'select')">
                            Pen <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="categoria" data-type="select" onclick="showFilter(this, 'categoria', 'select')">
                            Cat <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="endereco" data-type="text" onclick="showFilter(this, 'endereco', 'text')">
                            Endere√ßo <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="saldo" data-type="number" onclick="showFilter(this, 'saldo', 'number')">
                            Saldo <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="peso_unitario" data-type="number" onclick="showFilter(this, 'peso_unitario', 'number')">
                            Peso U. <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="peso_total" data-type="number" onclick="showFilter(this, 'peso_total', 'number')">
                            Peso T. <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="especie" data-type="select" onclick="showFilter(this, 'especie', 'select')">
                            Esp√©cie <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="tratamento" data-type="select" onclick="showFilter(this, 'tratamento', 'select')">
                            Trat. <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="embalagem" data-type="select" onclick="showFilter(this, 'embalagem', 'select')">
                            Emb. <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="cliente" data-type="select" onclick="showFilter(this, 'cliente', 'select')">
                            Cliente <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="empresa" data-type="select" onclick="showFilter(this, 'empresa', 'select')">
                            Empresa <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                        <th data-column="conferente" data-type="select" onclick="showFilter(this, 'conferente', 'select')">
                            Conf. <i class="fa-solid fa-filter filter-indicator"></i>
                        </th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for item in estoque %}
                    <tr ondblclick="window.location.href='{% url "sapp:lista_estoque" %}?busca={{ item.lote }}'" 
                        style="cursor: pointer;">
                        
                        <!-- COLUNA DE STATUS -->
                        <td class="status-column">
                            <div class="status-sistemico-container" 
                                 onclick="event.stopPropagation(); abrirModalStatusSistemico({{ item.id }}, this)">
                                
                                <div class="status-sistemico-indicator" 
                                     data-id="{{ item.id }}"
                                     data-status="{{ item.status_sistemico }}"
                                     style="background-color: {% if item.status_sistemico == 'ok' %}#28a745{% elif item.status_sistemico == 'parcial' %}#ffc107{% else %}#dc3545{% endif %};">
                                </div>
                                
                                <!-- Tooltip -->
                                <div class="status-tooltip-custom">
                                    <strong>
                                        {% if item.status_sistemico == 'ok' %}üü¢ OK - Tudo certo
                                        {% elif item.status_sistemico == 'parcial' %}üü° Parcial - Diverg√™ncia
                                        {% else %}üî¥ Cr√≠tico - Sem saldo real{% endif %}
                                    </strong>
                                    {% if item.status_sistemico_alterado_por %}
                                        <small>
                                            <i class="fa-solid fa-user me-1"></i>{{ item.status_sistemico_alterado_por.get_full_name|default:item.status_sistemico_alterado_por.username }}<br>
                                            <i class="fa-solid fa-clock me-1"></i>{{ item.status_sistemico_alterado_em|date:'d/m/Y H:i' }}
                                        </small>
                                    {% else %}
                                        <small>Nunca alterado</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        
                        <!-- AZ -->
                        <td><span class="badge bg-secondary bg-opacity-10 text-dark">{{ item.az|default:"-" }}</span></td>
                        
                        <!-- Lote -->
                        <td><span class="fw-bold text-primary">{{ item.lote }}</span></td>
                        
                        <!-- Produto -->
                        <td><span class="text-truncate-custom" title="{{ item.produto|default:'' }}">{{ item.produto|default:"-" }}</span></td>
                        
                        <!-- Cultivar -->
                        <td>{{ item.cultivar.nome }}</td>
                        
                        <!-- Peneira -->
                        <td>{{ item.peneira.nome }}</td>
                        
                        <!-- Categoria -->
                        <td>{{ item.categoria.nome }}</td>
                        
                        <!-- Endere√ßo -->
                        <td>
                            <span class="endereco-badge" title="{{ item.endereco }}">
                                <i class="fa-solid fa-location-dot me-1"></i>{{ item.endereco }}
                            </span>
                        </td>
                        
                        <!-- Saldo -->
                        <td>
                            <span class="badge badge-saldo {% if item.saldo > 21 %}bg-success{% elif item.saldo > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ item.saldo|intcomma }}
                            </span>
                        </td>
                        
                        <!-- Peso Unit√°rio -->
                        <td>{{ item.peso_unitario|floatformat:2 }}</td>
                        
                        <!-- Peso Total -->
                        <td><strong>{{ item.peso_total|floatformat:2 }}</strong></td>
                        
                        <!-- Esp√©cie -->
                        <td>{{ item.especie|default:"-" }}</td>
                        
                        <!-- Tratamento -->
                        <td>
                            {% if item.tratamento %}
                                <span class="badge bg-info" title="{{ item.tratamento.nome }}">{{ item.tratamento.nome|truncatechars:10 }}</span>
                            {% else %}
                                <span class="badge bg-secondary">-</span>
                            {% endif %}
                        </td>
                        
                        <!-- Embalagem -->
                        <td>
                            <span class="badge {% if item.embalagem == 'BAG' %}bg-primary{% else %}bg-secondary{% endif %}">
                                {{ item.get_embalagem_display }}
                            </span>
                        </td>
                        
                        <!-- Cliente -->
                        <td>
                            {% if item.cliente %}
                                <span class="badge badge-cliente" title="{{ item.cliente }}">
                                    <i class="fas fa-user-tag me-1"></i>{{ item.cliente|truncatechars:12 }}
                                </span>
                            {% else %}-{% endif %}
                        </td>
                        
                        <!-- Empresa -->
                        <td>
                            {% if item.empresa %}
                                <span class="badge badge-empresa" title="{{ item.empresa }}">
                                    {{ item.empresa|truncatechars:15 }}
                                </span>
                            {% else %}-{% endif %}
                        </td>
                        
                        <!-- Conferente -->
                        <td>
                            <small title="{{ item.conferente.get_full_name|default:item.conferente.username }}">
                                {{ item.conferente.first_name|default:item.conferente.username|truncatechars:12 }}
                                
                            </small>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="17" class="text-center py-5">
                            <i class="fa-solid fa-inbox fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">Nenhum item encontrado em estoque</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAGINA√á√ÉO -->
    {% if estoque.paginator.num_pages > 1 %}
    <div class="pagination-container">
        <div class="row align-items-center">
            <div class="col-lg-4 mb-3 mb-lg-0">
                <div class="pagination-info">
                    <i class="fa-solid fa-list me-2 text-success"></i>
                    Mostrando {{ estoque.start_index }} - {{ estoque.end_index }} de {{ estoque.paginator.count }} itens
                </div>
            </div>
            
            <div class="col-lg-4 mb-3 mb-lg-0">
                <div class="pagination-controls">
                    {% if estoque.has_previous %}
                    <a href="?page=1{% if url_params %}&{{ url_params }}{% endif %}" class="pagination-btn" title="Primeira p√°gina">
                        <i class="fa-solid fa-angles-left"></i>
                    </a>
                    <a href="?page={{ estoque.previous_page_number }}{% if url_params %}&{{ url_params }}{% endif %}" class="pagination-btn" title="P√°gina anterior">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                    {% else %}
                    <span class="pagination-btn disabled"><i class="fa-solid fa-angles-left"></i></span>
                    <span class="pagination-btn disabled"><i class="fa-solid fa-chevron-left"></i></span>
                    {% endif %}
                    
                    {% for num in estoque.paginator.page_range %}
                        {% if num == estoque.number %}
                            <span class="pagination-btn active">{{ num }}</span>
                        {% elif num >= estoque.number|add:'-2' and num <= estoque.number|add:'2' %}
                            <a href="?page={{ num }}{% if url_params %}&{{ url_params }}{% endif %}" class="pagination-btn">{{ num }}</a>
                        {% elif num == 1 or num == estoque.paginator.num_pages %}
                            <a href="?page={{ num }}{% if url_params %}&{{ url_params }}{% endif %}" class="pagination-btn">{{ num }}</a>
                        {% elif num == estoque.number|add:'-3' or num == estoque.number|add:'3' %}
                            <span class="pagination-dots">...</span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if estoque.has_next %}
                    <a href="?page={{ estoque.next_page_number }}{% if url_params %}&{{ url_params }}{% endif %}" class="pagination-btn" title="Pr√≥xima p√°gina">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                    <a href="?page={{ estoque.paginator.num_pages }}{% if url_params %}&{{ url_params }}{% endif %}" class="pagination-btn" title="√öltima p√°gina">
                        <i class="fa-solid fa-angles-right"></i>
                    </a>
                    {% else %}
                    <span class="pagination-btn disabled"><i class="fa-solid fa-chevron-right"></i></span>
                    <span class="pagination-btn disabled"><i class="fa-solid fa-angles-right"></i></span>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="pagination-items-per-page text-lg-end">
                    <span class="text-muted me-2">Itens por p√°gina:</span>
                    <select class="pagination-items-select" onchange="updatePageSize(this.value)">
                        {% for size in page_sizes %}
                        <option value="{{ size }}" {% if size == page_size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- DADOS DO BACKEND -->
{{ filter_options|json_script:"filter-options-data" }}

<!-- MODAL DE EXPORTA√á√ÉO -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fa-solid fa-download me-2"></i>Exportar Estoque
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Escolha o formato para exportar:</p>
                <div class="d-grid gap-3">
                    <a href="{% url 'sapp:exportar_estoque_excel' %}" class="btn btn-success btn-lg">
                        <i class="fa-solid fa-file-excel me-2"></i>Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIRMA√á√ÉO PARA STATUS SIST√äMICO -->
<div class="modal fade" id="modalStatusSistemico" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fa-solid fa-rotate me-2"></i>
                    Alterar Status Sist√™mico
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <div class="small text-muted mb-2">Status Atual:</div>
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <div id="previewStatusAtual" style="width: 32px; height: 32px; border-radius: 50%;"></div>
                        <span id="textoStatusAtual" class="fw-bold"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <i class="fa-solid fa-arrow-down fa-2x text-muted"></i>
                </div>
                <div class="mb-4">
                    <div class="small text-muted mb-2">Novo Status:</div>
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <div id="previewNovoStatus" style="width: 32px; height: 32px; border-radius: 50%;"></div>
                        <span id="textoNovoStatus" class="fw-bold"></span>
                    </div>
                </div>
                <div class="alert alert-info small">
                    <i class="fa-solid fa-info-circle me-1"></i>
                    Ciclo: üî¥ Cr√≠tico ‚Üí üü° Parcial ‚Üí üü¢ OK ‚Üí üî¥ Cr√≠tico
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="confirmarStatusBtn">
                    <i class="fa-solid fa-check me-1"></i>Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script>
let backendOptions = {};
let currentUrlParams = new URLSearchParams(window.location.search);

document.addEventListener('DOMContentLoaded', function() {
    const dataScript = document.getElementById('filter-options-data');
    if (dataScript) {
        try {
            backendOptions = JSON.parse(dataScript.textContent);
            console.log('Op√ß√µes de filtro carregadas:', backendOptions);
        } catch (e) {
            console.error('Erro ao ler op√ß√µes de filtro:', e);
        }
    }
    
    setupSearch();
    setupClearButtons();
    updateActiveFiltersUI();
    markActiveHeaders();
    initStatusTooltips();
    
    const searchInput = document.getElementById('searchInput');
    if (searchInput && searchInput.value.trim() !== '') {
        setTimeout(() => {
            searchInput.focus();
            searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
        }, 100);
    }
});

function initStatusTooltips() {
    document.querySelectorAll('.status-sistemico-container').forEach(container => {
        const tooltip = container.querySelector('.status-tooltip-custom');
        const indicator = container.querySelector('.status-sistemico-indicator');
        
        if (tooltip && indicator) {
            container.addEventListener('mouseenter', () => {
                tooltip.style.display = 'block';
            });
            container.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
            indicator.addEventListener('mouseenter', () => {
                indicator.style.transform = 'scale(1.15)';
            });
            indicator.addEventListener('mouseleave', () => {
                indicator.style.transform = 'scale(1)';
            });
        }
    });
}

// ===== FILTROS =====
let activeFilterContainer = null;

window.showFilter = function(thElement, columnName, columnType) {
    // Fechar filtro anterior se existir
    if (activeFilterContainer) {
        activeFilterContainer.remove();
        activeFilterContainer = null;
    }
    
    const rect = thElement.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    const filterContainer = document.createElement('div');
    filterContainer.className = 'excel-filter-container';
    activeFilterContainer = filterContainer;
    
    if (window.innerWidth <= 768) {
        filterContainer.style.position = 'fixed';
        filterContainer.style.top = '50%';
        filterContainer.style.left = '50%';
        filterContainer.style.transform = 'translate(-50%, -50%)';
    } else {
        filterContainer.style.position = 'absolute';
        filterContainer.style.top = (rect.bottom + scrollTop + 5) + 'px';
        filterContainer.style.left = (rect.left + scrollLeft) + 'px';
    }
    
    if (columnType === 'number') {
        filterContainer.innerHTML = createNumericFilterHTML(columnName);
    } else {
        filterContainer.innerHTML = createSelectFilterHTML(columnName);
    }
    
    document.body.appendChild(filterContainer);
    
    // Impedir que o clique no container feche ele
    filterContainer.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    
    // Fechar ao clicar fora
    setTimeout(() => {
        document.addEventListener('click', function closeOnClickOutside(e) {
            if (filterContainer && !filterContainer.contains(e.target) && e.target !== thElement) {
                filterContainer.remove();
                activeFilterContainer = null;
                document.removeEventListener('click', closeOnClickOutside);
            }
        });
    }, 10);
};

function createNumericFilterHTML(columnName) {
    const minVal = currentUrlParams.get(`min_${columnName}`) || '';
    const maxVal = currentUrlParams.get(`max_${columnName}`) || '';
    return `
        <div class="filter-header"><strong>Filtrar ${columnName}</strong></div>
        <div class="filter-numeric p-3">
            <div class="mb-2">
                <small>M√≠nimo</small>
                <input type="number" id="${columnName}-min" class="form-control form-control-sm" value="${minVal}" step="0.01">
            </div>
            <div class="mb-3">
                <small>M√°ximo</small>
                <input type="number" id="${columnName}-max" class="form-control form-control-sm" value="${maxVal}" step="0.01">
            </div>
            <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-secondary" onclick="clearColumnFilter('${columnName}')">Limpar</button>
                <button class="btn btn-sm btn-primary" onclick="applyNumericFilter('${columnName}')">Aplicar</button>
            </div>
        </div>
    `;
}

function createSelectFilterHTML(columnName) {
    let options = [];
    
    if (columnName === 'status_sistemico') {
        options = [
            {value: 'ok', label: 'üü¢ OK - Tudo certo'},
            {value: 'parcial', label: 'üü° Parcial - Diverg√™ncia'},
            {value: 'critico', label: 'üî¥ Cr√≠tico - Sem saldo real'}
        ];
    } else {
        const rawOptions = backendOptions[columnName] || [];
        options = rawOptions.map(opt => ({value: opt, label: opt}));
    }
    
    const selectedValues = currentUrlParams.getAll(columnName);
    let optionsHtml = '';
    
    if (options.length === 0) {
        optionsHtml = '<div class="p-3 text-center text-muted">Sem op√ß√µes dispon√≠veis</div>';
    } else {
        options.forEach(opt => {
            const safeValue = String(opt.value);
            const isChecked = selectedValues.includes(safeValue) ? 'checked' : '';
            const id = `chk-${columnName}-${safeValue.replace(/[^a-zA-Z0-9]/g, '_')}`;
            optionsHtml += `
                <div class="filter-option">
                    <input type="checkbox" id="${id}" value="${safeValue}" ${isChecked}>
                    <label for="${id}" class="text-truncate" title="${opt.label}">${opt.label}</label>
                </div>
            `;
        });
    }
    
    return `
        <div class="filter-header"><strong>${columnName}</strong></div>
        <div class="filter-search">
            <input type="text" class="form-control form-control-sm" placeholder="Buscar..." onkeyup="filterOptionsList(this)">
        </div>
        <div class="filter-options" id="options-list-${columnName}">${optionsHtml}</div>
        <div class="filter-actions">
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-link p-0" onclick="toggleAll('${columnName}', true)">Todos</button>
                <button class="btn btn-sm btn-link p-0" onclick="toggleAll('${columnName}', false)">Nenhum</button>
            </div>
            <div class="d-flex gap-2 ms-auto">
                <button class="btn btn-sm btn-secondary" onclick="clearColumnFilter('${columnName}')">Limpar</button>
                <button class="btn btn-sm btn-primary" onclick="applySelectFilter('${columnName}')">Aplicar</button>
            </div>
        </div>
    `;
}

function setupSearch() {
    const input = document.getElementById('searchInput');
    const btn = document.getElementById('clearSearchBtn');
    let searchTimeout = null;
    
    if (input) {
        if (input.value) btn.style.display = 'flex';
        
        input.addEventListener('input', function() {
            btn.style.display = this.value ? 'flex' : 'none';
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            if (this.value.length >= 3 || this.value.length === 0) {
                searchTimeout = setTimeout(() => {
                    atualizarCardsComFiltros();
                    
                    if (this.value.length >= 3) {
                        currentUrlParams.set('busca', this.value);
                    } else {
                        currentUrlParams.delete('busca');
                    }
                    currentUrlParams.set('page', '1');
                    reloadPage();
                }, 500);
            }
        });
        
        btn.addEventListener('click', function() {
            input.value = '';
            btn.style.display = 'none';
            atualizarCardsComFiltros();
            currentUrlParams.delete('busca');
            currentUrlParams.set('page', '1');
            reloadPage();
        });
    }
}

function setupClearButtons() {
    const btn = document.getElementById('clearFiltersBtn');
    if(btn) btn.onclick = clearAllFilters;
}

window.applyNumericFilter = function(columnName) {
    const min = document.getElementById(`${columnName}-min`).value;
    const max = document.getElementById(`${columnName}-max`).value;
    currentUrlParams.delete(`min_${columnName}`);
    currentUrlParams.delete(`max_${columnName}`);
    if (min) currentUrlParams.set(`min_${columnName}`, min);
    if (max) currentUrlParams.set(`max_${columnName}`, max);
    currentUrlParams.set('page', '1');
    
    if (activeFilterContainer) {
        activeFilterContainer.remove();
        activeFilterContainer = null;
    }
    
    atualizarCardsComFiltros();
    reloadPage();
};

window.applySelectFilter = function(columnName) {
    const container = document.getElementById(`options-list-${columnName}`);
    const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
    currentUrlParams.delete(columnName);
    checkboxes.forEach(cb => { 
        currentUrlParams.append(columnName, cb.value); 
    });
    currentUrlParams.set('page', '1');
    
    if (activeFilterContainer) {
        activeFilterContainer.remove();
        activeFilterContainer = null;
    }
    
    atualizarCardsComFiltros();
    reloadPage();
};

window.clearColumnFilter = function(columnName) {
    // Remove todos os par√¢metros relacionados √† coluna
    const keysToRemove = [];
    for (let key of currentUrlParams.keys()) {
        if (key === columnName || key === `min_${columnName}` || key === `max_${columnName}`) {
            keysToRemove.push(key);
        }
    }
    keysToRemove.forEach(key => currentUrlParams.delete(key));
    currentUrlParams.set('page', '1');
    
    if (activeFilterContainer) {
        activeFilterContainer.remove();
        activeFilterContainer = null;
    }
    
    atualizarCardsComFiltros();
    reloadPage();
};

window.clearAllFilters = function() {
    const pageSize = currentUrlParams.get('page_size');
    currentUrlParams = new URLSearchParams();
    if (pageSize) {
        currentUrlParams.set('page_size', pageSize);
    }
    currentUrlParams.set('page', '1');
    
    if (activeFilterContainer) {
        activeFilterContainer.remove();
        activeFilterContainer = null;
    }
    
    atualizarCardsComFiltros();
    reloadPage();
};

window.filterOptionsList = function(input) {
    const term = input.value.toLowerCase();
    const container = input.closest('.filter-search').nextElementSibling;
    const options = container.querySelectorAll('.filter-option');
    options.forEach(opt => {
        const text = opt.innerText.toLowerCase();
        opt.style.display = text.includes(term) ? 'flex' : 'none';
    });
};

window.toggleAll = function(columnName, checked) {
    const container = document.getElementById(`options-list-${columnName}`);
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => { 
        if (cb.parentElement.style.display !== 'none') cb.checked = checked; 
    });
};

window.updatePageSize = function(size) {
    currentUrlParams.set('page_size', size);
    currentUrlParams.set('page', '1');
    reloadPage();
};

function reloadPage() {
    window.location.search = currentUrlParams.toString();
}

function markActiveHeaders() {
    const keys = Array.from(currentUrlParams.keys());
    document.querySelectorAll('th[data-column]').forEach(th => {
        const col = th.dataset.column;
        if (keys.includes(col) || keys.includes(`min_${col}`) || keys.includes(`max_${col}`)) {
            th.classList.add('filter-active');
        } else {
            th.classList.remove('filter-active');
        }
    });
}

function updateActiveFiltersUI() {
    const container = document.getElementById('activeFilters');
    if(!container) return;
    
    container.innerHTML = '';
    let count = 0;
    const ignore = ['page', 'page_size'];
    const uniqueKeys = new Set(Array.from(currentUrlParams.keys()).filter(k => !ignore.includes(k)));
    
    uniqueKeys.forEach(key => {
        count++;
        let label = key;
        const vals = currentUrlParams.getAll(key);
        
        if (key.startsWith('min_')) {
            label = `${key.replace('min_', '')} ‚â• ${vals[0]}`;
        } else if (key.startsWith('max_')) {
            label = `${key.replace('max_', '')} ‚â§ ${vals[0]}`;
        } else {
            if (key === 'status_sistemico') {
                const displayVals = vals.map(v => {
                    if (v === 'ok') return 'üü¢ OK';
                    if (v === 'parcial') return 'üü° Parcial';
                    if (v === 'critico') return 'üî¥ Cr√≠tico';
                    return v;
                });
                label = `${key}: ${displayVals.join(', ')}`;
            } else if (key === 'busca') {
                label = `Busca: "${vals[0]}"`;
            } else {
                label = `${key}: ${vals.join(', ')}`;
            }
        }
        
        const badge = document.createElement('span');
        badge.className = 'active-filter-badge';
        badge.innerHTML = `${label} <i class="fa-solid fa-times" onclick="clearColumnFilter('${key.replace(/min_|max_/, '')}')"></i>`;
        container.appendChild(badge);
    });
    
    document.getElementById('activeFiltersContainer').style.display = count > 0 ? 'block' : 'none';
    document.getElementById('clearFiltersBtn').style.display = count > 0 ? 'inline-flex' : 'none';
}

function atualizarCardsComFiltros() {
    document.querySelectorAll('.stats-card h4').forEach(el => {
        el.style.opacity = '0.5';
    });
    
    document.querySelectorAll('.stats-card .rounded-circle i').forEach(el => {
        if (!el.classList.contains('fa-spinner')) {
            el.classList.add('fa-spinner', 'fa-pulse');
        }
    });
    
    const params = new URLSearchParams(currentUrlParams);
    
    fetch(`/api/estoque/estatisticas/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalItens').textContent = Number(data.total_itens).toLocaleString('pt-BR');
                document.getElementById('totalSc').textContent = Number(data.total_sc).toLocaleString('pt-BR');
                document.getElementById('totalBags').textContent = Number(data.total_bags).toLocaleString('pt-BR');
                document.getElementById('clientesUnicos').textContent = Number(data.clientes_unicos).toLocaleString('pt-BR');
            }
            
            document.querySelectorAll('.stats-card h4').forEach(el => {
                el.style.opacity = '1';
            });
            
            document.querySelectorAll('.stats-card .rounded-circle i').forEach(el => {
                el.classList.remove('fa-spinner', 'fa-pulse');
            });
        })
        .catch(error => {
            console.error('Erro ao atualizar cards:', error);
            document.querySelectorAll('.stats-card h4').forEach(el => el.style.opacity = '1');
            document.querySelectorAll('.stats-card .rounded-circle i').forEach(el => {
                el.classList.remove('fa-spinner', 'fa-pulse');
            });
        });
}

// ===== STATUS SIST√äMICO =====
let loteIdAtual = null;
let elementoAtual = null;
let statusAtual = '';

function abrirModalStatusSistemico(loteId, elemento) {
    event.stopPropagation();
    
    const indicator = elemento.querySelector('.status-sistemico-indicator');
    if (!indicator) return;
    
    loteIdAtual = loteId;
    elementoAtual = indicator;
    statusAtual = indicator.dataset.status;
    
    const cores = {
        'critico': '#dc3545',
        'parcial': '#ffc107',
        'ok': '#28a745'
    };
    
    const textos = {
        'critico': 'Cr√≠tico - Sem saldo real',
        'parcial': 'Parcial - Diverg√™ncia',
        'ok': 'OK - Tudo certo'
    };
    
    const proximoStatus = statusAtual === 'critico' ? 'parcial' : 
                         (statusAtual === 'parcial' ? 'ok' : 'critico');
    
    document.getElementById('previewStatusAtual').style.backgroundColor = cores[statusAtual];
    document.getElementById('textoStatusAtual').innerHTML = textos[statusAtual];
    document.getElementById('textoStatusAtual').style.color = cores[statusAtual];
    
    document.getElementById('previewNovoStatus').style.backgroundColor = cores[proximoStatus];
    document.getElementById('textoNovoStatus').innerHTML = textos[proximoStatus];
    document.getElementById('textoNovoStatus').style.color = cores[proximoStatus];
    
    document.getElementById('confirmarStatusBtn').onclick = confirmarAlteracaoStatus;
    
    new bootstrap.Modal(document.getElementById('modalStatusSistemico')).show();
}

function confirmarAlteracaoStatus() {
    if (!loteIdAtual || !elementoAtual) return;
    
    const btn = document.getElementById('confirmarStatusBtn');
    const textoOriginal = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-pulse me-1"></i>Alterando...';
    btn.disabled = true;
    
    fetch('/api/atualizar-status-sistemico/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ lote_id: loteIdAtual })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const cores = {
                'critico': '#dc3545',
                'parcial': '#ffc107',
                'ok': '#28a745'
            };
            
            elementoAtual.style.backgroundColor = cores[data.novo_status];
            elementoAtual.dataset.status = data.novo_status;
            
            const container = elementoAtual.closest('.status-sistemico-container');
            const tooltip = container.querySelector('.status-tooltip-custom');
            if (tooltip) {
                tooltip.innerHTML = `
                    <strong>
                        ${data.novo_status === 'ok' ? 'üü¢ OK - Tudo certo' : 
                          (data.novo_status === 'parcial' ? 'üü° Parcial - Diverg√™ncia' : 'üî¥ Cr√≠tico - Sem saldo real')}
                    </strong>
                    <small>
                        <i class="fa-solid fa-user me-1"></i>${data.alterado_por}<br>
                        <i class="fa-solid fa-clock me-1"></i>${data.alterado_em}
                    </small>
                `;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('modalStatusSistemico')).hide();
            mostrarNotificacao('Status atualizado com sucesso!', 'success');
        } else {
            mostrarNotificacao('Erro: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao comunicar com o servidor', 'danger');
    })
    .finally(() => {
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
    });
}

function mostrarNotificacao(mensagem, tipo) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${tipo} border-0 position-fixed top-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.style.zIndex = '9999';
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${mensagem}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    setTimeout(() => toast.remove(), 3500);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Atualizar cards ao carregar com filtros
if (currentUrlParams.toString()) {
    setTimeout(() => {
        atualizarCardsComFiltros();
    }, 100);
}

// Observar mudan√ßas nos filtros via popstate
window.addEventListener('popstate', function() {
    currentUrlParams = new URLSearchParams(window.location.search);
    updateActiveFiltersUI();
    markActiveHeaders();
    
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        const busca = currentUrlParams.get('busca') || '';
        searchInput.value = busca;
        document.getElementById('clearSearchBtn').style.display = busca ? 'flex' : 'none';
    }
    
    atualizarCardsComFiltros();
});
</script>
{% endblock %}