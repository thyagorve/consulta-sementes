<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Importar Lotes</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        textarea { width: 100%; font-family: monospace; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 4px; font-size: 12px; }
        .botao { padding: 10px 20px; margin-top: 10px; background: #28a745; color: white; border: none; cursor: pointer; }
        .botao:disabled { background: #888; }
        #status { margin-top: 10px; }
    </style>
</head>
<body>
    <h2>Importar Lotes</h2>

    <p>Cole abaixo os dados copiados diretamente do Excel:</p>
    <textarea id="excelInput" rows="12" placeholder="Código\tLote\tCultivar\tCategoria\tQuantidade... (Ctrl+V)"></textarea>

    <div id="preview"></div>

    <button class="botao" onclick="enviarDados()">Importar</button>

    <div id="status"></div>

    <script>
        let dadosProcessados = [];
        let debounceTimeout;

        document.getElementById("excelInput").addEventListener("input", () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(processarDados, 300);
        });

        function processarDados() {
            const input = document.getElementById("excelInput").value.trim();
            const linhas = input.split("\n").filter(l => l.trim() !== "");

            dadosProcessados = linhas.map(l => l.split("\t"));

            const previewLimit = 100;
            const linhasPreview = dadosProcessados.slice(0, previewLimit);
            const previewHTML = linhasPreview.map(cols => 
                `<tr>${cols.map(col => `<td>${col}</td>`).join("")}</tr>`
            ).join("");

            document.getElementById("preview").innerHTML = `
                <p><strong>Preview das primeiras ${linhasPreview.length} de ${dadosProcessados.length} linhas:</strong></p>
                <table>${previewHTML}</table>
            `;
        }

        function enviarDados() {
            if (dadosProcessados.length === 0) {
                alert("Nenhum dado para importar!");
                return;
            }

            const botao = document.querySelector(".botao");
            botao.disabled = true;
            document.getElementById("status").textContent = "Enviando dados...";

            fetch("/importar/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({ dados: dadosProcessados })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("status").innerHTML = `<span style="color:green;">Importação concluída com sucesso! ${data.total} registros importados.</span>`;
                botao.disabled = false;
            })
            .catch(error => {
                console.error("Erro:", error);
                document.getElementById("status").innerHTML = `<span style="color:red;">Erro ao importar os dados.</span>`;
                botao.disabled = false;
            });
        }

        function getCookie(name) {
            const cookieValue = document.cookie.split("; ")
                .find(row => row.startsWith(name + "="));
            return cookieValue ? decodeURIComponent(cookieValue.split("=")[1]) : null;
        }
    </script>
</body>
</html>
