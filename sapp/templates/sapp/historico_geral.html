<!-- sapp/templates/sapp/historico_geral.html -->
{% extends 'sapp/base.html' %}
{% load humanize %}

{% block content %}

<!-- Bibliotecas Necessárias -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    :root {
        --primary-brown: #8B4513;
        --secondary-brown: #D2691E;
        --header-bg: linear-gradient(135deg, #2c3e50, #34495e);
        --accent-color: #e67e22;
        --stats-green: #10b981;
        --stats-red: #ef4444;
        --stats-blue: #3b82f6;
        --stats-orange: #f97316;
    }

    /* --- Cards de Estatísticas --- */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #f0f0f0;
    }

    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    .stats-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        background: #f8fafc;
    }

    .stats-icon.total { background: #e6f7ff; color: #0284c7; }
    .stats-icon.entradas { background: #e6f7e6; color: #059669; }
    .stats-icon.saidas { background: #fee2e2; color: #dc2626; }
    .stats-icon.transf { background: #fff3e6; color: #d97706; }

    .stats-content {
        flex: 1;
    }

    .stats-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        margin-bottom: 0.25rem;
    }

    .stats-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.2;
    }

    .stats-sub {
        font-size: 0.7rem;
        color: #64748b;
        margin-top: 0.15rem;
    }

    /* --- Título e Card --- */
    .page-title {
        background: white;
        color: #333;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 5px solid var(--primary-brown);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .page-title h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        color: var(--primary-brown);
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    /* --- Customização do DataTables --- */
    .dataTables_wrapper {
        padding: 0;
    }

    .dataTables_filter {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        margin-bottom: 0 !important;
        text-align: right;
    }

    .dataTables_filter input {
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 6px 15px;
        width: 250px;
        transition: all 0.3s;
        outline: none;
    }

    .dataTables_filter input:focus {
        border-color: var(--primary-brown);
        box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
    }

    .dt-footer-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
        flex-wrap: wrap;
        gap: 10px;
    }

    .dataTables_info {
        padding-top: 0 !important;
        font-size: 0.85rem;
        color: #666;
    }

    .dataTables_paginate .pagination {
        margin: 0 !important;
    }

    .page-item.active .page-link {
        background-color: var(--primary-brown) !important;
        border-color: var(--primary-brown) !important;
    }

    .page-link {
        color: var(--primary-brown);
        border-radius: 4px;
        margin: 0 2px;
        border: none;
        font-size: 0.85rem;
    }

    /* Remover setas de ordenação */
    table.dataTable thead .sorting,
    table.dataTable thead .sorting_asc,
    table.dataTable thead .sorting_desc,
    table.dataTable thead .sorting_asc_disabled,
    table.dataTable thead .sorting_desc_disabled {
        background-image: none !important;
        cursor: default;
    }

    /* --- Tabela e Cabeçalhos --- */
    #tabelaHistorico {
        margin: 0 !important;
        width: 100% !important;
        border-collapse: collapse;
    }

    #tabelaHistorico thead th {
        background: var(--header-bg) !important;
        color: white !important;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0 !important;
        border: none;
        height: 50px;
        vertical-align: middle;
    }

    .filter-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 100%;
        padding: 0 12px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .filter-header:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .filter-icon {
        background: rgba(255,255,255,0.15);
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 8px;
    }

    .filter-icon.active {
        background: var(--accent-color);
        color: white;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    #tabelaHistorico tbody td {
        padding: 10px 12px;
        font-size: 0.9rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f1f1;
    }

    /* Badges e formatação */
    .badge-quantidade {
        background: #f1f5f9;
        color: #1e293b;
        font-weight: 600;
        padding: 6px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: inline-block;
        min-width: 70px;
        text-align: center;
        border: 1px solid #e2e8f0;
    }

    .badge-quantidade.entrada { 
        background: #dcfce7; 
        color: #059669;
        border-left: 4px solid #059669;
    }
    
    .badge-quantidade.saida { 
        background: #fee2e2; 
        color: #dc2626;
        border-left: 4px solid #dc2626;
    }
    
    .badge-quantidade.transferencia {
        background: #fff3e6;
        color: #d97706;
        border-left: 4px solid #d97706;
    }

    .badge {
        font-weight: 500;
        letter-spacing: 0.3px;
        padding: 6px 10px;
        font-size: 0.75rem;
    }

    .badge-entrada { background-color: #27ae60; }
    .badge-saida { background-color: #c0392b; }
    .badge-transferencia { background-color: #f39c12; color: white; }
    .badge-edicao { background-color: #2980b9; }
    .badge-exclusao { background-color: #7f8c8d; }

    .endereco-badge {
        background: #f1f5f9;
        color: #334155;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-block;
    }

    .endereco-badge i {
        color: #64748b;
        margin-right: 4px;
    }

    /* --- Menu Dropdown de Filtro --- */
    .excel-filter-dropdown {
        position: absolute;
        z-index: 10000;
        background: white;
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        width: 300px;
        display: none;
        font-family: 'Segoe UI', sans-serif;
        overflow: hidden;
        animation: fadeIn 0.2s ease-out;
        border: 1px solid #e2e8f0;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .excel-filter-header {
        background: #f8fafc;
        padding: 15px;
        border-bottom: 1px solid #e2e8f0;
    }

    .filter-search-box {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .filter-search-box:focus {
        border-color: var(--primary-brown);
        outline: none;
        box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
    }

    .excel-filter-content {
        max-height: 300px;
        overflow-y: auto;
        padding: 8px 0;
        background: white;
    }

    .filter-checkbox-item {
        padding: 8px 15px;
        transition: background 0.1s;
        border-bottom: 1px solid #f1f5f9;
    }

    .filter-checkbox-item:hover {
        background-color: #f1f5f9;
    }

    .filter-checkbox-item label {
        display: flex;
        align-items: center;
        width: 100%;
        cursor: pointer;
        font-size: 0.9rem;
        color: #1e293b;
        margin: 0;
        gap: 8px;
    }

    .filter-checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-brown);
        cursor: pointer;
    }

    .filter-checkbox-item .valor-texto {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .filter-checkbox-item .contador {
        background: #e2e8f0;
        padding: 2px 8px;
        border-radius: 20px;
        font-size: 0.7rem;
        color: #475569;
    }

    .filter-buttons {
        padding: 15px;
        background: white;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .filter-buttons button {
        font-size: 0.85rem;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-buttons .btn-primary {
        background: var(--primary-brown);
        color: white;
    }

    .filter-buttons .btn-primary:hover {
        background: #6b3410;
    }

    .filter-buttons .btn-light {
        background: #f1f5f9;
        color: #475569;
    }

    .filter-buttons .btn-light:hover {
        background: #e2e8f0;
    }

    .filter-buttons .btn-outline-danger {
        background: white;
        color: #dc2626;
        border: 1px solid #dc2626;
    }

    .filter-buttons .btn-outline-danger:hover {
        background: #dc2626;
        color: white;
    }

    /* Descrição */
    .descricao-cell {
        max-width: 350px;
        line-height: 1.4;
    }

    /* --- Mobile --- */
    @media (max-width: 768px) {
        .page-title { flex-direction: column; text-align: center; gap: 10px; }
        .dataTables_filter { text-align: center; }
        .dataTables_filter input { width: 100%; }
        .dt-footer-wrapper { justify-content: center; text-align: center; flex-direction: column; }
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
        
        .excel-filter-dropdown {
            width: 95vw;
            max-width: 350px;
        }
        
        #tabelaHistorico thead th { font-size: 0.7rem; height: 45px; }
        .filter-header { padding: 0 5px; }
        
        .badge-quantidade {
            min-width: 50px;
            padding: 4px 6px;
            font-size: 0.75rem;
        }
        
        .descricao-cell {
            max-width: 200px;
        }
    }

    #filter-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        z-index: 9999; display: none; background: rgba(0,0,0,0.3);
        backdrop-filter: blur(3px);
    }
</style>

<div class="container-fluid mt-3 mb-5">
    
    <!-- Título da Página -->
    <div class="page-title">
        <div>
            <h1><i class="fas fa-history me-2"></i>Histórico Geral</h1>
            <small class="text-muted">Gerencie e rastreie todas as movimentações</small>
        </div>
        <div class="d-none d-md-block">
            <span class="badge bg-secondary"><i class="fas fa-filter me-1"></i>Filtros Avançados</span>
        </div>
    </div>

    <!-- Cards de Estatísticas -->
    <div class="stats-grid mb-4">
        <div class="stats-card">
            <div class="stats-icon total">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stats-content">
                <div class="stats-label">Total de Registros</div>
                <div class="stats-value">{{ historico_lista|length|intcomma }}</div>
                <div class="stats-sub">movimentações no sistema</div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon entradas">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="stats-content">
                <div class="stats-label">Entradas</div>
                <div class="stats-value">{{ total_entradas|default:"0"|intcomma }}</div>
                <div class="stats-sub">{{ entradas_bags|default:"0" }} bags / {{ entradas_sc|default:"0" }} sc</div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon saidas">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="stats-content">
                <div class="stats-label">Saídas/Expedições</div>
                <div class="stats-value">{{ total_saidas|default:"0"|intcomma }}</div>
                <div class="stats-sub">{{ saidas_bags|default:"0" }} bags / {{ saidas_sc|default:"0" }} sc</div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon transf">
                <i class="fas fa-arrows-spin"></i>
            </div>
            <div class="stats-content">
                <div class="stats-label">Transferências</div>
                <div class="stats-value">{{ total_transferencias|default:"0"|intcomma }}</div>
                <div class="stats-sub">entre endereços</div>
            </div>
        </div>
    </div>

    <!-- Tabela Card -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="tabelaHistorico" class="table table-hover align-middle" style="width:100%">
                    <thead>
                        <tr>
                            <th style="width: 12%;">
                                <div class="filter-header" data-column="0">
                                    <span>DATA/HORA</span>
                                    <div class="filter-icon"><i class="fas fa-filter"></i></div>
                                </div>
                            </th>
                            <th style="width: 10%;">
                                <div class="filter-header" data-column="1">
                                    <span>TIPO</span>
                                    <div class="filter-icon"><i class="fas fa-filter"></i></div>
                                </div>
                            </th>
                            <th style="width: 10%;">
                                <div class="filter-header" data-column="2">
                                    <span>LOTE</span>
                                    <div class="filter-icon"><i class="fas fa-filter"></i></div>
                                </div>
                            </th>
                            <th style="width: 8%;">
                                <div class="filter-header" data-column="3">
                                    <span>ENDEREÇO</span>
                                    <div class="filter-icon"><i class="fas fa-filter"></i></div>
                                </div>
                            </th>
                            <th style="width: 8%;">
                                <div class="filter-header" data-column="4">
                                    <span>QUANTIDADE</span>
                                    <div class="filter-icon"><i class="fas fa-filter"></i></div>
                                </div>
                            </th>
                            <th style="width: 12%;">
                                <div class="filter-header" data-column="5">
                                    <span>USUÁRIO</span>
                                    <div class="filter-icon"><i class="fas fa-filter"></i></div>
                                </div>
                            </th>
                            <th style="width: 40%;">
                                <div class="filter-header" data-column="6">
                                    <span>DETALHES</span>
                                    <div class="filter-icon"><i class="fas fa-filter"></i></div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in historico_lista %}
                        <tr>
                            <!-- DATA/HORA -->
                            <td data-order="{{ h.data_hora|date:'YmdHis' }}">
                                <div class="fw-bold">{{ h.data_hora|date:"d/m/Y" }}</div>
                                <div class="text-muted small">{{ h.data_hora|date:"H:i:s" }}</div>
                            </td>
                            
                            <!-- TIPO -->
                            <td data-order="{{ h.tipo }}">
                                {% if 'Entrada' in h.tipo %}
                                    <span class="badge badge-entrada rounded-pill px-3">ENTRADA</span>
                                {% elif 'Saída' in h.tipo or 'Expedição' in h.tipo %}
                                    <span class="badge badge-saida rounded-pill px-3">SAÍDA</span>
                                {% elif 'Transferência' in h.tipo %}
                                    <span class="badge badge-transferencia rounded-pill px-3">TRANSF.</span>
                                {% elif 'Edição' in h.tipo %}
                                    <span class="badge badge-edicao rounded-pill px-3">EDIÇÃO</span>
                                {% elif 'EXCLUSÃO' in h.tipo %}
                                    <span class="badge badge-exclusao rounded-pill px-3">EXCLUSÃO</span>
                                {% else %}
                                    <span class="badge bg-secondary rounded-pill px-3">{{ h.tipo|upper|truncatechars:10 }}</span>
                                {% endif %}
                            </td>
                            
                            <!-- LOTE -->
                            <td data-order="{{ h.lote_ref }}">
                                {% if h.estoque %}
                                    <span class="fw-bold">{{ h.estoque.lote }}</span>
                                    {% if h.estoque.produto %}
                                        <small class="d-block text-muted">{{ h.estoque.produto|truncatechars:12 }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="fw-bold">{{ h.lote_ref|default:"--" }}</span>
                                {% endif %}
                            </td>
                            
                            <!-- ENDEREÇO -->
                            <td data-order="{{ h.estoque.endereco|default:'' }}">
                                {% if h.estoque and h.estoque.endereco %}
                                    <span class="endereco-badge">
                                        <i class="fas fa-location-dot"></i> {{ h.estoque.endereco }}
                                    </span>
                                    {% if h.estoque.az %}
                                        <small class="d-block text-muted mt-1">AZ {{ h.estoque.az }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            
                            <!-- QUANTIDADE - AGORA CORRETO -->
                            <td data-order="{{ h.quantidade }}" class="text-center">
                                {% if h.quantidade and h.quantidade > 0 %}
                                    {% if 'Entrada' in h.tipo %}
                                        <span class="badge-quantidade entrada">
                                            <i class="fas fa-plus-circle me-1"></i>{{ h.quantidade|intcomma }}
                                        </span>
                                    {% elif 'Saída' in h.tipo or 'Expedição' in h.tipo %}
                                        <span class="badge-quantidade saida">
                                            <i class="fas fa-minus-circle me-1"></i>{{ h.quantidade|intcomma }}
                                        </span>
                                    {% elif 'Transferência' in h.tipo %}
                                        <span class="badge-quantidade transferencia">
                                            <i class="fas fa-arrows-spin me-1"></i>{{ h.quantidade|intcomma }}
                                        </span>
                                    {% else %}
                                        <span class="badge-quantidade">
                                            {{ h.quantidade|intcomma }}
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted small">—</span>
                                {% endif %}
                            </td>
                            
                            <!-- USUÁRIO -->
                            <td data-order="{{ h.usuario.username|default:'Sistema' }}">
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar bg-secondary bg-opacity-10 rounded-circle me-2" 
                                         style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user-circle text-secondary" style="font-size: 1.2rem;"></i>
                                    </div>
                                    <div>
                                        <span class="fw-medium">{{ h.usuario.username|default:"Sistema" }}</span>
                                        {% if h.usuario.first_name %}
                                            <small class="d-block text-muted">{{ h.usuario.first_name }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            
                            <!-- DETALHES -->
                            <td>
                                <div class="descricao-cell small">
                                    {{ h.descricao|safe }}
                                </div>
                                {% if h.numero_carga or h.motorista or h.placa or h.cliente %}
                                <div class="mt-2 pt-1 border-top small text-muted">
                                    {% if h.numero_carga %}
                                        <span class="me-2"><i class="fas fa-truck"></i> {{ h.numero_carga }}</span>
                                    {% endif %}
                                    {% if h.motorista %}
                                        <span class="me-2"><i class="fas fa-id-card"></i> {{ h.motorista }}</span>
                                    {% endif %}
                                    {% if h.placa %}
                                        <span class="me-2"><i class="fas fa-car"></i> {{ h.placa }}</span>
                                    {% endif %}
                                    {% if h.cliente %}
                                        <span><i class="fas fa-building"></i> {{ h.cliente }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="fas fa-history fa-3x mb-3 opacity-25"></i>
                                <p class="mb-0">Nenhum registro de movimentação encontrado</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Rodapé Personalizado -->
            <div id="custom-footer" class="dt-footer-wrapper"></div>
        </div>
    </div>
</div>

<div id="filter-overlay"></div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    
    // Configuração do DataTable
    var table = $('#tabelaHistorico').DataTable({
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json",
            search: "",
            searchPlaceholder: "Pesquisar em tudo..."
        },
        ordering: false,
        order: [],
        autoWidth: false,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
        dom: '<"top"f>rt<"bottom"ip><"clear">',
        
        drawCallback: function() {
            var footer = $('#custom-footer');
            $('.dataTables_info').detach().appendTo(footer);
            $('.dataTables_paginate').detach().appendTo(footer);
            $('.dataTables_length').detach().appendTo(footer);
        }
    });

    // Função para extrair texto puro do HTML
    function getTextFromHtml(html) {
        if (!html) return "";
        // Cria um elemento temporário para converter HTML em texto
        var temp = document.createElement('div');
        temp.innerHTML = html;
        return temp.textContent || temp.innerText || "";
    }

    // Função para obter valor da célula baseado na coluna
    function getCellValue(cell, colIndex) {
        if (!cell) return "";
        
        // Para coluna de quantidade, usar o atributo data-order
        if (colIndex === 4) {
            var orderValue = cell.getAttribute('data-order');
            if (orderValue && orderValue !== "0") {
                return orderValue;
            }
        }
        
        // Para outras colunas, usar data-order se existir
        var orderAttr = cell.getAttribute('data-order');
        if (orderAttr) {
            return orderAttr;
        }
        
        // Fallback: texto puro da célula
        return getTextFromHtml(cell.innerHTML).trim();
    }

    // Abrir Filtro ao Clicar no Header
    $(document).on('click', '.filter-header', function(e) {
        e.stopPropagation();
        
        var $header = $(this);
        var colIndex = $header.data('column');
        
        // Fechar filtros anteriores
        $('.excel-filter-dropdown').remove();
        $('#filter-overlay').fadeIn(200);

        // Coletar dados únicos da coluna
        var column = table.column(colIndex);
        var uniqueValues = new Map(); // Usar Map para contar ocorrências
        
        column.nodes().each(function(cell) {
            var value = getCellValue(cell, colIndex);
            if (value && value.trim() !== '' && value !== '—' && value !== '0') {
                var count = uniqueValues.get(value) || 0;
                uniqueValues.set(value, count + 1);
            }
        });
        
        // Converter para array e ordenar
        var sortedData = Array.from(uniqueValues.entries())
            .sort(function(a, b) {
                // Ordenar por valor (texto)
                if (a[0] < b[0]) return -1;
                if (a[0] > b[0]) return 1;
                return 0;
            });
        
        var currentSearch = column.search();
        
        // Criar dropdown
        var dropdownHtml = `
            <div class="excel-filter-dropdown" data-col="${colIndex}">
                <div class="excel-filter-header">
                    <input type="text" class="filter-search-box" placeholder="Filtrar nesta lista...">
                </div>
                <div class="excel-filter-content">
                    <ul class="list-unstyled m-0">
                        <li class="filter-checkbox-item">
                            <label>
                                <input type="checkbox" class="select-all" checked>
                                <span class="valor-texto fw-bold text-primary">(Selecionar Tudo)</span>
                                <span class="contador">${sortedData.length}</span>
                            </label>
                        </li>
        `;

        sortedData.forEach(function(item) {
            var value = item[0];
            var count = item[1];
            
            // Determinar se deve estar marcado baseado no filtro atual
            var isChecked = true;
            if (currentSearch) {
                try {
                    var regex = new RegExp(currentSearch.replace(/[\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&"));
                    if (!regex.test(value)) isChecked = false;
                } catch(err) {
                    isChecked = false;
                }
            }

            dropdownHtml += `
                <li class="filter-checkbox-item">
                    <label>
                        <input type="checkbox" class="val-checkbox" value="${value.replace(/"/g, '&quot;')}" ${isChecked ? 'checked' : ''}>
                        <span class="valor-texto" title="${value}">${value.length > 30 ? value.substring(0, 30) + '...' : value}</span>
                        <span class="contador">${count}</span>
                    </label>
                </li>`;
        });

        dropdownHtml += `
                    </ul>
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-light close-filter">Cancelar</button>
                    <button class="btn btn-primary apply-filter">Aplicar</button>
                    <button class="btn btn-outline-danger clear-filter" title="Limpar Filtro"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;

        $('body').append(dropdownHtml);

        // Posicionar dropdown
        var offset = $header.offset();
        var dropdown = $('.excel-filter-dropdown');
        var top = offset.top + $header.outerHeight() + 8;
        var left = offset.left;
        var screenWidth = $(window).width();

        if (screenWidth < 768) {
            left = (screenWidth - dropdown.outerWidth()) / 2;
        } else if (left + 320 > screenWidth) {
            left = screenWidth - 330;
        }

        dropdown.css({ top: top, left: left }).show();
        dropdown.find('.filter-search-box').focus();
    });

    // Busca dentro do filtro
    $(document).on('keyup', '.filter-search-box', function() {
        var term = $(this).val().toLowerCase();
        $('.excel-filter-content li:not(:first)').each(function() {
            var text = $(this).find('.valor-texto').text().toLowerCase();
            $(this).toggle(text.indexOf(term) > -1);
        });
    });

    // Checkbox "Selecionar Tudo"
    $(document).on('change', '.select-all', function() {
        var checked = $(this).prop('checked');
        $(this).closest('.excel-filter-dropdown').find('.val-checkbox:visible').prop('checked', checked);
    });

    // Quando um checkbox individual muda, atualizar o "Selecionar Tudo"
    $(document).on('change', '.val-checkbox', function() {
        var dropdown = $(this).closest('.excel-filter-dropdown');
        var totalVisible = dropdown.find('.val-checkbox:visible').length;
        var checkedVisible = dropdown.find('.val-checkbox:visible:checked').length;
        var selectAll = dropdown.find('.select-all');
        
        if (checkedVisible === 0) {
            selectAll.prop('checked', false);
            selectAll.prop('indeterminate', false);
        } else if (checkedVisible === totalVisible) {
            selectAll.prop('checked', true);
            selectAll.prop('indeterminate', false);
        } else {
            selectAll.prop('checked', false);
            selectAll.prop('indeterminate', true);
        }
    });

    // Botão Aplicar
    $(document).on('click', '.apply-filter', function() {
        var dropdown = $(this).closest('.excel-filter-dropdown');
        var colIndex = dropdown.data('col');
        var checkedValues = [];
        
        dropdown.find('.val-checkbox:checked').each(function() {
            var val = $(this).val();
            if (val) {
                // Escapar caracteres especiais para regex
                val = val.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
                checkedValues.push(val);
            }
        });

        var searchString = '';
        var $icon = $(`.filter-header[data-column="${colIndex}"] .filter-icon`);
        
        var totalVisible = dropdown.find('.val-checkbox').length;
        
        if (checkedValues.length > 0 && checkedValues.length < totalVisible) {
            searchString = '^(' + checkedValues.join('|') + ')$';
            $icon.addClass('active');
        } else if (checkedValues.length === 0) {
            searchString = '^$';
            $icon.addClass('active');
        } else {
            searchString = '';
            $icon.removeClass('active');
        }

        table.column(colIndex).search(searchString, true, false).draw();
        closeFilters();
    });

    // Botão Limpar
    $(document).on('click', '.clear-filter', function() {
        var colIndex = $(this).closest('.excel-filter-dropdown').data('col');
        table.column(colIndex).search('').draw();
        $(`.filter-header[data-column="${colIndex}"] .filter-icon`).removeClass('active');
        closeFilters();
    });

    // Fechar filtros
    function closeFilters() {
        $('.excel-filter-dropdown').fadeOut(100, function(){ $(this).remove(); });
        $('#filter-overlay').fadeOut(200);
    }

    $(document).on('click', '.close-filter', closeFilters);
    $('#filter-overlay').on('click', closeFilters);
    
    // Prevenir fechamento ao clicar dentro do dropdown
    $(document).on('click', '.excel-filter-dropdown', function(e) {
        e.stopPropagation();
    });
});
</script>
{% endblock %}