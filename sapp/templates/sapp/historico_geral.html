{% extends 'sapp/base.html' %}
{% load humanize %}

{% block content %}
<style>

    :root {
        --primary-brown: #8B4513;
        --secondary-brown: #D2691E;
        --success-green: #2E8B57;
        --warning-orange: #A0522D;
        --light-beige: #fff8dc;
        --hover-gray: #f8f9fa;
    }

    .page-title {
        background: linear-gradient(135deg, var(--primary-brown), #a05a2b);
        color: white;
        padding: 20px 15px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(139, 69, 19, 0.2);
    }


    .page-title-historic {
        background: linear-gradient(135deg, var(--primary-brown), #a05a2b);
        
        padding: 20px 15px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 6px 20px rgba(44, 62, 80, 0.3);
        border-left: 5px solid #e74c3c;
    }

    .table-responsive {
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        /* üî• CORRE√á√ÉO: Adicionar scroll horizontal */
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Scroll suave no mobile */
    }

    /* Garantir que a tabela tenha largura m√≠nima para for√ßar o scroll */
    .table-responsive table {
        min-width: 700px; /* Largura m√≠nima para for√ßar scroll em mobile */
        width: 100%;
        margin-bottom: 0;
    }

    .bg-sub-header { 
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        font-weight: bold;
        border: none;
        text-align: center;
    }

    .badge-entrada { background: linear-gradient(135deg, #28a745, #20c997); }
    .badge-saida { background: linear-gradient(135deg, #dc3545, #e83e8c); }
    .badge-transferencia { background: linear-gradient(135deg, #ffc107, #fd7e14); }
    .badge-edicao { background: linear-gradient(135deg, #17a2b8, #6f42c1); }
    .badge-exclusao { background: linear-gradient(135deg, #6c757d, #495057); }

    .pagination-controls {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
    }

    /* RESPONSIVIDADE PARA CELULAR */
    @media (max-width: 768px) {
        .page-title-historic {
            padding: 15px 10px;
            margin-bottom: 15px;
        }
        
        .page-title-historic h1 {
            font-size: 1.5rem;
        }
        
        .page-title-historic p {
            font-size: 0.9rem;
        }
        
        .pagination-controls {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }
        
        .table-responsive {
            font-size: 0.8rem;
            /* üî• Scroll mais vis√≠vel no mobile */
            border: 1px solid #dee2e6;
        }
        
        .table-responsive table {
            min-width: 650px; /* Ajuste para mobile */
        }
        
        .table th,
        .table td {
            padding: 0.5rem;
            white-space: nowrap; /* Impede quebra de linha */
        }
        
        .badge {
            font-size: 0.7rem;
            padding: 0.3em 0.6em;
        }
        
        /* Esconder colunas menos importantes no mobile */
        .mobile-hidden {
            display: none;
        }
        
        .mobile-visible {
            display: table-cell;
        }
    }

    @media (max-width: 576px) {
        .container-fluid {
            padding-left: 5px;
            padding-right: 5px;
        }
        
        .table-responsive {
            font-size: 0.75rem;
            margin-left: -5px;
            margin-right: -5px;
        }
        
        .table-responsive table {
            min-width: 600px; /* Menor largura para celulares muito pequenos */
        }
        
        .table th,
        .table td {
            padding: 0.3rem;
        }
        
        /* Layout vertical para informa√ß√µes compactas */
        .mobile-compact {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .mobile-compact .badge {
            align-self: center;
        }

        /* Indicador visual de que tem scroll */
        .table-responsive::after {
            content: "‚Üê Arraste ‚Üí";
            display: block;
            text-align: center;
            padding: 5px;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 0.7rem;
            border-top: 1px solid #dee2e6;
        }
    }
</style>

<div class="container-fluid mt-3">
    


     <div class="page-title text-center">
        <h1 class="mb-2"><i class="fas fa-boxes me-3"></i>REGISTRO HIST√ìRICO</h1>
        <p class="mb-0 opacity-75">Auditoria completa de todas as movimenta√ß√µes.</p>
    </div>

    <!-- Controles de Pagina√ß√£o Responsivos -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 p-3 rounded pagination-controls">
        <div class="text-muted mb-2 mb-md-0 text-center text-md-start">
            <i class="fas fa-list me-1"></i>
            <strong>{{ page_obj.start_index }} - {{ page_obj.end_index }}</strong> de 
            <strong>{{ page_obj.paginator.count|intcomma }}</strong>
        </div>
        
        <div class="d-flex align-items-center">
            <span class="me-2 text-muted d-none d-md-block">Itens por p√°gina:</span>
            <span class="me-2 text-muted d-md-none">Mostrar:</span>
            <select class="form-select form-select-sm" style="width: auto;" onchange="location = this.value;">
                <option value="?page=1&pagina_by=20" {% if request.GET.pagina_by == '20' or not request.GET.pagina_by %}selected{% endif %}>20</option>
                <option value="?page=1&pagina_by=50" {% if request.GET.pagina_by == '50' %}selected{% endif %}>50</option>
                <option value="?page=1&pagina_by=100" {% if request.GET.pagina_by == '100' %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>

    <!-- Tabela Responsiva COM SCROLL -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm align-middle mb-0">
            <thead>
                <tr style="background: linear-gradient(135deg, #2c3e50, #4a6491); color: white;">
                    <th style="width: 120px; min-width: 120px;" class="text-center text-uppercase fw-bold small py-3">
                        <i class="fas fa-clock me-1"></i>DATA/HORA
                    </th>
                    <th style="min-width: 150px;" class="text-center text-uppercase fw-bold small py-3">
                        <i class="fas fa-boxes me-1"></i>LOTE
                    </th>
                    <th style="min-width: 120px;" class="text-center text-uppercase fw-bold small py-3 d-md-table-cell">
                        <i class="fas fa-user-circle me-1"></i>USU√ÅRIO
                    </th>
                    <th style="width: 110px; min-width: 110px;" class="text-center text-uppercase fw-bold small py-3">
                        <i class="fas fa-exchange-alt me-1"></i>TIPO
                    </th>
                    <th style="min-width: 200px;" class="text-center text-uppercase fw-bold small py-3 d-md-table-cell">
                        <i class="fas fa-file-alt me-1"></i>DETALHES
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for h in page_obj %}
                <tr>
                    <td class="fw-bold text-center" style="white-space: nowrap;">
                        <small>{{ h.data_hora|date:"d/m/Y" }}</small><br>
                        <small class="text-muted">{{ h.data_hora|date:"H:i" }}</small>
                    </td>
                    <td class="text-center">
                        {% if h.estoque %}
                            <span class="badge bg-dark">{{ h.estoque.lote }}</span>
                            <small class="text-muted d-none d-sm-block">{{ h.estoque.endereco }}</small>
                        {% else %}
                            <span class="badge bg-danger">{{ h.lote_ref }}</span>
                        {% endif %}
                    </td>
                    <td class="text-center d-md-table-cell">
                        <span class="badge bg-primary">
                            <i class="fas fa-user me-1"></i>{{ h.usuario.username|default:"Sistema" }}
                        </span>
                    </td>
                    <td class="text-center">
                        {% if 'Entrada' in h.tipo %}
                            <span class="badge badge-entrada text-white">
                                <i class="fas fa-plus me-1"></i>Entrada
                            </span>
                        {% elif 'Sa√≠da' in h.tipo %}
                            <span class="badge badge-saida text-white">
                                <i class="fas fa-minus me-1"></i>Sa√≠da
                            </span>
                        {% elif 'Transfer√™ncia' in h.tipo %}
                            <span class="badge badge-transferencia text-white">
                                <i class="fas fa-exchange-alt me-1"></i>Transf.
                            </span>
                        {% elif 'Edi√ß√£o' in h.tipo %}
                            <span class="badge badge-edicao text-white">
                                <i class="fas fa-edit me-1"></i>Edi√ß√£o
                            </span>
                        {% elif 'EXCLUS√ÉO' in h.tipo %}
                            <span class="badge badge-exclusao text-white">
                                <i class="fas fa-trash me-1"></i>Exclus√£o
                            </span>
                        {% else %}
                            <span class="badge bg-secondary">{{ h.tipo|truncatechars:10 }}</span>
                        {% endif %}
                    </td>
                    <td class="small text-center d-md-table-cell">
                        {{ h.descricao|safe|truncatechars:50 }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum registro no hist√≥rico</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Resto do c√≥digo de pagina√ß√£o permanece igual -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center flex-wrap">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.pagina_by %}&pagina_by={{ request.GET.pagina_by }}{% endif %}" aria-label="First">
                    <span class="d-none d-sm-inline">&laquo;&laquo;</span>
                    <span class="d-sm-none">‚èÆ</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.pagina_by %}&pagina_by={{ request.GET.pagina_by }}{% endif %}" aria-label="Previous">
                    <span class="d-none d-sm-inline">&laquo;</span>
                    <span class="d-sm-none">‚óÄ</span>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-2' and num < page_obj.number|add:'2' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if request.GET.pagina_by %}&pagina_by={{ request.GET.pagina_by }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.pagina_by %}&pagina_by={{ request.GET.pagina_by }}{% endif %}" aria-label="Next">
                    <span class="d-none d-sm-inline">&raquo;</span>
                    <span class="d-sm-none">‚ñ∂</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.pagina_by %}&pagina_by={{ request.GET.pagina_by }}{% endif %}" aria-label="Last">
                    <span class="d-none d-sm-inline">&raquo;&raquo;</span>
                    <span class="d-sm-none">‚è≠</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<script>
    // Adicionar indicador de scroll para mobile
    document.addEventListener('DOMContentLoaded', function() {
        const tableResponsive = document.querySelector('.table-responsive');
        const isMobile = window.innerWidth < 768;
        
        if (isMobile && tableResponsive) {
            // Mostrar que tem conte√∫do para o lado
            setTimeout(() => {
                tableResponsive.scrollLeft = 10;
                setTimeout(() => {
                    tableResponsive.scrollLeft = 0;
                }, 500);
            }, 1000);
        }
    });
</script>
{% endblock %}