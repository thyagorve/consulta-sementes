{% extends "sapp/base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 class="mb-4">{{ titulo_pagina }}</h2>

  <!-- FILTROS -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header fw-bold">
      <i class="fas fa-filter"></i> Filtros
    </div>
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        {% for field in filter.form %}
          <div class="col-sm-6 col-md-4 col-lg-3">
            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
            {% render_field field class="form-control form-control-sm" %}
          </div>
        {% endfor %}
        <div class="col-12 col-md-auto">
          <button class="btn btn-primary btn-sm" type="submit">Aplicar Filtros</button>
          <a href="{{ request.path }}" class="btn btn-secondary btn-sm">Limpar</a>
        </div>
      </form>
    </div>
  </div>

  <!-- TABELA -->
  {% if linhas_de_dados %}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <p class="mb-0 text-muted">
        Mostrando <strong>{{ page_obj.start_index }} - {{ page_obj.end_index }}</strong> de
        <strong>{{ page_obj.paginator.count }}</strong> registro(s).
      </p>
      <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#adicionarLoteModal">
        <i class="fas fa-plus"></i> Adicionar Lote
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover table-sm align-middle">
        <thead class="table-dark">
          <tr>
            {% for cabecalho in cabecalhos %}
              <th scope="col" class="text-nowrap">{{ cabecalho }}</th>
            {% endfor %}
            <th scope="col" class="text-center text-nowrap">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for linha in linhas_de_dados %}
          {# linha esperado como {'obj': EstoqueLote, 'valores': [...] } #}
          <tr>
            {% if linha.valores %}
              {% for celula in linha.valores %}
                <td class="text-nowrap">{{ celula|default:"---" }}</td>
              {% endfor %}
            {% else %}
              {% for celula in linha %}
                <td class="text-nowrap">{{ celula|default:"---" }}</td>
              {% endfor %}
            {% endif %}

            <td class="text-center text-nowrap">
              <div class="btn-group btn-group-sm">
                <!-- Histórico (expande linha) -->
                <button class="btn btn-secondary"
                        title="Histórico"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#hist-{{ linha.obj.id }}"
                        aria-expanded="false">
                  <i class="fas fa-clock"></i>
                </button>

                <!-- Detalhes (pode aproveitar depois p/ abrir um drawer/modal detalhado) -->
                <button class="btn btn-info" title="Detalhes" type="button"
                        data-action="detalhes" data-lote-id="{{ linha.obj.id }}">
                  <i class="fas fa-info-circle"></i>
                </button>

                <!-- Editar (sem URL agora; abre modal local) -->
                <button class="btn btn-warning"
                        title="Editar"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#modalEditar"
                        data-lote-id="{{ linha.obj.id }}"
                        data-lote="{{ linha.obj.lote }}"
                        data-endereco="{{ linha.obj.endereco }}"
                        data-entrada="{{ linha.obj.entrada }}"
                        data-saida="{{ linha.obj.saida }}"
                        data-peso="{{ linha.obj.peso }}"
                        data-obs="{{ linha.obj.observacao|default_if_none:'' }}">
                  <i class="fas fa-edit"></i>
                </button>

                <!-- Transferir -->
                <button class="btn btn-outline-primary"
                        title="Transferir"
                        data-bs-toggle="modal"
                        data-bs-target="#modalTransferir"
                        data-lote-id="{{ linha.obj.id }}"
                        data-lote="{{ linha.obj.lote }}"
                        data-endereco="{{ linha.obj.endereco }}"
                        data-saldo="{{ linha.obj.saldo }}">
                  <i class="fas fa-exchange-alt"></i>
                </button>

                <!-- Excluir (sem URL agora; confirmação local) -->
                <button class="btn btn-danger"
                        title="Excluir"
                        type="button"
                        data-action="excluir"
                        data-lote-id="{{ linha.obj.id }}"
                        data-lote="{{ linha.obj.lote }}">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </td>
          </tr>

          {# LINHA COLAPSÁVEL DE HISTÓRICO #}
          <tr class="collapse bg-light" id="hist-{{ linha.obj.id }}">
            <td colspan="{{ cabecalhos|length|add:'1' }}">
              <div class="p-3">
                <h6 class="mb-2">
                  Histórico do lote <strong>{{ linha.obj.lote }}</strong> – Endereço <strong>{{ linha.obj.endereco }}</strong>
                </h6>
                {% with movs=linha.obj.movimentacoes.all %}
                  {% if movs %}
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered mb-0">
                        <thead class="table-secondary">
                          <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Bags</th>
                            <th>KG</th>
                            <th>Origem</th>
                            <th>Destino</th>
                            <th>Usuário</th>
                            <th>Obs</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for m in movs|slice:":10" %}
                            <tr>
                              <td class="text-nowrap">{{ m.data_movimentacao|date:"d/m/Y H:i" }}</td>
                              <td class="text-nowrap">{{ m.get_tipo_movimentacao_display }}</td>
                              <td class="text-end">{{ m.quantidade_bags|floatformat:0 }}</td>
                              <td class="text-end">{{ m.quantidade_kg|floatformat:2 }}</td>
                              <td class="text-nowrap">{{ m.endereco_origem|default:"—" }}</td>
                              <td class="text-nowrap">{{ m.endereco_destino|default:"—" }}</td>
                              <td class="text-nowrap">{{ m.usuario|default:"—" }}</td>
                              <td class="text-truncate" style="max-width: 280px;">
                                {{ m.origem_destino_geral|default:"" }}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                      <small class="text-muted">Mostrando até 10 últimas movimentações.</small>
                    </div>
                  {% else %}
                    <div class="text-muted">Sem movimentações registradas.</div>
                  {% endif %}
                {% endwith %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
    <nav aria-label="Navegação da página" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">«</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
        {% endif %}

        {% for i in page_obj.paginator.page_range %}
          {% if page_obj.number == i %}
            <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
          {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
            <li class="page-item">
              <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a>
            </li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">»</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">»</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  {% else %}
    <div class="alert alert-warning mt-4" role="alert">
      <h4 class="alert-heading">Nenhum Registro Encontrado</h4>
      <p>Não há dados que correspondam aos seus critérios de busca.</p>
      {% if request.GET %}
        <hr>
        <p class="mb-0">Tente <a href="{{ request.path }}" class="alert-link">limpar os filtros</a> para ver todos os registros.</p>
      {% endif %}
      <button type="button" class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#adicionarLoteModal">
        <i class="fas fa-plus"></i> Adicionar Lote
      </button>
    </div>
  {% endif %}
</div>

<!-- MODAL: ADICIONAR LOTE -->
<div class="modal fade" id="adicionarLoteModal" tabindex="-1" aria-labelledby="adicionarLoteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="adicionarLoteModalLabel">Adicionar Novo Lote</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formAdicionarLote" method="post" action="{% url 'sapp:adicionar_lote' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            {% for field in form_adicionar_lote %}
              <div class="col-md-6">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {% render_field field class="form-control" %}
                {% for error in field.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>

          {% if form_adicionar_lote.non_field_errors %}
            <div class="alert alert-danger mt-3">
              {% for error in form_adicionar_lote.non_field_errors %}<p class="mb-0">{{ error }}</p>{% endfor %}
            </div>
          {% endif %}
          <p class="text-muted small mt-2">PN, CAT e ENDEREÇO são convertidos para MAIÚSCULO automaticamente.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar Lote</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR (placeholder local, sem endpoint ainda) -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formEditar" class="modal-content">
      {% csrf_token %}
      <div class="modal-header bg-warning">
        <h5 class="modal-title">Editar Lote</h5>
        <button type="button" class="btn-close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="lote_id" id="ed_lote_id">
        <div class="mb-2">
          <label class="form-label">Lote</label>
          <input type="text" class="form-control" id="ed_lote" readonly>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Endereço</label>
            <input type="text" class="form-control" name="endereco" id="ed_endereco" required>
          </div>
          <div class="col-6">
            <label class="form-label">Peso Unit. (kg)</label>
            <input type="number" step="0.01" class="form-control" name="peso" id="ed_peso">
          </div>
        </div>
        <div class="row g-2 mt-1">
          <div class="col-6">
            <label class="form-label">Entrada (Bags)</label>
            <input type="number" class="form-control" name="entrada" id="ed_entrada" min="0">
          </div>
          <div class="col-6">
            <label class="form-label">Saída (Bags)</label>
            <input type="number" class="form-control" name="saida" id="ed_saida" min="0">
          </div>
        </div>
        <div class="mt-2">
          <label class="form-label">Observação</label>
          <textarea class="form-control" name="observacao" id="ed_obs" rows="2"></textarea>
        </div>
        <div id="ed_feedback" class="text-danger small mt-1"></div>
        <small class="text-muted">Saldo e Peso Total são calculados automaticamente no servidor.</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-warning" type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: TRANSFERIR LOTE -->
<div class="modal fade" id="modalTransferir" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formTransferir" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Transferir Lote</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="lote_id" id="tf_lote_id">
        <div class="mb-2">
          <label class="form-label">Lote</label>
          <input type="text" class="form-control" id="tf_lote" readonly>
        </div>
        <div class="mb-2">
          <label class="form-label">Endereço Origem</label>
          <input type="text" class="form-control" id="tf_end_origem" readonly>
        </div>
        <div class="mb-2">
          <label class="form-label">Saldo Disponível (Bags)</label>
          <input type="number" class="form-control" id="tf_saldo" readonly>
        </div>
        <div class="mb-2">
          <label class="form-label">Quantidade a Transferir (Bags)</label>
          <input type="number" class="form-control" name="quantidade_bags" id="tf_qtd" min="1" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Endereço Destino</label>
          <input type="text" class="form-control" name="endereco_destino" id="tf_end_dest" required placeholder="Ex: R02 LN09 P01">
          <small class="text-muted">Será salvo em MAIÚSCULO e deve conter números.</small>
        </div>
        <div id="tf_feedback" class="text-danger small"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary" type="submit">Confirmar</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Reseta modal Adicionar
  const adicionarLoteModal = document.getElementById('adicionarLoteModal');
  if (adicionarLoteModal) {
    adicionarLoteModal.addEventListener('show.bs.modal', function () {
      const form = document.getElementById('formAdicionarLote');
      if (form) form.reset();
    });
  }

  // Força uppercase em campos (Adicionar/Editar/Transferir)
  document.addEventListener('input', function(e){
    const id = e.target.id || '';
    const upperIds = ['id_peneira', 'id_categoria', 'id_endereco', 'ed_endereco', 'tf_end_dest'];
    if (upperIds.includes(id)) {
      e.target.value = (e.target.value || '').toUpperCase();
    }
  });

  // Modal Transferir - preenche dados
  const modalTransferir = document.getElementById('modalTransferir');
  if (modalTransferir) {
    modalTransferir.addEventListener('show.bs.modal', (event) => {
      const btn = event.relatedTarget;
      document.getElementById('tf_lote_id').value = btn.dataset.loteId;
      document.getElementById('tf_lote').value = btn.dataset.lote;
      document.getElementById('tf_end_origem').value = btn.dataset.endereco;
      document.getElementById('tf_saldo').value = btn.dataset.saldo;
      document.getElementById('tf_qtd').value = '';
      document.getElementById('tf_end_dest').value = '';
      document.getElementById('tf_feedback').textContent = '';
    });

    // Envia Transferência
    document.getElementById('formTransferir').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(e.currentTarget);
      const resp = await fetch("{% url 'sapp:transferir_lote' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: data
      });
      const json = await resp.json();
      if (json.status === 'sucesso') {
        location.reload();
      } else {
        document.getElementById('tf_feedback').textContent = json.mensagem || 'Erro ao transferir.';
      }
    });
  }

  // Modal Editar - pré-preenche
  const modalEditar = document.getElementById('modalEditar');
  if (modalEditar) {
    modalEditar.addEventListener('show.bs.modal', (event) => {
      const btn = event.relatedTarget;
      document.getElementById('ed_lote_id').value = btn.dataset.loteId;
      document.getElementById('ed_lote').value = btn.dataset.lote;
      document.getElementById('ed_endereco').value = btn.dataset.endereco || '';
      document.getElementById('ed_entrada').value = btn.dataset.entrada || 0;
      document.getElementById('ed_saida').value = btn.dataset.saida || 0;
      document.getElementById('ed_peso').value = btn.dataset.peso || 0;
      document.getElementById('ed_obs').value = btn.dataset.obs || '';
      document.getElementById('ed_feedback').textContent = '';
    });

    // Envia Edição (placeholder — ajuste a URL quando criar a view)
    document.getElementById('formEditar').addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('ed_feedback').textContent = 'Defina a URL da view de edição para salvar (ex.: /lotes/editar/<id>/).';
      // DICA: quando tiver a view:
      // const id = document.getElementById('ed_lote_id').value;
      // const resp = await fetch(`/lotes/${id}/editar/`, { method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}' }, body: new FormData(e.currentTarget) });
      // const json = await resp.json(); if(json.status==='sucesso'){ location.reload(); } else { ... }
    });
  }

  // Ações Detalhes/Excluir (placeholders seguros)
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.loteId;
    const lote = btn.dataset.lote || id;

    if (action === 'detalhes') {
      // já temos o histórico expandível; aqui só damos foco no botão de histórico
      const col = document.querySelector(`[data-bs-target="#hist-${id}"]`);
      if (col) col.click();
    }

    if (action === 'excluir') {
      if (confirm(`Excluir o lote ${lote}? (Apenas placeholder — defina o endpoint depois)`)) {
        // Quando tiver a view:
        // fetch(`/lotes/${id}/excluir/`, { method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}' } })
        //   .then(r => r.json()).then(j => { if(j.status==='sucesso') location.reload(); else alert(j.mensagem||'Erro'); });
        alert('Defina a URL da view de exclusão (ex.: /lotes/<id>/excluir/).');
      }
    }
  });

  // Mensagens Django
  {% if messages %}
    {% for message in messages %}
      alert("{{ message|escapejs }}");
    {% endfor %}
  {% endif %}
</script>
{% endblock %}
